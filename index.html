<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema RNC 8D - Gestão de Qualidade</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f1f5f9;
            color: #0f172a;
        }
        
        /* SIDEBAR */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: #0b1f3a;
            color: white;
            overflow-y: auto;
            box-shadow: 4px 0 24px rgba(11, 31, 58, 0.25);
            z-index: 100;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            background: rgba(255, 255, 255, 0.04);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h2 {
            font-size: 1.5rem;
            font-weight: 800;
        }
        
        .user-info {
            padding: 1.25rem 1.5rem;
            background: rgba(255, 255, 255, 0.08);
            margin: 1.5rem;
            border-radius: 12px;
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.125rem;
            margin-bottom: 0.75rem;
        }
        
        .nav-menu {
            padding: 1rem;
        }
        
        .nav-item {
            padding: 0.875rem 1rem;
            margin: 0.25rem 0;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.875rem;
            transition: all 0.25s;
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        
        .nav-item.active {
            background: rgba(37, 99, 235, 0.35);
            font-weight: 600;
            border-left: 3px solid #93c5fd;
        }
        
        .nav-badge {
            margin-left: auto;
            background: #ef4444;
            color: white;
            padding: 0.25rem 0.625rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        /* MAIN CONTENT */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
        }
        
        .top-bar {
            background: linear-gradient(90deg, #0b1f3a 0%, #14345c 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.14);
            padding: 1.25rem 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #f8fafc;
        }

        .top-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 0;
        }

        .top-logo {
            font-size: 1.15rem;
            font-weight: 800;
            letter-spacing: 0.08em;
            color: #ffffff;
            white-space: nowrap;
        }

        .top-institutional {
            font-size: 0.69rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.72);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 520px;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-btn {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.24);
            background: rgba(255, 255, 255, 0.08);
            color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            background: #ef4444;
            color: white;
            font-size: 0.6875rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 0.3rem;
        }

        .top-user {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            cursor: pointer;
        }

        .top-user-meta {
            text-align: right;
            line-height: 1.2;
        }

        .top-user-name {
            font-size: 0.86rem;
            font-weight: 600;
            color: #ffffff;
        }

        .top-user-role {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.75);
        }
        
        .content-area {
            padding: 2rem;
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 800;
            color: #0f172a;
            margin-bottom: 0.5rem;
        }
        
        /* CARDS */
        .card {
            background: white;
            border-radius: 14px;
            padding: 1.75rem;
            box-shadow: 0 4px 14px rgba(15, 23, 42, 0.06);
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .stat-card.success::before {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }
        
        .stat-card.warning::before {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }
        
        .stat-card.danger::before {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .stat-icon {
            color: #1d4ed8;
            opacity: 0.9;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.25rem;
            height: 2.25rem;
            background: #eff6ff;
            border-radius: 10px;
        }

        .section-title-icon {
            color: #1d4ed8;
            display: inline-flex;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2.75rem;
            font-weight: 900;
            color: #1e40af;
            line-height: 1;
        }
        
        .stat-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            font-size: 0.875rem;
        }
        
        .stat-trend.positive {
            color: #059669;
        }
        
        .stat-trend.negative {
            color: #dc2626;
        }
        
        .stat-trend.neutral {
            color: #64748b;
        }
        
        .stat-comparison {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        
        /* TABELA */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            padding: 1rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.8125rem;
            text-transform: uppercase;
            color: #475569;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        
        td {
            padding: 1.125rem 1rem;
            border-bottom: 1px solid #f1f5f9;
        }
        
        tbody tr {
            cursor: pointer;
            transition: all 0.15s;
        }
        
        tbody tr:hover {
            background: #f8fafc;
        }
        
        /* BADGES */
        .badge {
            display: inline-flex;
            padding: 0.375rem 0.875rem;
            border-radius: 10px;
            font-size: 0.8125rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .badge.blue { background: #dbeafe; color: #1e40af; }
        .badge.green { background: #d1fae5; color: #065f46; }
        .badge.red { background: #fee2e2; color: #991b1b; }
        .badge.orange { background: #fed7aa; color: #92400e; }
        .badge.purple { background: #ede9fe; color: #6d28d9; }
        
        /* BOTÕES */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9375rem;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary {
            background: #1d4ed8;
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #1e293b;
        }
        
        /* MODAL */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            max-height: 90vh;
            overflow-y: auto;
            width: 95%;
            max-width: 1400px;
        }
        
        .modal-header {
            padding: 2rem;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: start;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        }
        
        .modal-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: #0f172a;
        }
        
        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: #64748b;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .modal-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 2rem;
            gap: 0.5rem;
            overflow-x: auto;
        }
        
        .modal-tab {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9375rem;
            color: #64748b;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        
        .modal-tab.active {
            color: #1e40af;
            border-bottom-color: #1e40af;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* PHASE TRACKER */
        .phase-tracker {
            display: flex;
            justify-content: space-between;
            margin: 2rem 0;
            padding: 0 1rem;
        }
        
        .phase-step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .phase-step::after {
            content: '';
            position: absolute;
            top: 1.5rem;
            left: 50%;
            width: 100%;
            height: 3px;
            background: #e2e8f0;
            z-index: 0;
        }
        
        .phase-step:last-child::after {
            display: none;
        }
        
        .phase-circle {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: #e2e8f0;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: 700;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }
        
        .phase-circle.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .phase-circle.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        /* 8D SECTION */
        .d8-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px solid #e2e8f0;
        }
        
        .d8-section.active {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.02) 100%);
        }
        
        .d8-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .d8-title {
            font-size: 1.25rem;
            font-weight: 800;
            color: #0f172a;
        }
        
        .prazo-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .prazo-box {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 0.75rem 1rem;
        }
        
        .prazo-box.original {
            border-color: #3b82f6;
        }
        
        .prazo-box.reprazo1 {
            border-color: #f59e0b;
        }
        
        .prazo-box.reprazo2 {
            border-color: #ef4444;
        }
        
        .prazo-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
        }
        
        .prazo-date {
            font-size: 1rem;
            font-weight: 800;
            color: #0f172a;
            margin-top: 0.25rem;
        }
        
        /* FORMS */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            font-weight: 600;
            font-size: 0.9375rem;
            margin-bottom: 0.5rem;
            color: #334155;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.9375rem;
            font-family: inherit;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .alert-warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
        }

        .prazo-justificativa {
            border: 1px solid #f59e0b;
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            padding: 0.875rem 1rem;
            margin-top: 0.75rem;
            color: #92400e;
            background: transparent;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .d2-image-layout {
            --d2-image-height: 220px;
            display: grid;
            grid-template-columns: repeat(2, minmax(220px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .d2-image-card {
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
        }

        .d2-image-card.green {
            border: 2px solid #16a34a;
        }

        .d2-image-card.red {
            border: 2px solid #dc2626;
        }

        .d2-image-preview {
            width: 100%;
            height: var(--d2-image-height);
            object-fit: cover;
            display: block;
            cursor: zoom-in;
            border: 0;
            box-shadow: none;
        }

        .d2-image-empty {
            width: 100%;
            height: var(--d2-image-height);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            background: #f8fafc;
        }

        .d2-image-label {
            padding: 0.5rem 0.75rem;
            min-height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 700;
            color: #fff;
            background: #334155;
        }

        .d2-image-card.green .d2-image-label {
            background: #16a34a;
        }

        .d2-image-card.red .d2-image-label {
            background: #dc2626;
        }
        
        /* LOGIN */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
        }
        
        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 24px;
            width: 100%;
            max-width: 460px;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 2rem;
            font-weight: 900;
            color: white;
        }
        
        /* DASHBOARD ENHANCEMENTS */
        .metrics-section {
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .lean-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }
        
        .chart-title {
            font-size: 1rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 1.5rem;
        }
        
        /* Bar Chart */
        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .bar-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .bar-label {
            min-width: 100px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #475569;
        }
        
        .bar-container {
            flex: 1;
            height: 32px;
            background: #f1f5f9;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.75rem;
            color: white;
            font-weight: 700;
            font-size: 0.75rem;
            transition: width 0.8s ease;
            border-radius: 8px;
        }
        
        .bar-value {
            min-width: 40px;
            text-align: right;
            font-weight: 700;
            font-size: 0.875rem;
            color: #1e40af;
        }
        
        /* Donut Chart */
        .donut-chart {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .donut-container {
            position: relative;
            width: 200px;
            height: 200px;
        }
        
        .donut-svg {
            transform: rotate(-90deg);
        }
        
        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .donut-total {
            font-size: 2rem;
            font-weight: 900;
            color: #1e40af;
        }
        
        .donut-label-text {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
        }
        
        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .donut-legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .donut-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        
        .donut-legend-label {
            font-size: 0.875rem;
            color: #475569;
            font-weight: 600;
            flex: 1;
        }
        
        .donut-legend-value {
            font-weight: 700;
            font-size: 0.875rem;
            color: #1e40af;
        }
        
        /* Line Chart */
        .line-chart {
            position: relative;
            height: 200px;
        }
        
        .line-chart-svg {
            width: 100%;
            height: 100%;
        }
        
        .line-chart-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
        }
        
        .line-chart-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
        }
        
        /* Tooltips */
        .chart-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        
        .chart-tooltip.active {
            opacity: 1;
        }
        
        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .stagger-1 { animation-delay: 0.1s; opacity: 0; }
        .stagger-2 { animation-delay: 0.2s; opacity: 0; }
        .stagger-3 { animation-delay: 0.3s; opacity: 0; }
        .stagger-4 { animation-delay: 0.4s; opacity: 0; }

        .dashboard-filter-bar {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.25rem;
            background: #ffffff;
            border: 1px solid #dbeafe;
            border-radius: 12px;
            padding: 1rem;
        }

        .dashboard-list-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .pagination-info {
            font-size: 0.82rem;
            color: #64748b;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .lean-metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .donut-chart {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBcrG1TEl6Q4C1Nsu0BJJ0HlZZzcqUNHVc",
            authDomain: "controle-rnc.firebaseapp.com",
            projectId: "controle-rnc",
            storageBucket: "controle-rnc.firebasestorage.app",
            messagingSenderId: "949786734068",
            appId: "1:949786734068:web:1f6e27f35449907a7a1da1"
        };

        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch (error) {
            console.warn('Falha ao inicializar Firebase:', error);
        }

        // ESTADO GLOBAL
        let state = {
            currentPage: 'login',
            currentUser: null,
            perfilModalAberto: false,
            perfilAbaAtiva: 'perfil',
            exportModalAberto: false,
            exportAnalisesSelecionadas: {
                resumoGeral: true,
                volumePecasImpactadas: true,
                statusPrioridade: true,
                tempoPorFase: true,
                leadTimeTotal: true,
                tempoMedioPorFase: true,
                tempoAtrasoPorFase: true,
                numeroReprazosPorRnc: true,
                primeiroPrazoUltimoPrazo: true,
                diasAdicionadosReprazo: true,
                rncsComReprazo: true,
                qtdAcoesCorretivas: true,
                qtdAcoesPreventivas: true,
                tempoMedioImplementacaoAcoes: true,
                acoesNoPrazoForaPrazo: true,
                quantidadeTotalPecas: true,
                quantidadeInspecionada: true,
                quantidadeNaoConforme: true,
                percentualNaoConforme: true,
                taxaRncsNoPrazo: true,
                taxaRncsEmRisco: true,
                taxaReprazos: true,
                rncsEncerradasPeriodo: true
            },
            dashboardFilterMonth: new Date().getMonth(),
            dashboardFilterYear: new Date().getFullYear(),
            dashboardSearch: '',
            dashboardPage: 1,
            selectedRNC: null,
            activeTab: 'd1',
            activeD4SubTab: 'principal',
            rncs: [
                {
                    id: 1,
                    numero: "RNC-2026-001",
                    cliente: "AutoParts Brasil",
                    codigoPeca: "P-12345",
                    tipoFalha: "Dimensional",
                    responsavel: "Débora Silva",
                    quantidade: 120,
                    faseAtual: "d3",
                    status: "AT_RISK",
                    prioridade: "Alta",
                    setor: "Usinagem",
                    dataAbertura: "2026-02-10",
                    descricao: "Peça fora da tolerância dimensional",
                    d1: { equipe: "Débora Silva, Lucas Santos, Marcos Oliveira", lider: "Débora Silva" },
                    d2: { problema: "Dimensional fora de especificação no furo Ø10mm", is5w2h: "Sim" },
                    d3: { acaoContemcao: "Inspeção 100% do estoque", evidencia: "Relatório de inspeção anexo" },
                    d4: { causaRaiz: "", why1: "", why2: "", why3: "", why4: "", why5: "" },
                    d5: { acoesCorretivas: "" },
                    d6: { planoImplementacao: "", responsavel: "", prazoImplementacao: "" },
                    d7: { acoesPreventivas: "" },
                    d8: { reconhecimento: "", licaoAprendida: "" },
                    prazos: {
                        d1: { original: "2026-02-10", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d2: { original: "2026-02-10", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d3: { original: "2026-02-11", sla: "24 horas", reprazo1: "2026-02-13", reprazo2: null, just1: "Aguardando laboratório", just2: "" },
                        d4: { original: "2026-02-14", sla: "3 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d5: { original: "2026-02-16", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d6: { original: "2026-02-23", sla: "7 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d7: { original: "2026-02-25", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d8: { original: "2026-02-26", sla: "1 dia", reprazo1: null, reprazo2: null, just1: "", just2: "" }
                    }
                },
                {
                    id: 2,
                    numero: "RNC-2026-002",
                    cliente: "Metal Solutions",
                    codigoPeca: "P-67890",
                    tipoFalha: "Acabamento",
                    responsavel: "Marcos Oliveira",
                    quantidade: 45,
                    faseAtual: "d4",
                    status: "ON_TIME",
                    prioridade: "Média",
                    setor: "Pintura",
                    dataAbertura: "2026-02-11",
                    descricao: "Falha no acabamento superficial",
                    d1: { equipe: "Marcos Oliveira, Pedro Costa", lider: "Marcos Oliveira" },
                    d2: { problema: "Bolhas na pintura", is5w2h: "Sim" },
                    d3: { acaoContemcao: "Retrabalho das peças", evidencia: "Fotos anexas" },
                    d4: { causaRaiz: "", why1: "", why2: "", why3: "", why4: "", why5: "" },
                    d5: { acoesCorretivas: "" },
                    d6: { planoImplementacao: "", responsavel: "", prazoImplementacao: "" },
                    d7: { acoesPreventivas: "" },
                    d8: { reconhecimento: "", licaoAprendida: "" },
                    prazos: {
                        d1: { original: "2026-02-11", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d2: { original: "2026-02-11", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d3: { original: "2026-02-12", sla: "24 horas", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d4: { original: "2026-02-15", sla: "3 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d5: { original: "2026-02-17", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d6: { original: "2026-02-24", sla: "7 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d7: { original: "2026-02-26", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d8: { original: "2026-02-27", sla: "1 dia", reprazo1: null, reprazo2: null, just1: "", just2: "" }
                    }
                },
                {
                    id: 3,
                    numero: "RNC-2026-003",
                    cliente: "TechParts Ltd",
                    codigoPeca: "P-11223",
                    tipoFalha: "Montagem",
                    responsavel: "Lucas Santos",
                    quantidade: 85,
                    faseAtual: "d6",
                    status: "ON_TIME",
                    prioridade: "Alta",
                    setor: "Montagem",
                    dataAbertura: "2026-02-05",
                    dataEncerramento: null,
                    descricao: "Erro de montagem",
                    d1: { equipe: "Lucas Santos, Ana Costa", lider: "Lucas Santos" },
                    d2: { problema: "Componente montado invertido", is5w2h: "Sim" },
                    d3: { acaoContemcao: "Desmontagem e remontagem", evidencia: "Check-list anexo" },
                    d4: { causaRaiz: "Falta de procedimento visual", why1: "Sem instrução", why2: "", why3: "", why4: "", why5: "" },
                    d5: { acoesCorretivas: "Criar instrução de trabalho visual" },
                    d6: { planoImplementacao: "Em andamento", responsavel: "Lucas Santos", prazoImplementacao: "2026-02-20" },
                    d7: { acoesPreventivas: "" },
                    d8: { reconhecimento: "", licaoAprendida: "" },
                    prazos: {
                        d1: { original: "2026-02-05", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d2: { original: "2026-02-05", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d3: { original: "2026-02-06", sla: "24 horas", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d4: { original: "2026-02-09", sla: "3 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d5: { original: "2026-02-11", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d6: { original: "2026-02-20", sla: "7 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d7: { original: "2026-02-22", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d8: { original: "2026-02-23", sla: "1 dia", reprazo1: null, reprazo2: null, just1: "", just2: "" }
                    }
                },
                {
                    id: 4,
                    numero: "RNC-2026-004",
                    cliente: "Indústria XYZ",
                    codigoPeca: "P-99887",
                    tipoFalha: "Acabamento",
                    responsavel: "Pedro Costa",
                    quantidade: 200,
                    faseAtual: "d2",
                    status: "ON_TIME",
                    prioridade: "Média",
                    setor: "Acabamento",
                    dataAbertura: "2026-02-12",
                    dataEncerramento: null,
                    descricao: "Risco na superfície",
                    d1: { equipe: "Pedro Costa, Maria Lima", lider: "Pedro Costa" },
                    d2: { problema: "Arranhões na superfície polida", is5w2h: "Em andamento" },
                    d3: { acaoContemcao: "", evidencia: "" },
                    d4: { causaRaiz: "", why1: "", why2: "", why3: "", why4: "", why5: "" },
                    d5: { acoesCorretivas: "" },
                    d6: { planoImplementacao: "", responsavel: "", prazoImplementacao: "" },
                    d7: { acoesPreventivas: "" },
                    d8: { reconhecimento: "", licaoAprendida: "" },
                    prazos: {
                        d1: { original: "2026-02-12", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d2: { original: "2026-02-12", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d3: { original: "2026-02-13", sla: "24 horas", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d4: { original: "2026-02-16", sla: "3 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d5: { original: "2026-02-18", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d6: { original: "2026-02-25", sla: "7 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d7: { original: "2026-02-27", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d8: { original: "2026-02-28", sla: "1 dia", reprazo1: null, reprazo2: null, just1: "", just2: "" }
                    }
                },
                {
                    id: 5,
                    numero: "RNC-2026-005",
                    cliente: "MegaAuto SA",
                    codigoPeca: "P-55443",
                    tipoFalha: "Dimensional",
                    responsavel: "Débora Silva",
                    quantidade: 75,
                    faseAtual: "d5",
                    status: "AT_RISK",
                    prioridade: "Alta",
                    setor: "Usinagem",
                    dataAbertura: "2026-02-08",
                    dataEncerramento: null,
                    descricao: "Diâmetro fora de especificação",
                    d1: { equipe: "Débora Silva, João Mendes", lider: "Débora Silva" },
                    d2: { problema: "Diâmetro externo com variação", is5w2h: "Sim" },
                    d3: { acaoContemcao: "Segregação e inspeção total", evidencia: "Relatório metrológico" },
                    d4: { causaRaiz: "Desgaste da ferramenta", why1: "Ferramenta não calibrada", why2: "Falta de plano de calibração", why3: "", why4: "", why5: "" },
                    d5: { acoesCorretivas: "Implementar plano de calibração" },
                    d6: { planoImplementacao: "", responsavel: "", prazoImplementacao: "" },
                    d7: { acoesPreventivas: "" },
                    d8: { reconhecimento: "", licaoAprendida: "" },
                    prazos: {
                        d1: { original: "2026-02-08", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d2: { original: "2026-02-08", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d3: { original: "2026-02-09", sla: "24 horas", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d4: { original: "2026-02-12", sla: "3 dias", reprazo1: "2026-02-14", reprazo2: null, just1: "Aguardando análise metrológica", just2: "" },
                        d5: { original: "2026-02-14", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d6: { original: "2026-02-21", sla: "7 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d7: { original: "2026-02-23", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d8: { original: "2026-02-24", sla: "1 dia", reprazo1: null, reprazo2: null, just1: "", just2: "" }
                    }
                }
            ]
        };

        // Dados históricos para tendências (últimos 6 meses)
        const historicalData = {
            monthlyRNCs: [
                { month: "Set/25", count: 3, onTime: 2, atRisk: 1 },
                { month: "Out/25", count: 5, onTime: 4, atRisk: 1 },
                { month: "Nov/25", count: 4, onTime: 3, atRisk: 1 },
                { month: "Dez/25", count: 6, onTime: 4, atRisk: 2 },
                { month: "Jan/26", count: 7, onTime: 5, atRisk: 2 },
                { month: "Fev/26", count: 5, onTime: 3, atRisk: 2 }
            ],
            previousMonth: {
                total: 7,
                onTime: 5,
                atRisk: 2,
                avgLeadTime: 14.5
            }
        };

        const users = [
            { id: 1, name: "Débora Silva", email: "debora@empresa.com", role: "Coordenadora de Qualidade", planta: "Matriz", initials: "DS" }
        ];

        let pessoasBase = [
            { id: 1, nome: "Lucas Santos", cargo: "Analista de Engenharia", setor: "Engenharia", planta: "Planta A", gerente: "Carlos Mendes", email: "lucas.santos@empresa.com" },
            { id: 2, nome: "Ana Costa", cargo: "Analista de Engenharia", setor: "Engenharia", planta: "Planta B", gerente: "Carlos Mendes", email: "ana.costa@empresa.com" },
            { id: 3, nome: "Débora Silva", cargo: "Analista da Qualidade", setor: "Qualidade", planta: "Planta A", gerente: "Fernanda Rocha", email: "debora@empresa.com" },
            { id: 4, nome: "Marcos Oliveira", cargo: "Analista da Qualidade", setor: "Qualidade", planta: "Planta A", gerente: "Fernanda Rocha", email: "marcos.oliveira@empresa.com" },
            { id: 5, nome: "Pedro Costa", cargo: "Responsável pela Contenção", setor: "Produção", planta: "Planta B", gerente: "Joana Almeida", email: "pedro.costa@empresa.com" },
            { id: 6, nome: "Maria Lima", cargo: "Analista de PCP", setor: "PCP", planta: "Planta A", gerente: "Rafael Souza", email: "maria.lima@empresa.com" },
            { id: 7, nome: "João Mendes", cargo: "Técnico de Processo", setor: "Processos", planta: "Planta B", gerente: "Carlos Mendes", email: "joao.mendes@empresa.com" }
        ];
        let modosFalhaBase = [
            { id: 1, nome: "Dimensional" },
            { id: 2, nome: "Acabamento" },
            { id: 3, nome: "Montagem" }
        ];
        let clientesBase = [
            { id: 1, nome: "AutoParts Brasil", fotoNome: "", fotoConteudo: "" },
            { id: 2, nome: "Metal Solutions", fotoNome: "", fotoConteudo: "" },
            { id: 3, nome: "TechParts Ltd", fotoNome: "", fotoConteudo: "" },
            { id: 4, nome: "Indústria XYZ", fotoNome: "", fotoConteudo: "" },
            { id: 5, nome: "MegaAuto SA", fotoNome: "", fotoConteudo: "" }
        ];

        const phases = [
            { id: 'd1', name: 'D1 - Equipe', short: 'D1' },
            { id: 'd2', name: 'D2 - Problema', short: 'D2' },
            { id: 'd3', name: 'D3 - Contenção', short: 'D3' },
            { id: 'd4', name: 'D4 - Causa Raiz', short: 'D4' },
            { id: 'd5', name: 'D5 - Ações Corretivas', short: 'D5' },
            { id: 'd6', name: 'D6 - Implementação', short: 'D6' },
            { id: 'd7', name: 'D7 - Prevenção', short: 'D7' },
            { id: 'd8', name: 'D8 - Encerramento', short: 'D8' }
        ];

        function renderIcon(type) {
            const icons = {
                chart: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19V5"/><path d="M10 19V9"/><path d="M16 19V13"/><path d="M22 19V3"/></svg>',
                check: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="m5 13 4 4L19 7"/></svg>',
                alert: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v4"/><path d="M12 17h.01"/><path d="M10.3 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.7 3.86a2 2 0 0 0-3.4 0z"/></svg>',
                time: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></svg>',
                metrics: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 17 6-6 4 4 7-7"/><path d="M14 8h6v6"/></svg>',
                analytics: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>',
                list: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 6h12"/><path d="M9 12h12"/><path d="M9 18h12"/><circle cx="4" cy="6" r="1"/><circle cx="4" cy="12" r="1"/><circle cx="4" cy="18" r="1"/></svg>',
                bell: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 1 0-12 0v3.2a2 2 0 0 1-.6 1.4L4 17h5"/><path d="M9 17a3 3 0 0 0 6 0"/></svg>',
                report: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M8 13h8"/><path d="M8 17h8"/><path d="M8 9h2"/></svg>'
            };
            return icons[type] || icons.chart;
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function getSafeImageSrc(value) {
            const src = String(value || '');
            return /^data:image\/(?:jpeg|jpg|png|gif|webp);base64,[a-zA-Z0-9+/=]+$/.test(src) ? src : '';
        }

        function abrirImagemModal(src, titulo) {
            const safeSrc = getSafeImageSrc(src);
            if (!safeSrc) return;
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1004';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 900px;" onclick="event.stopPropagation()" tabindex="0" role="dialog" aria-labelledby="image-modal-title" aria-label="Visualização ampliada de imagem">
                    <div class="modal-header">
                        <h2 class="modal-title" id="image-modal-title"></h2>
                        <button class="modal-close" data-close-image-modal>×</button>
                    </div>
                    <div class="modal-body" style="text-align:center;">
                        <img src="${escapeHtml(safeSrc)}" alt="${escapeHtml(titulo)}" style="max-width:100%; max-height:70vh; border-radius:10px; border:1px solid #e2e8f0;">
                    </div>
                </div>
            `;
            const fecharModal = () => {
                document.removeEventListener('keydown', onEscape);
                overlay.remove();
            };
            const onEscape = (event) => {
                if (event.key === 'Escape') fecharModal();
            };
            document.body.appendChild(overlay);
            const modalTitle = overlay.querySelector('#image-modal-title');
            if (modalTitle) modalTitle.textContent = titulo;
            const modalContent = overlay.querySelector('.modal-content');
            if (modalContent) modalContent.focus();
            document.addEventListener('keydown', onEscape);
            overlay.onclick = (e) => e.target === overlay && fecharModal();
            overlay.querySelector('[data-close-image-modal]').onclick = () => fecharModal();
        }

        function formatDateSafe(dateText) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(String(dateText || ''))) return '-';
            const parsed = new Date(`${dateText}T00:00:00`);
            if (Number.isNaN(parsed.getTime())) return '-';
            return parsed.toLocaleDateString('pt-BR');
        }

        function extractAndFormatDate(dateTimeText) {
            const value = String(dateTimeText || '');
            const dateOnly = /^\d{4}-\d{2}-\d{2}/.test(value) ? value.slice(0, 10) : '';
            return formatDateSafe(dateOnly);
        }

        function getUltimoPorquePreenchido(analise) {
            for (let i = 5; i > 0; i--) {
                const valor = String(analise?.[`why${i}`] || '').trim();
                if (valor) return valor;
            }
            return '';
        }

        function consolidateD4Data(d4) {
            d4.ocorrencia = d4.ocorrencia || { why1: '', why2: '', why3: '', why4: '', why5: '' };
            d4.deteccao = d4.deteccao || { why1: '', why2: '', why3: '', why4: '', why5: '' };
            d4.causaRaizOcorrencia = getUltimoPorquePreenchido(d4.ocorrencia);
            d4.causaRaizDeteccao = getUltimoPorquePreenchido(d4.deteccao);
            // Compatibilidade com estrutura legada do D4.
            for (let i = 1; i <= 5; i++) d4[`why${i}`] = d4.ocorrencia[`why${i}`];
            d4.causaRaiz = d4.causaRaizOcorrencia || '';
        }

        function ensureD4Structure(rnc) {
            if (!rnc.d4) rnc.d4 = {};
            rnc.d4.ocorrencia = rnc.d4.ocorrencia || {
                why1: rnc.d4.why1 || '',
                why2: rnc.d4.why2 || '',
                why3: rnc.d4.why3 || '',
                why4: rnc.d4.why4 || '',
                why5: rnc.d4.why5 || ''
            };
            rnc.d4.deteccao = rnc.d4.deteccao || {
                why1: '',
                why2: '',
                why3: '',
                why4: '',
                why5: ''
            };
            consolidateD4Data(rnc.d4);
        }

        function sincronizarD4EmEdicao() {
            if (!state.selectedRNC || state.activeTab !== 'd4') return;
            ensureD4Structure(state.selectedRNC);
            const d4 = state.selectedRNC.d4;
            for (let i = 1; i <= 5; i++) {
                const oc = document.getElementById(`d4-oc-why${i}`);
                const det = document.getElementById(`d4-det-why${i}`);
                if (oc) d4.ocorrencia[`why${i}`] = oc.value;
                if (det) d4.deteccao[`why${i}`] = det.value;
            }
            consolidateD4Data(d4);
        }

        function getPessoaById(id) {
            return pessoasBase.find(pessoa => pessoa.id === Number(id));
        }

        function getPessoasOptions() {
            return pessoasBase.map(pessoa => `
                <option value="${pessoa.id}">${escapeHtml(pessoa.nome)} - ${escapeHtml(pessoa.cargo)} (${escapeHtml(pessoa.setor)} / ${escapeHtml(pessoa.planta)})</option>
            `).join('');
        }

        function getOutrosEnvolvidosSelecionados() {
            const hidden = document.getElementById('outrosEnvolvidosIds');
            if (!hidden || !hidden.value) return [];
            const value = String(hidden.value || '').trim();
            if (!value) return [];
            return value.split(',').map(id => Number(id)).filter(id => Number.isFinite(id) && id > 0);
        }

        function renderOutrosEnvolvidosSelecionados() {
            const container = document.getElementById('outrosEnvolvidosSelecionados');
            if (!container) return;
            const selecionados = getOutrosEnvolvidosSelecionados();
            if (!selecionados.length) {
                container.innerHTML = '<p style="font-size:0.8125rem; color:#64748b;">Nenhum envolvido adicional selecionado.</p>';
                return;
            }
            container.innerHTML = selecionados.map(id => {
                const pessoa = getPessoaById(id);
                if (!pessoa) return '';
                return `
                    <span style="display:inline-flex; align-items:center; gap:0.35rem; border:1px solid #cbd5e1; border-radius:999px; padding:0.25rem 0.6rem; font-size:0.8125rem;">
                        ${escapeHtml(pessoa.nome)} (${escapeHtml(pessoa.cargo)} • ${escapeHtml(pessoa.planta)})
                        <button type="button" data-outro-id="${pessoa.id}" class="btn-remover-outro" style="border:none; background:transparent; color:#dc2626; cursor:pointer; font-weight:700;">×</button>
                    </span>
                `;
            }).join('');
        }

        function montarEquipeD1(rnc) {
            const equipe = [];
            if (rnc.equipeResponsavel?.responsavelContencaoId) {
                const pessoa = getPessoaById(rnc.equipeResponsavel.responsavelContencaoId);
                if (pessoa) equipe.push({ pessoa, funcaoRnc: "Responsável pela Contenção" });
            }
            if (rnc.equipeResponsavel?.analistaEngenhariaId) {
                const pessoa = getPessoaById(rnc.equipeResponsavel.analistaEngenhariaId);
                if (pessoa) equipe.push({ pessoa, funcaoRnc: "Analista de Engenharia" });
            }
            if (rnc.equipeResponsavel?.analistaQualidadeId) {
                const pessoa = getPessoaById(rnc.equipeResponsavel.analistaQualidadeId);
                if (pessoa) equipe.push({ pessoa, funcaoRnc: "Analista da Qualidade" });
            }
            (rnc.equipeResponsavel?.outrosEnvolvidosIds || []).forEach(id => {
                const pessoa = getPessoaById(id);
                if (pessoa) equipe.push({ pessoa, funcaoRnc: "Outros Envolvidos" });
            });
            if (equipe.length > 0) return equipe;

            const nomesLegados = (rnc.d1?.equipe || '').split(',').map(nome => nome.trim()).filter(Boolean);
            // Regra de compatibilidade para registros antigos sem papéis estruturados por ID.
            return nomesLegados.map(nome => {
                const pessoa = pessoasBase.find(item => item.nome === nome) || { id: null, nome, cargo: "-", setor: "-", planta: "-" };
                return { pessoa, funcaoRnc: nome === rnc.d1?.lider ? "Analista da Qualidade" : "Outros Envolvidos" };
            });
        }

        function getEquipeMembroKey(item) {
            if (item?.pessoa?.id) return `id-${item.pessoa.id}`;
            return `nome-${String(item?.pessoa?.nome || '').replace(/[^a-zA-Z0-9_-]/g, '_')}`;
        }

        function ensureD8Structure(rnc) {
            if (!rnc.d8) rnc.d8 = {};
            if (typeof rnc.d8.licaoAprendida !== 'string') rnc.d8.licaoAprendida = '';
            if (typeof rnc.d8.mensagemFinal !== 'string') rnc.d8.mensagemFinal = rnc.d8.reconhecimento || '';
            if (!rnc.d8.reconhecimentoIndividual || typeof rnc.d8.reconhecimentoIndividual !== 'object') rnc.d8.reconhecimentoIndividual = {};
            if (typeof rnc.d8.concluida !== 'boolean') rnc.d8.concluida = false;
            if (typeof rnc.d8.dataConclusao !== 'string') rnc.d8.dataConclusao = '';
        }

        function getPendenciasConclusaoD8(rnc) {
            const pendencias = [];
            if (!(rnc.d8?.licaoAprendida || '').trim()) pendencias.push('Preencha o campo obrigatório de lições aprendidas.');
            const acoesCorretivas = (rnc.d5?.listaAcoes || []).map(normalizeAcaoD5);
            const acoesPreventivas = (rnc.d7?.listaAcoes || []).map(normalizeAcaoD7);
            if (acoesCorretivas.some(acao => acao.status !== 'CONCLUIDA')) pendencias.push('Conclua todas as ações corretivas (D5/D6).');
            if (acoesPreventivas.some(acao => acao.status !== 'CONCLUIDA')) pendencias.push('Conclua todas as ações preventivas (D7).');
            return pendencias;
        }

        function isEtapaConcluida(rnc, phaseId) {
            if (phaseId === 'd1') return true;
            if (phaseId === 'd2') {
                // D2 é concluída no cadastro; fallback garante compatibilidade com registros legados.
                return rnc.d2?.etapaConcluida === true || (!!String(rnc.descricao || '').trim() && !!String(rnc.cliente || '').trim() && !!String(rnc.tipoFalha || '').trim());
            }
            if (phaseId === 'd3') return !!rnc.d3?.etapaConcluida;
            if (phaseId === 'd4') {
                ensureD4Structure(rnc);
                return !!(getUltimoPorquePreenchido(rnc.d4.ocorrencia) && getUltimoPorquePreenchido(rnc.d4.deteccao));
            }
            // No D5 a conclusão considera ações cadastradas, não necessariamente concluídas.
            if (phaseId === 'd5') return (rnc.d5?.listaAcoes || []).map(normalizeAcaoD5).length > 0;
            if (phaseId === 'd6') {
                const acoes = (rnc.d5?.listaAcoes || []).map(normalizeAcaoD5);
                return acoes.length > 0 && acoes.every(acao => acao.status === 'CONCLUIDA' && (acao.evidencias?.length || 0) > 0);
            }
            if (phaseId === 'd7') {
                const acoes = (rnc.d7?.listaAcoes || []).map(normalizeAcaoD7);
                return acoes.length > 0 && acoes.every(acao => acao.status === 'CONCLUIDA' && (acao.evidencias?.length || 0) > 0);
            }
            if (phaseId === 'd8') return !!rnc.d8?.concluida;
            return false;
        }

        function canAcessarEtapa(rnc, phaseId) {
            const targetIndex = phases.findIndex(p => p.id === phaseId);
            if (targetIndex <= 0) return true;
            for (let i = 0; i < targetIndex; i++) {
                if (!isEtapaConcluida(rnc, phases[i].id)) return false;
            }
            return true;
        }

        function getPrimeiraEtapaPendente(rnc) {
            const pendente = phases.find(phase => !isEtapaConcluida(rnc, phase.id));
            return pendente ? pendente.id : null;
        }

        function sincronizarFluxo8D(rnc) {
            if (!rnc) return;
            const proximaEtapa = getPrimeiraEtapaPendente(rnc);
            rnc.faseAtual = proximaEtapa || 'd8';
        }

        function getResponsavelRNC(rnc) {
            return getPessoaById(rnc.equipeResponsavel?.analistaQualidadeId)?.nome || rnc.responsavel || rnc.d1?.lider || '-';
        }

        function isAcaoEmAtrasoAberta(acao, normalizador) {
            const acaoNormalizada = normalizador(acao);
            if (acaoNormalizada.status === 'CONCLUIDA') return false;
            return obterIndicadorPrazoAcao(acaoNormalizada).className === 'red';
        }

        function isRncEmRisco(rnc) {
            if (isEtapaConcluida(rnc, 'd8')) return false;
            const etapasAtrasadas = getEtapasEmAtraso(rnc);
            if (etapasAtrasadas.length > 0) return true;
            const acoesCorretivasAtrasadas = (rnc.d5?.listaAcoes || []).some(acao => isAcaoEmAtrasoAberta(acao, normalizeAcaoD5));
            if (acoesCorretivasAtrasadas) return true;
            const acoesPreventivasAtrasadas = (rnc.d7?.listaAcoes || []).some(acao => isAcaoEmAtrasoAberta(acao, normalizeAcaoD7));
            return acoesPreventivasAtrasadas;
        }

        function getStatusRncValue(rnc) {
            return isRncEmRisco(rnc) ? 'AT_RISK' : 'ON_TIME';
        }

        function getDashboardCompetenciaRncs() {
            return state.rncs.filter(rnc => {
                if (!rnc?.dataAbertura) return false;
                const abertura = new Date(rnc.dataAbertura);
                if (Number.isNaN(abertura.getTime())) return false;
                return abertura.getMonth() === Number(state.dashboardFilterMonth) &&
                    abertura.getFullYear() === Number(state.dashboardFilterYear);
            });
        }

        function buildCompetenciaTrendData() {
            const series = [];
            const baseDate = new Date(Number(state.dashboardFilterYear), Number(state.dashboardFilterMonth), 1);
            for (let i = 5; i >= 0; i--) {
                const pointDate = new Date(baseDate.getFullYear(), baseDate.getMonth() - i, 1);
                const month = pointDate.toLocaleDateString('pt-BR', { month: 'short' }).replace('.', '');
                const yearShort = String(pointDate.getFullYear()).slice(-2);
                const count = state.rncs.filter(rnc => {
                    if (!rnc?.dataAbertura) return false;
                    const abertura = new Date(rnc.dataAbertura);
                    return !Number.isNaN(abertura.getTime()) &&
                        abertura.getMonth() === pointDate.getMonth() &&
                        abertura.getFullYear() === pointDate.getFullYear();
                }).length;
                series.push({ month: `${month.charAt(0).toUpperCase()}${month.slice(1)}/${yearShort}`, count });
            }
            return series;
        }

        function parseISODate(dateValue) {
            const value = String(dateValue || '');
            const dateOnly = /^\d{4}-\d{2}-\d{2}/.test(value) ? value.slice(0, 10) : '';
            if (!dateOnly) return null;
            const parsed = new Date(`${dateOnly}T00:00:00`);
            if (Number.isNaN(parsed.getTime())) return null;
            return parsed;
        }

        function diffDays(startDateValue, endDateValue) {
            const start = parseISODate(startDateValue);
            const end = parseISODate(endDateValue);
            if (!start || !end) return '';
            const msPerDay = 24 * 60 * 60 * 1000;
            return Math.max(0, Math.floor((end.getTime() - start.getTime()) / msPerDay));
        }

        function getRNCsPeriodoAnalitico() {
            return getDashboardCompetenciaRncs();
        }

        function getTotalReprazosRNC(rnc) {
            const etapas = ['d3', 'd4', 'd5', 'd6', 'd7', 'd8'];
            return etapas.reduce((acc, etapa) => {
                const prazoEtapa = rnc.prazos?.[etapa];
                if (!prazoEtapa) return acc;
                return acc + (prazoEtapa.reprazo1 ? 1 : 0) + (prazoEtapa.reprazo2 ? 1 : 0);
            }, 0);
        }

        function getPrimeiroEUltimoPrazoRNC(rnc) {
            const etapas = ['d3', 'd4', 'd5', 'd6', 'd7', 'd8'];
            const datas = [];
            etapas.forEach(etapa => {
                const prazo = rnc.prazos?.[etapa];
                if (!prazo) return;
                [prazo.original, prazo.reprazo1, prazo.reprazo2].forEach(data => {
                    const parsed = parseISODate(data);
                    if (parsed) datas.push(parsed);
                });
            });
            if (!datas.length) return { primeiroPrazo: '', ultimoPrazo: '' };
            datas.sort((a, b) => a.getTime() - b.getTime());
            const formatISO = d => d.toISOString().slice(0, 10);
            return { primeiroPrazo: formatISO(datas[0]), ultimoPrazo: formatISO(datas[datas.length - 1]) };
        }

        function xmlEscape(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        function buildExcelWorkbookXML(sheets) {
            const header = `<?xml version="1.0"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
 <Styles>
  <Style ss:ID="Header"><Font ss:Bold="1"/><Interior ss:Color="#DCE6F1" ss:Pattern="Solid"/></Style>
 </Styles>`;
            const usedNames = new Set();
            const getUniqueSheetName = (baseName) => {
                const normalized = String(baseName || 'Aba').slice(0, 31);
                if (!usedNames.has(normalized)) {
                    usedNames.add(normalized);
                    return normalized;
                }
                let idx = 2;
                while (idx < 1000) {
                    const suffix = ` (${idx})`;
                    const candidate = `${normalized.slice(0, 31 - suffix.length)}${suffix}`;
                    if (!usedNames.has(candidate)) {
                        usedNames.add(candidate);
                        return candidate;
                    }
                    idx += 1;
                }
                return normalized;
            };
            const worksheets = sheets.map(sheet => {
                const safeName = xmlEscape(getUniqueSheetName(sheet.name));
                const headerRow = `<Row>${(sheet.headers || []).map(h => `<Cell ss:StyleID="Header"><Data ss:Type="String">${xmlEscape(h)}</Data></Cell>`).join('')}</Row>`;
                const dataRows = (sheet.rows || []).map(row => `<Row>${row.map(cell => {
                    const isNumber = typeof cell === 'number' && Number.isFinite(cell);
                    return `<Cell><Data ss:Type="${isNumber ? 'Number' : 'String'}">${xmlEscape(isNumber ? cell : String(cell ?? ''))}</Data></Cell>`;
                }).join('')}</Row>`).join('');
                return `<Worksheet ss:Name="${safeName}"><Table>${headerRow}${dataRows}</Table></Worksheet>`;
            }).join('');
            return `${header}${worksheets}</Workbook>`;
        }

        function exportarRelatorioAnaliticoExcel() {
            const selecionadas = state.exportAnalisesSelecionadas || {};
            const rncs = getRNCsPeriodoAnalitico();
            const hojeISO = new Date().toISOString().slice(0, 10);
            const hasAny = Object.values(selecionadas).some(Boolean);
            if (!hasAny) {
                alert('Selecione ao menos uma análise para exportar.');
                return;
            }

            const sheets = [];

            if (selecionadas.resumoGeral || selecionadas.volumePecasImpactadas || selecionadas.statusPrioridade) {
                sheets.push({
                    name: 'Resumo Geral',
                    headers: ['Nº RNC', 'Cliente', 'Setor', 'Tipo Falha', 'Prioridade', 'Status', 'Em Risco', 'Qtde Peças'],
                    rows: rncs.map(rnc => [
                        rnc.numero || '-',
                        rnc.cliente || '-',
                        rnc.setor || '-',
                        rnc.tipoFalha || '-',
                        rnc.prioridade || '-',
                        isEtapaConcluida(rnc, 'd8') ? 'Encerrada' : 'Em andamento',
                        isRncEmRisco(rnc) ? 'Sim' : 'Não',
                        Number(rnc.quantidade || 0)
                    ])
                });
            }

            if (selecionadas.tempoPorFase || selecionadas.leadTimeTotal || selecionadas.tempoMedioPorFase || selecionadas.tempoAtrasoPorFase) {
                const phaseIds = ['d1', 'd2', 'd3', 'd4', 'd5', 'd6', 'd7', 'd8'];
                const rows = rncs.map(rnc => {
                    const faseDias = phaseIds.map(id => diffDays(rnc.dataAbertura, getPrazoVigenteEtapa(rnc.prazos?.[id])));
                    const leadTime = isEtapaConcluida(rnc, 'd8') ? diffDays(rnc.dataAbertura, rnc.d8?.dataConclusao) : diffDays(rnc.dataAbertura, hojeISO);
                    const atrasoPorFase = getEtapasEmAtraso(rnc).reduce((acc, item) => acc + Number(diffDays(item.vencimento, hojeISO) || 0), 0);
                    return [rnc.numero || '-', ...faseDias.map(v => Number(v || 0)), Number(leadTime || 0), atrasoPorFase];
                });
                sheets.push({
                    name: 'Tempo por Fase',
                    headers: ['Nº RNC', 'D1 (dias)', 'D2', 'D3', 'D4', 'D5', 'D6', 'D7', 'D8', 'Lead Time Total', 'Tempo em atraso (dias)'],
                    rows
                });
            }

            if (selecionadas.numeroReprazosPorRnc || selecionadas.primeiroPrazoUltimoPrazo || selecionadas.diasAdicionadosReprazo || selecionadas.rncsComReprazo) {
                sheets.push({
                    name: 'Reprazos',
                    headers: ['Nº RNC', 'Qtde Re-prazos', 'Prazo Inicial', 'Último Prazo', 'Dias Adicionados', 'RNC com Re-prazo'],
                    rows: rncs.map(rnc => {
                        const qtde = getTotalReprazosRNC(rnc);
                        const { primeiroPrazo, ultimoPrazo } = getPrimeiroEUltimoPrazoRNC(rnc);
                        const diasAdd = Number(diffDays(primeiroPrazo, ultimoPrazo) || 0);
                        return [rnc.numero || '-', qtde, formatDateSafe(primeiroPrazo), formatDateSafe(ultimoPrazo), diasAdd, qtde > 0 ? 'Sim' : 'Não'];
                    })
                });
            }

            if (selecionadas.qtdAcoesCorretivas || selecionadas.qtdAcoesPreventivas || selecionadas.tempoMedioImplementacaoAcoes || selecionadas.acoesNoPrazoForaPrazo) {
                const rows = [];
                rncs.forEach(rnc => {
                    const grupos = [
                        { tipo: 'Corretiva', acoes: (rnc.d5?.listaAcoes || []).map(normalizeAcaoD5) },
                        { tipo: 'Preventiva', acoes: (rnc.d7?.listaAcoes || []).map(normalizeAcaoD7) }
                    ];
                    grupos.forEach(grupo => {
                        const totalAcoes = grupo.acoes.length;
                        const concluidas = grupo.acoes.filter(a => a.status === 'CONCLUIDA').length;
                        const foraPrazo = grupo.acoes.filter(a => a.status === 'CONCLUIDA' && diffDays(obterPrazoVigenteAcao(a), a.dataConclusao) > 0).length;
                        const tempos = grupo.acoes
                            .filter(a => a.status === 'CONCLUIDA')
                            .map(a => Number(diffDays(rnc.dataAbertura, a.dataConclusao) || 0));
                        const tempoMedio = tempos.length ? (tempos.reduce((a, b) => a + b, 0) / tempos.length).toFixed(1) : '0.0';
                        rows.push([rnc.numero || '-', grupo.tipo, totalAcoes, concluidas, foraPrazo, tempoMedio]);
                    });
                });
                sheets.push({
                    name: 'Ações',
                    headers: ['Nº RNC', 'Tipo Ação', 'Qtde Ações', 'Concluídas', 'Fora do Prazo', 'Tempo Médio (dias)'],
                    rows
                });
            }

            if (selecionadas.quantidadeTotalPecas || selecionadas.quantidadeInspecionada || selecionadas.quantidadeNaoConforme || selecionadas.percentualNaoConforme) {
                sheets.push({
                    name: 'Volume e Contenção',
                    headers: ['Nº RNC', 'Qtde Peças', 'Inspecionadas', 'Não Conformes', '% NC'],
                    rows: rncs.map(rnc => {
                        const qtde = Number(rnc.quantidade || 0);
                        const inspecionada = Number(rnc.d3?.quantidadeInspecionada || 0);
                        const naoConf = Number(rnc.d3?.quantidadeNaoConforme || 0);
                        const percNC = inspecionada > 0 ? ((naoConf / inspecionada) * 100).toFixed(1) : '0.0';
                        return [rnc.numero || '-', qtde, inspecionada, naoConf, `${percNC}%`];
                    })
                });
            }

            if (selecionadas.taxaRncsNoPrazo || selecionadas.taxaRncsEmRisco || selecionadas.taxaReprazos || selecionadas.rncsEncerradasPeriodo) {
                const total = rncs.length;
                const noPrazo = rncs.filter(r => getStatusRncValue(r) === 'ON_TIME').length;
                const emRisco = rncs.filter(r => getStatusRncValue(r) === 'AT_RISK').length;
                const comReprazo = rncs.filter(r => getTotalReprazosRNC(r) > 0).length;
                const encerradas = rncs.filter(r => isEtapaConcluida(r, 'd8')).length;
                const leadTimes = rncs.map(r => Number((isEtapaConcluida(r, 'd8') ? diffDays(r.dataAbertura, r.d8?.dataConclusao) : diffDays(r.dataAbertura, hojeISO)) || 0));
                const leadTimeMedio = leadTimes.length ? (leadTimes.reduce((a, b) => a + b, 0) / leadTimes.length).toFixed(1) : '0.0';
                sheets.push({
                    name: 'Indicadores',
                    headers: ['Indicador', 'Valor'],
                    rows: [
                        ['Taxa de RNCs no prazo', `${total ? ((noPrazo / total) * 100).toFixed(1) : '0.0'}%`],
                        ['Taxa de RNCs em risco', `${total ? ((emRisco / total) * 100).toFixed(1) : '0.0'}%`],
                        ['Taxa de re-prazos', `${total ? ((comReprazo / total) * 100).toFixed(1) : '0.0'}%`],
                        ['RNCs encerradas no período', encerradas],
                        ['Lead Time Médio (dias)', leadTimeMedio]
                    ]
                });
            }

            if (!sheets.length) {
                alert('Não há análises selecionadas para exportação.');
                return;
            }

            const xml = buildExcelWorkbookXML(sheets);
            const blob = new Blob([xml], { type: 'application/vnd.ms-excel' });
            const a = document.createElement('a');
            const month = String(Number(state.dashboardFilterMonth) + 1).padStart(2, '0');
            a.href = URL.createObjectURL(blob);
            a.download = `relatorio-8d-analitico-${state.dashboardFilterYear}-${month}.xls`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                URL.revokeObjectURL(a.href);
                a.remove();
            }, 1000);
        }

        function validatePasswordComplexity(password) {
            return /[A-Z]/.test(password) && /[a-z]/.test(password) && /[0-9]/.test(password) && /[^A-Za-z0-9]/.test(password);
        }

        function normalizeNumeroRNC(numero) {
            return String(numero || '').trim().toUpperCase();
        }

        const RNC_NUMERO_DUPLICADO_MSG = '⚠️ Já existe uma RNC cadastrada com este número. Informe um número diferente.';

        function existeNumeroRNCDuplicado(numero) {
            const alvo = normalizeNumeroRNC(numero);
            if (!alvo) return false;
            return state.rncs.some(rnc => normalizeNumeroRNC(rnc.numero) === alvo);
        }

        function getStatusConclusao8D(rnc) {
            const concluido = isEtapaConcluida(rnc, 'd8');
            return concluido
                ? { value: 'CONCLUIDO', label: 'Concluído', className: 'green' }
                : { value: 'EM_ANDAMENTO', label: 'Em andamento', className: 'blue' };
        }

        function getPrazoVigenteEtapa(prazoEtapa) {
            if (!prazoEtapa) return '';
            return prazoEtapa.reprazo2 || prazoEtapa.reprazo1 || prazoEtapa.original || '';
        }

        function getResponsavelEtapaAtrasada(rnc, phaseId) {
            if (phaseId === 'd5' || phaseId === 'd6') {
                const acaoAberta = (rnc.d5?.listaAcoes || []).map(normalizeAcaoD5).find(acao => acao.status !== 'CONCLUIDA');
                if (acaoAberta) return getPessoaById(acaoAberta.responsavelId)?.nome || acaoAberta.responsavel || getResponsavelRNC(rnc);
            }
            if (phaseId === 'd7') {
                const acaoAberta = (rnc.d7?.listaAcoes || []).map(normalizeAcaoD7).find(acao => acao.status !== 'CONCLUIDA');
                if (acaoAberta) return getPessoaById(acaoAberta.responsavelId)?.nome || acaoAberta.responsavel || getResponsavelRNC(rnc);
            }
            return getResponsavelRNC(rnc);
        }

        function getEtapasEmAtraso(rnc) {
            const etapas = ['d3', 'd4', 'd5', 'd6', 'd7'];
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            return etapas.flatMap(phaseId => {
                if (isEtapaConcluida(rnc, phaseId)) return [];
                const prazoVigente = getPrazoVigenteEtapa(rnc.prazos?.[phaseId]);
                if (!/^\d{4}-\d{2}-\d{2}$/.test(String(prazoVigente || ''))) return [];
                const prazo = new Date(`${prazoVigente}T00:00:00`);
                if (hoje.getTime() <= prazo.getTime()) return [];
                return [{
                    phaseId,
                    phaseName: phases.find(p => p.id === phaseId)?.name || phaseId.toUpperCase(),
                    vencimento: prazoVigente,
                    responsavel: getResponsavelEtapaAtrasada(rnc, phaseId)
                }];
            });
        }

        function getStatusEtapas8D(rnc) {
            const atrasos = getEtapasEmAtraso(rnc);
            if (!atrasos.length) return { value: 'SEM_ATRASO', label: 'Sem atraso', className: 'green', detalhe: '' };
            const detalhe = atrasos.map(item => `Etapa em atraso: ${item.phaseName} • Prazo vencido em: ${formatDateSafe(item.vencimento)} • Responsável: ${item.responsavel}`).join(' || ');
            return { value: 'COM_ATRASO', label: 'Com atraso', className: 'red', detalhe };
        }

        function isRNCAtiva(rnc) {
            return !isEtapaConcluida(rnc, 'd8');
        }

        function getCadastroConfig(tipo) {
            if (tipo === 'pessoas') {
                return {
                    titulo: 'Pessoas',
                    descricao: 'Base de integrantes para equipes de RNC',
                    fields: [
                        { key: 'nome', label: 'Nome', type: 'text', required: true },
                        { key: 'cargo', label: 'Função / Cargo', type: 'text', required: true },
                        { key: 'setor', label: 'Setor', type: 'text', required: true },
                        { key: 'planta', label: 'Planta', type: 'text', required: true },
                        { key: 'gerente', label: 'Gerente', type: 'text', required: true },
                        { key: 'email', label: 'E-mail', type: 'email', required: true }
                    ]
                };
            }
            if (tipo === 'modos-falha') {
                return {
                    titulo: 'Modo de Falha',
                    descricao: 'Tipos de falha padronizados para RNC',
                    fields: [
                        { key: 'nome', label: 'Nome do Modo de Falha', type: 'text', required: true }
                    ]
                };
            }
            return {
                titulo: 'Cliente',
                descricao: 'Clientes reutilizáveis nas RNCs',
                fields: [
                    { key: 'nome', label: 'Nome do Cliente', type: 'text', required: true },
                    { key: 'fotoConteudo', label: 'Foto', type: 'file', required: true, isImage: true }
                ]
            };
        }

        function getCadastroLista(tipo) {
            if (tipo === 'pessoas') return pessoasBase;
            if (tipo === 'modos-falha') return modosFalhaBase;
            return clientesBase;
        }

        function getCadastroItemById(tipo, id) {
            return getCadastroLista(tipo).find(item => item.id === Number(id));
        }

        function getNextId(listaBase) {
            return Math.max(0, ...listaBase.map(x => Number(x.id) || 0)) + 1;
        }

        function bloqueioExclusaoCadastro(tipo, item) {
            if (!item) return null;
            if (tipo === 'pessoas') {
                const vinculado = state.rncs.some(rnc => isRNCAtiva(rnc) && (
                    rnc.equipeResponsavel?.responsavelContencaoId === item.id ||
                    rnc.equipeResponsavel?.analistaEngenhariaId === item.id ||
                    rnc.equipeResponsavel?.analistaQualidadeId === item.id ||
                    (rnc.equipeResponsavel?.outrosEnvolvidosIds || []).includes(item.id) ||
                    (rnc.d5?.listaAcoes || []).some(acao => acao.responsavelId === item.id || acao.responsavel === item.nome) ||
                    rnc.responsavel === item.nome ||
                    (rnc.d1?.lider === item.nome) ||
                    (rnc.d1?.equipe || '').split(',').map(nome => nome.trim()).includes(item.nome)
                ));
                if (vinculado) return 'Não é possível excluir: item vinculado a RNC ativa.';
            }
            if (tipo === 'modos-falha') {
                const vinculado = state.rncs.some(rnc => isRNCAtiva(rnc) && rnc.tipoFalha === item.nome);
                if (vinculado) return 'Não é possível excluir: modo de falha vinculado a RNC ativa.';
            }
            if (tipo === 'clientes') {
                const vinculado = state.rncs.some(rnc => isRNCAtiva(rnc) && rnc.cliente === item.nome);
                if (vinculado) return 'Não é possível excluir: cliente vinculado a RNC ativa.';
            }
            return null;
        }

        function propagarRenomeacaoCadastro(tipo, nomeAnterior, nomeNovo) {
            if (!nomeAnterior || nomeAnterior === nomeNovo) return;
            if (tipo === 'pessoas') {
                state.rncs.forEach(rnc => {
                    if (rnc.responsavel === nomeAnterior) rnc.responsavel = nomeNovo;
                    if (rnc.d1?.lider === nomeAnterior) rnc.d1.lider = nomeNovo;
                    if (rnc.d1?.equipe) {
                        rnc.d1.equipe = rnc.d1.equipe
                            .split(',')
                            .map(nome => nome.trim() === nomeAnterior ? nomeNovo : nome.trim())
                            .join(', ');
                    }
                    (rnc.d5?.listaAcoes || []).forEach(acao => {
                        if (acao.responsavel === nomeAnterior) acao.responsavel = nomeNovo;
                    });
                });
            } else if (tipo === 'modos-falha') {
                state.rncs.forEach(rnc => {
                    if (rnc.tipoFalha === nomeAnterior) rnc.tipoFalha = nomeNovo;
                });
            } else if (tipo === 'clientes') {
                state.rncs.forEach(rnc => {
                    if (rnc.cliente === nomeAnterior) rnc.cliente = nomeNovo;
                });
            }
        }

        function abrirModalListagemCadastro(tipo) {
            const config = getCadastroConfig(tipo);
            const lista = getCadastroLista(tipo);
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1002';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 1200px; width: 95vw;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">Gerenciar ${config.titulo}</h2>
                            <p style="color:#64748b; margin-top:0.5rem;">${config.descricao}</p>
                        </div>
                        <button class="modal-close" data-close-cadastro-lista>×</button>
                    </div>
                    <div class="modal-body">
                        <div style="overflow:auto;">
                        <table>
                            <thead>
                                <tr>
                                    ${config.fields.map(field => `<th>${field.label}</th>`).join('')}
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lista.length === 0 ? `
                                    <tr><td colspan="${config.fields.length + 1}" style="text-align:center; color:#64748b;">Nenhum item cadastrado.</td></tr>
                                ` : lista.map(item => `
                                    <tr>
                                        ${config.fields.map(field => {
                                            if (field.isImage) {
                                                return `<td>${item.fotoConteudo ? `<img src="${item.fotoConteudo}" alt="${escapeHtml(item.nome)}" style="width:48px; height:48px; object-fit:cover; border-radius:8px; border:1px solid #e2e8f0;">` : '<span style="color:#94a3b8;">Sem foto</span>'}</td>`;
                                            }
                                            return `<td>${escapeHtml(item[field.key] || '')}</td>`;
                                        }).join('')}
                                        <td style="display:flex; gap:0.5rem;">
                                            <button type="button" class="btn btn-secondary btn-editar-cadastro-item" data-cadastro-tipo="${tipo}" data-item-id="${item.id}" style="padding:0.4rem 0.75rem; font-size:0.8rem;">Editar</button>
                                            <button type="button" class="btn btn-warning btn-excluir-cadastro-item" data-cadastro-tipo="${tipo}" data-item-id="${item.id}" style="padding:0.4rem 0.75rem; font-size:0.8rem;">Excluir</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        </div>
                        <div style="margin-top:1rem; display:flex; justify-content:flex-end;">
                            <button type="button" class="btn btn-primary btn-novo-cadastro-item" data-cadastro-tipo="${tipo}">Novo Cadastro</button>
                        </div>
                    </div>
                </div>
            `;
            overlay.onclick = (e) => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);

            overlay.querySelector('[data-close-cadastro-lista]').onclick = () => overlay.remove();
            overlay.querySelector('.btn-novo-cadastro-item').onclick = () => abrirModalFormularioCadastro(tipo, null, overlay);
            overlay.querySelectorAll('.btn-editar-cadastro-item').forEach(btn => {
                btn.onclick = () => abrirModalFormularioCadastro(btn.dataset.cadastroTipo, btn.dataset.itemId, overlay);
            });
            overlay.querySelectorAll('.btn-excluir-cadastro-item').forEach(btn => {
                btn.onclick = () => {
                    const item = getCadastroItemById(btn.dataset.cadastroTipo, btn.dataset.itemId);
                    if (!item) return;
                    const bloqueio = bloqueioExclusaoCadastro(btn.dataset.cadastroTipo, item);
                    if (bloqueio) {
                        alert(bloqueio);
                        return;
                    }
                    if (!confirm(`Deseja excluir "${item.nome}"?`)) return;
                    const listaBase = getCadastroLista(btn.dataset.cadastroTipo);
                    const idx = listaBase.findIndex(x => x.id === item.id);
                    if (idx !== -1) listaBase.splice(idx, 1);
                    overlay.remove();
                    abrirModalListagemCadastro(btn.dataset.cadastroTipo);
                    render();
                };
            });
        }

        function abrirModalFormularioCadastro(tipo, itemId, parentOverlay) {
            const config = getCadastroConfig(tipo);
            const item = itemId ? getCadastroItemById(tipo, itemId) : null;
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1003';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 720px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">${item ? 'Editar' : 'Novo'} ${config.titulo}</h2>
                        </div>
                        <button class="modal-close" data-close-cadastro-form>×</button>
                    </div>
                    <div class="modal-body">
                        <form id="cadastroItemForm">
                            ${config.fields.map(field => `
                                <div class="form-group">
                                    <label>${field.label} ${field.required ? '*' : ''}</label>
                                    ${field.type === 'file'
                                        ? `<input type="file" name="${field.key}" accept="image/*" ${field.required && !item?.fotoConteudo ? 'required' : ''}>`
                                        : `<input type="${field.type}" name="${field.key}" value="${escapeHtml(item?.[field.key] || '')}" ${field.required ? 'required' : ''}>`
                                    }
                                    ${field.isImage && item?.fotoConteudo ? `<div style="margin-top:0.5rem;"><img src="${item.fotoConteudo}" alt="${escapeHtml(item.nome)}" style="width:64px; height:64px; object-fit:cover; border-radius:8px; border:1px solid #e2e8f0;"></div>` : ''}
                                </div>
                            `).join('')}
                            <div style="display:flex; gap:0.75rem;">
                                <button type="button" class="btn btn-secondary" data-close-cadastro-form>Cancelar</button>
                                <button type="submit" class="btn btn-success">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            overlay.onclick = (e) => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);
            overlay.querySelectorAll('[data-close-cadastro-form]').forEach(btn => btn.onclick = () => overlay.remove());
            overlay.querySelector('#cadastroItemForm').onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const payload = {};
                config.fields.forEach(field => {
                    if (field.type !== 'file') payload[field.key] = String(formData.get(field.key) || '').trim();
                });
                const invalid = config.fields.some(field => field.required && field.type !== 'file' && !payload[field.key]);
                if (invalid) {
                    alert('Preencha todos os campos obrigatórios.');
                    return;
                }
                const listaBase = getCadastroLista(tipo);
                const fotoField = config.fields.find(field => field.type === 'file');
                if (fotoField) {
                    const fotoFile = formData.get(fotoField.key);
                    if (fotoFile && fotoFile.name) {
                        const base64 = await lerArquivoBase64(fotoFile, 'foto cliente');
                        if (!base64) {
                            alert('Não foi possível processar a foto. Tente novamente.');
                            return;
                        }
                        payload.fotoNome = fotoFile.name;
                        payload.fotoConteudo = base64;
                    } else if (fotoField.required && !item?.fotoConteudo) {
                        alert('A foto do cliente é obrigatória.');
                        return;
                    }
                }
                if (payload.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.email)) {
                    alert('Informe um e-mail válido.');
                    return;
                }
                if (payload.nome) {
                    const normalize = (nome) => String(nome || '').trim().replace(/\s+/g, ' ').toLowerCase();
                    const nomeJaExiste = listaBase.some(registro => registro.id !== item?.id && normalize(registro.nome) === normalize(payload.nome));
                    if (nomeJaExiste) {
                        alert('Já existe um cadastro com este nome.');
                        return;
                    }
                }
                if (item) {
                    const idx = listaBase.findIndex(x => x.id === item.id);
                    if (idx !== -1) {
                        const nomeAnterior = listaBase[idx].nome;
                        listaBase[idx] = { ...listaBase[idx], ...payload };
                        propagarRenomeacaoCadastro(tipo, nomeAnterior, listaBase[idx].nome);
                    }
                } else {
                    const nextId = getNextId(listaBase);
                    listaBase.push({ id: nextId, ...payload });
                }
                overlay.remove();
                if (parentOverlay) parentOverlay.remove();
                abrirModalListagemCadastro(tipo);
                render();
            };
        }

        async function carregarRNCsDoFirebase() {
            if (!db) return;

            try {
                const snapshot = await db.collection('rncs').get();
                if (snapshot.empty) return;

                state.rncs = snapshot.docs
                    .map(doc => {
                        const numericId = Number(doc.id);
                        const data = doc.data();
                        const id = Number.isFinite(numericId) ? numericId : data.id;
                        if (!Number.isFinite(id)) {
                            console.warn('RNC ignorada por ID inválido no Firebase:', doc.id, data.id);
                            return null;
                        }
                        return { ...data, id };
                    })
                    .filter(rnc => rnc && Number.isFinite(rnc.id))
                    .sort((a, b) => a.id - b.id);
            } catch (error) {
                console.warn('Falha ao carregar RNCs do Firebase:', error);
            }
        }

        function salvarRNCNoFirebase(rnc) {
            if (!db) {
                console.warn('Salvamento não executado. Firebase indisponível.');
                return Promise.resolve(false);
            }
            if (!rnc || !Number.isFinite(rnc.id)) {
                console.warn('Salvamento não executado. RNC inválida.');
                return Promise.resolve(false);
            }

            return db.collection('rncs')
                .doc(String(rnc.id))
                .set(rnc, { merge: true })
                .then(() => true)
                .catch(error => {
                    console.warn('Falha ao salvar RNC no Firebase:', error);
                    return false;
                });
        }

        function render() {
            const app = document.getElementById('app');
            state.rncs.forEach(rnc => sincronizarFluxo8D(rnc));
            
            if (state.currentPage === 'login') {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = `
                    ${renderSidebar()}
                    <div class="main-content">
                        ${renderTopBar()}
                        <div class="content-area">
                            ${state.currentPage === 'dashboard' ? renderDashboard() : ''}
                            ${state.currentPage === 'cadastro-rnc' ? renderCadastroRNC() : ''}
                            ${state.currentPage === 'cadastro-pessoas' ? renderCadastroPessoas() : ''}
                            ${state.currentPage === 'controle' ? renderControle() : ''}
                            ${state.currentPage === 'relatorios' ? renderRelatorios() : ''}
                        </div>
                    </div>
                    ${renderModal()}
                    ${renderPerfilModal()}
                    ${renderExportAnaliticoModal()}
                `;
            }
            
            attachEventListeners();
        }

        function renderLogin() {
            return `
                <div class="login-container">
                    <div class="login-box">
                        <div class="login-logo">8D</div>
                        <h1 style="font-size: 2rem; font-weight: 800; text-align: center; margin-bottom: 2rem;">Sistema RNC 8D</h1>
                        <form id="loginForm">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" value="debora@empresa.com" required>
                            </div>
                            <div class="form-group">
                                <label>Senha</label>
                                <input type="password" value="123" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Acessar</button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderSidebar() {
            return `
                <div class="sidebar">
                    <div class="sidebar-header">
                        <h2>MAGIUS • 8D</h2>
                    </div>
                    <div class="nav-menu">
                        <div class="nav-item ${state.currentPage === 'dashboard' ? 'active' : ''}" data-page="dashboard">
                            <span>Dashboard</span>
                        </div>
                        <div class="nav-item ${state.currentPage === 'controle' ? 'active' : ''}" data-page="controle">
                            <span>Controle 8D</span>
                            <span class="nav-badge">${state.rncs.filter(r => getStatusRncValue(r) === 'AT_RISK').length}</span>
                        </div>
                        <div class="nav-item ${state.currentPage === 'cadastro-rnc' ? 'active' : ''}" data-page="cadastro-rnc">
                            <span>Cadastro de RNC</span>
                        </div>
                        <div class="nav-item ${state.currentPage === 'cadastro-pessoas' ? 'active' : ''}" data-page="cadastro-pessoas">
                            <span>Cadastros Base</span>
                        </div>
                        <div class="nav-item ${state.currentPage === 'relatorios' ? 'active' : ''}" data-page="relatorios">
                            <span>Relatórios</span>
                        </div>
                        <div class="nav-item" data-page="logout" style="margin-top: 2rem; color: #ef4444;">
                            <span>Sair</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTopBar() {
            const alertas = state.rncs.filter(r => getStatusRncValue(r) === 'AT_RISK').length;
            return `
                <div class="top-bar">
                    <div class="top-brand">
                        <div class="top-logo">MAGIUS</div>
                        <div class="top-institutional">AJUDANDO A CONSTRUIR, CULTIVAR, TRANSPORTAR E SEGUIR EM FRENTE</div>
                    </div>
                    <div class="top-bar-actions">
                        <button class="notification-btn" type="button" title="Notificações">
                            ${renderIcon('bell')}
                            <span class="notification-badge">${alertas}</span>
                        </button>
                        <div class="top-user" id="abrirPerfilModal" role="button" tabindex="0" title="Perfil e segurança">
                            <div class="top-user-meta">
                                <div class="top-user-name">${escapeHtml(state.currentUser.name)}</div>
                                <div class="top-user-role">${escapeHtml(state.currentUser.role)} • ${escapeHtml(state.currentUser.planta || 'Matriz')}</div>
                            </div>
                            <div class="user-avatar" style="width: 38px; height: 38px; margin: 0; font-size: 0.9rem;">${state.currentUser.initials}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPerfilModal() {
            if (!state.perfilModalAberto || !state.currentUser) return '';
            return `
                <div class="modal-overlay active" id="perfilModal">
                    <div class="modal-content" style="max-width: 620px;">
                        <div class="modal-header">
                            <div>
                                <h2 class="modal-title">Perfil do Usuário</h2>
                                <p style="color:#64748b; margin-top:0.4rem;">Gerencie seus dados e segurança sem sair da tela atual.</p>
                            </div>
                            <button class="modal-close" id="fecharPerfilModal">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="modal-tabs">
                                <button type="button" class="modal-tab profile-modal-tab ${state.perfilAbaAtiva === 'perfil' ? 'active' : ''}" data-perfil-tab="perfil">Perfil</button>
                                <button type="button" class="modal-tab profile-modal-tab ${state.perfilAbaAtiva === 'seguranca' ? 'active' : ''}" data-perfil-tab="seguranca">Segurança / Senha</button>
                            </div>
                            <div class="tab-content ${state.perfilAbaAtiva === 'perfil' ? 'active' : ''}">
                                <div class="card" style="margin-bottom:0;">
                                    <p><strong>Nome:</strong> ${escapeHtml(state.currentUser.name)}</p>
                                    <p style="margin-top:0.5rem;"><strong>Cargo:</strong> ${escapeHtml(state.currentUser.role)}</p>
                                    <p style="margin-top:0.5rem;"><strong>Planta:</strong> ${escapeHtml(state.currentUser.planta || 'Matriz')}</p>
                                    <p style="margin-top:0.5rem;"><strong>E-mail:</strong> ${escapeHtml(state.currentUser.email || '-')}</p>
                                </div>
                            </div>
                            <div class="tab-content ${state.perfilAbaAtiva === 'seguranca' ? 'active' : ''}">
                                <form id="segurancaSenhaForm">
                                    <div class="form-group">
                                        <label>Senha atual</label>
                                        <input type="password" name="senhaAtual" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Nova senha</label>
                                        <input type="password" name="novaSenha" minlength="8" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Confirmar nova senha</label>
                                        <input type="password" name="confirmarNovaSenha" minlength="8" required>
                                    </div>
                                    <p id="segurancaSenhaMsg" style="font-size:0.875rem; margin-bottom:0.75rem; color:#64748b;"></p>
                                    <button type="submit" class="btn btn-primary">Atualizar senha</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderExportAnaliticoModal() {
            if (!state.exportModalAberto) return '';
            const selected = state.exportAnalisesSelecionadas || {};
            const mk = (key, label) => `
                <label style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
                    <input type="checkbox" data-export-key="${key}" ${selected[key] ? 'checked' : ''}>
                    <span>${label}</span>
                </label>
            `;
            return `
                <div class="modal-overlay active" id="exportAnaliticoModal">
                    <div class="modal-content" style="max-width:780px;">
                        <div class="modal-header">
                            <div>
                                <h2 class="modal-title">Exportações Analíticas – Relatórios 8D (Excel)</h2>
                                <p style="color:#64748b; margin-top:0.4rem;">Selecione quais análises gerar para a competência ${String(Number(state.dashboardFilterMonth) + 1).padStart(2, '0')}/${state.dashboardFilterYear}.</p>
                            </div>
                            <button class="modal-close" id="fecharExportAnaliticoModal">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="grid-2">
                                <div class="card" style="margin-bottom:0;">
                                    <h4 style="font-size:1rem; font-weight:700; margin-bottom:0.75rem;">Análises Gerais da RNC</h4>
                                    ${mk('resumoGeral', 'Resumo Geral das RNCs')}
                                    ${mk('volumePecasImpactadas', 'Volume de Peças Impactadas')}
                                    ${mk('statusPrioridade', 'Status e Prioridade')}
                                </div>
                                <div class="card" style="margin-bottom:0;">
                                    <h4 style="font-size:1rem; font-weight:700; margin-bottom:0.75rem;">Análise de Tempo</h4>
                                    ${mk('tempoPorFase', 'Tempo por Fase (D1 a D8)')}
                                    ${mk('leadTimeTotal', 'Lead Time Total (D1 → D8)')}
                                    ${mk('tempoMedioPorFase', 'Tempo médio por fase')}
                                    ${mk('tempoAtrasoPorFase', 'Tempo em atraso por fase')}
                                </div>
                                <div class="card" style="margin-bottom:0;">
                                    <h4 style="font-size:1rem; font-weight:700; margin-bottom:0.75rem;">Prazo e Re-prazo</h4>
                                    ${mk('numeroReprazosPorRnc', 'Número de Re-prazos por RNC')}
                                    ${mk('primeiroPrazoUltimoPrazo', 'Data do primeiro prazo x último prazo')}
                                    ${mk('diasAdicionadosReprazo', 'Dias adicionados por re-prazo')}
                                    ${mk('rncsComReprazo', 'RNCs com re-prazo (Sim/Não)')}
                                </div>
                                <div class="card" style="margin-bottom:0;">
                                    <h4 style="font-size:1rem; font-weight:700; margin-bottom:0.75rem;">Análise de Ações</h4>
                                    ${mk('qtdAcoesCorretivas', 'Quantidade de ações corretivas por RNC')}
                                    ${mk('qtdAcoesPreventivas', 'Quantidade de ações preventivas por RNC')}
                                    ${mk('tempoMedioImplementacaoAcoes', 'Tempo médio de implementação das ações')}
                                    ${mk('acoesNoPrazoForaPrazo', 'Ações concluídas no prazo x fora do prazo')}
                                </div>
                                <div class="card" style="margin-bottom:0;">
                                    <h4 style="font-size:1rem; font-weight:700; margin-bottom:0.75rem;">Contenção e Volume</h4>
                                    ${mk('quantidadeTotalPecas', 'Quantidade total de peças impactadas')}
                                    ${mk('quantidadeInspecionada', 'Quantidade inspecionada')}
                                    ${mk('quantidadeNaoConforme', 'Quantidade não conforme')}
                                    ${mk('percentualNaoConforme', '% de peças não conformes')}
                                </div>
                                <div class="card" style="margin-bottom:0;">
                                    <h4 style="font-size:1rem; font-weight:700; margin-bottom:0.75rem;">Performance do Sistema</h4>
                                    ${mk('taxaRncsNoPrazo', 'Taxa de RNCs no prazo')}
                                    ${mk('taxaRncsEmRisco', 'Taxa de RNCs em risco')}
                                    ${mk('taxaReprazos', 'Taxa de re-prazos')}
                                    ${mk('rncsEncerradasPeriodo', 'RNCs encerradas no período')}
                                </div>
                            </div>
                            <div style="display:flex; justify-content:flex-end; gap:0.75rem; margin-top:1rem;">
                                <button type="button" class="btn btn-secondary" id="cancelarExportAnalitico">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="confirmarExportAnalitico">Gerar Excel Analítico</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const anosDisponiveis = [...new Set(state.rncs
                .map(r => new Date(r.dataAbertura).getFullYear())
                .filter(y => !Number.isNaN(y))
                .concat([new Date().getFullYear()]))].sort((a, b) => a - b);
            const rncsCompetencia = getDashboardCompetenciaRncs();
            const trendData = buildCompetenciaTrendData();

            // Cálculos de métricas básicas
            const total = rncsCompetencia.length;
            const noPrazo = rncsCompetencia.filter(r => getStatusRncValue(r) === "ON_TIME").length;
            const emRisco = rncsCompetencia.filter(r => getStatusRncValue(r) === "AT_RISK").length;
            
            // Cálculos Lean
            const taxaNoPrazo = total > 0 ? ((noPrazo / total) * 100).toFixed(1) : 0;
            const rncsComReprazo = rncsCompetencia.filter(r => {
                return Object.values(r.prazos).some(p => p.reprazo1 !== null || p.reprazo2 !== null);
            }).length;
            const taxaReprazo = total > 0 ? ((rncsComReprazo / total) * 100).toFixed(1) : 0;
            
            // Lead Time médio (simulado - dias desde abertura)
            const hoje = new Date('2026-02-14');
            const leadTimes = rncsCompetencia.map(r => {
                const abertura = new Date(r.dataAbertura);
                return Math.floor((hoje - abertura) / (1000 * 60 * 60 * 24));
            });
            const avgLeadTime = leadTimes.length > 0 ? 
                (leadTimes.reduce((a, b) => a + b, 0) / leadTimes.length).toFixed(1) : 0;
            
            // Comparação com mês anterior
            const prevTotal = historicalData.previousMonth.total;
            const totalTrend = total - prevTotal;
            const totalTrendPercent = prevTotal > 0 ? ((totalTrend / prevTotal) * 100).toFixed(0) : 0;
            const leadTimeTrend = avgLeadTime - historicalData.previousMonth.avgLeadTime;
            
            // Distribuição por setor
            const porSetor = {};
            rncsCompetencia.forEach(r => {
                porSetor[r.setor] = (porSetor[r.setor] || 0) + 1;
            });
            const setorData = Object.entries(porSetor).map(([setor, count]) => ({ setor, count }))
                .sort((a, b) => b.count - a.count);
            
            // Distribuição por tipo de falha
            const porTipo = {};
            rncsCompetencia.forEach(r => {
                porTipo[r.tipoFalha] = (porTipo[r.tipoFalha] || 0) + 1;
            });
            const tipoData = Object.entries(porTipo).map(([tipo, count]) => ({ tipo, count }))
                .sort((a, b) => b.count - a.count);
            
            // Tempo médio por fase (simulado)
            const tempoMedioPorFase = {
                'D1-D2': 0.5,
                'D2-D3': 1.2,
                'D3-D4': 3.5,
                'D4-D5': 2.8,
                'D5-D6': 4.2,
                'D6-D7': 5.5,
                'D7-D8': 1.5
            };

            const searchTerm = String(state.dashboardSearch || '').trim().toLowerCase();
            const listaFiltrada = rncsCompetencia.filter(rnc =>
                !searchTerm ||
                String(rnc.numero || '').toLowerCase().includes(searchTerm) ||
                String(rnc.cliente || '').toLowerCase().includes(searchTerm)
            );
            const pageSize = 5;
            const totalPages = Math.max(1, Math.ceil(listaFiltrada.length / pageSize));
            const currentPage = Math.min(state.dashboardPage, totalPages);
            state.dashboardPage = currentPage;
            const start = (currentPage - 1) * pageSize;
            const listaPaginada = listaFiltrada.slice(start, start + pageSize);
             
            return `
                <div class="dashboard-filter-bar">
                    <div class="form-group" style="margin-bottom:0;">
                        <label>Mês</label>
                        <select id="dashboardMonthFilter">
                            ${meses.map((mes, idx) => `<option value="${idx}" ${Number(state.dashboardFilterMonth) === idx ? 'selected' : ''}>${mes}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label>Ano</label>
                        <select id="dashboardYearFilter">
                            ${anosDisponiveis.map(ano => `<option value="${ano}" ${Number(state.dashboardFilterYear) === ano ? 'selected' : ''}>${ano}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <!-- Métricas Principais -->
                <div class="stats-grid">
                    <div class="stat-card fade-in-up stagger-1" data-filter="all">
                        <div class="stat-header">
                            <div class="stat-icon">${renderIcon('chart')}</div>
                        </div>
                        <div class="stat-label">Total de RNCs</div>
                        <div class="stat-value">${total}</div>
                        <div class="stat-trend ${totalTrend > 0 ? 'negative' : totalTrend < 0 ? 'positive' : 'neutral'}">
                            <span>${totalTrend > 0 ? '↗' : totalTrend < 0 ? '↘' : '→'} ${Math.abs(totalTrendPercent)}%</span>
                        </div>
                        <div class="stat-comparison">vs mês anterior (${prevTotal})</div>
                    </div>
                    
                    <div class="stat-card success fade-in-up stagger-2" data-filter="ON_TIME">
                        <div class="stat-header">
                            <div class="stat-icon">${renderIcon('check')}</div>
                        </div>
                        <div class="stat-label">No Prazo</div>
                        <div class="stat-value" style="color: #059669;">${noPrazo}</div>
                        <div class="stat-trend positive">
                            <span>${taxaNoPrazo}% do total</span>
                        </div>
                        <div class="stat-comparison">Meta: ≥ 80%</div>
                    </div>
                    
                    <div class="stat-card danger fade-in-up stagger-3" data-filter="AT_RISK">
                        <div class="stat-header">
                            <div class="stat-icon">${renderIcon('alert')}</div>
                        </div>
                        <div class="stat-label">Em Risco</div>
                        <div class="stat-value" style="color: #dc2626;">${emRisco}</div>
                        <div class="stat-trend ${emRisco > 2 ? 'negative' : 'positive'}">
                            <span>${total > 0 ? ((emRisco / total) * 100).toFixed(1) : '0.0'}% do total</span>
                        </div>
                        <div class="stat-comparison">Meta: ≤ 20%</div>
                    </div>
                    
                    <div class="stat-card fade-in-up stagger-4">
                        <div class="stat-header">
                            <div class="stat-icon">${renderIcon('time')}</div>
                        </div>
                        <div class="stat-label">Lead Time Médio</div>
                        <div class="stat-value" style="font-size: 2.25rem;">${avgLeadTime}<span style="font-size: 1rem; color: #64748b; font-weight: 600;"> dias</span></div>
                        <div class="stat-trend ${leadTimeTrend > 0 ? 'negative' : 'positive'}">
                            <span>${leadTimeTrend > 0 ? '↗' : '↘'} ${Math.abs(leadTimeTrend).toFixed(1)} dias</span>
                        </div>
                        <div class="stat-comparison">vs mês anterior</div>
                    </div>
                </div>
                
                <!-- Métricas Lean -->
                <div class="section-title" style="margin-top: 2rem;"><span class="section-title-icon">${renderIcon('metrics')}</span> Métricas Lean</div>
                <div class="lean-metrics-grid">
                    <div class="stat-card ${taxaNoPrazo >= 80 ? 'success' : taxaNoPrazo >= 60 ? 'warning' : 'danger'} fade-in-up">
                        <div class="stat-label">Taxa Resolução no Prazo</div>
                        <div class="stat-value" style="font-size: 2.5rem; color: ${taxaNoPrazo >= 80 ? '#059669' : taxaNoPrazo >= 60 ? '#f59e0b' : '#dc2626'};">${taxaNoPrazo}%</div>
                        <div class="stat-comparison">RNCs concluídas dentro do prazo</div>
                    </div>
                    
                    <div class="stat-card warning fade-in-up">
                        <div class="stat-label">Taxa de Re-prazos</div>
                        <div class="stat-value" style="font-size: 2.5rem; color: #f59e0b;">${taxaReprazo}%</div>
                        <div class="stat-comparison">${rncsComReprazo} de ${total} RNCs com reprazo</div>
                    </div>
                    
                    <div class="stat-card fade-in-up">
                        <div class="stat-label">Tempo Médio D1 → D8</div>
                        <div class="stat-value" style="font-size: 2.5rem;">15.2<span style="font-size: 1rem; color: #64748b; font-weight: 600;"> dias</span></div>
                        <div class="stat-comparison">Ciclo completo 8D</div>
                    </div>
                </div>
                
                <!-- Gráficos -->
                <div class="section-title" style="margin-top: 2rem;"><span class="section-title-icon">${renderIcon('analytics')}</span> Análises Visuais</div>
                <div class="charts-grid">
                    <!-- Gráfico RNCs por Setor -->
                    <div class="chart-card fade-in-up">
                        <div class="chart-title">RNCs por Setor</div>
                        <div class="bar-chart">
                            ${setorData.map(item => {
                                const percentage = (item.count / total) * 100;
                                return `
                                    <div class="bar-item">
                                        <div class="bar-label">${item.setor}</div>
                                        <div class="bar-container">
                                            <div class="bar-fill" style="width: ${percentage}%">
                                                ${item.count > 1 ? item.count : ''}
                                            </div>
                                        </div>
                                        <div class="bar-value">${item.count}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Gráfico Distribuição de Status -->
                    <div class="chart-card fade-in-up">
                        <div class="chart-title">Distribuição de Status</div>
                        <div class="donut-chart">
                            <div class="donut-container">
                                <svg class="donut-svg" width="200" height="200" viewBox="0 0 200 200">
                                    ${renderDonutChart(noPrazo, emRisco)}
                                </svg>
                                <div class="donut-center">
                                    <div class="donut-total">${total}</div>
                                    <div class="donut-label-text">RNCs</div>
                                </div>
                            </div>
                            <div class="donut-legend">
                                <div class="donut-legend-item">
                                    <div class="donut-color" style="background: #10b981;"></div>
                                    <div class="donut-legend-label">No Prazo</div>
                                    <div class="donut-legend-value">${noPrazo}</div>
                                </div>
                                <div class="donut-legend-item">
                                    <div class="donut-color" style="background: #ef4444;"></div>
                                    <div class="donut-legend-label">Em Risco</div>
                                    <div class="donut-legend-value">${emRisco}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gráfico RNCs por Tipo de Falha -->
                    <div class="chart-card fade-in-up">
                        <div class="chart-title">RNCs por Tipo de Falha</div>
                        <div class="bar-chart">
                            ${tipoData.map(item => {
                                const percentage = (item.count / total) * 100;
                                return `
                                    <div class="bar-item">
                                        <div class="bar-label">${item.tipo}</div>
                                        <div class="bar-container">
                                            <div class="bar-fill" style="width: ${percentage}%; background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);">
                                                ${item.count > 1 ? item.count : ''}
                                            </div>
                                        </div>
                                        <div class="bar-value">${item.count}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Gráfico Tendência Mensal -->
                    <div class="chart-card fade-in-up">
                        <div class="chart-title">Tendência de RNCs (Últimos 6 Meses)</div>
                        <div class="line-chart">
                            <svg class="line-chart-svg" viewBox="0 0 100 50">
                                ${renderLineChart(trendData)}
                            </svg>
                        </div>
                        <div class="line-chart-labels">
                            ${trendData.map(m => `
                                <span class="line-chart-label">${m.month}</span>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Tabela de RNCs -->
                <div class="section-title" style="margin-top: 2rem;"><span class="section-title-icon">${renderIcon('list')}</span> Lista de RNCs</div>
                <div class="card fade-in-up">
                    <div class="dashboard-list-toolbar">
                        <input id="dashboardSearchInput" type="text" placeholder="Buscar por número ou cliente" value="${escapeHtml(state.dashboardSearch || '')}" style="max-width: 320px;">
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <button class="btn btn-secondary" id="dashboardPrevPage" ${currentPage <= 1 ? 'disabled' : ''}>Anterior</button>
                            <button class="btn btn-secondary" id="dashboardNextPage" ${currentPage >= totalPages ? 'disabled' : ''}>Próxima</button>
                            <span class="pagination-info">Página ${currentPage} de ${totalPages}</span>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Cliente</th>
                                <th>Tipo</th>
                                <th>Setor</th>
                                <th>Prioridade</th>
                                <th>Fase</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${listaPaginada.map(rnc => {
                                const statusRnc = getStatusRncValue(rnc);
                                return `
                                <tr class="rnc-row" data-rnc-id="${rnc.id}">
                                    <td style="font-weight: 700; color: #1e40af;">${rnc.numero}</td>
                                    <td>${rnc.cliente}</td>
                                    <td>${rnc.tipoFalha}</td>
                                    <td>${rnc.setor}</td>
                                    <td><span class="badge ${rnc.prioridade === 'Alta' ? 'red' : 'orange'}">${rnc.prioridade}</span></td>
                                    <td><span class="badge blue">${phases.find(p => p.id === rnc.faseAtual).name}</span></td>
                                    <td><span class="badge ${statusRnc === 'ON_TIME' ? 'green' : 'red'}">${statusRnc === 'ON_TIME' ? 'No Prazo' : 'Em Risco'}</span></td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Função auxiliar para renderizar gráfico donut
        function renderDonutChart(onTime, atRisk) {
            const total = onTime + atRisk;
            if (total === 0) return '';
            
            const radius = 80;
            const circumference = 2 * Math.PI * radius;
            const onTimePercent = onTime / total;
            const atRiskPercent = atRisk / total;
            
            const onTimeStroke = circumference * onTimePercent;
            const atRiskStroke = circumference * atRiskPercent;
            
            return `
                <circle cx="100" cy="100" r="${radius}" fill="none" stroke="#f1f5f9" stroke-width="30"/>
                <circle cx="100" cy="100" r="${radius}" fill="none" stroke="#10b981" stroke-width="30"
                    stroke-dasharray="${onTimeStroke} ${circumference}"
                    stroke-dashoffset="0"
                    style="transition: stroke-dasharray 1s ease;"/>
                <circle cx="100" cy="100" r="${radius}" fill="none" stroke="#ef4444" stroke-width="30"
                    stroke-dasharray="${atRiskStroke} ${circumference}"
                    stroke-dashoffset="${-onTimeStroke}"
                    style="transition: stroke-dasharray 1s ease;"/>
            `;
        }
        
        // Função auxiliar para renderizar gráfico de linha
        function renderLineChart(data) {
            if (!data.length) return '';
            const maxCount = Math.max(1, ...data.map(d => d.count || 0));
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * 100;
                const y = 45 - ((d.count / maxCount) * 35);
                return `${x},${y}`;
            }).join(' ');
            
            const area = `0,45 ${points} 100,45`;
            
            return `
                <defs>
                    <linearGradient id="lineGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3" />
                        <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0.05" />
                    </linearGradient>
                </defs>
                <polygon points="${area}" fill="url(#lineGradient)" />
                <polyline points="${points}" fill="none" stroke="#3b82f6" stroke-width="2" />
                ${data.map((d, i) => {
                    const x = (i / (data.length - 1)) * 100;
                    const y = 45 - ((d.count / maxCount) * 35);
                    return `<circle cx="${x}" cy="${y}" r="2" fill="#1e40af" />`;
                }).join('')}
            `;
        }

        function renderCadastroRNC() {
            return `
                <h1 class="page-title">Cadastro de RNC</h1>
                <div class="card">
                    <h3 style="font-size: 1.125rem; font-weight: 800; margin-bottom: 1.25rem;">Cadastro de RNC</h3>
                    <form id="cadastroRncForm">
                        <div class="form-group" style="padding:0.8rem; border:1px solid #bfdbfe; border-radius:8px; background:#eff6ff; margin-bottom:1rem;">
                            <label>Número da RNC *</label>
                            <input type="text" name="numeroRnc" id="numeroRncInput" placeholder="Ex.: RNC-2026-001" required>
                            <p id="numeroRncValidacao" aria-live="polite" style="font-size: 0.8125rem; color: #dc2626; margin-top: 0.45rem; display:none;"></p>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Cliente</label>
                                <select name="cliente" required>
                                    <option value="">Selecione</option>
                                    ${clientesBase.map(cliente => `<option value="${escapeHtml(cliente.nome)}">${escapeHtml(cliente.nome)}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Código da Peça</label>
                                <input type="text" name="codigoPeca" required>
                            </div>
                            <div class="form-group">
                                <label>Tipo de Falha</label>
                                <select name="tipoFalha" required>
                                    <option value="">Selecione</option>
                                    ${modosFalhaBase.map(modo => `<option value="${escapeHtml(modo.nome)}">${escapeHtml(modo.nome)}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Setor</label>
                                <select name="setor" required>
                                    <option value="">Selecione</option>
                                    <option value="Usinagem">Usinagem</option>
                                    <option value="Pintura">Pintura</option>
                                    <option value="Montagem">Montagem</option>
                                    <option value="Acabamento">Acabamento</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Prioridade</label>
                                <select name="prioridade" required>
                                    <option value="">Selecione</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Média">Média</option>
                                    <option value="Baixa">Baixa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Quantidade</label>
                                <input type="number" name="quantidade" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Analista de Engenharia</label>
                                <select name="analistaEngenhariaId" required>
                                    <option value="">Selecione</option>
                                    ${getPessoasOptions()}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Analista da Qualidade</label>
                                <select name="analistaQualidadeId" required>
                                    <option value="">Selecione</option>
                                    ${getPessoasOptions()}
                                </select>
                                <p style="font-size: 0.75rem; color: #1d4ed8; margin-top: 0.5rem;">Regra automática: o Analista da Qualidade será o Líder da Equipe 8D.</p>
                            </div>
                            <div class="form-group">
                                <label>Responsável da Contenção</label>
                                <select name="responsavelContencaoId" required>
                                    <option value="">Selecione</option>
                                    ${getPessoasOptions()}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Outros Envolvidos</label>
                                <div style="display:flex; gap:0.5rem; align-items:center;">
                                    <select id="outrosEnvolvidosSelect" aria-label="Selecione outros envolvidos da RNC">
                                        <option value="">Selecione</option>
                                        ${getPessoasOptions()}
                                    </select>
                                    <button type="button" class="btn btn-secondary" id="adicionarOutroEnvolvidoBtn">Adicionar</button>
                                </div>
                                <input type="hidden" name="outrosEnvolvidosIds" id="outrosEnvolvidosIds" value="">
                                <div id="outrosEnvolvidosSelecionados" style="margin-top:0.6rem; display:flex; flex-wrap:wrap; gap:0.4rem;"></div>
                                <p id="outrosEnvolvidosHint" style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">Selecione um nome e clique em adicionar. Você pode remover depois.</p>
                            </div>
                            <div class="form-group">
                                <label>Foto da Peça Conforme</label>
                                <input type="file" name="fotoConforme" accept="image/*" required>
                            </div>
                            <div class="form-group">
                                <label>Foto da Peça Não Conforme</label>
                                <input type="file" name="fotoNaoConforme" accept="image/*" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Descrição da Não Conformidade</label>
                            <textarea rows="3" name="descricao" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" id="cadastroRncSubmitBtn">Cadastrar RNC</button>
                    </form>
                </div>
            `;
        }

        function renderCadastroPessoas() {
            return `
                <h1 class="page-title">Cadastros Base</h1>
                <div class="stats-grid">
                    ${['pessoas', 'modos-falha', 'clientes'].map(tipo => {
                        const config = getCadastroConfig(tipo);
                        const total = getCadastroLista(tipo).length;
                        return `
                            <div class="card">
                                <h3 style="font-size: 1.1rem; font-weight: 800; margin-bottom: 0.5rem;">${config.titulo}</h3>
                                <p style="color:#64748b; margin-bottom: 1rem;">${config.descricao}</p>
                                <p style="font-size:0.875rem; color:#475569; margin-bottom: 1rem;">Itens cadastrados: <strong>${total}</strong></p>
                                <button type="button" class="btn btn-primary btn-gerenciar-cadastro" data-cadastro-tipo="${tipo}">Gerenciar</button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderControle() {
            return `
                <h1 class="page-title">Controle 8D</h1>
                <div class="card">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Filtrar por Status</label>
                            <select id="controleFiltroStatus">
                                <option value="">Todos</option>
                                <option value="ON_TIME">No Prazo</option>
                                <option value="AT_RISK">Em Risco</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filtrar por Setor</label>
                            <select id="controleFiltroSetor">
                                <option value="">Todos</option>
                                ${[...new Set(state.rncs.map(r => r.setor))].map(setor => `<option value="${escapeHtml(setor)}">${escapeHtml(setor)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status de Conclusão</label>
                            <select id="controleFiltroConclusao">
                                <option value="">Todos</option>
                                <option value="CONCLUIDO">Concluído</option>
                                <option value="EM_ANDAMENTO">Em andamento</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Situação de Etapas</label>
                            <select id="controleFiltroEtapas">
                                <option value="">Todos</option>
                                <option value="SEM_ATRASO">Sem atraso</option>
                                <option value="COM_ATRASO">Com atraso</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Buscar por número ou cliente</label>
                        <input type="text" id="controleFiltroBusca" placeholder="Ex.: RNC-2026-001 ou nome do cliente">
                    </div>
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Cliente</th>
                                <th>Responsável</th>
                                <th>Fase Atual</th>
                                <th>Status Conclusão</th>
                                <th>Status Etapas</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.rncs.map(rnc => {
                                const statusConclusao = getStatusConclusao8D(rnc);
                                const statusEtapas = getStatusEtapas8D(rnc);
                                const responsavel = getResponsavelRNC(rnc);
                                const statusRnc = getStatusRncValue(rnc);
                                return `
                                <tr class="controle-row" data-status="${statusRnc}" data-conclusao="${statusConclusao.value}" data-etapas="${statusEtapas.value}" data-setor="${encodeURIComponent(rnc.setor)}">
                                    <td style="font-weight: 700; color: #1e40af;">${rnc.numero}</td>
                                    <td>${rnc.cliente}</td>
                                    <td>${escapeHtml(responsavel)}</td>
                                    <td><span class="badge blue">${phases.find(p => p.id === rnc.faseAtual).name}</span></td>
                                    <td><span class="badge ${statusConclusao.className}">${statusConclusao.label}</span></td>
                                    <td><span class="badge ${statusEtapas.className}" title="${escapeHtml(statusEtapas.detalhe || '')}">${statusEtapas.label}</span></td>
                                    <td>
                                        <button class="btn btn-primary btn-view" data-rnc-id="${rnc.id}" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                            Ver Detalhes
                                        </button>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderRelatorios() {
            const total = state.rncs.length;
            const noPrazo = state.rncs.filter(r => getStatusRncValue(r) === 'ON_TIME').length;
            const emRisco = state.rncs.filter(r => getStatusRncValue(r) === 'AT_RISK').length;
            const taxaNoPrazo = total > 0 ? ((noPrazo / total) * 100).toFixed(1) : '0.0';

            return `
                <h1 class="page-title">Relatórios Qualificados</h1>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header"><div class="stat-icon">${renderIcon('report')}</div></div>
                        <div class="stat-label">Total Auditado</div>
                        <div class="stat-value">${total}</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-header"><div class="stat-icon">${renderIcon('check')}</div></div>
                        <div class="stat-label">Taxa no Prazo</div>
                        <div class="stat-value" style="color:#059669;">${taxaNoPrazo}%</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-header"><div class="stat-icon">${renderIcon('alert')}</div></div>
                        <div class="stat-label">Pendências Críticas</div>
                        <div class="stat-value" style="color:#dc2626;">${emRisco}</div>
                    </div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:flex-end; margin-bottom:0.75rem;">
                        <button type="button" class="btn btn-primary" id="abrirExportAnaliticoModal">Exportar Análises (Excel)</button>
                    </div>
                    <h3 class="section-title"><span class="section-title-icon">${renderIcon('analytics')}</span> Consolidado por Setor</h3>
                    <table>
                        <thead>
                            <tr><th>Setor</th><th>Quantidade</th><th>Em Risco</th><th>Taxa no Prazo</th></tr>
                        </thead>
                        <tbody>
                            ${Object.entries(state.rncs.reduce((acc, r) => {
                                acc[r.setor] = acc[r.setor] || { total: 0, risk: 0 };
                                acc[r.setor].total += 1;
                                if (getStatusRncValue(r) === 'AT_RISK') acc[r.setor].risk += 1;
                                return acc;
                            }, {})).map(([setor, dados]) => `
                                <tr>
                                    <td>${setor}</td>
                                    <td>${dados.total}</td>
                                    <td>${dados.risk}</td>
                                    <td>${dados.total > 0 ? ((((dados.total - dados.risk) / dados.total) * 100).toFixed(1)) : '0.0'}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderModal() {
            if (!state.selectedRNC) return '';
            
            const rnc = state.selectedRNC;
            sincronizarFluxo8D(rnc);
            if (!canAcessarEtapa(rnc, state.activeTab)) state.activeTab = rnc.faseAtual;
            const currentPhaseIndex = phases.findIndex(p => p.id === rnc.faseAtual);
            
            return `
                <div class="modal-overlay active" id="rncModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div>
                                <h2 class="modal-title">${rnc.numero} - ${rnc.cliente}</h2>
                                <p style="color: #64748b; margin-top: 0.5rem;">Metodologia 8D de Resolução de Problemas</p>
                            </div>
                            <button class="modal-close" id="closeModal">×</button>
                        </div>
                        
                        <div class="modal-body">
                            <div class="phase-tracker">
                                ${phases.map((phase, index) => `
                                    <div class="phase-step">
                                        <div class="phase-circle ${isEtapaConcluida(rnc, phase.id) ? 'completed' : index === currentPhaseIndex ? 'active' : ''}">
                                            ${isEtapaConcluida(rnc, phase.id) ? renderIcon('check') : phase.short}
                                        </div>
                                        <p style="font-size: 0.75rem; font-weight: 600; margin-top: 0.5rem;">${phase.name.replace(/D\d - /, '')}</p>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="modal-tabs">
                                ${phases.map(phase => `
                                    <button class="modal-tab rnc-phase-tab ${state.activeTab === phase.id ? 'active' : ''}" data-tab="${phase.id}" ${canAcessarEtapa(rnc, phase.id) ? '' : 'disabled'}>
                                        ${phase.name}
                                    </button>
                                `).join('')}
                            </div>
                            
                            ${phases.map(phase => `
                                <div class="tab-content ${state.activeTab === phase.id ? 'active' : ''}">
                                    ${renderPhaseContent(rnc, phase)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPhaseContent(rnc, phase) {
            const prazo = rnc.prazos[phase.id];
            const canReprazo = ['d3', 'd4'].includes(phase.id);
            
            let content = `
                <div class="d8-section ${rnc.faseAtual === phase.id ? 'active' : ''}">
                    <div class="d8-header">
                        <h3 class="d8-title">${phase.name}</h3>
                        <div class="prazo-info">
                            <div class="prazo-box original">
                                <div class="prazo-label">Prazo Original (${prazo.sla})</div>
                                <div class="prazo-date">${new Date(prazo.original).toLocaleDateString('pt-BR')}</div>
                            </div>
                            ${prazo.reprazo1 ? `
                                <div class="prazo-box reprazo1">
                                    <div class="prazo-label">Re-prazo 1</div>
                                    <div class="prazo-date">${new Date(prazo.reprazo1).toLocaleDateString('pt-BR')}</div>
                                </div>
                            ` : ''}
                            ${prazo.reprazo2 ? `
                                <div class="prazo-box reprazo2">
                                    <div class="prazo-label">Re-prazo 2</div>
                                    <div class="prazo-date">${new Date(prazo.reprazo2).toLocaleDateString('pt-BR')}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
            `;
            
            // Conteúdo específico de cada fase
            if (phase.id === 'd1') {
                const equipeD1 = montarEquipeD1(rnc);
                content += `
                    <div class="card" style="padding: 1rem; margin-top: 0.5rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Equipe da RNC</h4>
                        <table>
                            <thead>
                                <tr><th>Nome</th><th>Função na RNC</th><th>Setor</th><th>Planta</th></tr>
                            </thead>
                            <tbody>
                                ${equipeD1.length === 0 ? `
                                    <tr><td colspan="4" style="text-align:center; color:#64748b;">Equipe não definida no cadastro da RNC.</td></tr>
                                ` : equipeD1.map(item => `
                                    <tr>
                                        <td>${escapeHtml(item.pessoa.nome)}${item.funcaoRnc === 'Analista da Qualidade' ? ' <span class="badge blue" style="margin-left:0.35rem;">Líder da Equipe</span>' : ''}</td>
                                        <td>${escapeHtml(item.funcaoRnc)}</td>
                                        <td>${escapeHtml(item.pessoa.setor || '-')}</td>
                                        <td>${escapeHtml(item.pessoa.planta || '-')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.75rem;">A atualização dos dados da equipe deve ser feita na página "Cadastro de Pessoas".</p>
                    </div>
                `;
            } else if (phase.id === 'd2') {
                const fotoConformeSrc = getSafeImageSrc(rnc.fotosPeca?.conforme?.conteudo);
                const fotoNaoConformeSrc = getSafeImageSrc(rnc.fotosPeca?.naoConforme?.conteudo);
                content += `
                    <div class="card" style="padding:1rem; margin-top:0.5rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Dados do Cadastro da RNC</h4>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Cliente</label>
                                <input type="text" value="${escapeHtml(rnc.cliente || '')}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Modo de Falha</label>
                                <input type="text" value="${escapeHtml(rnc.tipoFalha || '')}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Quantidade de Peças</label>
                                <input type="text" value="${escapeHtml(rnc.quantidade ?? '')}" readonly>
                            </div>
                        </div>
                        <div class="d2-image-layout">
                            <div class="d2-image-card green">
                                ${fotoConformeSrc
                                    ? `<img src="${escapeHtml(fotoConformeSrc)}" alt="Peça conforme" class="d2-image-preview" data-image-src="${escapeHtml(fotoConformeSrc)}" data-image-title="Peça Conforme" role="button" tabindex="0">`
                                    : `<div class="d2-image-empty">Sem foto</div>`
                                }
                                <div class="d2-image-label">Peça Conforme</div>
                            </div>
                            <div class="d2-image-card red">
                                ${fotoNaoConformeSrc
                                    ? `<img src="${escapeHtml(fotoNaoConformeSrc)}" alt="Peça não conforme" class="d2-image-preview" data-image-src="${escapeHtml(fotoNaoConformeSrc)}" data-image-title="Peça Não Conforme" role="button" tabindex="0">`
                                    : `<div class="d2-image-empty">Sem foto</div>`
                                }
                                <div class="d2-image-label">Peça Não Conforme</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Definição do Problema</label>
                        <textarea rows="4" readonly>${escapeHtml(rnc.descricao || rnc.d2.problema || '')}</textarea>
                    </div>
                `;
            } else if (phase.id === 'd3') {
                content += `
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Quantidade de Peças em Estoque</label>
                            <input type="number" min="0" id="d3-estoque" value="${rnc.d3.quantidadeEstoque ?? ''}">
                        </div>
                        <div class="form-group">
                            <label>Quantidade de Peças Inspecionadas</label>
                            <input type="number" min="0" id="d3-inspecionada" value="${rnc.d3.quantidadeInspecionada ?? ''}">
                        </div>
                        <div class="form-group">
                            <label>Quantidade de Peças Não Conformes</label>
                            <input type="number" min="0" id="d3-nao-conforme" value="${rnc.d3.quantidadeNaoConforme ?? ''}">
                        </div>
                        <div class="form-group">
                            <label>Anexo – Alerta Assinado</label>
                            <input type="file" id="d3-alerta-arquivo" accept=".pdf,image/*">
                            ${rnc.d3.anexoAlertaAssinadoNome ? `
                                <div style="margin-top:0.5rem; display:flex; align-items:center; gap:0.5rem;">
                                    <span style="font-size:0.8125rem; color:#475569;">Anexo atual: ${escapeHtml(rnc.d3.anexoAlertaAssinadoNome)}</span>
                                    <button type="button" class="btn btn-secondary" style="padding:0.3rem 0.6rem; font-size:0.75rem;" onclick="removerAnexoD3()">Remover</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Evidências</label>
                        <input type="text" id="d3-evidencia" value="${rnc.d3.evidencia}">
                    </div>
                    <div id="d3-validacao-msg" class="prazo-justificativa" style="margin-bottom:1rem; display:none;"></div>
                    <button type="button" class="btn btn-primary" id="d3-etapa-concluida-btn" onclick="concluirEtapaD3()" disabled>Etapa Concluída</button>
                    ${prazo.reprazo1 ? `
                        <div class="prazo-justificativa">
                            <strong>Justificativa Re-prazo 1:</strong> ${prazo.just1}
                        </div>
                    ` : ''}
                    ${prazo.reprazo2 ? `
                        <div class="prazo-justificativa">
                            <strong>Justificativa Re-prazo 2:</strong> ${prazo.just2}
                        </div>
                    ` : ''}
                `;
            } else if (phase.id === 'd4') {
                ensureD4Structure(rnc);
                const d4 = rnc.d4;
                content += `
                    <div style="display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap;">
                        <button type="button" class="modal-tab d4-subtab ${state.activeD4SubTab === 'principal' ? 'active' : ''}" data-d4-subtab="principal">Principal</button>
                        <button type="button" class="modal-tab d4-subtab ${state.activeD4SubTab === 'ocorrencia' ? 'active' : ''}" data-d4-subtab="ocorrencia">Ocorrência</button>
                        <button type="button" class="modal-tab d4-subtab ${state.activeD4SubTab === 'deteccao' ? 'active' : ''}" data-d4-subtab="deteccao">Detecção</button>
                    </div>
                    ${state.activeD4SubTab === 'principal' ? `
                        <div class="form-group">
                            <label for="d4-causa-raiz-ocorrencia">Causa Raiz – Ocorrência</label>
                            <input type="text" id="d4-causa-raiz-ocorrencia" value="${escapeHtml(getUltimoPorquePreenchido(d4.ocorrencia))}" readonly>
                        </div>
                        <div class="form-group">
                            <label for="d4-causa-raiz-deteccao">Causa Raiz – Detecção</label>
                            <input type="text" id="d4-causa-raiz-deteccao" value="${escapeHtml(getUltimoPorquePreenchido(d4.deteccao))}" readonly>
                        </div>
                    ` : ''}
                    ${state.activeD4SubTab === 'ocorrencia' ? `
                        <h4 style="font-weight: 700; margin-bottom: 1rem;">Análise 5 Porquês - Ocorrência</h4>
                        ${[1,2,3,4,5].map(i => `
                            <div class="form-group">
                                <label>${i}º Por quê?</label>
                                <textarea rows="2" id="d4-oc-why${i}">${escapeHtml(d4.ocorrencia[`why${i}`] || '')}</textarea>
                            </div>
                        `).join('')}
                    ` : ''}
                    ${state.activeD4SubTab === 'deteccao' ? `
                        <h4 style="font-weight: 700; margin-bottom: 1rem;">Análise 5 Porquês - Detecção</h4>
                        ${[1,2,3,4,5].map(i => `
                            <div class="form-group">
                                <label>${i}º Por quê?</label>
                                <textarea rows="2" id="d4-det-why${i}">${escapeHtml(d4.deteccao[`why${i}`] || '')}</textarea>
                            </div>
                        `).join('')}
                    ` : ''}
                `;
            } else if (phase.id === 'd5') {
                const acoesD5 = rnc.d5.listaAcoes || [];
                content += `
                    <div style="display:flex; justify-content:flex-end; margin-bottom:1rem;">
                        <button type="button" class="btn btn-primary" onclick="abrirCadastroAcaoD5()">Cadastrar Ação</button>
                    </div>
                    <div class="card" style="padding: 1rem; margin-top: 1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Ações Cadastradas</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Descrição da Ação</th>
                                    <th>Responsável</th>
                                    <th>Prazo Original</th>
                                    <th>Último Re-prazo</th>
                                    <th>Status de Prazo</th>
                                    <th>Status da Ação</th>
                                    <th>Re-prazo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${acoesD5.length === 0 ? `
                                    <tr>
                                        <td colspan="8" style="text-align:center; color:#64748b;">Nenhuma ação cadastrada.</td>
                                    </tr>
                                ` : acoesD5.map(acao => {
                                    const acaoNormalizada = normalizeAcaoD5(acao);
                                    const indicador = obterIndicadorPrazoAcao(acaoNormalizada);
                                    const responsavelAcao = getPessoaById(acaoNormalizada.responsavelId)?.nome || acaoNormalizada.responsavel || '-';
                                    const ultimoReprazoData = acaoNormalizada.reprazos?.length ? acaoNormalizada.reprazos[acaoNormalizada.reprazos.length - 1]?.data : '';
                                    return `
                                        <tr>
                                            <td>${escapeHtml(acaoNormalizada.descricao || '')}</td>
                                            <td>${escapeHtml(responsavelAcao)}</td>
                                            <td>${formatDateSafe(acaoNormalizada.prazoPrincipal)}</td>
                                            <td>${ultimoReprazoData ? formatDateSafe(ultimoReprazoData) : '—'}</td>
                                            <td><span class="badge ${indicador.className === 'red' ? 'red' : (indicador.className === 'orange' ? 'orange' : 'green')}">${indicador.className === 'red' ? 'Em atraso' : (indicador.className === 'orange' ? 'Próximo ao vencimento' : 'Dentro do prazo')}</span></td>
                                            <td><span class="badge ${acaoNormalizada.status === 'CONCLUIDA' ? 'green' : 'orange'}">${acaoNormalizada.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto'}</span></td>
                                            <td>${acaoNormalizada.reprazos?.length ? `Sim / Nº ${acaoNormalizada.reprazos.length}` : 'Não'}</td>
                                            <td><button type="button" class="btn btn-secondary" style="padding:0.45rem 0.8rem; font-size:0.8125rem;" onclick="abrirCadastroAcaoD5('${acao.id}')">Editar</button></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (phase.id === 'd6') {
                const acoesD6 = (rnc.d5.listaAcoes || []).map(normalizeAcaoD5);
                content += `
                    <div class="card" style="padding:1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Ações para Implementação</h4>
                        ${acoesD6.length === 0 ? `
                            <div style="color:#64748b;">Nenhuma ação cadastrada no D5.</div>
                        ` : `
                            <div style="display:flex; flex-direction:column; gap:0.75rem;">
                                ${acoesD6.map(acao => {
                                    const prazoVigente = obterPrazoVigenteAcao(acao);
                                    const responsavelAcao = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
                                    return `
                                        <button type="button" class="btn btn-secondary" style="text-align:left; width:100%;" onclick="abrirImplementacaoAcaoD6('${acao.id}')">
                                            <strong>${escapeHtml(acao.descricao || 'Ação sem descrição')}</strong><br>
                                            <span style="font-size:0.8125rem; color:#475569;">Responsável: ${escapeHtml(responsavelAcao)} • Prazo vigente: ${formatDateSafe(prazoVigente)} • Status: ${acao.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto'}</span>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            } else if (phase.id === 'd7') {
                const acoesD7 = (rnc.d7.listaAcoes || []).map(normalizeAcaoD7);
                content += `
                    <div class="card" style="padding:1rem; margin-bottom:1rem;">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:0.75rem; margin-bottom:0.75rem;">
                            <h4 style="font-weight:700;">Ações Preventivas Cadastradas (Controle)</h4>
                            <button type="button" class="btn btn-primary" onclick="abrirCadastroAcaoD7()">Cadastrar Ação Preventiva</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Descrição da Ação Preventiva</th>
                                    <th>Responsável</th>
                                    <th>Origem da Prevenção</th>
                                    <th>Prazo Original</th>
                                    <th>Último Re-prazo</th>
                                    <th>Status de Prazo</th>
                                    <th>Status da Ação</th>
                                    <th>Re-prazo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${acoesD7.length === 0 ? `
                                    <tr><td colspan="9" style="text-align:center; color:#64748b;">Nenhuma ação preventiva cadastrada.</td></tr>
                                ` : acoesD7.map(acao => {
                                    const responsavelAcao = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
                                    const indicador = obterIndicadorPrazoAcao(acao);
                                    const ultimoReprazoData = acao.reprazos?.length ? acao.reprazos[acao.reprazos.length - 1]?.data : '';
                                    return `
                                        <tr>
                                            <td>${escapeHtml(acao.descricao || '')}</td>
                                            <td>${escapeHtml(responsavelAcao)}</td>
                                            <td>${escapeHtml(acao.origemPrevencao || '-')}</td>
                                            <td>${formatDateSafe(acao.prazoPrincipal)}</td>
                                            <td>${ultimoReprazoData ? formatDateSafe(ultimoReprazoData) : '—'}</td>
                                            <td><span class="badge ${indicador.className === 'red' ? 'red' : (indicador.className === 'orange' ? 'orange' : 'green')}">${indicador.className === 'red' ? 'Em atraso' : (indicador.className === 'orange' ? 'Próximo ao vencimento' : 'Dentro do prazo')}</span></td>
                                            <td><span class="badge ${acao.status === 'CONCLUIDA' ? 'green' : 'orange'}">${acao.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto'}</span></td>
                                            <td>${acao.reprazos?.length ? `Sim / Nº ${acao.reprazos.length}` : 'Não'}</td>
                                            <td><button type="button" class="btn btn-secondary" style="padding:0.45rem 0.8rem; font-size:0.8125rem;" onclick="abrirCadastroAcaoD7('${acao.id}')">Editar</button></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="card" style="padding:1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Implementação das Ações Preventivas</h4>
                        ${acoesD7.length === 0 ? `
                            <div style="color:#64748b;">Nenhuma ação preventiva para implementação.</div>
                        ` : `
                            <div style="display:flex; flex-direction:column; gap:0.75rem;">
                                ${acoesD7.map(acao => {
                                    const responsavelAcao = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
                                    const prazoVigente = obterPrazoVigenteAcao(acao);
                                    return `
                                        <button type="button" class="btn btn-secondary" style="text-align:left; width:100%;" onclick="abrirImplementacaoAcaoD7('${acao.id}')">
                                            <strong>${escapeHtml(acao.descricao || 'Ação preventiva sem descrição')}</strong><br>
                                            <span style="font-size:0.8125rem; color:#475569;">Responsável: ${escapeHtml(responsavelAcao)} • Prazo vigente: ${formatDateSafe(prazoVigente)} • Status: ${acao.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto'}</span>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            } else if (phase.id === 'd8') {
                ensureD8Structure(rnc);
                const equipeD1 = montarEquipeD1(rnc);
                const pendenciasD8 = getPendenciasConclusaoD8(rnc);
                const d8Readonly = rnc.d8.concluida ? 'readonly disabled' : '';
                const dataConclusaoD8 = /^\d{4}-\d{2}-\d{2}/.test(rnc.d8.dataConclusao || '') ? rnc.d8.dataConclusao.slice(0, 10) : '';
                content += `
                    <div class="card" style="padding:1rem; margin-bottom:1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Lições Aprendidas</h4>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Lições Aprendidas <span style="color:#dc2626;">*</span></label>
                            <textarea rows="4" id="d8-licao" ${d8Readonly}>${escapeHtml(rnc.d8.licaoAprendida || '')}</textarea>
                        </div>
                    </div>
                    <div class="card" style="padding:1rem; margin-bottom:1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Equipe Envolvida</h4>
                        <table>
                            <thead>
                                <tr><th>Nome</th><th>Função na RNC</th><th>Setor</th><th>Planta</th></tr>
                            </thead>
                            <tbody>
                                ${equipeD1.length === 0 ? `
                                    <tr><td colspan="4" style="text-align:center; color:#64748b;">Equipe não disponível.</td></tr>
                                ` : equipeD1.map(item => `
                                    <tr>
                                        <td>${escapeHtml(item.pessoa.nome)}</td>
                                        <td>${escapeHtml(item.funcaoRnc)}</td>
                                        <td>${escapeHtml(item.pessoa.setor || '-')}</td>
                                        <td>${escapeHtml(item.pessoa.planta || '-')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="card" style="padding:1rem; margin-bottom:1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Reconhecimento Individual</h4>
                        ${equipeD1.length === 0 ? `<div style="color:#64748b;">Sem membros para reconhecer.</div>` : equipeD1.map(item => {
                            const key = getEquipeMembroKey(item);
                            return `
                                <div class="form-group">
                                    <label>${escapeHtml(item.pessoa.nome)} (${escapeHtml(item.funcaoRnc)})</label>
                                    <textarea rows="2" id="d8-rec-${key}" ${d8Readonly}>${escapeHtml(rnc.d8.reconhecimentoIndividual?.[key] || '')}</textarea>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="card" style="padding:1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Agradecimento Final da Liderança</h4>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Mensagem Final de Agradecimento</label>
                            <textarea rows="3" id="d8-mensagem" ${d8Readonly}>${escapeHtml(rnc.d8.mensagemFinal || '')}</textarea>
                        </div>
                    </div>
                    <div style="margin-top:1rem;">
                        ${rnc.d8.concluida ? `
                            <div class="badge green" style="display:inline-flex;">8D encerrado em ${formatDateSafe(dataConclusaoD8)}</div>
                            <p style="margin-top:0.5rem; color:#64748b;">Registro disponível somente para consulta.</p>
                            <button type="button" class="btn btn-primary" style="margin-top:0.75rem;" onclick="gerarRelatorio8DPDF()">Gerar Relatório 8D (PDF)</button>
                        ` : `
                            ${pendenciasD8.length ? `<div class="prazo-justificativa" style="margin-bottom:0.75rem;"><strong>Pendências para concluir D8:</strong><ul style="padding-left:1.25rem; margin-top:0.5rem;">${pendenciasD8.map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ul></div>` : ''}
                            <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                                <button type="button" class="btn btn-secondary" onclick="salvarD8(false)">Salvar D8</button>
                                <button type="button" class="btn btn-success" onclick="salvarD8(true)" ${pendenciasD8.length ? 'disabled' : ''}>Concluir D8 e Encerrar 8D</button>
                            </div>
                        `}
                    </div>
                `;
            }
            
            content += `
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    ${!['d1', 'd2', 'd3', 'd5', 'd6', 'd7', 'd8'].includes(phase.id) ? `<button class="btn btn-success" onclick="salvarFase('${phase.id}')">Salvar ${phase.name}</button>` : ''}
                    ${canReprazo && !prazo.reprazo2 ? `
                        <button class="btn btn-warning" onclick="solicitarReprazo('${phase.id}', ${prazo.reprazo1 ? 2 : 1})">
                            Solicitar ${prazo.reprazo1 ? 'Re-prazo 2' : 'Re-prazo 1'}
                        </button>
                    ` : ''}
                </div>
            </div>
            `;
            
            return content;
        }

        function normalizeAcaoD5(acao) {
            if (!acao) return { id: '', descricao: '', prazoPrincipal: '', responsavelId: null, status: 'ABERTA', reprazos: [], evidencias: [], dataConclusao: '' };
            if (!Array.isArray(acao.reprazos)) {
                const reprazos = [];
                if (acao.reprazo1) reprazos.push({ numero: 1, data: acao.reprazo1, justificativa: acao.justificativaReprazo1 || '' });
                if (acao.reprazo2) reprazos.push({ numero: 2, data: acao.reprazo2, justificativa: acao.justificativaReprazo2 || '' });
                acao.reprazos = reprazos;
            }
            acao.evidencias = Array.isArray(acao.evidencias) ? acao.evidencias : [];
            return acao;
        }

        function normalizeAcaoD7(acao) {
            if (!acao) return { id: '', descricao: '', origemPrevencao: '', prazoPrincipal: '', responsavelId: null, status: 'ABERTA', reprazos: [], evidencias: [], dataConclusao: '' };
            if (!Array.isArray(acao.reprazos)) acao.reprazos = [];
            acao.evidencias = Array.isArray(acao.evidencias) ? acao.evidencias : [];
            return acao;
        }

        function obterPrazoVigenteAcao(acao) {
            const acaoNormalizada = normalizeAcaoD5(acao);
            const ultimoReprazo = acaoNormalizada.reprazos?.length ? acaoNormalizada.reprazos[acaoNormalizada.reprazos.length - 1]?.data : '';
            return ultimoReprazo || acaoNormalizada.prazoPrincipal || '';
        }

        function obterIndicadorPrazoAcao(acao) {
            const prazoVigente = obterPrazoVigenteAcao(acao);
            if (!prazoVigente) return { label: '-', className: 'blue' };
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const prazo = new Date(`${prazoVigente}T00:00:00`);
            if (hoje.getTime() < prazo.getTime()) return { label: 'No prazo', className: 'green' };
            if (hoje.getTime() === prazo.getTime()) return { label: 'A vencer', className: 'orange' };
            return { label: 'Em atraso', className: 'red' };
        }

        function validarCamposD3({ quantidadeEstoque, quantidadeInspecionada, quantidadeNaoConforme, anexoPresente }) {
            if (quantidadeEstoque === '' || quantidadeInspecionada === '' || quantidadeNaoConforme === '' || !anexoPresente) {
                return { valido: false, mensagem: 'Preencha todos os campos obrigatórios da contenção para concluir a etapa.' };
            }
            const estoque = Number(quantidadeEstoque);
            const inspecionada = Number(quantidadeInspecionada);
            const naoConforme = Number(quantidadeNaoConforme);
            if (inspecionada > estoque) {
                return { valido: false, mensagem: 'Quantidade inspecionada deve ser menor ou igual à quantidade em estoque.' };
            }
            if (naoConforme > inspecionada) {
                return { valido: false, mensagem: 'Quantidade não conforme deve ser menor ou igual à quantidade inspecionada.' };
            }
            return { valido: true, mensagem: 'Campos válidos. A etapa pode ser concluída.' };
        }

        function atualizarEstadoConclusaoD3() {
            const estoqueInput = document.getElementById('d3-estoque');
            const inspecionadaInput = document.getElementById('d3-inspecionada');
            const naoConformeInput = document.getElementById('d3-nao-conforme');
            const anexoInput = document.getElementById('d3-alerta-arquivo');
            const concluirBtn = document.getElementById('d3-etapa-concluida-btn');
            const msg = document.getElementById('d3-validacao-msg');
            if (!estoqueInput || !inspecionadaInput || !naoConformeInput || !anexoInput || !concluirBtn || !msg) {
                console.warn('Campos obrigatórios da D3 não encontrados para validação dinâmica.');
                return;
            }

            const anexoPresente = (anexoInput.files && anexoInput.files.length > 0) || !!state.selectedRNC?.d3?.anexoAlertaAssinadoNome;
            const validacao = validarCamposD3({
                quantidadeEstoque: estoqueInput.value,
                quantidadeInspecionada: inspecionadaInput.value,
                quantidadeNaoConforme: naoConformeInput.value,
                anexoPresente
            });

            const etapaConcluida = !!state.selectedRNC?.d3?.etapaConcluida;
            concluirBtn.disabled = etapaConcluida || !validacao.valido;
            if (!etapaConcluida && !validacao.valido) {
                msg.textContent = validacao.mensagem;
                msg.style.display = 'block';
            } else {
                msg.textContent = '';
                msg.style.display = 'none';
            }
        }

        function lerArquivoBase64(file, contexto = 'arquivo') {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result || '');
                reader.onerror = () => {
                    console.warn(`Falha ao converter ${contexto} para base64.`);
                    resolve(null);
                };
                reader.readAsDataURL(file);
            });
        }

        async function removerAnexoD3() {
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            state.rncs[rncIndex].d3.anexoAlertaAssinadoNome = '';
            state.rncs[rncIndex].d3.anexoAlertaAssinadoConteudo = '';
            state.rncs[rncIndex].d3.etapaConcluida = false;
            state.selectedRNC = state.rncs[rncIndex];
            await salvarRNCNoFirebase(state.selectedRNC);
            render();
        }

        async function concluirEtapaD3() {
            const estoqueInput = document.getElementById('d3-estoque');
            const inspecionadaInput = document.getElementById('d3-inspecionada');
            const naoConformeInput = document.getElementById('d3-nao-conforme');
            const anexoInput = document.getElementById('d3-alerta-arquivo');
            const anexoPresente = (anexoInput.files && anexoInput.files.length > 0) || !!state.selectedRNC?.d3?.anexoAlertaAssinadoNome;
            const validacao = validarCamposD3({
                quantidadeEstoque: estoqueInput.value,
                quantidadeInspecionada: inspecionadaInput.value,
                quantidadeNaoConforme: naoConformeInput.value,
                anexoPresente
            });
            if (!validacao.valido) {
                alert(validacao.mensagem);
                return;
            }
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            state.rncs[rncIndex].d3.quantidadeEstoque = estoqueInput.value;
            state.rncs[rncIndex].d3.quantidadeInspecionada = inspecionadaInput.value;
            state.rncs[rncIndex].d3.quantidadeNaoConforme = naoConformeInput.value;
            const evidenciaInput = document.getElementById('d3-evidencia');
            state.rncs[rncIndex].d3.evidencia = evidenciaInput ? evidenciaInput.value : state.rncs[rncIndex].d3.evidencia;
            if (anexoInput && anexoInput.files && anexoInput.files.length > 0) {
                const arquivo = anexoInput.files[0];
                const base64 = await lerArquivoBase64(arquivo, 'anexo D3');
                if (base64 === null) {
                    alert('Falha ao processar o anexo da D3. Tente novamente.');
                    return;
                }
                state.rncs[rncIndex].d3.anexoAlertaAssinadoNome = arquivo.name;
                state.rncs[rncIndex].d3.anexoAlertaAssinadoConteudo = base64;
            }
            state.rncs[rncIndex].d3.etapaConcluida = true;
            state.rncs[rncIndex].d3.dataConclusao = new Date().toISOString();
            const indiceFaseAtual = phases.findIndex(p => p.id === 'd3');
            const proximaFase = (indiceFaseAtual >= 0 && indiceFaseAtual < phases.length - 1) ? phases[indiceFaseAtual + 1] : null;
            if (proximaFase) {
                state.rncs[rncIndex].faseAtual = proximaFase.id;
                state.activeTab = proximaFase.id;
            }
            state.selectedRNC = state.rncs[rncIndex];
            const salvoNoFirebase = await salvarRNCNoFirebase(state.selectedRNC);
            alert(salvoNoFirebase ? 'Etapa D3 concluída com sucesso! Avançando para a próxima etapa.' : 'Etapa D3 concluída localmente. Firebase indisponível. Avançando para a próxima etapa.');
            render();
        }

        function abrirCadastroAcaoD5(acaoId = '') {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1002';
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            const acoes = state.rncs[rncIndex].d5.listaAcoes || [];
            const acaoExistente = acoes.find(acao => acao.id === acaoId);
            const dadosAcao = normalizeAcaoD5(acaoExistente || {});
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 760px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">${acaoExistente ? 'Editar Ação Corretiva' : 'Cadastrar Ação Corretiva'}</h2>
                            <p style="color:#64748b; margin-top:0.5rem;">Etapa D5 - Ações Corretivas</p>
                        </div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="d5AcaoForm">
                            <div class="form-group">
                                <label>Descrição da Ação</label>
                                <textarea id="d5-acao-descricao" rows="3" required>${escapeHtml(dadosAcao.descricao || '')}</textarea>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Prazo Principal</label>
                                    <input type="date" id="d5-acao-prazo-principal" value="${dadosAcao.prazoPrincipal || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Responsável</label>
                                    <select id="d5-acao-responsavel" required>
                                        <option value="">Selecione</option>
                                        ${pessoasBase.map(pessoa => `<option value="${pessoa.id}" ${Number(dadosAcao.responsavelId) === pessoa.id ? 'selected' : ''}>${escapeHtml(pessoa.nome)}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div style="display:flex; gap:1rem;">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
                                <button type="submit" class="btn btn-success">${acaoExistente ? 'Salvar Alterações' : 'Salvar Ação'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            overlay.onclick = (e) => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);

            document.getElementById('d5AcaoForm').onsubmit = async (e) => {
                e.preventDefault();
                state.rncs[rncIndex].d5.listaAcoes = state.rncs[rncIndex].d5.listaAcoes || [];
                const payload = {
                    id: acaoExistente?.id || `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                    descricao: document.getElementById('d5-acao-descricao').value,
                    prazoPrincipal: document.getElementById('d5-acao-prazo-principal').value,
                    responsavelId: Number(document.getElementById('d5-acao-responsavel').value),
                    status: acaoExistente?.status || 'ABERTA',
                    reprazos: acaoExistente?.reprazos || [],
                    evidencias: acaoExistente?.evidencias || [],
                    dataConclusao: acaoExistente?.dataConclusao || ''
                };
                const idxAcao = state.rncs[rncIndex].d5.listaAcoes.findIndex(acao => acao.id === payload.id);
                if (idxAcao >= 0) state.rncs[rncIndex].d5.listaAcoes[idxAcao] = payload;
                else state.rncs[rncIndex].d5.listaAcoes.push(payload);
                state.selectedRNC = state.rncs[rncIndex];
                sincronizarFluxo8D(state.selectedRNC);
                state.activeTab = state.selectedRNC.faseAtual;
                const salvoNoFirebase = await salvarRNCNoFirebase(state.selectedRNC);
                overlay.remove();
                render();
                alert(salvoNoFirebase ? 'Ação corretiva salva com sucesso!' : 'Ação salva localmente. Firebase indisponível.');
            };
        }

        function obterHistoricoReprazoHtml(acao) {
            const reprazos = normalizeAcaoD5(acao).reprazos || [];
            if (!reprazos.length) return '<div style="color:#64748b;">Sem re-prazo aplicado.</div>';
            return `<ul style="padding-left:1.25rem; color:#334155;">${reprazos.map(item => `<li>Nº ${item.numero}: ${formatDateSafe(item.data)} - ${escapeHtml(item.justificativa || '-')}</li>`).join('')}</ul>`;
        }

        function abrirImplementacaoAcaoD6(acaoId) {
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            const acoes = state.rncs[rncIndex].d5.listaAcoes || [];
            const acaoIndex = acoes.findIndex(acao => acao.id === acaoId);
            if (acaoIndex === -1) return;
            const acao = normalizeAcaoD5(acoes[acaoIndex]);
            const responsavelAcao = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1003';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 780px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h2 class="modal-title">Implementação da Ação</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="card" style="padding:1rem; margin-bottom:1rem;">
                            <h4 style="font-weight:700; margin-bottom:0.75rem;">Informações de Cadastro</h4>
                            <div><strong>Descrição:</strong> ${escapeHtml(acao.descricao || '-')}</div>
                            <div><strong>Responsável:</strong> ${escapeHtml(responsavelAcao)}</div>
                            <div><strong>Prazo Original:</strong> ${formatDateSafe(acao.prazoPrincipal)}</div>
                            <div style="margin-top:0.5rem;"><strong>Histórico de Re-prazo:</strong> ${obterHistoricoReprazoHtml(acao)}</div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Novo Re-prazo</label>
                                <input type="date" id="d6-acao-reprazo-data">
                            </div>
                            <div class="form-group">
                                <label>Justificativa do Re-prazo</label>
                                <input type="text" id="d6-acao-reprazo-just" placeholder="Obrigatória ao aplicar re-prazo">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Anexo de Evidências da Implementação</label>
                            <input type="file" id="d6-acao-evidencia-file" accept=".pdf,image/*">
                            ${acao.evidencias?.length ? `<div style="margin-top:0.5rem; color:#475569; font-size:0.8125rem;">Evidências anexadas: ${acao.evidencias.length}</div>` : ''}
                        </div>
                        <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                            <button type="button" class="btn btn-secondary" id="d6-salvar-acao-btn">Salvar Alterações</button>
                            <button type="button" class="btn btn-success" id="d6-concluir-acao-btn" ${acao.evidencias?.length ? '' : 'disabled'}>Concluir Ação</button>
                        </div>
                    </div>
                </div>
            `;
            overlay.onclick = (e) => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);

            const evidenciaInput = overlay.querySelector('#d6-acao-evidencia-file');
            const concluirBtn = overlay.querySelector('#d6-concluir-acao-btn');
            const atualizarEstadoConcluir = () => {
                concluirBtn.disabled = !(acao.evidencias?.length || evidenciaInput.files?.length);
            };
            evidenciaInput.onchange = atualizarEstadoConcluir;
            atualizarEstadoConcluir();

            const aplicarAtualizacoes = async () => {
                const reprazoData = overlay.querySelector('#d6-acao-reprazo-data').value;
                const reprazoJust = overlay.querySelector('#d6-acao-reprazo-just').value.trim();
                if (reprazoData && !reprazoJust) {
                    alert('Justificativa é obrigatória para aplicar re-prazo.');
                    return false;
                }
                if (reprazoData) {
                    const numero = (acao.reprazos?.length || 0) + 1;
                    acao.reprazos.push({ numero, data: reprazoData, justificativa: reprazoJust, dataRegistro: new Date().toISOString() });
                }
                if (evidenciaInput.files?.length) {
                    const arquivo = evidenciaInput.files[0];
                    const base64 = await lerArquivoBase64(arquivo, 'evidência da ação D6');
                    if (base64 === null) {
                        alert('Falha ao processar evidência. Tente novamente.');
                        return false;
                    }
                    acao.evidencias = acao.evidencias || [];
                    acao.evidencias.push({ nome: arquivo.name, conteudo: base64, data: new Date().toISOString() });
                }
                return true;
            };

            overlay.querySelector('#d6-salvar-acao-btn').onclick = async () => {
                const ok = await aplicarAtualizacoes();
                if (!ok) return;
                acoes[acaoIndex] = acao;
                state.selectedRNC = state.rncs[rncIndex];
                sincronizarFluxo8D(state.selectedRNC);
                await salvarRNCNoFirebase(state.selectedRNC);
                overlay.remove();
                render();
            };

            concluirBtn.onclick = async () => {
                if (!acao.evidencias?.length && !evidenciaInput.files?.length) {
                    alert('Anexe pelo menos uma evidência para concluir a ação.');
                    return;
                }
                const ok = await aplicarAtualizacoes();
                if (!ok) return;
                acao.status = 'CONCLUIDA';
                acao.dataConclusao = new Date().toISOString();
                acoes[acaoIndex] = acao;
                state.selectedRNC = state.rncs[rncIndex];
                sincronizarFluxo8D(state.selectedRNC);
                state.activeTab = state.selectedRNC.faseAtual;
                await salvarRNCNoFirebase(state.selectedRNC);
                overlay.remove();
                render();
            };
        }

        function abrirCadastroAcaoD7(acaoId = '') {
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            state.rncs[rncIndex].d7.listaAcoes = state.rncs[rncIndex].d7.listaAcoes || [];
            const acoes = state.rncs[rncIndex].d7.listaAcoes;
            const acaoExistente = acoes.find(acao => acao.id === acaoId);
            const dadosAcao = normalizeAcaoD7(acaoExistente || {});
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1002';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 760px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">${acaoExistente ? 'Editar Ação Preventiva' : 'Cadastrar Ação Preventiva'}</h2>
                            <p style="color:#64748b; margin-top:0.5rem;">Etapa D7 - Ações Preventivas</p>
                        </div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="d7AcaoForm">
                            <div class="form-group">
                                <label>Descrição da Ação Preventiva</label>
                                <textarea id="d7-acao-descricao" rows="3" required>${escapeHtml(dadosAcao.descricao || '')}</textarea>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Origem da Prevenção</label>
                                    <select id="d7-acao-origem" required>
                                        <option value="">Selecione</option>
                                        ${['Mesmo produto', 'Outro produto', 'Outro processo', 'Outra planta'].map(origem => `<option value="${origem}" ${dadosAcao.origemPrevencao === origem ? 'selected' : ''}>${origem}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Prazo Original</label>
                                    <input type="date" id="d7-acao-prazo-principal" value="${dadosAcao.prazoPrincipal || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Responsável</label>
                                    <select id="d7-acao-responsavel" required>
                                        <option value="">Selecione</option>
                                        ${pessoasBase.map(pessoa => `<option value="${pessoa.id}" ${Number(dadosAcao.responsavelId) === pessoa.id ? 'selected' : ''}>${escapeHtml(pessoa.nome)}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div style="display:flex; gap:1rem;">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
                                <button type="submit" class="btn btn-success">${acaoExistente ? 'Salvar Alterações' : 'Salvar Ação Preventiva'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            overlay.onclick = (e) => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);

            document.getElementById('d7AcaoForm').onsubmit = async (e) => {
                e.preventDefault();
                const payload = {
                    id: acaoExistente?.id || `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                    descricao: document.getElementById('d7-acao-descricao').value,
                    origemPrevencao: document.getElementById('d7-acao-origem').value,
                    prazoPrincipal: document.getElementById('d7-acao-prazo-principal').value,
                    responsavelId: Number(document.getElementById('d7-acao-responsavel').value),
                    status: acaoExistente?.status || 'ABERTA',
                    reprazos: acaoExistente?.reprazos || [],
                    evidencias: acaoExistente?.evidencias || [],
                    dataConclusao: acaoExistente?.dataConclusao || ''
                };
                const idxAcao = acoes.findIndex(acao => acao.id === payload.id);
                if (idxAcao >= 0) acoes[idxAcao] = payload;
                else acoes.push(payload);
                state.selectedRNC = state.rncs[rncIndex];
                sincronizarFluxo8D(state.selectedRNC);
                state.activeTab = state.selectedRNC.faseAtual;
                await salvarRNCNoFirebase(state.selectedRNC);
                overlay.remove();
                render();
            };
        }

        function obterHistoricoReprazoHtmlD7(acao) {
            const reprazos = normalizeAcaoD7(acao).reprazos || [];
            if (!reprazos.length) return '<div style="color:#64748b;">Sem re-prazo aplicado.</div>';
            return `<ul style="padding-left:1.25rem; color:#334155;">${reprazos.map(item => `<li>Nº ${item.numero}: ${formatDateSafe(item.data)} - ${escapeHtml(item.justificativa || '-')}</li>`).join('')}</ul>`;
        }

        function abrirImplementacaoAcaoD7(acaoId) {
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            state.rncs[rncIndex].d7.listaAcoes = state.rncs[rncIndex].d7.listaAcoes || [];
            const acoes = state.rncs[rncIndex].d7.listaAcoes;
            const acaoIndex = acoes.findIndex(acao => acao.id === acaoId);
            if (acaoIndex === -1) return;
            const acao = normalizeAcaoD7(acoes[acaoIndex]);
            const responsavelAcao = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1003';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 780px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h2 class="modal-title">Implementação da Ação Preventiva</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="card" style="padding:1rem; margin-bottom:1rem;">
                            <h4 style="font-weight:700; margin-bottom:0.75rem;">Informações de Cadastro</h4>
                            <div><strong>Descrição:</strong> ${escapeHtml(acao.descricao || '-')}</div>
                            <div><strong>Responsável:</strong> ${escapeHtml(responsavelAcao)}</div>
                            <div><strong>Origem da prevenção:</strong> ${escapeHtml(acao.origemPrevencao || '-')}</div>
                            <div><strong>Prazo Original:</strong> ${formatDateSafe(acao.prazoPrincipal)}</div>
                            <div style="margin-top:0.5rem;"><strong>Histórico de Re-prazo:</strong> ${obterHistoricoReprazoHtmlD7(acao)}</div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Novo Re-prazo</label>
                                <input type="date" id="d7-acao-reprazo-data">
                            </div>
                            <div class="form-group">
                                <label>Justificativa do Re-prazo</label>
                                <input type="text" id="d7-acao-reprazo-just" placeholder="Obrigatória ao aplicar re-prazo">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Anexo de Evidências da Implementação</label>
                            <input type="file" id="d7-acao-evidencia-file" accept=".pdf,image/*">
                            ${acao.evidencias?.length ? `<div style="margin-top:0.5rem; color:#475569; font-size:0.8125rem;">Evidências anexadas: ${acao.evidencias.length}</div>` : ''}
                        </div>
                        <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                            <button type="button" class="btn btn-secondary" id="d7-salvar-acao-btn">Salvar Alterações</button>
                            <button type="button" class="btn btn-success" id="d7-concluir-acao-btn" ${acao.evidencias?.length ? '' : 'disabled'} aria-disabled="${acao.evidencias?.length ? 'false' : 'true'}">Concluir Ação Preventiva</button>
                        </div>
                    </div>
                </div>
            `;
            overlay.onclick = (e) => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);

            const evidenciaInput = overlay.querySelector('#d7-acao-evidencia-file');
            const concluirBtn = overlay.querySelector('#d7-concluir-acao-btn');
            const atualizarEstadoConcluir = () => {
                const habilitado = !!(acao.evidencias?.length || evidenciaInput.files?.length);
                concluirBtn.disabled = !habilitado;
                concluirBtn.setAttribute('aria-disabled', habilitado ? 'false' : 'true');
            };
            evidenciaInput.onchange = atualizarEstadoConcluir;
            atualizarEstadoConcluir();

            const aplicarAtualizacoes = async () => {
                const reprazoData = overlay.querySelector('#d7-acao-reprazo-data').value;
                const reprazoJust = overlay.querySelector('#d7-acao-reprazo-just').value.trim();
                if (reprazoData && !reprazoJust) {
                    alert('Justificativa é obrigatória para aplicar re-prazo.');
                    return false;
                }
                if (reprazoData) {
                    const numero = (acao.reprazos?.length || 0) + 1;
                    acao.reprazos.push({ numero, data: reprazoData, justificativa: reprazoJust, dataRegistro: new Date().toISOString() });
                }
                if (evidenciaInput.files?.length) {
                    const arquivo = evidenciaInput.files[0];
                    const base64 = await lerArquivoBase64(arquivo, 'evidência da ação D7');
                    if (base64 === null) {
                        alert('Falha ao processar evidência. Tente novamente.');
                        return false;
                    }
                    acao.evidencias = acao.evidencias || [];
                    acao.evidencias.push({ nome: arquivo.name, conteudo: base64, data: new Date().toISOString() });
                }
                return true;
            };

            overlay.querySelector('#d7-salvar-acao-btn').onclick = async () => {
                const ok = await aplicarAtualizacoes();
                if (!ok) return;
                acoes[acaoIndex] = acao;
                state.selectedRNC = state.rncs[rncIndex];
                sincronizarFluxo8D(state.selectedRNC);
                await salvarRNCNoFirebase(state.selectedRNC);
                overlay.remove();
                render();
            };

            concluirBtn.onclick = async () => {
                if (!acao.evidencias?.length && !evidenciaInput.files?.length) {
                    alert('Anexe pelo menos uma evidência para concluir a ação preventiva.');
                    return;
                }
                const ok = await aplicarAtualizacoes();
                if (!ok) return;
                acao.status = 'CONCLUIDA';
                acao.dataConclusao = new Date().toISOString();
                acoes[acaoIndex] = acao;
                state.selectedRNC = state.rncs[rncIndex];
                sincronizarFluxo8D(state.selectedRNC);
                state.activeTab = state.selectedRNC.faseAtual;
                await salvarRNCNoFirebase(state.selectedRNC);
                overlay.remove();
                render();
            };
        }

        async function salvarD8(concluir = false) {
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            ensureD8Structure(state.rncs[rncIndex]);
            const rnc = state.rncs[rncIndex];
            if (rnc.d8.concluida) {
                alert('O D8 já foi concluído e está disponível somente para consulta.');
                return;
            }

            const licaoInput = document.getElementById('d8-licao');
            const msgInput = document.getElementById('d8-mensagem');
            rnc.d8.licaoAprendida = licaoInput ? licaoInput.value : rnc.d8.licaoAprendida;
            rnc.d8.mensagemFinal = msgInput ? msgInput.value : rnc.d8.mensagemFinal;

            const equipeD1 = montarEquipeD1(rnc);
            const reconhecimentoIndividual = {};
            equipeD1.forEach(item => {
                const key = getEquipeMembroKey(item);
                const campo = document.getElementById(`d8-rec-${key}`);
                if (campo) reconhecimentoIndividual[key] = campo.value;
            });
            rnc.d8.reconhecimentoIndividual = reconhecimentoIndividual;

            if (concluir) {
                const pendencias = getPendenciasConclusaoD8(rnc);
                if (pendencias.length) {
                    alert(`Não foi possível concluir o D8:\n- ${pendencias.join('\n- ')}`);
                    return;
                }
                rnc.d8.concluida = true;
                rnc.d8.dataConclusao = new Date().toISOString();
            }

            state.selectedRNC = rnc;
            sincronizarFluxo8D(state.selectedRNC);
            if (concluir) state.activeTab = state.selectedRNC.faseAtual;
            const salvoNoFirebase = await salvarRNCNoFirebase(state.selectedRNC);
            alert(salvoNoFirebase
                ? (concluir ? 'D8 concluído e 8D encerrado com sucesso!' : 'D8 salvo com sucesso!')
                : (concluir ? 'D8 concluído localmente. Firebase indisponível.' : 'D8 salvo localmente. Firebase indisponível.'));
            render();
        }

        function isDataUrlImagem(data) {
            return /^data:image\//.test(String(data || ''));
        }

        function renderImagemOuAnexoRelatorio(titulo, dataUrl, options = {}) {
            if (!dataUrl) return `<div class="pdf-muted">${titulo}: não informado.</div>`;
            if (isDataUrlImagem(dataUrl)) {
                return `
                    <div class="pdf-image-card ${options.variant || ''}">
                        <div class="pdf-image-title">${escapeHtml(titulo)}</div>
                        <img src="${dataUrl}" alt="${escapeHtml(titulo)}">
                    </div>
                `;
            }
            return `<div class="pdf-muted">${escapeHtml(titulo)} anexado (conteúdo não-imagem).</div>`;
        }

        function renderTabelaAcoesRelatorio(acoes = [], incluirOrigem = false) {
            if (!acoes.length) return '<div class="pdf-muted">Nenhuma ação cadastrada.</div>';
            return `
                <table class="pdf-table">
                    <thead>
                        <tr>
                            <th>Descrição</th>
                            <th>Responsável</th>
                            ${incluirOrigem ? '<th>Origem</th>' : ''}
                            <th>Prazo Original</th>
                            <th>Último Re-prazo</th>
                            <th>Status de Prazo</th>
                            <th>Status da Ação</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${acoes.map(acao => {
                            const responsavel = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
                            const indicador = obterIndicadorPrazoAcao(acao);
                            const ultimoReprazoData = acao.reprazos?.length ? acao.reprazos[acao.reprazos.length - 1]?.data : '';
                            return `
                                <tr>
                                    <td>${escapeHtml(acao.descricao || '-')}</td>
                                    <td>${escapeHtml(responsavel)}</td>
                                    ${incluirOrigem ? `<td>${escapeHtml(acao.origemPrevencao || '-')}</td>` : ''}
                                    <td>${formatDateSafe(acao.prazoPrincipal)}</td>
                                    <td>${ultimoReprazoData ? formatDateSafe(ultimoReprazoData) : '—'}</td>
                                    <td>${indicador.className === 'red' ? 'Em atraso' : (indicador.className === 'orange' ? 'Próximo ao vencimento' : 'Dentro do prazo')}</td>
                                    <td>${acao.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderEvidenciasAcoesRelatorio(acoes = [], tituloPadrao = 'Ação') {
            if (!acoes.length) return '<div class="pdf-muted">Nenhuma ação cadastrada.</div>';
            return acoes.map((acao, idx) => {
                const evidencias = acao.evidencias || [];
                const dataConclusao = extractAndFormatDate(acao.dataConclusao);
                return `
                    <div class="pdf-action-block">
                        <h4>${escapeHtml(acao.descricao || `${tituloPadrao} ${idx + 1}`)}</h4>
                        <div><strong>Status:</strong> ${acao.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto'}</div>
                        <div><strong>Data de conclusão:</strong> ${acao.status === 'CONCLUIDA' ? dataConclusao : 'Não concluída'}</div>
                        ${evidencias.length ? `
                            <div class="pdf-evidence-grid">
                                ${evidencias.map((ev, eidx) => renderImagemOuAnexoRelatorio(ev.nome || `Evidência ${eidx + 1}`, ev.conteudo)).join('')}
                            </div>
                        ` : '<div class="pdf-muted">Sem evidências anexadas.</div>'}
                    </div>
                `;
            }).join('');
        }

        function gerarRelatorio8DPDF() {
            const rnc = state.selectedRNC;
            if (!rnc) return;
            if (!isEtapaConcluida(rnc, 'd8')) {
                alert('O botão de geração do relatório está disponível somente após a conclusão do D8.');
                return;
            }

            ensureD4Structure(rnc);
            ensureD8Structure(rnc);
            const equipeD1 = montarEquipeD1(rnc);
            const acoesD5 = (rnc.d5?.listaAcoes || []).map(normalizeAcaoD5);
            const acoesD7 = (rnc.d7?.listaAcoes || []).map(normalizeAcaoD7);
            const dataGeracao = new Date().toLocaleString('pt-BR');
            const plantaRnc = equipeD1[0]?.pessoa?.planta || '-';
            const responsavelRnc = getPessoaById(rnc.equipeResponsavel?.analistaQualidadeId)?.nome || rnc.d1?.lider || '-';

            const html = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8" />
                    <title>Relatório 8D - ${escapeHtml(rnc.numero)}</title>
                    <style>
                        @page { size: A4 portrait; margin: 16mm; }
                        body { font-family: Inter, Segoe UI, Arial, sans-serif; color:#1e293b; font-size:12px; margin:0; }
                        .pdf-page { page-break-after: always; padding-bottom: 18mm; }
                        .pdf-page:last-child { page-break-after: auto; }
                        .pdf-header { border-bottom:2px solid #0f172a; padding-bottom:8px; margin-bottom:10px; }
                        .pdf-brand { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
                        .pdf-logo { font-weight:800; letter-spacing:0.08em; color:#0b1f3a; }
                        .pdf-frase { font-size:9px; text-transform:uppercase; letter-spacing:0.04em; color:#64748b; max-width:70%; text-align:right; }
                        .pdf-header h1 { margin:0; font-size:20px; }
                        .pdf-header h2 { margin:6px 0 0; font-size:16px; color:#1d4ed8; }
                        .pdf-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px 14px; margin-top:10px; }
                        .pdf-grid div { padding:6px; border:1px solid #cbd5e1; border-radius:6px; }
                        .pdf-section-title { font-size:16px; color:#0f172a; margin:0 0 8px; border-bottom:1px solid #cbd5e1; padding-bottom:4px; }
                        .pdf-subtitle { margin:10px 0 6px; font-size:13px; color:#1d4ed8; }
                        .pdf-table { width:100%; border-collapse: collapse; margin-top:6px; }
                        .pdf-table th, .pdf-table td { border:1px solid #cbd5e1; padding:6px; vertical-align: top; text-align:left; }
                        .pdf-table th { background:#eff6ff; }
                        .pdf-muted { color:#64748b; font-style:italic; margin-top:4px; }
                        .pdf-image-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
                        .pdf-image-card { border:2px solid #94a3b8; border-radius:6px; padding:6px; }
                        .pdf-image-card.green { border-color:#16a34a; }
                        .pdf-image-card.red { border-color:#dc2626; }
                        .pdf-image-title { font-weight:700; margin-bottom:6px; }
                        .pdf-image-card img { width:100%; max-height:240px; object-fit:contain; border:1px solid #e2e8f0; background:white; }
                        .pdf-action-block { border:1px solid #cbd5e1; border-radius:6px; padding:8px; margin-bottom:8px; }
                        .pdf-action-block h4 { margin:0 0 6px; font-size:13px; }
                        .pdf-evidence-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:6px; }
                        .pdf-footer { margin-top:10px; padding-top:6px; border-top:1px solid #cbd5e1; font-size:10px; color:#475569; display:flex; justify-content:space-between; }
                    </style>
                </head>
                <body>
                    <section class="pdf-page">
                        <div class="pdf-header">
                            <div class="pdf-brand">
                                <div class="pdf-logo">MAGIUS</div>
                                <div class="pdf-frase">AJUDANDO A CONSTRUIR, CULTIVAR, TRANSPORTAR E SEGUIR EM FRENTE</div>
                            </div>
                            <h1>Relatório 8D</h1>
                            <h2>${escapeHtml(rnc.numero)}</h2>
                        </div>
                        <div class="pdf-grid">
                            <div><strong>Cliente:</strong> ${escapeHtml(rnc.cliente || '-')}</div>
                            <div><strong>Produto / Processo:</strong> ${escapeHtml(rnc.setor || '-')}</div>
                            <div><strong>Planta:</strong> ${escapeHtml(plantaRnc)}</div>
                            <div><strong>Data de abertura:</strong> ${formatDateSafe(rnc.dataAbertura)}</div>
                            <div><strong>Data de encerramento:</strong> ${extractAndFormatDate(rnc.d8?.dataConclusao)}</div>
                            <div><strong>Responsável pela RNC:</strong> ${escapeHtml(responsavelRnc)}</div>
                        </div>
                        <div class="pdf-footer"><span>RNC: ${escapeHtml(rnc.numero)}</span><span>Gerado em ${dataGeracao}</span></div>
                    </section>

                    <section class="pdf-page">
                        <h3 class="pdf-section-title">D1 – Construção da Equipe</h3>
                        <table class="pdf-table">
                            <thead><tr><th>Nome</th><th>Função na RNC</th><th>Setor</th><th>Planta</th></tr></thead>
                            <tbody>
                                ${equipeD1.length ? equipeD1.map(item => `<tr><td>${escapeHtml(item.pessoa.nome)}</td><td>${escapeHtml(item.funcaoRnc)}</td><td>${escapeHtml(item.pessoa.setor || '-')}</td><td>${escapeHtml(item.pessoa.planta || '-')}</td></tr>`).join('') : '<tr><td colspan="4">Equipe não informada.</td></tr>'}
                            </tbody>
                        </table>
                        <div class="pdf-footer"><span>RNC: ${escapeHtml(rnc.numero)}</span><span>Relatório 8D</span></div>
                    </section>

                    <section class="pdf-page">
                        <h3 class="pdf-section-title">D2 – Definição do Problema</h3>
                        <div><strong>Descrição do problema:</strong> ${escapeHtml(rnc.descricao || rnc.d2?.problema || '-')}</div>
                        <div class="pdf-grid" style="margin-top:8px;">
                            <div><strong>Cliente:</strong> ${escapeHtml(rnc.cliente || '-')}</div>
                            <div><strong>Modo de falha:</strong> ${escapeHtml(rnc.tipoFalha || '-')}</div>
                            <div><strong>Quantidade impactada:</strong> ${escapeHtml(String(rnc.quantidade || '-'))}</div>
                        </div>
                        <h4 class="pdf-subtitle">Imagens de referência</h4>
                        <div class="pdf-image-grid">
                            ${renderImagemOuAnexoRelatorio('Peça Conforme', rnc.fotosPeca?.conforme?.conteudo, { variant: 'green' })}
                            ${renderImagemOuAnexoRelatorio('Peça Não Conforme', rnc.fotosPeca?.naoConforme?.conteudo, { variant: 'red' })}
                        </div>
                        <div class="pdf-footer"><span>RNC: ${escapeHtml(rnc.numero)}</span><span>Relatório 8D</span></div>
                    </section>

                    <section class="pdf-page">
                        <h3 class="pdf-section-title">D3 – Contenção</h3>
                        <div class="pdf-grid">
                            <div><strong>Quantidade em estoque:</strong> ${escapeHtml(String(rnc.d3?.quantidadeEstoque || '-'))}</div>
                            <div><strong>Quantidade inspecionada:</strong> ${escapeHtml(String(rnc.d3?.quantidadeInspecionada || '-'))}</div>
                            <div><strong>Quantidade não conforme:</strong> ${escapeHtml(String(rnc.d3?.quantidadeNaoConforme || '-'))}</div>
                            <div><strong>Data de conclusão da contenção:</strong> ${extractAndFormatDate(rnc.d3?.dataConclusao)}</div>
                        </div>
                        <h4 class="pdf-subtitle">Alerta de contenção assinado</h4>
                        ${renderImagemOuAnexoRelatorio(rnc.d3?.anexoAlertaAssinadoNome || 'Alerta assinado', rnc.d3?.anexoAlertaAssinadoConteudo)}
                        <div class="pdf-footer"><span>RNC: ${escapeHtml(rnc.numero)}</span><span>Relatório 8D</span></div>
                    </section>

                    <section class="pdf-page">
                        <h3 class="pdf-section-title">D4 – Análise da Causa Raiz</h3>
                        <div class="pdf-grid">
                            <div><strong>Causa raiz – Ocorrência:</strong> ${escapeHtml(rnc.d4?.causaRaizOcorrencia || '-')}</div>
                            <div><strong>Causa raiz – Detecção:</strong> ${escapeHtml(rnc.d4?.causaRaizDeteccao || '-')}</div>
                        </div>
                        <h4 class="pdf-subtitle">5 Porquês – Ocorrência</h4>
                        <ol>${[1,2,3,4,5].map(i => `<li>${escapeHtml(rnc.d4?.ocorrencia?.[`why${i}`] || '-')}</li>`).join('')}</ol>
                        <h4 class="pdf-subtitle">5 Porquês – Detecção</h4>
                        <ol>${[1,2,3,4,5].map(i => `<li>${escapeHtml(rnc.d4?.deteccao?.[`why${i}`] || '-')}</li>`).join('')}</ol>
                        <div class="pdf-footer"><span>RNC: ${escapeHtml(rnc.numero)}</span><span>Relatório 8D</span></div>
                    </section>

                    <section class="pdf-page">
                        <h3 class="pdf-section-title">D5 – Ações Corretivas</h3>
                        ${renderTabelaAcoesRelatorio(acoesD5)}
                        <div class="pdf-footer"><span>RNC: ${escapeHtml(rnc.numero)}</span><span>Relatório 8D</span></div>
                    </section>

                    <section class="pdf-page">
                        <h3 class="pdf-section-title">D6 – Implementação das Ações Corretivas</h3>
                        ${renderEvidenciasAcoesRelatorio(acoesD5, 'Ação corretiva')}
                        <div class="pdf-footer"><span>RNC: ${escapeHtml(rnc.numero)}</span><span>Relatório 8D</span></div>
                    </section>

                    <section class="pdf-page">
                        <h3 class="pdf-section-title">D7 – Ações Preventivas</h3>
                        ${renderTabelaAcoesRelatorio(acoesD7, true)}
                        <h4 class="pdf-subtitle">Implementação e Evidências</h4>
                        ${renderEvidenciasAcoesRelatorio(acoesD7, 'Ação preventiva')}
                        <div class="pdf-footer"><span>RNC: ${escapeHtml(rnc.numero)}</span><span>Relatório 8D</span></div>
                    </section>

                    <section class="pdf-page">
                        <h3 class="pdf-section-title">D8 – Lições Aprendidas e Reconhecimento</h3>
                        <h4 class="pdf-subtitle">Lições Aprendidas</h4>
                        <div>${escapeHtml(rnc.d8?.licaoAprendida || '-')}</div>
                        <h4 class="pdf-subtitle">Reconhecimento Individual</h4>
                        <table class="pdf-table">
                            <thead><tr><th>Nome</th><th>Função</th><th>Reconhecimento</th></tr></thead>
                            <tbody>
                                ${equipeD1.length ? equipeD1.map(item => {
                                    const key = getEquipeMembroKey(item);
                                    return `<tr><td>${escapeHtml(item.pessoa.nome)}</td><td>${escapeHtml(item.funcaoRnc)}</td><td>${escapeHtml(rnc.d8?.reconhecimentoIndividual?.[key] || '-')}</td></tr>`;
                                }).join('') : '<tr><td colspan="3">Sem equipe vinculada.</td></tr>'}
                            </tbody>
                        </table>
                        <h4 class="pdf-subtitle">Agradecimento Final</h4>
                        <div>${escapeHtml(rnc.d8?.mensagemFinal || '-')}</div>
                        <div class="pdf-footer"><span>RNC: ${escapeHtml(rnc.numero)}</span><span>Gerado em ${dataGeracao}</span></div>
                    </section>
                </body>
                </html>
            `;

            const blob = new Blob([html], { type: 'text/html' });
            const blobUrl = URL.createObjectURL(blob);
            const win = window.open(blobUrl, '_blank', 'noopener,noreferrer');
            if (!win) {
                URL.revokeObjectURL(blobUrl);
                alert('Não foi possível abrir a janela do relatório. Verifique bloqueio de pop-up.');
                return;
            }
            // 2 minutos para permitir carregamento completo e diálogo de impressão em relatórios extensos.
            const BLOB_URL_CLEANUP_TIMEOUT_MS = 120000;
            const WINDOW_CLOSE_POLL_INTERVAL_MS = 1000;
            const cleanupUrl = () => URL.revokeObjectURL(blobUrl);
            const cleanupTimer = setTimeout(cleanupUrl, BLOB_URL_CLEANUP_TIMEOUT_MS);
            const cleanupPoll = setInterval(() => {
                try {
                    if (!win.closed) return;
                    clearInterval(cleanupPoll);
                    clearTimeout(cleanupTimer);
                    cleanupUrl();
                } catch (error) {
                    console.warn('Erro ao verificar fechamento da janela do relatório 8D.', error);
                    clearInterval(cleanupPoll);
                    clearTimeout(cleanupTimer);
                    cleanupUrl();
                }
            }, WINDOW_CLOSE_POLL_INTERVAL_MS);
            win.onload = () => {
                win.print();
            };
        }

        async function salvarFase(phaseId) {
            const rnc = state.selectedRNC;
            const rncIndex = state.rncs.findIndex(r => r.id === rnc.id);
            
            if (phaseId === 'd1') {
                // D1 é controlado pelo cadastro de pessoas e pelo cadastro da RNC.
                return;
            } else if (phaseId === 'd2') {
                return;
            } else if (phaseId === 'd3') {
                state.rncs[rncIndex].d3.evidencia = document.getElementById('d3-evidencia').value;
                state.rncs[rncIndex].d3.quantidadeEstoque = document.getElementById('d3-estoque').value;
                state.rncs[rncIndex].d3.quantidadeInspecionada = document.getElementById('d3-inspecionada').value;
                state.rncs[rncIndex].d3.quantidadeNaoConforme = document.getElementById('d3-nao-conforme').value;
                const anexoInput = document.getElementById('d3-alerta-arquivo');
                if (anexoInput && anexoInput.files && anexoInput.files.length > 0) {
                    const arquivo = anexoInput.files[0];
                    const base64 = await lerArquivoBase64(arquivo, 'anexo D3');
                    if (base64 === null) {
                        alert('Falha ao processar o anexo da D3. Tente novamente.');
                        return;
                    }
                    state.rncs[rncIndex].d3.anexoAlertaAssinadoNome = arquivo.name;
                    state.rncs[rncIndex].d3.anexoAlertaAssinadoConteudo = base64;
                }
            } else if (phaseId === 'd4') {
                ensureD4Structure(state.rncs[rncIndex]);
                const d4 = state.rncs[rncIndex].d4;
                for (let i = 1; i <= 5; i++) {
                    const oc = document.getElementById(`d4-oc-why${i}`);
                    const det = document.getElementById(`d4-det-why${i}`);
                    if (oc) d4.ocorrencia[`why${i}`] = oc.value;
                    if (det) d4.deteccao[`why${i}`] = det.value;
                }
                consolidateD4Data(d4);
            } else if (phaseId === 'd5') {
                return;
            } else if (phaseId === 'd6') {
                return;
            } else if (phaseId === 'd7') {
                return;
            } else if (phaseId === 'd8') {
                return;
            }
            
            state.selectedRNC = state.rncs[rncIndex];
            sincronizarFluxo8D(state.selectedRNC);
            state.activeTab = state.selectedRNC.faseAtual;
            const salvoNoFirebase = await salvarRNCNoFirebase(state.selectedRNC);
            alert(salvoNoFirebase ? 'Dados salvos com sucesso!' : 'Dados salvos localmente. Firebase indisponível.');
            render();
        }

        function solicitarReprazo(phaseId, num) {
            const phase = phases.find(p => p.id === phaseId);
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1001';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 600px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">Solicitar Re-prazo ${num}</h2>
                            <p style="color: #64748b; margin-top: 0.5rem;">${phase.name}</p>
                        </div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <strong>Atenção:</strong> Justifique detalhadamente o motivo da solicitação.
                        </div>
                        <form id="reprazoForm">
                            <div class="form-group">
                                <label>Nova Data Limite</label>
                                <input type="date" id="novaData" required>
                            </div>
                            <div class="form-group">
                                <label>Justificativa</label>
                                <textarea id="justificativa" rows="4" placeholder="Descreva o motivo..." required></textarea>
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
                                <button type="submit" class="btn btn-success">Confirmar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            overlay.onclick = (e) => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);
            
            document.getElementById('reprazoForm').onsubmit = async (e) => {
                e.preventDefault();
                const novaData = document.getElementById('novaData').value;
                const just = document.getElementById('justificativa').value;
                
                const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
                if (num === 1) {
                    state.rncs[rncIndex].prazos[phaseId].reprazo1 = novaData;
                    state.rncs[rncIndex].prazos[phaseId].just1 = just;
                } else {
                    state.rncs[rncIndex].prazos[phaseId].reprazo2 = novaData;
                    state.rncs[rncIndex].prazos[phaseId].just2 = just;
                }
                
                state.rncs[rncIndex].status = "AT_RISK";
                state.selectedRNC = state.rncs[rncIndex];
                const salvoNoFirebase = await salvarRNCNoFirebase(state.selectedRNC);
                overlay.remove();
                render();
                alert(salvoNoFirebase ? `Re-prazo ${num} solicitado com sucesso!` : `Re-prazo ${num} salvo localmente. Firebase indisponível.`);
            };
        }

        function attachEventListeners() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.onsubmit = (e) => {
                    e.preventDefault();
                    state.currentUser = users[0];
                    state.currentPage = 'dashboard';
                    render();
                };
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.onclick = () => {
                    const page = item.dataset.page;
                    if (page === 'logout') {
                        if (confirm('Sair?')) {
                            state.currentUser = null;
                            state.currentPage = 'login';
                            render();
                        }
                    } else if (page) {
                        state.currentPage = page;
                        render();
                    }
                };
            });
            
            document.querySelectorAll('.rnc-row').forEach(row => {
                row.onclick = () => {
                    state.selectedRNC = state.rncs.find(r => r.id == row.dataset.rncId);
                    sincronizarFluxo8D(state.selectedRNC);
                    state.activeTab = state.selectedRNC?.faseAtual || 'd1';
                    state.activeD4SubTab = 'principal';
                    render();
                };
            });

            const abrirPerfilModal = document.getElementById('abrirPerfilModal');
            if (abrirPerfilModal) {
                const abrirModalPerfil = () => {
                    state.perfilModalAberto = true;
                    state.perfilAbaAtiva = 'perfil';
                    render();
                };
                abrirPerfilModal.onclick = abrirModalPerfil;
                abrirPerfilModal.onkeydown = (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        abrirModalPerfil();
                    }
                };
            }
            
            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.onclick = () => {
                    state.selectedRNC = state.rncs.find(r => r.id == btn.dataset.rncId);
                    sincronizarFluxo8D(state.selectedRNC);
                    state.activeTab = state.selectedRNC?.faseAtual || 'd1';
                    state.activeD4SubTab = 'principal';
                    render();
                };
            });

            const dashboardMonthFilter = document.getElementById('dashboardMonthFilter');
            const dashboardYearFilter = document.getElementById('dashboardYearFilter');
            const dashboardSearchInput = document.getElementById('dashboardSearchInput');
            const dashboardPrevPage = document.getElementById('dashboardPrevPage');
            const dashboardNextPage = document.getElementById('dashboardNextPage');
            if (dashboardMonthFilter && dashboardYearFilter) {
                dashboardMonthFilter.onchange = () => {
                    state.dashboardFilterMonth = Number(dashboardMonthFilter.value);
                    state.dashboardPage = 1;
                    render();
                };
                dashboardYearFilter.onchange = () => {
                    state.dashboardFilterYear = Number(dashboardYearFilter.value);
                    state.dashboardPage = 1;
                    render();
                };
            }
            if (dashboardSearchInput) {
                dashboardSearchInput.oninput = () => {
                    state.dashboardSearch = dashboardSearchInput.value;
                    state.dashboardPage = 1;
                    render();
                };
            }
            if (dashboardPrevPage) {
                dashboardPrevPage.onclick = () => {
                    state.dashboardPage = Math.max(1, state.dashboardPage - 1);
                    render();
                };
            }
            if (dashboardNextPage) {
                dashboardNextPage.onclick = () => {
                    state.dashboardPage = state.dashboardPage + 1;
                    render();
                };
            }

            const cadastroRncForm = document.getElementById('cadastroRncForm');
            if (cadastroRncForm) {
                const numeroRncInput = cadastroRncForm.querySelector('#numeroRncInput');
                const numeroRncMsg = cadastroRncForm.querySelector('#numeroRncValidacao');
                const cadastroRncSubmitBtn = cadastroRncForm.querySelector('#cadastroRncSubmitBtn');
                const validarNumeroRncUnico = () => {
                    if (!numeroRncInput || !numeroRncMsg || !cadastroRncSubmitBtn) return true;
                    const numeroInformado = String(numeroRncInput.value || '').trim();
                    if (!numeroInformado) {
                        numeroRncInput.setCustomValidity('');
                        numeroRncMsg.style.display = 'none';
                        cadastroRncSubmitBtn.disabled = false;
                        return true;
                    }
                    if (existeNumeroRNCDuplicado(numeroInformado)) {
                        numeroRncInput.setCustomValidity(RNC_NUMERO_DUPLICADO_MSG);
                        numeroRncMsg.textContent = RNC_NUMERO_DUPLICADO_MSG;
                        numeroRncMsg.style.display = 'block';
                        cadastroRncSubmitBtn.disabled = true;
                        return false;
                    }
                    numeroRncInput.setCustomValidity('');
                    numeroRncMsg.textContent = '';
                    numeroRncMsg.style.display = 'none';
                    cadastroRncSubmitBtn.disabled = false;
                    return true;
                };
                if (numeroRncInput) {
                    numeroRncInput.onblur = validarNumeroRncUnico;
                    numeroRncInput.oninput = validarNumeroRncUnico;
                }

                const outrosHidden = cadastroRncForm.querySelector('#outrosEnvolvidosIds');
                const outrosSelect = cadastroRncForm.querySelector('#outrosEnvolvidosSelect');
                const adicionarOutroBtn = cadastroRncForm.querySelector('#adicionarOutroEnvolvidoBtn');
                const outrosSelecionadosContainer = cadastroRncForm.querySelector('#outrosEnvolvidosSelecionados');
                if (outrosHidden && outrosSelect && adicionarOutroBtn && outrosSelecionadosContainer) {
                    renderOutrosEnvolvidosSelecionados();
                    adicionarOutroBtn.onclick = () => {
                        const novoId = Number(outrosSelect.value);
                        if (!novoId) return;
                        const ids = getOutrosEnvolvidosSelecionados();
                        if (!ids.includes(novoId)) {
                            ids.push(novoId);
                            outrosHidden.value = ids.join(',');
                            renderOutrosEnvolvidosSelecionados();
                        }
                        outrosSelect.value = '';
                    };
                    outrosSelecionadosContainer.onclick = (event) => {
                        const target = event.target.closest('.btn-remover-outro');
                        if (!target) return;
                        const removerId = Number(target.dataset.outroId);
                        const ids = getOutrosEnvolvidosSelecionados().filter(id => id !== removerId);
                        outrosHidden.value = ids.join(',');
                        renderOutrosEnvolvidosSelecionados();
                    };
                }

                cadastroRncForm.onsubmit = async (e) => {
                    e.preventDefault();
                    if (!validarNumeroRncUnico()) return;
                    const formData = new FormData(cadastroRncForm);
                    const nextId = state.rncs.length ? Math.max(...state.rncs.map(r => r.id)) + 1 : 1;
                    const hoje = new Date();
                    const dataAbertura = hoje.toISOString().split('T')[0];
                    const addDays = (days) => {
                        const data = new Date(hoje);
                        data.setDate(data.getDate() + days);
                        return data.toISOString().split('T')[0];
                    };

                    const analistaEngenhariaId = Number(formData.get('analistaEngenhariaId'));
                    const analistaQualidadeId = Number(formData.get('analistaQualidadeId'));
                    const responsavelContencaoId = Number(formData.get('responsavelContencaoId'));
                    const outrosEnvolvidosIds = String(formData.get('outrosEnvolvidosIds') || '').trim()
                        ? String(formData.get('outrosEnvolvidosIds') || '').split(',').map(id => Number(id)).filter(id => Number.isFinite(id) && id > 0)
                        : [];

                    const analistaEngenharia = getPessoaById(analistaEngenhariaId);
                    const analistaQualidade = getPessoaById(analistaQualidadeId);
                    const responsavelContencao = getPessoaById(responsavelContencaoId);
                    const outrosEnvolvidos = outrosEnvolvidosIds.map(id => getPessoaById(id)).filter(Boolean);
                    const equipeD1 = [...new Set([
                        responsavelContencao?.nome,
                        analistaEngenharia?.nome,
                        analistaQualidade?.nome,
                        ...outrosEnvolvidos.map(p => p.nome)
                    ].filter(Boolean))].join(', ');
                    const fotoConformeFile = formData.get('fotoConforme');
                    const fotoNaoConformeFile = formData.get('fotoNaoConforme');

                    const toBase64 = (file) => new Promise((resolve) => {
                        if (!file || !file.name) {
                            resolve('');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result || '');
                        reader.onerror = () => {
                            console.warn('Falha ao ler arquivo de foto:', file.name);
                            resolve('');
                        };
                        reader.readAsDataURL(file);
                    });

                    const fotoConformeBase64 = await toBase64(fotoConformeFile);
                    const fotoNaoConformeBase64 = await toBase64(fotoNaoConformeFile);
                    if (!fotoConformeBase64 || !fotoNaoConformeBase64) {
                        alert('Não foi possível processar as fotos da peça. Tente novamente.');
                        return;
                    }

                    const numeroRnc = String(formData.get('numeroRnc') || '').trim();
                    if (existeNumeroRNCDuplicado(numeroRnc)) {
                        alert(RNC_NUMERO_DUPLICADO_MSG);
                        return;
                    }

                    const novaRnc = {
                        id: nextId,
                        numero: numeroRnc,
                        cliente: formData.get('cliente'),
                        codigoPeca: formData.get('codigoPeca'),
                        tipoFalha: formData.get('tipoFalha'),
                        responsavel: responsavelContencao?.nome || '',
                        quantidade: Number(formData.get('quantidade')),
                        faseAtual: 'd1',
                        status: 'ON_TIME',
                        prioridade: formData.get('prioridade'),
                        setor: formData.get('setor'),
                        dataAbertura,
                        descricao: formData.get('descricao'),
                        equipeResponsavel: {
                            analistaEngenhariaId,
                            analistaQualidadeId,
                            responsavelContencaoId,
                            outrosEnvolvidosIds
                        },
                        fotosPeca: {
                            conforme: {
                                nome: fotoConformeFile?.name || '',
                                conteudo: fotoConformeBase64
                            },
                            naoConforme: {
                                nome: fotoNaoConformeFile?.name || '',
                                conteudo: fotoNaoConformeBase64
                            }
                        },
                        d1: { equipe: equipeD1, lider: analistaQualidade?.nome || '' },
                        d2: { problema: formData.get('descricao'), etapaConcluida: true },
                        d3: {
                            acaoContemcao: "",
                            evidencia: "",
                            quantidadeEstoque: "",
                            quantidadeInspecionada: "",
                            quantidadeNaoConforme: "",
                            anexoAlertaAssinadoNome: "",
                            anexoAlertaAssinadoConteudo: "",
                            etapaConcluida: false
                        },
                        d4: { causaRaiz: "", why1: "", why2: "", why3: "", why4: "", why5: "" },
                        d5: { acoesCorretivas: "" },
                        d6: { planoImplementacao: "", responsavel: "", prazoImplementacao: "" },
                        d7: { acoesPreventivas: "", listaAcoes: [] },
                        d8: { reconhecimento: "", licaoAprendida: "", mensagemFinal: "", reconhecimentoIndividual: {}, concluida: false, dataConclusao: "" },
                        prazos: {
                            d1: { original: dataAbertura, sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d2: { original: dataAbertura, sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d3: { original: addDays(1), sla: "24 horas", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d4: { original: addDays(3), sla: "3 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d5: { original: addDays(5), sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d6: { original: addDays(12), sla: "7 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d7: { original: addDays(14), sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d8: { original: addDays(15), sla: "1 dia", reprazo1: null, reprazo2: null, just1: "", just2: "" }
                        }
                    };

                    state.rncs.push(novaRnc);
                    const salvoNoFirebase = await salvarRNCNoFirebase(novaRnc);
                    cadastroRncForm.reset();
                    render();
                    alert(salvoNoFirebase ? 'RNC cadastrada com sucesso!' : 'RNC cadastrada localmente. Firebase indisponível.');
                };
            }

            document.querySelectorAll('.btn-gerenciar-cadastro').forEach(btn => {
                btn.onclick = () => abrirModalListagemCadastro(btn.dataset.cadastroTipo);
            });

            const d3Estoque = document.getElementById('d3-estoque');
            const d3Inspecionada = document.getElementById('d3-inspecionada');
            const d3NaoConforme = document.getElementById('d3-nao-conforme');
            const d3Anexo = document.getElementById('d3-alerta-arquivo');
            if (d3Estoque && d3Inspecionada && d3NaoConforme && d3Anexo) {
                [d3Estoque, d3Inspecionada, d3NaoConforme].forEach(el => el.oninput = () => {
                    if (state.selectedRNC?.d3) {
                        state.selectedRNC.d3.etapaConcluida = false;
                        const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
                        if (rncIndex !== -1) state.rncs[rncIndex].d3.etapaConcluida = false;
                    }
                    atualizarEstadoConclusaoD3();
                });
                d3Anexo.onchange = () => {
                    if (state.selectedRNC?.d3) {
                        state.selectedRNC.d3.etapaConcluida = false;
                        const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
                        if (rncIndex !== -1) state.rncs[rncIndex].d3.etapaConcluida = false;
                    }
                    atualizarEstadoConclusaoD3();
                };
                atualizarEstadoConclusaoD3();
            }

            const filtroStatus = document.getElementById('controleFiltroStatus');
            const filtroSetor = document.getElementById('controleFiltroSetor');
            const filtroConclusao = document.getElementById('controleFiltroConclusao');
            const filtroEtapas = document.getElementById('controleFiltroEtapas');
            const filtroBusca = document.getElementById('controleFiltroBusca');
            if (filtroStatus && filtroSetor && filtroConclusao && filtroEtapas && filtroBusca) {
                const aplicarFiltrosControle = () => {
                    const status = filtroStatus.value;
                    const setor = filtroSetor.value;
                    const conclusao = filtroConclusao.value;
                    const etapas = filtroEtapas.value;
                    const busca = filtroBusca.value.trim().toLowerCase();
                    const setorEncoded = encodeURIComponent(setor);
                    document.querySelectorAll('.controle-row').forEach(row => {
                        const matchStatus = !status || row.dataset.status === status;
                        const matchSetor = !setor || row.dataset.setor === setorEncoded;
                        const matchConclusao = !conclusao || row.dataset.conclusao === conclusao;
                        const matchEtapas = !etapas || row.dataset.etapas === etapas;
                        const matchBusca = !busca || row.textContent.toLowerCase().includes(busca);
                        row.style.display = matchStatus && matchSetor && matchConclusao && matchEtapas && matchBusca ? '' : 'none';
                    });
                };
                filtroStatus.onchange = aplicarFiltrosControle;
                filtroSetor.onchange = aplicarFiltrosControle;
                filtroConclusao.onchange = aplicarFiltrosControle;
                filtroEtapas.onchange = aplicarFiltrosControle;
                filtroBusca.oninput = aplicarFiltrosControle;
            }
            
            const closeModal = document.getElementById('closeModal');
            if (closeModal) {
                closeModal.onclick = () => {
                    state.selectedRNC = null;
                    render();
                };
            }

            const perfilModal = document.getElementById('perfilModal');
            const fecharPerfilModal = document.getElementById('fecharPerfilModal');
            if (fecharPerfilModal) {
                fecharPerfilModal.onclick = () => {
                    state.perfilModalAberto = false;
                    render();
                };
            }
            if (perfilModal) {
                perfilModal.onclick = (e) => {
                    if (e.target === perfilModal) {
                        state.perfilModalAberto = false;
                        render();
                    }
                };
            }
            document.querySelectorAll('.profile-modal-tab[data-perfil-tab]').forEach(tab => {
                tab.onclick = () => {
                    state.perfilAbaAtiva = tab.dataset.perfilTab;
                    render();
                };
            });
            const segurancaSenhaForm = document.getElementById('segurancaSenhaForm');
            if (segurancaSenhaForm) {
                segurancaSenhaForm.onsubmit = async (event) => {
                    event.preventDefault();
                    const formData = new FormData(segurancaSenhaForm);
                    const senhaAtual = String(formData.get('senhaAtual') || '');
                    const novaSenha = String(formData.get('novaSenha') || '');
                    const confirmarNovaSenha = String(formData.get('confirmarNovaSenha') || '');
                    const msg = document.getElementById('segurancaSenhaMsg');
                    if (!msg) return;
                    if (!senhaAtual.trim()) {
                        msg.textContent = 'Informe a senha atual.';
                        msg.style.color = '#dc2626';
                        return;
                    }
                    if (novaSenha.length < 8) {
                        msg.textContent = 'A nova senha deve ter no mínimo 8 caracteres.';
                        msg.style.color = '#dc2626';
                        return;
                    }
                    if (!validatePasswordComplexity(novaSenha)) {
                        msg.textContent = 'A nova senha deve conter letra maiúscula, minúscula, número e caractere especial.';
                        msg.style.color = '#dc2626';
                        return;
                    }
                    if (novaSenha !== confirmarNovaSenha) {
                        msg.textContent = 'Confirmação de senha não confere.';
                        msg.style.color = '#dc2626';
                        return;
                    }
                    if (senhaAtual === novaSenha) {
                        msg.textContent = 'A nova senha deve ser diferente da senha atual.';
                        msg.style.color = '#dc2626';
                        return;
                    }
                    msg.textContent = 'Senha validada. Para concluir a alteração, integre com seu provedor de autenticação.';
                    msg.style.color = '#059669';
                    segurancaSenhaForm.reset();
                };
            }

            const abrirExportAnaliticoModal = document.getElementById('abrirExportAnaliticoModal');
            if (abrirExportAnaliticoModal) {
                abrirExportAnaliticoModal.onclick = () => {
                    state.exportModalAberto = true;
                    render();
                };
            }
            const exportAnaliticoModal = document.getElementById('exportAnaliticoModal');
            const fecharExportAnaliticoModal = document.getElementById('fecharExportAnaliticoModal');
            const cancelarExportAnalitico = document.getElementById('cancelarExportAnalitico');
            const confirmarExportAnalitico = document.getElementById('confirmarExportAnalitico');
            if (fecharExportAnaliticoModal) {
                fecharExportAnaliticoModal.onclick = () => {
                    state.exportModalAberto = false;
                    render();
                };
            }
            if (cancelarExportAnalitico) {
                cancelarExportAnalitico.onclick = () => {
                    state.exportModalAberto = false;
                    render();
                };
            }
            if (exportAnaliticoModal) {
                exportAnaliticoModal.onclick = (event) => {
                    if (event.target === exportAnaliticoModal) {
                        state.exportModalAberto = false;
                        render();
                    }
                };
            }
            document.querySelectorAll('[data-export-key]').forEach(input => {
                input.onchange = () => {
                    const key = input.getAttribute('data-export-key');
                    if (!key) return;
                    state.exportAnalisesSelecionadas[key] = input.checked;
                };
            });
            if (confirmarExportAnalitico) {
                confirmarExportAnalitico.onclick = () => {
                    exportarRelatorioAnaliticoExcel();
                    state.exportModalAberto = false;
                    render();
                };
            }
             
            const modal = document.getElementById('rncModal');
            if (modal) {
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        state.selectedRNC = null;
                        render();
                    }
                };
            }
            
            document.querySelectorAll('.rnc-phase-tab[data-tab]:not(.d4-subtab)').forEach(tab => {
                tab.onclick = () => {
                    if (!tab.dataset.tab) return;
                    if (!state.selectedRNC || !canAcessarEtapa(state.selectedRNC, tab.dataset.tab)) {
                        const targetIndex = phases.findIndex(p => p.id === tab.dataset.tab);
                        const etapaBloqueante = targetIndex > 0 ? phases[targetIndex - 1]?.name : 'etapa anterior';
                        alert(`Esta etapa está bloqueada. Conclua ${etapaBloqueante} para continuar.`);
                        return;
                    }
                    if (state.activeTab === 'd4') sincronizarD4EmEdicao();
                    state.activeTab = tab.dataset.tab;
                    if (state.activeTab === 'd4') state.activeD4SubTab = 'principal';
                    render();
                };
            });

            document.querySelectorAll('.d4-subtab').forEach(tab => {
                tab.onclick = () => {
                    sincronizarD4EmEdicao();
                    state.activeD4SubTab = tab.dataset.d4Subtab;
                    render();
                };
            });

            document.querySelectorAll('.d2-image-preview').forEach(img => {
                img.onclick = () => abrirImagemModal(img.dataset.imageSrc, img.dataset.imageTitle || 'Imagem');
                img.onkeydown = (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        abrirImagemModal(img.dataset.imageSrc, img.dataset.imageTitle || 'Imagem');
                    }
                };
            });
            
            // Event listeners para filtros dos cards de métricas
            document.querySelectorAll('.stat-card[data-filter]').forEach(card => {
                card.onclick = () => {
                    const filter = card.dataset.filter;
                    const rows = document.querySelectorAll('.rnc-row');
                    
                    rows.forEach(row => {
                        const rncId = parseInt(row.dataset.rncId);
                        const rnc = state.rncs.find(r => r.id === rncId);
                        const statusRnc = rnc ? getStatusRncValue(rnc) : 'ON_TIME';
                        
                        if (filter === 'all' || statusRnc === filter) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                    
                    // Scroll suave para a tabela
                    const table = document.querySelector('.card table');
                    if (table) {
                        table.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };
            });
        }

        async function initApp() {
            await carregarRNCsDoFirebase();
            render();
        }

        initApp();
    </script>
</body>

</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema RNC 8D - Gestão de Qualidade</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f1f5f9;
            color: #0f172a;
        }
        
        /* SIDEBAR */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: #0b1f3a;
            color: white;
            overflow-y: auto;
            box-shadow: 4px 0 24px rgba(11, 31, 58, 0.25);
            z-index: 100;
            transition: width 0.25s ease, transform 0.25s ease;
        }

        .sidebar.collapsed {
            width: 72px;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            background: rgba(255, 255, 255, 0.04);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .sidebar-header h2 {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .menu-toggle-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(255, 255, 255, 0.08);
            color: #e2e8f0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .menu-toggle-btn:focus-visible,
        .nav-item:focus-visible {
            outline: 2px solid #93c5fd;
            outline-offset: 2px;
        }

        .sidebar.collapsed .sidebar-header h2 {
            display: none;
        }

        .sidebar.collapsed .sidebar-header {
            align-items: center;
        }
        
        .user-info {
            padding: 1.25rem 1.5rem;
            background: rgba(255, 255, 255, 0.08);
            margin: 1.5rem;
            border-radius: 12px;
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.125rem;
            margin-bottom: 0.75rem;
        }
        
        .nav-menu {
            padding: 1rem;
        }
        
        .nav-item {
            padding: 0.875rem 1rem;
            margin: 0.25rem 0;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.875rem;
            transition: all 0.25s;
            font-weight: 500;
            position: relative;
        }

        .nav-icon {
            display: inline-flex;
            width: 20px;
            height: 20px;
            color: #dbeafe;
            flex: 0 0 20px;
        }

        .nav-label {
            white-space: nowrap;
        }

        .sidebar.collapsed .nav-label {
            display: none;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        
        .nav-item.active {
            background: rgba(37, 99, 235, 0.35);
            font-weight: 600;
            border-left: 3px solid #93c5fd;
        }
        
        .nav-badge {
            margin-left: auto;
            background: #ef4444;
            color: white;
            padding: 0.25rem 0.625rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .sidebar.collapsed .nav-badge {
            position: absolute;
            right: 6px;
            top: 6px;
            margin-left: 0;
            padding: 0.2rem 0.45rem;
            min-width: 18px;
            height: 18px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
        }
        
        /* MAIN CONTENT */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.25s ease;
        }

        .main-content.sidebar-collapsed {
            margin-left: 72px;
        }

        .sidebar-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.42);
            z-index: 90;
        }
        
        .top-bar {
            background: linear-gradient(90deg, #0b1f3a 0%, #14345c 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.14);
            padding: 1.25rem 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #f8fafc;
        }

        .top-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 0;
        }

        .top-menu-btn {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.24);
            background: rgba(255, 255, 255, 0.08);
            color: #e2e8f0;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .top-logo {
            font-size: 1.15rem;
            font-weight: 800;
            letter-spacing: 0.08em;
            color: #ffffff;
            white-space: nowrap;
        }

        .top-institutional {
            font-size: 0.69rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.72);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 520px;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-btn {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.24);
            background: rgba(255, 255, 255, 0.08);
            color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            background: #ef4444;
            color: white;
            font-size: 0.6875rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 0.3rem;
        }

        .alerts-popover-overlay {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 1100;
            background: transparent;
            pointer-events: none;
        }

        .alerts-popover-overlay.active {
            display: block;
        }

        .alerts-popover {
            position: absolute;
            top: 74px;
            right: 2rem;
            width: min(520px, calc(100vw - 2rem));
            max-height: calc(100vh - 96px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border: 1px solid #dbe2ea;
            border-radius: 14px;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.2);
            pointer-events: auto;
        }

        .alerts-popover-header {
            padding: 1rem 1.1rem 0.8rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .alerts-popover-title {
            font-size: 1rem;
            font-weight: 700;
            color: #0f172a;
        }

        .alerts-popover-subtitle {
            font-size: 0.78rem;
            color: #64748b;
            margin-top: 0.3rem;
        }

        .alerts-popover-content {
            overflow-y: auto;
            padding: 0.9rem 1.1rem;
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
        }

        .alerts-section-title {
            font-size: 0.79rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #334155;
            margin-bottom: 0.4rem;
            font-weight: 700;
        }

        .alerts-item-card {
            width: 100%;
            text-align: left;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            padding: 0.75rem 0.85rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .alerts-item-card:last-child {
            margin-bottom: 0;
        }

        .alerts-item-card.red {
            border-left: 4px solid #dc2626;
        }

        .alerts-item-card.orange {
            border-left: 4px solid #f59e0b;
        }

        .alerts-item-label {
            font-size: 0.72rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .alerts-item-line {
            font-size: 0.8rem;
            color: #334155;
            line-height: 1.35;
        }

        .alerts-empty {
            border: 1px dashed #cbd5e1;
            border-radius: 10px;
            padding: 0.8rem;
            color: #64748b;
            font-size: 0.82rem;
            background: #f8fafc;
        }

        .alerts-popover-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.65rem;
            border-top: 1px solid #e2e8f0;
            padding: 0.85rem 1.1rem;
            background: #f8fafc;
        }

        .top-user {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            cursor: pointer;
        }

        .top-user-meta {
            text-align: right;
            line-height: 1.2;
        }

        .top-user-name {
            font-size: 0.86rem;
            font-weight: 600;
            color: #ffffff;
        }

        .top-user-role {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.75);
        }
        
        .content-area {
            padding: 2rem;
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 800;
            color: #0f172a;
            margin-bottom: 0.5rem;
        }
        
        /* CARDS */
        .card {
            background: white;
            border-radius: 14px;
            padding: 1.75rem;
            box-shadow: 0 4px 14px rgba(15, 23, 42, 0.06);
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .stat-card.success::before {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }
        
        .stat-card.warning::before {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }
        
        .stat-card.danger::before {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .stat-icon {
            color: #1d4ed8;
            opacity: 0.9;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.25rem;
            height: 2.25rem;
            background: #eff6ff;
            border-radius: 10px;
        }

        .section-title-icon {
            color: #1d4ed8;
            display: inline-flex;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2.75rem;
            font-weight: 900;
            color: #1e40af;
            line-height: 1;
        }
        
        .stat-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            font-size: 0.875rem;
        }
        
        .stat-trend.positive {
            color: #059669;
        }
        
        .stat-trend.negative {
            color: #dc2626;
        }
        
        .stat-trend.neutral {
            color: #64748b;
        }
        
        .stat-comparison {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        
        /* TABELA */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            padding: 1rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.8125rem;
            text-transform: uppercase;
            color: #475569;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .th-sort-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            border: none;
            background: transparent;
            color: inherit;
            font: inherit;
            text-transform: inherit;
            cursor: pointer;
            padding: 0;
        }

        .th-sort-icon {
            font-size: 0.7rem;
            color: #94a3b8;
            letter-spacing: -0.1rem;
            transition: color 0.15s;
        }

        .th-sort-icon.active {
            color: #1d4ed8;
        }

        .controle-status-detail {
            display: block;
            margin-top: 0.35rem;
            font-size: 0.72rem;
            color: #64748b;
            line-height: 1.3;
        }

        .controle-status-detail.warning {
            color: #b45309;
            font-weight: 600;
        }

        .controle-status-detail.critical {
            color: #b91c1c;
            font-weight: 700;
        }
        
        td {
            padding: 1.125rem 1rem;
            border-bottom: 1px solid #f1f5f9;
        }
        
        tbody tr {
            cursor: pointer;
            transition: all 0.15s;
        }
        
        tbody tr:hover {
            background: #f8fafc;
        }
        
        /* BADGES */
        .badge {
            display: inline-flex;
            padding: 0.375rem 0.875rem;
            border-radius: 10px;
            font-size: 0.8125rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .badge.blue { background: #dbeafe; color: #1e40af; }
        .badge.green { background: #d1fae5; color: #065f46; }
        .badge.red { background: #fee2e2; color: #991b1b; }
        .badge.orange { background: #fed7aa; color: #92400e; }
        .badge.purple { background: #ede9fe; color: #6d28d9; }
        
        /* BOTÕES */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9375rem;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary {
            background: #1d4ed8;
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #1e293b;
        }
        
        /* MODAL */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            max-height: 90vh;
            overflow-y: auto;
            width: 95%;
            max-width: 1400px;
        }
        
        .modal-header {
            padding: 2rem;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: start;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        }
        
        .modal-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: #0f172a;
        }
        
        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: #64748b;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .modal-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 2rem;
            gap: 0.5rem;
            overflow-x: auto;
        }
        
        .modal-tab {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9375rem;
            color: #64748b;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        
        .modal-tab.active {
            color: #1e40af;
            border-bottom-color: #1e40af;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* PHASE TRACKER */
        .phase-tracker {
            display: flex;
            justify-content: space-between;
            margin: 2rem 0;
            padding: 0 1rem;
        }
        
        .phase-step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .phase-step::after {
            content: '';
            position: absolute;
            top: 1.5rem;
            left: 50%;
            width: 100%;
            height: 3px;
            background: #e2e8f0;
            z-index: 0;
        }
        
        .phase-step:last-child::after {
            display: none;
        }
        
        .phase-circle {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: #e2e8f0;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: 700;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }
        
        .phase-circle.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .phase-circle.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        /* 8D SECTION */
        .d8-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px solid #e2e8f0;
        }
        
        .d8-section.active {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.02) 100%);
        }
        
        .d8-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .d8-title {
            font-size: 1.25rem;
            font-weight: 800;
            color: #0f172a;
        }
        
        .prazo-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .prazo-box {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 0.75rem 1rem;
        }
        
        .prazo-box.original {
            border-color: #3b82f6;
        }
        
        .prazo-box.reprazo1 {
            border-color: #f59e0b;
        }
        
        .prazo-box.reprazo2 {
            border-color: #ef4444;
        }
        
        .prazo-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
        }
        
        .prazo-date {
            font-size: 1rem;
            font-weight: 800;
            color: #0f172a;
            margin-top: 0.25rem;
        }
        
        /* FORMS */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            font-weight: 600;
            font-size: 0.9375rem;
            margin-bottom: 0.5rem;
            color: #334155;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.9375rem;
            font-family: inherit;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .alert-warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
        }

        .prazo-justificativa {
            border: 1px solid #f59e0b;
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            padding: 0.875rem 1rem;
            margin-top: 0.75rem;
            color: #92400e;
            background: transparent;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .export-modal-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.875rem;
        }

        .export-box {
            border: 1px solid #dbe2ea;
            border-radius: 10px;
            padding: 0.875rem 1rem;
            background: #fff;
            min-height: 180px;
        }

        .export-box.compact {
            min-height: auto;
        }

        .export-box h4 {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .export-box hr {
            border: 0;
            border-top: 1px solid #e2e8f0;
            margin: 0 0 0.625rem;
        }

        .export-checkbox-item,
        .export-radio-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.45rem;
            font-size: 0.875rem;
        }

        .export-section-divider {
            border: 0;
            border-top: 1px solid #dbe2ea;
            margin: 1rem 0;
        }

        .d2-image-layout {
            --d2-image-height: 220px;
            display: grid;
            grid-template-columns: repeat(2, minmax(220px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .d2-image-card {
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
        }

        .d2-image-card.green {
            border: 2px solid #16a34a;
        }

        .d2-image-card.red {
            border: 2px solid #dc2626;
        }

        .d2-image-preview {
            width: 100%;
            height: var(--d2-image-height);
            object-fit: cover;
            display: block;
            cursor: zoom-in;
            border: 0;
            box-shadow: none;
        }

        .d2-image-empty {
            width: 100%;
            height: var(--d2-image-height);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            background: #f8fafc;
        }

        .d2-image-label {
            padding: 0.5rem 0.75rem;
            min-height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 700;
            color: #fff;
            background: #334155;
        }

        .d2-image-card.green .d2-image-label {
            background: #16a34a;
        }

        .d2-image-card.red .d2-image-label {
            background: #dc2626;
        }
        
        /* LOGIN */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
        }
        
        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 24px;
            width: 100%;
            max-width: 460px;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 2rem;
            font-weight: 900;
            color: white;
        }
        
        /* DASHBOARD ENHANCEMENTS */
        .metrics-section {
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .lean-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }
        
        .chart-title {
            font-size: 1rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 1.5rem;
        }
        
        /* Bar Chart */
        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .bar-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .bar-label {
            min-width: 100px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #475569;
        }
        
        .bar-container {
            flex: 1;
            height: 32px;
            background: #f1f5f9;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.75rem;
            color: white;
            font-weight: 700;
            font-size: 0.75rem;
            transition: width 0.8s ease;
            border-radius: 8px;
        }
        
        .bar-value {
            min-width: 40px;
            text-align: right;
            font-weight: 700;
            font-size: 0.875rem;
            color: #1e40af;
        }
        
        /* Donut Chart */
        .donut-chart {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .donut-container {
            position: relative;
            width: 200px;
            height: 200px;
        }
        
        .donut-svg {
            transform: rotate(-90deg);
        }
        
        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .donut-total {
            font-size: 2rem;
            font-weight: 900;
            color: #1e40af;
        }
        
        .donut-label-text {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
        }
        
        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .donut-legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .donut-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        
        .donut-legend-label {
            font-size: 0.875rem;
            color: #475569;
            font-weight: 600;
            flex: 1;
        }
        
        .donut-legend-value {
            font-weight: 700;
            font-size: 0.875rem;
            color: #1e40af;
        }
        
        /* Line Chart */
        .line-chart {
            position: relative;
            height: 200px;
        }
        
        .line-chart-svg {
            width: 100%;
            height: 100%;
        }
        
        .line-chart-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
        }
        
        .line-chart-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
        }
        
        /* Tooltips */
        .chart-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        
        .chart-tooltip.active {
            opacity: 1;
        }
        
        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .stagger-1 { animation-delay: 0.1s; opacity: 0; }
        .stagger-2 { animation-delay: 0.2s; opacity: 0; }
        .stagger-3 { animation-delay: 0.3s; opacity: 0; }
        .stagger-4 { animation-delay: 0.4s; opacity: 0; }

        .dashboard-filter-bar {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.25rem;
            background: #ffffff;
            border: 1px solid #dbeafe;
            border-radius: 12px;
            padding: 1rem;
        }

        .dashboard-list-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .pagination-info {
            font-size: 0.82rem;
            color: #64748b;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .top-menu-btn {
                display: inline-flex;
            }

            .sidebar.mobile {
                width: 280px;
                transform: translateX(-100%);
            }

            .sidebar.mobile.open {
                transform: translateX(0);
            }

            .main-content,
            .main-content.sidebar-collapsed {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .lean-metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .donut-chart {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBcrG1TEl6Q4C1Nsu0BJJ0HlZZzcqUNHVc",
            authDomain: "controle-rnc.firebaseapp.com",
            projectId: "controle-rnc",
            storageBucket: "controle-rnc.firebasestorage.app",
            messagingSenderId: "949786734068",
            appId: "1:949786734068:web:1f6e27f35449907a7a1da1"
        };

        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch (error) {
            console.warn('Falha ao inicializar Firebase:', error);
        }

        const SIDEBAR_STATE_KEY = 'magius-sidebar-collapsed';
        const SIDEBAR_COLLAPSED_VALUE = '1';
        const SIDEBAR_EXPANDED_VALUE = '0';
        const SIDEBAR_AUTO_COLLAPSE_BREAKPOINT = 1024;

        // ESTADO GLOBAL
        let state = {
            currentPage: 'login',
            currentUser: null,
            adminTabAtiva: 'pessoas',
            perfilModalAberto: false,
            perfilAbaAtiva: 'perfil',
            alertsModalAberto: false,
            pendingActionAlert: null,
            exportModalAberto: false,
            exportAnalisesSelecionadas: {
                resumoGeral: true,
                volumePecasImpactadas: true,
                statusPrioridade: true,
                tempoPorFase: true,
                leadTimeTotal: true,
                tempoMedioPorFase: true,
                tempoAtrasoPorFase: true,
                numeroReprazosPorRnc: true,
                primeiroPrazoUltimoPrazo: true,
                diasAdicionadosReprazo: true,
                rncsComReprazo: true,
                qtdAcoesCorretivas: true,
                qtdAcoesPreventivas: true,
                tempoMedioImplementacaoAcoes: true,
                acoesNoPrazoForaPrazo: true,
                quantidadeTotalPecas: true,
                quantidadeInspecionada: true,
                quantidadeNaoConforme: true,
                percentualNaoConforme: true,
                taxaRncsNoPrazo: true,
                taxaRncsEmRisco: true,
                taxaReprazos: true,
                rncsEncerradasPeriodo: true
            },
            exportDiretoTipo: 'RNC_GERAL',
            dashboardFilterMonth: new Date().getMonth(),
            dashboardFilterYear: new Date().getFullYear(),
            dashboardSearch: '',
            dashboardPage: 1,
            sidebarCollapsed: (() => {
                try {
                    const persisted = localStorage.getItem(SIDEBAR_STATE_KEY);
                    if (persisted !== null) return persisted === SIDEBAR_COLLAPSED_VALUE;
                } catch (error) {
                    console.warn('Falha ao ler estado do menu lateral:', error);
                }
                return window.innerWidth <= SIDEBAR_AUTO_COLLAPSE_BREAKPOINT;
            })(),
            mobileMenuOpen: false,
            controleFilters: {
                status: '',
                setor: '',
                conclusao: '',
                etapas: '',
                busca: '',
                showExcluidas: false
            },
            controleSort: {
                key: '',
                dir: 'asc'
            },
            movimentacoesFilters: {
                dataInicio: '',
                dataFim: '',
                usuario: '',
                tipoAcao: '',
                modulo: '',
                numeroRnc: ''
            },
            selectedRNC: null,
            activeTab: 'd1',
            activeD4SubTab: 'principal',
            rncs: [
                {
                    id: 1,
                    numero: "RNC-2026-001",
                    cliente: "AutoParts Brasil",
                    codigoPeca: "P-12345",
                    tipoFalha: "Dimensional",
                    responsavel: "Débora Silva",
                    quantidade: 120,
                    faseAtual: "d3",
                    status: "AT_RISK",
                    prioridade: "Alta",
                    setor: "Usinagem",
                    dataAbertura: "2026-02-10",
                    descricao: "Peça fora da tolerância dimensional",
                    d1: { equipe: "Débora Silva, Lucas Santos, Marcos Oliveira", lider: "Débora Silva" },
                    d2: { problema: "Dimensional fora de especificação no furo Ø10mm", is5w2h: "Sim" },
                    d3: { acaoContemcao: "Inspeção 100% do estoque", evidencia: "Relatório de inspeção anexo" },
                    d4: { causaRaiz: "", why1: "", why2: "", why3: "", why4: "", why5: "" },
                    d5: { acoesCorretivas: "" },
                    d6: { planoImplementacao: "", responsavel: "", prazoImplementacao: "" },
                    d7: { acoesPreventivas: "" },
                    d8: { reconhecimento: "", licaoAprendida: "" },
                    prazos: {
                        d1: { original: "2026-02-10", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d2: { original: "2026-02-10", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d3: { original: "2026-02-11", sla: "24 horas", reprazo1: "2026-02-13", reprazo2: null, just1: "Aguardando laboratório", just2: "" },
                        d4: { original: "2026-02-14", sla: "3 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d5: { original: "2026-02-16", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d6: { original: "2026-02-23", sla: "7 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d7: { original: "2026-02-25", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d8: { original: "2026-02-26", sla: "1 dia", reprazo1: null, reprazo2: null, just1: "", just2: "" }
                    }
                },
                {
                    id: 2,
                    numero: "RNC-2026-002",
                    cliente: "Metal Solutions",
                    codigoPeca: "P-67890",
                    tipoFalha: "Acabamento",
                    responsavel: "Marcos Oliveira",
                    quantidade: 45,
                    faseAtual: "d4",
                    status: "ON_TIME",
                    prioridade: "Média",
                    setor: "Pintura",
                    dataAbertura: "2026-02-11",
                    descricao: "Falha no acabamento superficial",
                    d1: { equipe: "Marcos Oliveira, Pedro Costa", lider: "Marcos Oliveira" },
                    d2: { problema: "Bolhas na pintura", is5w2h: "Sim" },
                    d3: { acaoContemcao: "Retrabalho das peças", evidencia: "Fotos anexas" },
                    d4: { causaRaiz: "", why1: "", why2: "", why3: "", why4: "", why5: "" },
                    d5: { acoesCorretivas: "" },
                    d6: { planoImplementacao: "", responsavel: "", prazoImplementacao: "" },
                    d7: { acoesPreventivas: "" },
                    d8: { reconhecimento: "", licaoAprendida: "" },
                    prazos: {
                        d1: { original: "2026-02-11", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d2: { original: "2026-02-11", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d3: { original: "2026-02-12", sla: "24 horas", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d4: { original: "2026-02-15", sla: "3 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d5: { original: "2026-02-17", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d6: { original: "2026-02-24", sla: "7 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d7: { original: "2026-02-26", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d8: { original: "2026-02-27", sla: "1 dia", reprazo1: null, reprazo2: null, just1: "", just2: "" }
                    }
                },
                {
                    id: 3,
                    numero: "RNC-2026-003",
                    cliente: "TechParts Ltd",
                    codigoPeca: "P-11223",
                    tipoFalha: "Montagem",
                    responsavel: "Lucas Santos",
                    quantidade: 85,
                    faseAtual: "d6",
                    status: "ON_TIME",
                    prioridade: "Alta",
                    setor: "Montagem",
                    dataAbertura: "2026-02-05",
                    dataEncerramento: null,
                    descricao: "Erro de montagem",
                    d1: { equipe: "Lucas Santos, Ana Costa", lider: "Lucas Santos" },
                    d2: { problema: "Componente montado invertido", is5w2h: "Sim" },
                    d3: { acaoContemcao: "Desmontagem e remontagem", evidencia: "Check-list anexo" },
                    d4: { causaRaiz: "Falta de procedimento visual", why1: "Sem instrução", why2: "", why3: "", why4: "", why5: "" },
                    d5: { acoesCorretivas: "Criar instrução de trabalho visual" },
                    d6: { planoImplementacao: "Em andamento", responsavel: "Lucas Santos", prazoImplementacao: "2026-02-20" },
                    d7: { acoesPreventivas: "" },
                    d8: { reconhecimento: "", licaoAprendida: "" },
                    prazos: {
                        d1: { original: "2026-02-05", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d2: { original: "2026-02-05", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d3: { original: "2026-02-06", sla: "24 horas", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d4: { original: "2026-02-09", sla: "3 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d5: { original: "2026-02-11", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d6: { original: "2026-02-20", sla: "7 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d7: { original: "2026-02-22", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d8: { original: "2026-02-23", sla: "1 dia", reprazo1: null, reprazo2: null, just1: "", just2: "" }
                    }
                },
                {
                    id: 4,
                    numero: "RNC-2026-004",
                    cliente: "Indústria XYZ",
                    codigoPeca: "P-99887",
                    tipoFalha: "Acabamento",
                    responsavel: "Pedro Costa",
                    quantidade: 200,
                    faseAtual: "d2",
                    status: "ON_TIME",
                    prioridade: "Média",
                    setor: "Acabamento",
                    dataAbertura: "2026-02-12",
                    dataEncerramento: null,
                    descricao: "Risco na superfície",
                    d1: { equipe: "Pedro Costa, Maria Lima", lider: "Pedro Costa" },
                    d2: { problema: "Arranhões na superfície polida", is5w2h: "Em andamento" },
                    d3: { acaoContemcao: "", evidencia: "" },
                    d4: { causaRaiz: "", why1: "", why2: "", why3: "", why4: "", why5: "" },
                    d5: { acoesCorretivas: "" },
                    d6: { planoImplementacao: "", responsavel: "", prazoImplementacao: "" },
                    d7: { acoesPreventivas: "" },
                    d8: { reconhecimento: "", licaoAprendida: "" },
                    prazos: {
                        d1: { original: "2026-02-12", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d2: { original: "2026-02-12", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d3: { original: "2026-02-13", sla: "24 horas", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d4: { original: "2026-02-16", sla: "3 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d5: { original: "2026-02-18", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d6: { original: "2026-02-25", sla: "7 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d7: { original: "2026-02-27", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d8: { original: "2026-02-28", sla: "1 dia", reprazo1: null, reprazo2: null, just1: "", just2: "" }
                    }
                },
                {
                    id: 5,
                    numero: "RNC-2026-005",
                    cliente: "MegaAuto SA",
                    codigoPeca: "P-55443",
                    tipoFalha: "Dimensional",
                    responsavel: "Débora Silva",
                    quantidade: 75,
                    faseAtual: "d5",
                    status: "AT_RISK",
                    prioridade: "Alta",
                    setor: "Usinagem",
                    dataAbertura: "2026-02-08",
                    dataEncerramento: null,
                    descricao: "Diâmetro fora de especificação",
                    d1: { equipe: "Débora Silva, João Mendes", lider: "Débora Silva" },
                    d2: { problema: "Diâmetro externo com variação", is5w2h: "Sim" },
                    d3: { acaoContemcao: "Segregação e inspeção total", evidencia: "Relatório metrológico" },
                    d4: { causaRaiz: "Desgaste da ferramenta", why1: "Ferramenta não calibrada", why2: "Falta de plano de calibração", why3: "", why4: "", why5: "" },
                    d5: { acoesCorretivas: "Implementar plano de calibração" },
                    d6: { planoImplementacao: "", responsavel: "", prazoImplementacao: "" },
                    d7: { acoesPreventivas: "" },
                    d8: { reconhecimento: "", licaoAprendida: "" },
                    prazos: {
                        d1: { original: "2026-02-08", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d2: { original: "2026-02-08", sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d3: { original: "2026-02-09", sla: "24 horas", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d4: { original: "2026-02-12", sla: "3 dias", reprazo1: "2026-02-14", reprazo2: null, just1: "Aguardando análise metrológica", just2: "" },
                        d5: { original: "2026-02-14", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d6: { original: "2026-02-21", sla: "7 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d7: { original: "2026-02-23", sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                        d8: { original: "2026-02-24", sla: "1 dia", reprazo1: null, reprazo2: null, just1: "", just2: "" }
                    }
                }
            ]
        };

        const defaultEmailTemplates = {
            fase: {
                assunto: 'Escalonamento de fase - {{numero_rnc}}',
                corpo: 'RNC {{numero_rnc}} / Cliente {{cliente}}.\nFase: {{fase}}.\nResponsável: {{responsavel}}.\nDias em atraso: {{dias_atraso}}.\nRe-prazos da fase: {{quantidade_reprazo}}.\nData de referência: {{data_referencia}}.'
            },
            acao: {
                assunto: 'Escalonamento de ação - {{numero_rnc}}',
                corpo: 'RNC {{numero_rnc}} / Cliente {{cliente}}.\nAção: {{acao}}.\nResponsável: {{responsavel}}.\nDias em atraso: {{dias_atraso}}.\nRe-prazos da ação: {{quantidade_reprazo}}.\nData de referência: {{data_referencia}}.'
            },
            prazoTotal: {
                assunto: 'Escalonamento de prazo total - {{numero_rnc}}',
                corpo: 'RNC {{numero_rnc}} ultrapassou o prazo total de 30 dias.\nCliente: {{cliente}}.\nFase atual: {{fase}}.\nResponsável: {{responsavel}}.\nData de referência: {{data_referencia}}.'
            }
        };

        let emailTemplatesBase = {
            ...defaultEmailTemplates
        };
        let auditoriaAdmin = [];

        // Dados históricos para tendências (últimos 6 meses)
        const historicalData = {
            monthlyRNCs: [
                { month: "Set/25", count: 3, onTime: 2, atRisk: 1 },
                { month: "Out/25", count: 5, onTime: 4, atRisk: 1 },
                { month: "Nov/25", count: 4, onTime: 3, atRisk: 1 },
                { month: "Dez/25", count: 6, onTime: 4, atRisk: 2 },
                { month: "Jan/26", count: 7, onTime: 5, atRisk: 2 },
                { month: "Fev/26", count: 5, onTime: 3, atRisk: 2 }
            ],
            previousMonth: {
                total: 7,
                onTime: 5,
                atRisk: 2,
                avgLeadTime: 14.5
            }
        };

        const users = [
            { id: 1, name: "Débora Silva", email: "debora@empresa.com", role: "Coordenadora de Qualidade", profile: "ADMIN", planta: "Matriz", initials: "DS" }
        ];
        const SENHA_PADRAO_SISTEMA = 'Magius@123';
        const MIN_DELETE_REASON_LENGTH = 10;
        const userPasswords = { "debora@empresa.com": SENHA_PADRAO_SISTEMA };

        let pessoasBase = [
            { id: 1, nome: "Lucas Santos", cargo: "Analista de Engenharia", setor: "Engenharia", planta: "Planta A", gerente: "Carlos Mendes", emailGerencia: "carlos.mendes@empresa.com", email: "lucas.santos@empresa.com", perfilAcesso: "USUARIO", status: "Ativo" },
            { id: 2, nome: "Ana Costa", cargo: "Analista de Engenharia", setor: "Engenharia", planta: "Planta B", gerente: "Carlos Mendes", emailGerencia: "carlos.mendes@empresa.com", email: "ana.costa@empresa.com", perfilAcesso: "USUARIO", status: "Ativo" },
            { id: 3, nome: "Débora Silva", cargo: "Analista da Qualidade", setor: "Qualidade", planta: "Planta A", gerente: "Fernanda Rocha", emailGerencia: "fernanda.rocha@empresa.com", email: "debora@empresa.com", perfilAcesso: "ADMIN", status: "Ativo" },
            { id: 4, nome: "Marcos Oliveira", cargo: "Analista da Qualidade", setor: "Qualidade", planta: "Planta A", gerente: "Fernanda Rocha", emailGerencia: "fernanda.rocha@empresa.com", email: "marcos.oliveira@empresa.com", perfilAcesso: "USUARIO", status: "Ativo" },
            { id: 5, nome: "Pedro Costa", cargo: "Responsável pela Contenção", setor: "Produção", planta: "Planta B", gerente: "Joana Almeida", emailGerencia: "joana.almeida@empresa.com", email: "pedro.costa@empresa.com", perfilAcesso: "USUARIO", status: "Ativo" },
            { id: 6, nome: "Maria Lima", cargo: "Analista de PCP", setor: "PCP", planta: "Planta A", gerente: "Rafael Souza", emailGerencia: "rafael.souza@empresa.com", email: "maria.lima@empresa.com", perfilAcesso: "USUARIO", status: "Ativo" },
            { id: 7, nome: "João Mendes", cargo: "Técnico de Processo", setor: "Processos", planta: "Planta B", gerente: "Carlos Mendes", emailGerencia: "carlos.mendes@empresa.com", email: "joao.mendes@empresa.com", perfilAcesso: "USUARIO", status: "Ativo" }
        ];
        let modosFalhaBase = [
            { id: 1, nome: "Dimensional", descricao: "", status: "Ativo" },
            { id: 2, nome: "Acabamento", descricao: "", status: "Ativo" },
            { id: 3, nome: "Montagem", descricao: "", status: "Ativo" }
        ];
        let clientesBase = [
            { id: 1, nome: "AutoParts Brasil", codigo: "", fotoNome: "", fotoConteudo: "", status: "Ativo" },
            { id: 2, nome: "Metal Solutions", codigo: "", fotoNome: "", fotoConteudo: "", status: "Ativo" },
            { id: 3, nome: "TechParts Ltd", codigo: "", fotoNome: "", fotoConteudo: "", status: "Ativo" },
            { id: 4, nome: "Indústria XYZ", codigo: "", fotoNome: "", fotoConteudo: "", status: "Ativo" },
            { id: 5, nome: "MegaAuto SA", codigo: "", fotoNome: "", fotoConteudo: "", status: "Ativo" }
        ];

        const phases = [
            { id: 'd1', name: 'D1 - Equipe', short: 'D1' },
            { id: 'd2', name: 'D2 - Problema', short: 'D2' },
            { id: 'd3', name: 'D3 - Contenção', short: 'D3' },
            { id: 'd4', name: 'D4 - Causa Raiz', short: 'D4' },
            { id: 'd5', name: 'D5 - Ações Corretivas', short: 'D5' },
            { id: 'd6', name: 'D6 - Implementação', short: 'D6' },
            { id: 'd7', name: 'D7 - Prevenção', short: 'D7' },
            { id: 'd8', name: 'D8 - Encerramento', short: 'D8' }
        ];

        function renderIcon(type) {
            const icons = {
                chart: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19V5"/><path d="M10 19V9"/><path d="M16 19V13"/><path d="M22 19V3"/></svg>',
                check: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="m5 13 4 4L19 7"/></svg>',
                alert: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v4"/><path d="M12 17h.01"/><path d="M10.3 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.7 3.86a2 2 0 0 0-3.4 0z"/></svg>',
                time: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></svg>',
                metrics: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 17 6-6 4 4 7-7"/><path d="M14 8h6v6"/></svg>',
                analytics: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>',
                list: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 6h12"/><path d="M9 12h12"/><path d="M9 18h12"/><circle cx="4" cy="6" r="1"/><circle cx="4" cy="12" r="1"/><circle cx="4" cy="18" r="1"/></svg>',
                bell: '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 1 0-12 0v3.2a2 2 0 0 1-.6 1.4L4 17h5"/><path d="M9 17a3 3 0 0 0 6 0"/></svg>',
                report: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M8 13h8"/><path d="M8 17h8"/><path d="M8 9h2"/></svg>',
                trash: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>',
                menu: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16"/><path d="M4 12h16"/><path d="M4 17h16"/></svg>',
                dashboard: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="8" height="8" rx="1"/><rect x="13" y="3" width="8" height="5" rx="1"/><rect x="13" y="10" width="8" height="11" rx="1"/><rect x="3" y="13" width="8" height="8" rx="1"/></svg>',
                control: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18"/><path d="M12 3v18"/><circle cx="12" cy="12" r="9"/></svg>',
                register: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3h8"/><path d="M9 3v4"/><path d="M15 3v4"/><rect x="4" y="7" width="16" height="14" rx="2"/><path d="M8 12h8"/><path d="M8 16h6"/></svg>',
                base: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="8" ry="3"/><path d="M4 5v6c0 1.7 3.6 3 8 3s8-1.3 8-3V5"/><path d="M4 11v6c0 1.7 3.6 3 8 3s8-1.3 8-3v-6"/></svg>',
                logs: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h12"/><path d="M8 12h12"/><path d="M8 18h12"/><circle cx="4" cy="6" r="1"/><circle cx="4" cy="12" r="1"/><circle cx="4" cy="18" r="1"/></svg>',
                logout: '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="m16 17 5-5-5-5"/><path d="M21 12H9"/></svg>'
            };
            return icons[type] || icons.chart;
        }

        function normalizeEmail(email) {
            return String(email || '').trim().toLowerCase();
        }

        function getUserPassword(email) {
            const emailNormalizado = normalizeEmail(email);
            if (!emailNormalizado) return '';
            return userPasswords[emailNormalizado] || SENHA_PADRAO_SISTEMA;
        }

        function setUserPassword(email, senha) {
            const emailNormalizado = normalizeEmail(email);
            if (!emailNormalizado) return;
            userPasswords[emailNormalizado] = String(senha || '');
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function getSafeImageSrc(value) {
            const src = String(value || '');
            return /^data:image\/(?:jpeg|jpg|png|gif|webp);base64,[a-zA-Z0-9+/=]+$/.test(src) ? src : '';
        }

        function abrirImagemModal(src, titulo) {
            const safeSrc = getSafeImageSrc(src);
            if (!safeSrc) return;
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1004';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 900px;" onclick="event.stopPropagation()" tabindex="0" role="dialog" aria-labelledby="image-modal-title" aria-label="Visualização ampliada de imagem">
                    <div class="modal-header">
                        <h2 class="modal-title" id="image-modal-title"></h2>
                        <button class="modal-close" data-close-image-modal>×</button>
                    </div>
                    <div class="modal-body" style="text-align:center;">
                        <img src="${escapeHtml(safeSrc)}" alt="${escapeHtml(titulo)}" style="max-width:100%; max-height:70vh; border-radius:10px; border:1px solid #e2e8f0;">
                    </div>
                </div>
            `;
            const fecharModal = () => {
                document.removeEventListener('keydown', onEscape);
                overlay.remove();
            };
            const onEscape = (event) => {
                if (event.key === 'Escape') fecharModal();
            };
            document.body.appendChild(overlay);
            const modalTitle = overlay.querySelector('#image-modal-title');
            if (modalTitle) modalTitle.textContent = titulo;
            const modalContent = overlay.querySelector('.modal-content');
            if (modalContent) modalContent.focus();
            document.addEventListener('keydown', onEscape);
            overlay.onclick = (e) => e.target === overlay && fecharModal();
            overlay.querySelector('[data-close-image-modal]').onclick = () => fecharModal();
        }

        function formatDateSafe(dateText) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(String(dateText || ''))) return '-';
            const parsed = new Date(`${dateText}T00:00:00`);
            if (Number.isNaN(parsed.getTime())) return '-';
            return parsed.toLocaleDateString('pt-BR');
        }

        function extractAndFormatDate(dateTimeText) {
            const value = String(dateTimeText || '');
            const dateOnly = /^\d{4}-\d{2}-\d{2}/.test(value) ? value.slice(0, 10) : '';
            return formatDateSafe(dateOnly);
        }

        function getUltimoPorquePreenchido(analise) {
            for (let i = 5; i > 0; i--) {
                const valor = String(analise?.[`why${i}`] || '').trim();
                if (valor) return valor;
            }
            return '';
        }

        function consolidateD4Data(d4) {
            d4.ocorrencia = d4.ocorrencia || { why1: '', why2: '', why3: '', why4: '', why5: '' };
            d4.deteccao = d4.deteccao || { why1: '', why2: '', why3: '', why4: '', why5: '' };
            d4.causaRaizOcorrencia = getUltimoPorquePreenchido(d4.ocorrencia);
            d4.causaRaizDeteccao = getUltimoPorquePreenchido(d4.deteccao);
            // Compatibilidade com estrutura legada do D4.
            for (let i = 1; i <= 5; i++) d4[`why${i}`] = d4.ocorrencia[`why${i}`];
            d4.causaRaiz = d4.causaRaizOcorrencia || '';
        }

        function ensureD4Structure(rnc) {
            if (!rnc.d4) rnc.d4 = {};
            rnc.d4.ocorrencia = rnc.d4.ocorrencia || {
                why1: rnc.d4.why1 || '',
                why2: rnc.d4.why2 || '',
                why3: rnc.d4.why3 || '',
                why4: rnc.d4.why4 || '',
                why5: rnc.d4.why5 || ''
            };
            rnc.d4.deteccao = rnc.d4.deteccao || {
                why1: '',
                why2: '',
                why3: '',
                why4: '',
                why5: ''
            };
            consolidateD4Data(rnc.d4);
        }

        function sincronizarD4EmEdicao() {
            if (!state.selectedRNC || state.activeTab !== 'd4') return;
            ensureD4Structure(state.selectedRNC);
            const d4 = state.selectedRNC.d4;
            for (let i = 1; i <= 5; i++) {
                const oc = document.getElementById(`d4-oc-why${i}`);
                const det = document.getElementById(`d4-det-why${i}`);
                if (oc) d4.ocorrencia[`why${i}`] = oc.value;
                if (det) d4.deteccao[`why${i}`] = det.value;
            }
            consolidateD4Data(d4);
        }

        function getPessoaById(id) {
            return pessoasBase.find(pessoa => pessoa.id === Number(id));
        }

        function isRegistroAtivo(item) {
            return String(item?.status || 'Ativo').toLowerCase() !== 'inativo';
        }

        function getPessoasAtivas() {
            return pessoasBase.filter(isRegistroAtivo);
        }

        function getClientesAtivos() {
            return clientesBase.filter(isRegistroAtivo);
        }

        function getModosFalhaAtivos() {
            return modosFalhaBase.filter(isRegistroAtivo);
        }

        function isCurrentUserAdmin() {
            return String(state.currentUser?.profile || '').toUpperCase() === 'ADMIN';
        }

        function isMobileView() {
            return window.innerWidth <= 768;
        }

        function persistSidebarState() {
            try {
                localStorage.setItem(SIDEBAR_STATE_KEY, state.sidebarCollapsed ? SIDEBAR_COLLAPSED_VALUE : SIDEBAR_EXPANDED_VALUE);
            } catch (error) {
                console.warn('Falha ao persistir estado do menu lateral:', error);
            }
        }

        function toggleSidebar() {
            if (isMobileView()) {
                state.mobileMenuOpen = !state.mobileMenuOpen;
                render();
                return;
            }
            state.sidebarCollapsed = !state.sidebarCollapsed;
            persistSidebarState();
            render();
        }

        function isRncExcluida(rnc) {
            return String(rnc?.status || '').toUpperCase() === 'EXCLUIDA';
        }

        function isRncAtiva(rnc) {
            return !isRncExcluida(rnc);
        }

        function registrarMovimentacao({ tipoAcao, modulo, referencia = '', descricao = '', usuario, perfil, data } = {}) {
            const registro = {
                data: data || new Date().toISOString(),
                usuario: usuario || state.currentUser?.name || 'Sistema',
                perfil: (perfil || state.currentUser?.profile || 'SISTEMA').toUpperCase(),
                tipoAcao: String(tipoAcao || 'EDIÇÃO').toUpperCase(),
                modulo: String(modulo || 'Sistema'),
                referencia: String(referencia || ''),
                descricao: String(descricao || '')
            };
            registro.acao = registro.tipoAcao;
            registro.detalhe = `${registro.modulo}${registro.referencia ? ` • ${registro.referencia}` : ''} • ${registro.descricao}`;
            registro.por = registro.usuario;
            auditoriaAdmin.unshift(registro);
            auditoriaAdmin = auditoriaAdmin.slice(0, MAX_ADMIN_AUDIT_RECORDS);
            if (db) {
                salvarCadastrosBaseNoFirebase().catch(() => {});
            }
        }

        function registrarAuditoriaAdmin(acao, detalhe, extras = {}) {
            registrarMovimentacao({
                tipoAcao: extras.tipoAcao || acao || 'EDIÇÃO',
                modulo: extras.modulo || 'Admin',
                referencia: extras.referencia || '',
                descricao: detalhe || extras.descricao || '',
                usuario: extras.usuario,
                perfil: extras.perfil,
                data: extras.data
            });
        }

        function aplicarTemplateEmail(template, contexto = {}) {
            return String(template || '').replace(/\{\{([a-z_]+)\}\}/gi, (_, rawKey) => {
                const key = String(rawKey || '').trim();
                return escapeHtml(contexto[key] ?? '');
            });
        }

        function getTemplateEscalonamento(tipo) {
            const tipoNorm = String(tipo || '').toUpperCase();
            const key = tipoNorm.includes('ACAO')
                ? 'acao'
                : (tipoNorm === 'PRAZO_TOTAL_RNC' ? 'prazoTotal' : 'fase');
            return emailTemplatesBase[key] || defaultEmailTemplates[key];
        }

        function getPessoaEmailGerenciaById(id) {
            const pessoa = getPessoaById(id);
            return pessoa?.emailGerencia ? String(pessoa.emailGerencia).trim() : '';
        }

        function getPessoasOptions() {
            return getPessoasAtivas().map(pessoa => `
                <option value="${pessoa.id}">${escapeHtml(pessoa.nome)} - ${escapeHtml(pessoa.cargo)} (${escapeHtml(pessoa.setor)} / ${escapeHtml(pessoa.planta)})</option>
            `).join('');
        }

        function getOutrosEnvolvidosSelecionados() {
            const hidden = document.getElementById('outrosEnvolvidosIds');
            if (!hidden || !hidden.value) return [];
            const value = String(hidden.value || '').trim();
            if (!value) return [];
            return value.split(',').map(id => Number(id)).filter(id => Number.isFinite(id) && id > 0);
        }

        function renderOutrosEnvolvidosSelecionados() {
            const container = document.getElementById('outrosEnvolvidosSelecionados');
            if (!container) return;
            const selecionados = getOutrosEnvolvidosSelecionados();
            if (!selecionados.length) {
                container.innerHTML = '<p style="font-size:0.8125rem; color:#64748b;">Nenhum envolvido adicional selecionado.</p>';
                return;
            }
            container.innerHTML = selecionados.map(id => {
                const pessoa = getPessoaById(id);
                if (!pessoa) return '';
                return `
                    <span style="display:inline-flex; align-items:center; gap:0.35rem; border:1px solid #cbd5e1; border-radius:999px; padding:0.25rem 0.6rem; font-size:0.8125rem;">
                        ${escapeHtml(pessoa.nome)} (${escapeHtml(pessoa.cargo)} • ${escapeHtml(pessoa.planta)})
                        <button type="button" data-outro-id="${pessoa.id}" class="btn-remover-outro" style="border:none; background:transparent; color:#dc2626; cursor:pointer; font-weight:700;">×</button>
                    </span>
                `;
            }).join('');
        }

        function montarEquipeD1(rnc) {
            const equipe = [];
            if (rnc.equipeResponsavel?.responsavelContencaoId) {
                const pessoa = getPessoaById(rnc.equipeResponsavel.responsavelContencaoId);
                if (pessoa) equipe.push({ pessoa, funcaoRnc: "Responsável pela Contenção" });
            }
            if (rnc.equipeResponsavel?.analistaEngenhariaId) {
                const pessoa = getPessoaById(rnc.equipeResponsavel.analistaEngenhariaId);
                if (pessoa) equipe.push({ pessoa, funcaoRnc: "Analista de Engenharia" });
            }
            if (rnc.equipeResponsavel?.analistaQualidadeId) {
                const pessoa = getPessoaById(rnc.equipeResponsavel.analistaQualidadeId);
                if (pessoa) equipe.push({ pessoa, funcaoRnc: "Analista da Qualidade" });
            }
            (rnc.equipeResponsavel?.outrosEnvolvidosIds || []).forEach(id => {
                const pessoa = getPessoaById(id);
                if (pessoa) equipe.push({ pessoa, funcaoRnc: "Outros Envolvidos" });
            });
            if (equipe.length > 0) return equipe;

            const nomesLegados = (rnc.d1?.equipe || '').split(',').map(nome => nome.trim()).filter(Boolean);
            // Regra de compatibilidade para registros antigos sem papéis estruturados por ID.
            return nomesLegados.map(nome => {
                const pessoa = pessoasBase.find(item => item.nome === nome) || { id: null, nome, cargo: "-", setor: "-", planta: "-" };
                return { pessoa, funcaoRnc: nome === rnc.d1?.lider ? "Analista da Qualidade" : "Outros Envolvidos" };
            });
        }

        function getEquipeMembroKey(item) {
            if (item?.pessoa?.id) return `id-${item.pessoa.id}`;
            return `nome-${String(item?.pessoa?.nome || '').replace(/[^a-zA-Z0-9_-]/g, '_')}`;
        }

        function ensureD8Structure(rnc) {
            if (!rnc.d8) rnc.d8 = {};
            if (typeof rnc.d8.licaoAprendida !== 'string') rnc.d8.licaoAprendida = '';
            if (typeof rnc.d8.mensagemFinal !== 'string') rnc.d8.mensagemFinal = rnc.d8.reconhecimento || '';
            if (!rnc.d8.reconhecimentoIndividual || typeof rnc.d8.reconhecimentoIndividual !== 'object') rnc.d8.reconhecimentoIndividual = {};
            if (typeof rnc.d8.concluida !== 'boolean') rnc.d8.concluida = false;
            if (typeof rnc.d8.dataConclusao !== 'string') rnc.d8.dataConclusao = '';
        }

        function getPendenciasConclusaoD8(rnc) {
            const pendencias = [];
            if (!(rnc.d8?.licaoAprendida || '').trim()) pendencias.push('Preencha o campo obrigatório de lições aprendidas.');
            const acoesCorretivas = (rnc.d5?.listaAcoes || []).map(normalizeAcaoD5);
            const acoesPreventivas = (rnc.d7?.listaAcoes || []).map(normalizeAcaoD7);
            if (acoesCorretivas.some(acao => acao.status !== 'CONCLUIDA')) pendencias.push('Conclua todas as ações corretivas (D5/D6).');
            if (acoesPreventivas.some(acao => acao.status !== 'CONCLUIDA')) pendencias.push('Conclua todas as ações preventivas (D7).');
            return pendencias;
        }

        function isEtapaConcluida(rnc, phaseId) {
            if (phaseId === 'd1') return true;
            if (phaseId === 'd2') {
                // D2 é concluída no cadastro; fallback garante compatibilidade com registros legados.
                return rnc.d2?.etapaConcluida === true || (!!String(rnc.descricao || '').trim() && !!String(rnc.cliente || '').trim() && !!String(rnc.tipoFalha || '').trim());
            }
            if (phaseId === 'd3') return !!rnc.d3?.etapaConcluida;
            if (phaseId === 'd4') {
                ensureD4Structure(rnc);
                return !!(getUltimoPorquePreenchido(rnc.d4.ocorrencia) && getUltimoPorquePreenchido(rnc.d4.deteccao));
            }
            // No D5 a conclusão considera ações cadastradas, não necessariamente concluídas.
            if (phaseId === 'd5') return (rnc.d5?.listaAcoes || []).map(normalizeAcaoD5).length > 0;
            if (phaseId === 'd6') {
                const acoes = (rnc.d5?.listaAcoes || []).map(normalizeAcaoD5);
                return acoes.length > 0 && acoes.every(acao =>
                    acao.status === 'CONCLUIDA' &&
                    (!!acao.before_image_url || (acao.evidencias?.length || 0) > 0) &&
                    (!!acao.after_image_url || (acao.evidencias?.length || 0) > 0)
                );
            }
            if (phaseId === 'd7') {
                const acoes = (rnc.d7?.listaAcoes || []).map(normalizeAcaoD7);
                return acoes.length > 0 && acoes.every(acao => acao.status === 'CONCLUIDA' && (acao.evidencias?.length || 0) > 0);
            }
            if (phaseId === 'd8') return !!rnc.d8?.concluida;
            return false;
        }

        function canAcessarEtapa(rnc, phaseId) {
            const targetIndex = phases.findIndex(p => p.id === phaseId);
            if (targetIndex <= 0) return true;
            for (let i = 0; i < targetIndex; i++) {
                if (!isEtapaConcluida(rnc, phases[i].id)) return false;
            }
            return true;
        }

        function getPrimeiraEtapaPendente(rnc) {
            const pendente = phases.find(phase => !isEtapaConcluida(rnc, phase.id));
            return pendente ? pendente.id : null;
        }

        function sincronizarFluxo8D(rnc) {
            if (!rnc) return;
            const proximaEtapa = getPrimeiraEtapaPendente(rnc);
            rnc.faseAtual = proximaEtapa || 'd8';
        }

        function getResponsavelRNC(rnc) {
            return getPessoaById(rnc.equipeResponsavel?.analistaQualidadeId)?.nome || rnc.responsavel || rnc.d1?.lider || '-';
        }

        function getResponsavelFase(rnc, phaseId) {
            if (!rnc) return '-';
            if (['d3', 'd4', 'd5'].includes(phaseId)) {
                return getPessoaById(rnc.equipeResponsavel?.responsavelContencaoId)?.nome || getResponsavelRNC(rnc);
            }
            if (['d7', 'd8'].includes(phaseId)) {
                return getPessoaById(rnc.equipeResponsavel?.analistaQualidadeId)?.nome || getResponsavelRNC(rnc);
            }
            return getResponsavelRNC(rnc);
        }

        function getEmailGerenciaResponsavelFase(rnc, phaseId) {
            if (!rnc) return '';
            if (['d3', 'd4', 'd5'].includes(phaseId)) return getPessoaEmailGerenciaById(rnc.equipeResponsavel?.responsavelContencaoId);
            if (['d7', 'd8'].includes(phaseId)) return getPessoaEmailGerenciaById(rnc.equipeResponsavel?.analistaQualidadeId);
            return getPessoaEmailGerenciaById(rnc.equipeResponsavel?.analistaQualidadeId);
        }

        function getLabelCurtoFase(phaseId) {
            const phase = phases.find(item => item.id === phaseId);
            return `${phase?.short || String(phaseId || '').toUpperCase()} – ${String(phase?.name || '').replace(/^D\d+\s*-\s*/i, '').trim() || 'Etapa'}`;
        }

        function isAcaoEmAtrasoAberta(acao, normalizador) {
            const acaoNormalizada = normalizador(acao);
            if (acaoNormalizada.status === 'CONCLUIDA') return false;
            return obterIndicadorPrazoAcao(acaoNormalizada).className === 'red';
        }

        function isRncEmRisco(rnc) {
            if (isEtapaConcluida(rnc, 'd8')) return false;
            if (isPrazoTotalRncExcedido(rnc)) return true;
            const etapasAtrasadas = getEtapasEmAtraso(rnc);
            if (etapasAtrasadas.length > 0) return true;
            const acoesCorretivasAtrasadas = (rnc.d5?.listaAcoes || []).some(acao => isAcaoEmAtrasoAberta(acao, normalizeAcaoD5));
            if (acoesCorretivasAtrasadas) return true;
            const acoesPreventivasAtrasadas = (rnc.d7?.listaAcoes || []).some(acao => isAcaoEmAtrasoAberta(acao, normalizeAcaoD7));
            return acoesPreventivasAtrasadas;
        }

        function getStatusRncValue(rnc) {
            return isRncEmRisco(rnc) ? 'AT_RISK' : 'ON_TIME';
        }

        function getRNCsBaseAlerta() {
            const rncsFiltradas = getDashboardCompetenciaRncs();
            const base = rncsFiltradas.length ? rncsFiltradas : state.rncs;
            return base.filter(rnc => isRncAtiva(rnc) && !isEtapaConcluida(rnc, 'd8'));
        }

        function getPrazoGeralRNC(rnc) {
            const faseAtual = rnc?.faseAtual && rnc.prazos?.[rnc.faseAtual] ? rnc.faseAtual : 'd8';
            return getPrazoVigenteEtapa(rnc?.prazos?.[faseAtual]);
        }

        function getAlertasSistema() {
            const hojeISO = new Date().toISOString().slice(0, 10);
            const rncsBase = getRNCsBaseAlerta();
            const acoesAtrasadas = [];
            const rncsProximasVencimento = [];
            const rncsEmRisco = [];

            const getHistoricoPrazosReprazos = (rnc) => {
                const faseAtual = getFaseAtualDefinida(rnc);
                const prazoFase = rnc?.prazos?.[faseAtual];
                const historico = [prazoFase?.original, prazoFase?.reprazo1, prazoFase?.reprazo2].filter(Boolean).map(formatDateSafe);
                return historico.length ? historico.join(' → ') : 'Sem histórico registrado';
            };

            rncsBase.forEach(rnc => {
                registrarEscalonamentoPrazoTotalRNC(rnc);
                const acoesCorretivas = (rnc.d5?.listaAcoes || []).map(normalizeAcaoD5);
                acoesCorretivas.forEach(acao => {
                    const indicador = obterIndicadorPrazoAcao(acao);
                    if (acao.status !== 'CONCLUIDA' && indicador.className === CLASS_INDICADOR_ATRASO) {
                        const prazoVigente = obterPrazoVigenteAcao(acao);
                        const atrasoDias = Number(diffDays(prazoVigente, hojeISO) || 0);
                        acoesAtrasadas.push({
                            tipo: 'CORRETIVA',
                            rncId: rnc.id,
                            rncNumero: rnc.numero,
                            acaoId: acao.id,
                            descricao: acao.descricao || 'Ação sem descrição',
                            responsavel: getPessoaById(acao.responsavelId)?.nome || acao.responsavel || getResponsavelRNC(rnc),
                            prazo: prazoVigente,
                            atrasoDias,
                            historico: (acao.reprazos || []).map(item => `${formatDateSafe(item.data)} (${item.justificativa || '-'})`).join(' • ')
                        });
                    }
                });

                const acoesPreventivas = (rnc.d7?.listaAcoes || []).map(normalizeAcaoD7);
                acoesPreventivas.forEach(acao => {
                    const indicador = obterIndicadorPrazoAcao(acao);
                    if (acao.status !== 'CONCLUIDA' && indicador.className === CLASS_INDICADOR_ATRASO) {
                        const prazoVigente = obterPrazoVigenteAcao(acao);
                        const atrasoDias = Number(diffDays(prazoVigente, hojeISO) || 0);
                        acoesAtrasadas.push({
                            tipo: 'PREVENTIVA',
                            rncId: rnc.id,
                            rncNumero: rnc.numero,
                            acaoId: acao.id,
                            descricao: acao.descricao || 'Ação preventiva sem descrição',
                            responsavel: getPessoaById(acao.responsavelId)?.nome || acao.responsavel || getResponsavelRNC(rnc),
                            prazo: prazoVigente,
                            atrasoDias,
                            historico: (acao.reprazos || []).map(item => `${formatDateSafe(item.data)} (${item.justificativa || '-'})`).join(' • ')
                        });
                    }
                });

                const prazoGeral = getPrazoGeralRNC(rnc);
                const hoje = parseISODate(hojeISO);
                const prazoGeralDate = parseISODate(prazoGeral);
                const diasAteVencimento = (hoje && prazoGeralDate)
                    ? Math.floor((prazoGeralDate.getTime() - hoje.getTime()) / (24 * 60 * 60 * 1000))
                    : Number.NaN;
                if (prazoGeral && !Number.isNaN(diasAteVencimento) && diasAteVencimento >= 0 && diasAteVencimento <= DIAS_ALERTA_VENCIMENTO_RNC) {
                    rncsProximasVencimento.push({
                        rncId: rnc.id,
                        rncNumero: rnc.numero,
                        faseAtual: phases.find(p => p.id === rnc.faseAtual)?.name || 'Etapa em andamento',
                        vencimento: prazoGeral,
                        historico: getHistoricoPrazosReprazos(rnc)
                    });
                }

                if (isRncEmRisco(rnc)) {
                    const faseAtual = getFaseAtualDefinida(rnc);
                    const etapaCritica = getEtapasEmAtraso(rnc)[0]?.phaseName || (phases.find(p => p.id === faseAtual)?.name || 'Etapa em andamento');
                    const atrasos = getEtapasEmAtraso(rnc);
                    const prazoTotalAtraso = isPrazoTotalRncExcedido(rnc)
                        ? Number(diffDays(addDaysToISO(rnc.dataAbertura, PRAZO_TOTAL_RNC_DIAS), hojeISO) || 0)
                        : 0;
                    rncsEmRisco.push({
                        rncId: rnc.id,
                        rncNumero: rnc.numero,
                        etapaCritica,
                        diasAtraso: Math.max(0, ...atrasos.map(item => Number(diffDays(item.vencimento, hojeISO) || 0)), prazoTotalAtraso),
                        historico: getHistoricoPrazosReprazos(rnc),
                        reprazoInfo: getGovernancaReprazoFase(rnc, faseAtual).texto
                    });
                }
            });

            acoesAtrasadas.sort((a, b) => b.atrasoDias - a.atrasoDias);
            rncsProximasVencimento.sort((a, b) => (parseISODate(a.vencimento)?.getTime() || 0) - (parseISODate(b.vencimento)?.getTime() || 0));
            rncsEmRisco.sort((a, b) => (b.diasAtraso || 0) - (a.diasAtraso || 0));

            return {
                acoesAtrasadas,
                rncsProximasVencimento,
                rncsEmRisco,
                total: acoesAtrasadas.length + rncsProximasVencimento.length + rncsEmRisco.length
            };
        }

        function getDashboardCompetenciaRncs() {
            return state.rncs.filter(rnc => {
                if (!isRncAtiva(rnc)) return false;
                if (!rnc?.dataAbertura) return false;
                const abertura = new Date(rnc.dataAbertura);
                if (Number.isNaN(abertura.getTime())) return false;
                return abertura.getMonth() === Number(state.dashboardFilterMonth) &&
                    abertura.getFullYear() === Number(state.dashboardFilterYear);
            });
        }

        function buildCompetenciaTrendData() {
            const series = [];
            const baseDate = new Date(Number(state.dashboardFilterYear), Number(state.dashboardFilterMonth), 1);
            for (let i = 5; i >= 0; i--) {
                const pointDate = new Date(baseDate.getFullYear(), baseDate.getMonth() - i, 1);
                const month = pointDate.toLocaleDateString('pt-BR', { month: 'short' }).replace('.', '');
                const yearShort = String(pointDate.getFullYear()).slice(-2);
                const count = state.rncs.filter(rnc => {
                    if (!isRncAtiva(rnc)) return false;
                    if (!rnc?.dataAbertura) return false;
                    const abertura = new Date(rnc.dataAbertura);
                    return !Number.isNaN(abertura.getTime()) &&
                        abertura.getMonth() === pointDate.getMonth() &&
                        abertura.getFullYear() === pointDate.getFullYear();
                }).length;
                series.push({ month: `${month.charAt(0).toUpperCase()}${month.slice(1)}/${yearShort}`, count });
            }
            return series;
        }

        function parseISODate(dateValue) {
            const value = String(dateValue || '');
            const dateOnly = /^\d{4}-\d{2}-\d{2}/.test(value) ? value.slice(0, 10) : '';
            if (!dateOnly) return null;
            const parsed = new Date(`${dateOnly}T00:00:00`);
            if (Number.isNaN(parsed.getTime())) return null;
            return parsed;
        }

        function diffDays(startDateValue, endDateValue) {
            const start = parseISODate(startDateValue);
            const end = parseISODate(endDateValue);
            if (!start || !end) return '';
            const msPerDay = 24 * 60 * 60 * 1000;
            return Math.max(0, Math.floor((end.getTime() - start.getTime()) / msPerDay));
        }

        function addDaysToISO(dateValue, days) {
            const parsed = parseISODate(dateValue);
            if (!parsed) return '';
            parsed.setDate(parsed.getDate() + Number(days || 0));
            return parsed.toISOString().slice(0, 10);
        }

        function getRNCsPeriodoAnalitico() {
            return getDashboardCompetenciaRncs();
        }

        function getTotalReprazosRNC(rnc) {
            return getReprazoCountEtapas(rnc)
                + getReprazoCountAcoes(rnc?.d5?.listaAcoes, normalizeAcaoD5)
                + getReprazoCountAcoes(rnc?.d7?.listaAcoes, normalizeAcaoD7);
        }

        function getPrimeiroEUltimoPrazoRNC(rnc) {
            const etapas = ['d3', 'd4', 'd5', 'd6', 'd7', 'd8'];
            const datas = [];
            etapas.forEach(etapa => {
                const prazo = rnc.prazos?.[etapa];
                if (!prazo) return;
                [prazo.original, prazo.reprazo1, prazo.reprazo2].forEach(data => {
                    const parsed = parseISODate(data);
                    if (parsed) datas.push(parsed);
                });
            });
            if (!datas.length) return { primeiroPrazo: '', ultimoPrazo: '' };
            datas.sort((a, b) => a.getTime() - b.getTime());
            const formatISO = d => d.toISOString().slice(0, 10);
            return { primeiroPrazo: formatISO(datas[0]), ultimoPrazo: formatISO(datas[datas.length - 1]) };
        }

        function getCompetenciaLabelAtual() {
            const month = String(Number(state.dashboardFilterMonth) + 1).padStart(2, '0');
            return `${month}/${state.dashboardFilterYear}`;
        }

        function xmlEscape(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        function buildExcelWorkbookXML(sheets) {
            const header = `<?xml version="1.0"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
 <Styles>
  <Style ss:ID="Header"><Font ss:Bold="1"/><Interior ss:Color="#DCE6F1" ss:Pattern="Solid"/></Style>
 </Styles>`;
            const usedNames = new Set();
            const getUniqueSheetName = (baseName) => {
                const normalized = String(baseName || 'Aba').slice(0, 31);
                if (!usedNames.has(normalized)) {
                    usedNames.add(normalized);
                    return normalized;
                }
                let idx = 2;
                while (idx < 1000) {
                    const suffix = ` (${idx})`;
                    const candidate = `${normalized.slice(0, 31 - suffix.length)}${suffix}`;
                    if (!usedNames.has(candidate)) {
                        usedNames.add(candidate);
                        return candidate;
                    }
                    idx += 1;
                }
                return normalized;
            };
            const worksheets = sheets.map(sheet => {
                const safeName = xmlEscape(getUniqueSheetName(sheet.name));
                const headerRow = `<Row>${(sheet.headers || []).map(h => `<Cell ss:StyleID="Header"><Data ss:Type="String">${xmlEscape(h)}</Data></Cell>`).join('')}</Row>`;
                const dataRows = (sheet.rows || []).map(row => `<Row>${row.map(cell => {
                    const isNumber = typeof cell === 'number' && Number.isFinite(cell);
                    return `<Cell><Data ss:Type="${isNumber ? 'Number' : 'String'}">${xmlEscape(isNumber ? cell : String(cell ?? ''))}</Data></Cell>`;
                }).join('')}</Row>`).join('');
                return `<Worksheet ss:Name="${safeName}"><Table>${headerRow}${dataRows}</Table></Worksheet>`;
            }).join('');
            return `${header}${worksheets}</Workbook>`;
        }

        function downloadExcelFromSheets(sheets, fileName) {
            const xml = buildExcelWorkbookXML(sheets);
            const blob = new Blob([xml], { type: 'application/vnd.ms-excel' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                URL.revokeObjectURL(a.href);
                a.remove();
            }, 1000);
        }

        function exportarRelatorioAnaliticoExcel() {
            const selecionadas = state.exportAnalisesSelecionadas || {};
            const rncs = getRNCsPeriodoAnalitico();
            const hojeISO = new Date().toISOString().slice(0, 10);
            const hasAny = Object.values(selecionadas).some(Boolean);
            if (!hasAny) {
                alert('Selecione ao menos uma análise para exportar.');
                return;
            }

            const sheets = [];

            if (selecionadas.resumoGeral || selecionadas.volumePecasImpactadas || selecionadas.statusPrioridade) {
                sheets.push({
                    name: 'Resumo Geral',
                    headers: ['Nº RNC', 'Cliente', 'Setor', 'Tipo Falha', 'Prioridade', 'Status', 'Em Risco', 'Qtde Peças'],
                    rows: rncs.map(rnc => [
                        rnc.numero || '-',
                        rnc.cliente || '-',
                        rnc.setor || '-',
                        rnc.tipoFalha || '-',
                        rnc.prioridade || '-',
                        isEtapaConcluida(rnc, 'd8') ? 'Encerrada' : 'Em andamento',
                        isRncEmRisco(rnc) ? 'Sim' : 'Não',
                        Number(rnc.quantidade || 0)
                    ])
                });
            }

            if (selecionadas.tempoPorFase || selecionadas.leadTimeTotal || selecionadas.tempoMedioPorFase || selecionadas.tempoAtrasoPorFase) {
                const phaseIds = ['d1', 'd2', 'd3', 'd4', 'd5', 'd6', 'd7', 'd8'];
                const rows = rncs.map(rnc => {
                    const faseDias = phaseIds.map(id => diffDays(rnc.dataAbertura, getPrazoVigenteEtapa(rnc.prazos?.[id])));
                    const leadTime = isEtapaConcluida(rnc, 'd8') ? diffDays(rnc.dataAbertura, rnc.d8?.dataConclusao) : diffDays(rnc.dataAbertura, hojeISO);
                    const atrasoPorFase = getEtapasEmAtraso(rnc).reduce((acc, item) => acc + Number(diffDays(item.vencimento, hojeISO) || 0), 0);
                    return [rnc.numero || '-', ...faseDias.map(v => Number(v || 0)), Number(leadTime || 0), atrasoPorFase];
                });
                sheets.push({
                    name: 'Tempo por Fase',
                    headers: ['Nº RNC', 'D1 (dias)', 'D2', 'D3', 'D4', 'D5', 'D6', 'D7', 'D8', 'Lead Time Total', 'Tempo em atraso (dias)'],
                    rows
                });
            }

            if (selecionadas.numeroReprazosPorRnc || selecionadas.primeiroPrazoUltimoPrazo || selecionadas.diasAdicionadosReprazo || selecionadas.rncsComReprazo) {
                sheets.push({
                    name: 'Reprazos',
                    headers: ['Nº RNC', 'Qtde Re-prazos', 'Prazo Inicial', 'Último Prazo', 'Dias Adicionados', 'RNC com Re-prazo'],
                    rows: rncs.map(rnc => {
                        const qtde = getTotalReprazosRNC(rnc);
                        const { primeiroPrazo, ultimoPrazo } = getPrimeiroEUltimoPrazoRNC(rnc);
                        const diasAdd = Number(diffDays(primeiroPrazo, ultimoPrazo) || 0);
                        return [rnc.numero || '-', qtde, formatDateSafe(primeiroPrazo), formatDateSafe(ultimoPrazo), diasAdd, qtde > 0 ? 'Sim' : 'Não'];
                    })
                });
            }

            if (selecionadas.qtdAcoesCorretivas || selecionadas.qtdAcoesPreventivas || selecionadas.tempoMedioImplementacaoAcoes || selecionadas.acoesNoPrazoForaPrazo) {
                const rows = [];
                rncs.forEach(rnc => {
                    const grupos = [
                        { tipo: 'Corretiva', acoes: (rnc.d5?.listaAcoes || []).map(normalizeAcaoD5) },
                        { tipo: 'Preventiva', acoes: (rnc.d7?.listaAcoes || []).map(normalizeAcaoD7) }
                    ];
                    grupos.forEach(grupo => {
                        const totalAcoes = grupo.acoes.length;
                        const concluidas = grupo.acoes.filter(a => a.status === 'CONCLUIDA').length;
                        const foraPrazo = grupo.acoes.filter(a => a.status === 'CONCLUIDA' && diffDays(obterPrazoVigenteAcao(a), a.dataConclusao) > 0).length;
                        const tempos = grupo.acoes
                            .filter(a => a.status === 'CONCLUIDA')
                            .map(a => Number(diffDays(rnc.dataAbertura, a.dataConclusao) || 0));
                        const tempoMedio = tempos.length ? (tempos.reduce((a, b) => a + b, 0) / tempos.length).toFixed(1) : '0.0';
                        rows.push([rnc.numero || '-', grupo.tipo, totalAcoes, concluidas, foraPrazo, tempoMedio]);
                    });
                });
                sheets.push({
                    name: 'Ações',
                    headers: ['Nº RNC', 'Tipo Ação', 'Qtde Ações', 'Concluídas', 'Fora do Prazo', 'Tempo Médio (dias)'],
                    rows
                });
            }

            if (selecionadas.quantidadeTotalPecas || selecionadas.quantidadeInspecionada || selecionadas.quantidadeNaoConforme || selecionadas.percentualNaoConforme) {
                sheets.push({
                    name: 'Volume e Contenção',
                    headers: ['Nº RNC', 'Qtde Peças', 'Inspecionadas', 'Não Conformes', '% NC'],
                    rows: rncs.map(rnc => {
                        const qtde = Number(rnc.quantidade || 0);
                        const inspecionada = Number(rnc.d3?.quantidadeInspecionada || 0);
                        const naoConf = Number(rnc.d3?.quantidadeNaoConforme || 0);
                        const percNC = inspecionada > 0 ? ((naoConf / inspecionada) * 100).toFixed(1) : '0.0';
                        return [rnc.numero || '-', qtde, inspecionada, naoConf, `${percNC}%`];
                    })
                });
            }

            if (selecionadas.taxaRncsNoPrazo || selecionadas.taxaRncsEmRisco || selecionadas.taxaReprazos || selecionadas.rncsEncerradasPeriodo) {
                const total = rncs.length;
                const noPrazo = rncs.filter(r => getStatusRncValue(r) === 'ON_TIME').length;
                const emRisco = rncs.filter(r => getStatusRncValue(r) === 'AT_RISK').length;
                const comReprazo = rncs.filter(r => getTotalReprazosRNC(r) > 0).length;
                const encerradas = rncs.filter(r => isEtapaConcluida(r, 'd8')).length;
                const leadTimes = rncs.map(r => Number((isEtapaConcluida(r, 'd8') ? diffDays(r.dataAbertura, r.d8?.dataConclusao) : diffDays(r.dataAbertura, hojeISO)) || 0));
                const leadTimeMedio = leadTimes.length ? (leadTimes.reduce((a, b) => a + b, 0) / leadTimes.length).toFixed(1) : '0.0';
                sheets.push({
                    name: 'Indicadores',
                    headers: ['Indicador', 'Valor'],
                    rows: [
                        ['Taxa de RNCs no prazo', `${total ? ((noPrazo / total) * 100).toFixed(1) : '0.0'}%`],
                        ['Taxa de RNCs em risco', `${total ? ((emRisco / total) * 100).toFixed(1) : '0.0'}%`],
                        ['Taxa de re-prazos', `${total ? ((comReprazo / total) * 100).toFixed(1) : '0.0'}%`],
                        ['RNCs encerradas no período', encerradas],
                        ['Lead Time Médio (dias)', leadTimeMedio]
                    ]
                });
            }

            if (!sheets.length) {
                alert('Não há análises selecionadas para exportação.');
                return;
            }

            const month = String(Number(state.dashboardFilterMonth) + 1).padStart(2, '0');
            downloadExcelFromSheets(sheets, `relatorio-8d-analitico-${state.dashboardFilterYear}-${month}.xls`);
        }

        function exportarRelatorioDiretoExcel() {
            const rncs = getRNCsPeriodoAnalitico();
            const tipo = state.exportDiretoTipo || 'RNC_GERAL';
            let sheets = [];
            let nome = '';

            if (tipo === 'ACOES') {
                const rows = [];
                rncs.forEach(rnc => {
                    (rnc.d5?.listaAcoes || []).map(normalizeAcaoD5).forEach(acao => {
                        rows.push([
                            rnc.numero || '-',
                            'Corretiva',
                            getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-',
                            formatDateSafe(obterPrazoVigenteAcao(acao)),
                            acao.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto',
                            (acao.reprazos?.length || 0) > 0 ? 'Sim' : 'Não'
                        ]);
                    });
                    (rnc.d7?.listaAcoes || []).map(normalizeAcaoD7).forEach(acao => {
                        rows.push([
                            rnc.numero || '-',
                            'Preventiva',
                            getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-',
                            formatDateSafe(obterPrazoVigenteAcao(acao)),
                            acao.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto',
                            (acao.reprazos?.length || 0) > 0 ? 'Sim' : 'Não'
                        ]);
                    });
                });
                sheets = [{
                    name: 'Ações',
                    headers: ['Nº RNC', 'Tipo da Ação', 'Responsável', 'Prazo', 'Status', 'Re-prazo'],
                    rows
                }];
                nome = 'acoes';
            } else if (tipo === 'INDICADORES') {
                const total = rncs.length;
                const noPrazo = rncs.filter(r => getStatusRncValue(r) === 'ON_TIME').length;
                const emRisco = rncs.filter(r => getStatusRncValue(r) === 'AT_RISK').length;
                const leadTimes = rncs.map(r => Number((isEtapaConcluida(r, 'd8') ? diffDays(r.dataAbertura, r.d8?.dataConclusao) : diffDays(r.dataAbertura, new Date().toISOString().slice(0, 10))) || 0));
                const leadMedio = leadTimes.length ? (leadTimes.reduce((a, b) => a + b, 0) / leadTimes.length).toFixed(1) : '0.0';
                const taxaReprazo = total > 0 ? ((rncs.filter(r => getTotalReprazosRNC(r) > 0).length / total) * 100).toFixed(1) : '0.0';
                sheets = [{
                    name: 'Indicadores Mensais',
                    headers: ['Indicador', 'Valor'],
                    rows: [
                        ['Total de RNCs', total],
                        ['No prazo', noPrazo],
                        ['Em risco', emRisco],
                        ['Lead time médio (dias)', leadMedio],
                        ['Taxa de re-prazo', `${taxaReprazo}%`]
                    ]
                }];
                nome = 'indicadores';
            } else {
                sheets = [{
                    name: 'RNCs Visão Geral',
                    headers: ['Nº RNC', 'Cliente', 'Setor', 'Tipo de falha', 'Status', 'Fase atual', 'Em risco', 'Data abertura', 'Data fechamento'],
                    rows: rncs.map(rnc => [
                        rnc.numero || '-',
                        rnc.cliente || '-',
                        rnc.setor || '-',
                        rnc.tipoFalha || '-',
                        isEtapaConcluida(rnc, 'd8') ? 'Encerrada' : 'Em andamento',
                        phases.find(p => p.id === rnc.faseAtual)?.name || '-',
                        isRncEmRisco(rnc) ? 'Sim' : 'Não',
                        formatDateSafe(rnc.dataAbertura),
                        extractAndFormatDate(rnc.d8?.dataConclusao)
                    ])
                }];
                nome = 'rncs-visao-geral';
            }

            const month = String(Number(state.dashboardFilterMonth) + 1).padStart(2, '0');
            downloadExcelFromSheets(sheets, `relatorio-8d-direto-${nome}-${state.dashboardFilterYear}-${month}.xls`);
        }

        function validatePasswordComplexity(password) {
            return /[A-Z]/.test(password) && /[a-z]/.test(password) && /[0-9]/.test(password) && /[^A-Za-z0-9]/.test(password);
        }

        function normalizeNumeroRNC(numero) {
            return String(numero || '').trim().toUpperCase();
        }

        const RNC_NUMERO_DUPLICADO_MSG = '⚠️ Já existe uma RNC cadastrada com este número. Informe um número diferente.';
        const DIAS_ALERTA_VENCIMENTO_RNC = 5;
        const CLASS_INDICADOR_ATRASO = 'red';
        const PRAZO_TOTAL_RNC_DIAS = 30;
        const LIMITE_NEGOCIACAO_REPRAZO = 2;
        const PESO_CRITICIDADE_ATRASO = 1000;
        const PESO_CRITICIDADE_PRAZO_TOTAL = 500;
        const MAX_ADMIN_AUDIT_RECORDS = 200;
        const MAX_ADMIN_AUDIT_DISPLAY = 20;
        const GUEST_USER_ID = -1;

        function existeNumeroRNCDuplicado(numero) {
            const alvo = normalizeNumeroRNC(numero);
            if (!alvo) return false;
            return state.rncs.some(rnc => normalizeNumeroRNC(rnc.numero) === alvo);
        }

        function getStatusConclusao8D(rnc) {
            const concluido = isEtapaConcluida(rnc, 'd8');
            return concluido
                ? { value: 'CONCLUIDO', label: 'Concluído', className: 'green' }
                : { value: 'EM_ANDAMENTO', label: 'Em andamento', className: 'blue' };
        }

        function getPrazoVigenteEtapa(prazoEtapa) {
            if (!prazoEtapa) return '';
            return prazoEtapa.reprazo2 || prazoEtapa.reprazo1 || prazoEtapa.original || '';
        }

        function getFaseAtualDefinida(rnc) {
            if (rnc?.faseAtual && phases.some(p => p.id === rnc.faseAtual)) return rnc.faseAtual;
            return getPrimeiraEtapaPendente(rnc) || 'd8';
        }

        function getDataReferenciaControle(rnc) {
            const faseAtual = getFaseAtualDefinida(rnc);
            return getPrazoVigenteEtapa(rnc?.prazos?.[faseAtual]) || '';
        }

        function getReprazoCountEtapas(rnc) {
            return Object.values(rnc?.prazos || {}).reduce((acc, prazoEtapa) => {
                if (!prazoEtapa) return acc;
                return acc + (prazoEtapa.reprazo1 ? 1 : 0) + (prazoEtapa.reprazo2 ? 1 : 0);
            }, 0);
        }

        function getReprazoCountFase(rnc, phaseId) {
            const prazoEtapa = rnc?.prazos?.[phaseId];
            if (!prazoEtapa) return 0;
            return (prazoEtapa.reprazo1 ? 1 : 0) + (prazoEtapa.reprazo2 ? 1 : 0);
        }

        function getReprazoCountAcoes(listaAcoes, normalizer) {
            return (listaAcoes || []).reduce((acc, acao) => {
                const normalizada = normalizer(acao);
                return acc + (normalizada.reprazos?.length || 0);
            }, 0);
        }

        function usuarioPodeNegociarReprazo() {
            const role = String(state.currentUser?.role || '').toLowerCase();
            const perfisGerencia = ['gerente', 'gerência', 'gerencia', 'manager', 'diretor', 'diretoria'];
            return perfisGerencia.some(perfil => role.includes(perfil));
        }

        function registrarEscalonamentoReprazo(rnc, dados = {}) {
            if (!rnc) return;
            if (!Array.isArray(rnc.escalonamentos)) rnc.escalonamentos = [];
            const origem = String(dados.origem || 'GERAL');
            const tipo = String(dados.tipo || 'LIMITE_REPRAZO');
            const chave = String(dados.chave || `${tipo}:${origem}`);
            const jaEscalonada = rnc.escalonamentos.some(item => item?.tipo === tipo && item?.chave === chave);
            if (!jaEscalonada) {
                const template = getTemplateEscalonamento(tipo);
                const contexto = {
                    numero_rnc: rnc.numero || '',
                    cliente: rnc.cliente || '',
                    fase: dados.faseLabel || '',
                    acao: dados.acaoDescricao || '',
                    responsavel: dados.responsavel || '',
                    dias_atraso: String(dados.diasAtraso || ''),
                    quantidade_reprazo: String(dados.totalReprazosAcao || dados.totalReprazosFase || ''),
                    data_referencia: formatDateSafe(dados.dataReferencia || getDataReferenciaControle(rnc))
                };
                rnc.escalonamentos.push({
                    tipo,
                    origem,
                    chave,
                    faseId: dados.faseId || '',
                    faseLabel: dados.faseLabel || '',
                    acaoId: dados.acaoId || '',
                    acaoDescricao: dados.acaoDescricao || '',
                    responsavel: dados.responsavel || '',
                    emailGerencia: dados.emailGerencia || '',
                    mensagem: dados.mensagem || '',
                    emailAssunto: aplicarTemplateEmail(template.assunto, contexto),
                    emailCorpo: aplicarTemplateEmail(template.corpo, contexto),
                    dataRegistro: new Date().toISOString(),
                    totalReprazosFase: Number(dados.totalReprazosFase || 0),
                    totalReprazosAcao: Number(dados.totalReprazosAcao || 0)
                });
                registrarAuditoriaAdmin('ENVIO', `Escalonamento automático registrado para ${dados.responsavel || 'responsável não identificado'}${dados.emailGerencia ? ` (${dados.emailGerencia})` : ''}`, {
                    modulo: 'Template de E-mail',
                    referencia: rnc.numero || '',
                    tipoAcao: 'ENVIO'
                });
            }
        }

        function getGovernancaReprazoRnc(rnc) {
            const total = getTotalReprazosRNC(rnc);
            if (total >= LIMITE_NEGOCIACAO_REPRAZO) {
                return {
                    total,
                    className: 'critical',
                    texto: '⛔ Limite de re-prazos atingido. Próximo atraso será escalonado para a Gerência.'
                };
            }
            if (total === 1) {
                return {
                    total,
                    className: 'warning',
                    texto: '⚠ Atenção: haverá direito apenas a mais 1 negociação de prazo.'
                };
            }
            return {
                total,
                className: '',
                texto: total > 0 ? `RNC já teve ${total} re-prazo${total > 1 ? 's' : ''}` : 'RNC sem re-prazo registrado'
            };
        }

        function getGovernancaReprazoFase(rnc, phaseId) {
            const faseLabel = getLabelCurtoFase(phaseId);
            const total = getReprazoCountFase(rnc, phaseId);
            if (total >= LIMITE_NEGOCIACAO_REPRAZO) {
                return {
                    total,
                    className: 'critical',
                    texto: `⛔ Limite de re-prazos atingido na fase ${faseLabel}. Próximo atraso nesta fase será escalonado para a Gerência.`
                };
            }
            if (total === 1) {
                return {
                    total,
                    className: 'warning',
                    texto: `⚠ Fase ${faseLabel} já teve 1 re-prazo. Restará apenas mais 1 negociação para esta fase.`
                };
            }
            return {
                total,
                className: '',
                texto: `Fase ${faseLabel} sem re-prazo registrado.`
            };
        }

        function isPrazoTotalRncExcedido(rnc) {
            if (!rnc?.dataAbertura || isEtapaConcluida(rnc, 'd8')) return false;
            const abertura = parseISODate(rnc.dataAbertura);
            if (!abertura) return false;
            const limite = new Date(abertura);
            limite.setDate(limite.getDate() + PRAZO_TOTAL_RNC_DIAS);
            limite.setHours(0, 0, 0, 0);
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            return hoje.getTime() > limite.getTime();
        }

        function registrarEscalonamentoPrazoTotalRNC(rnc) {
            if (!rnc || !isPrazoTotalRncExcedido(rnc)) return;
            const faseAtual = getFaseAtualDefinida(rnc);
            const faseLabel = getLabelCurtoFase(faseAtual);
            const responsavelFase = getResponsavelFase(rnc, faseAtual);
            const emailGerenciaFase = getEmailGerenciaResponsavelFase(rnc, faseAtual);
            const responsavelQualidade = getPessoaById(rnc.equipeResponsavel?.analistaQualidadeId)?.nome || getResponsavelRNC(rnc);
            const emailGerenciaQualidade = getPessoaEmailGerenciaById(rnc.equipeResponsavel?.analistaQualidadeId);
            const mensagemFase = `⛔ Prazo total da RNC (${PRAZO_TOTAL_RNC_DIAS} dias) ultrapassado. Escalonamento para Gerência da fase atual (${faseLabel}).`;
            const mensagemQualidade = `⛔ Prazo total da RNC (${PRAZO_TOTAL_RNC_DIAS} dias) ultrapassado. Escalonamento para Gerência da Qualidade.`;
            registrarEscalonamentoReprazo(rnc, {
                tipo: 'PRAZO_TOTAL_RNC',
                origem: 'PRAZO_TOTAL_FASE',
                chave: `PRAZO_TOTAL:FASE:${faseAtual}`,
                faseId: faseAtual,
                faseLabel,
                responsavel: responsavelFase,
                emailGerencia: emailGerenciaFase,
                mensagem: mensagemFase
            });
            registrarEscalonamentoReprazo(rnc, {
                tipo: 'PRAZO_TOTAL_RNC',
                origem: 'PRAZO_TOTAL_QUALIDADE',
                chave: `PRAZO_TOTAL:QUALIDADE:${faseAtual}`,
                faseId: faseAtual,
                faseLabel,
                responsavel: responsavelQualidade,
                emailGerencia: emailGerenciaQualidade,
                mensagem: mensagemQualidade
            });
        }

        function formatAtrasoFaseLabel(phaseId) {
            const phase = phases.find(p => p.id === phaseId);
            if (!phase) return `ATRASADA NA FASE ${(String(phaseId || 'D?').toUpperCase())} – ETAPA NÃO IDENTIFICADA`;
            const nome = String(phase.name || '').replace(/^D\d+\s*-\s*/i, '').trim();
            const sufixo = nome ? ` – ${nome}` : '';
            return `ATRASADA NA FASE ${phase.short || String(phase.id || '').toUpperCase()}${sufixo}`;
        }

        function getResponsavelEtapaAtrasada(rnc, phaseId) {
            return getResponsavelFase(rnc, phaseId);
        }

        function getEtapasEmAtraso(rnc) {
            const etapas = ['d3', 'd4', 'd5', 'd6', 'd7'];
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            return etapas.flatMap(phaseId => {
                if (isEtapaConcluida(rnc, phaseId)) return [];
                const prazoVigente = getPrazoVigenteEtapa(rnc.prazos?.[phaseId]);
                if (!/^\d{4}-\d{2}-\d{2}$/.test(String(prazoVigente || ''))) return [];
                const prazo = new Date(`${prazoVigente}T00:00:00`);
                if (hoje.getTime() <= prazo.getTime()) return [];
                return [{
                    phaseId,
                    phaseName: phases.find(p => p.id === phaseId)?.name || phaseId.toUpperCase(),
                    vencimento: prazoVigente,
                    responsavel: getResponsavelEtapaAtrasada(rnc, phaseId)
                }];
            });
        }

        function getStatusEtapas8D(rnc) {
            const atrasos = getEtapasEmAtraso(rnc);
            const faseAtual = getFaseAtualDefinida(rnc);
            if (!atrasos.length) {
                if (isPrazoTotalRncExcedido(rnc)) {
                    const prazoLimite = addDaysToISO(rnc.dataAbertura, PRAZO_TOTAL_RNC_DIAS);
                    const detalhePrazoTotal = `Prazo total da RNC (${PRAZO_TOTAL_RNC_DIAS} dias) ultrapassado desde ${formatDateSafe(prazoLimite)}.`;
                    return { value: 'COM_ATRASO', label: formatAtrasoFaseLabel(faseAtual), className: 'red', detalhe: detalhePrazoTotal, faseAtrasoId: faseAtual };
                }
                return { value: 'SEM_ATRASO', label: 'Sem atraso', className: 'green', detalhe: '', faseAtrasoId: '' };
            }
            const faseCritica = atrasos[0];
            const detalhe = atrasos.map(item => `Etapa em atraso: ${item.phaseName} • Prazo vencido em: ${formatDateSafe(item.vencimento)} • Responsável: ${item.responsavel}`).join(' || ');
            return { value: 'COM_ATRASO', label: formatAtrasoFaseLabel(faseCritica.phaseId), className: 'red', detalhe, faseAtrasoId: faseCritica.phaseId };
        }

        function isRNCAtiva(rnc) {
            return !isEtapaConcluida(rnc, 'd8');
        }

        function getCadastroConfig(tipo) {
            if (tipo === 'pessoas') {
                return {
                    titulo: 'Pessoas',
                    descricao: 'Base de integrantes para equipes de RNC',
                    fields: [
                        { key: 'nome', label: 'Nome completo', type: 'text', required: true },
                        { key: 'cargo', label: 'Função / Cargo', type: 'text', required: true },
                        { key: 'setor', label: 'Setor', type: 'text', required: true },
                        { key: 'planta', label: 'Planta', type: 'text', required: true },
                        { key: 'gerente', label: 'Gerente', type: 'text', required: true },
                        { key: 'emailGerencia', label: 'E-mail da Gerência', type: 'email', required: true },
                        { key: 'email', label: 'E-mail', type: 'email', required: true },
                        { key: 'perfilAcesso', label: 'Perfil de Acesso', type: 'select', required: true, options: ['USUARIO', 'ADMIN'] },
                        { key: 'status', label: 'Status', type: 'select', required: true, options: ['Ativo', 'Inativo'] }
                    ]
                };
            }
            if (tipo === 'modos-falha') {
                return {
                    titulo: 'Modo de Falha',
                    descricao: 'Tipos de falha padronizados para RNC',
                    fields: [
                        { key: 'nome', label: 'Nome do Modo de Falha', type: 'text', required: true },
                        { key: 'descricao', label: 'Descrição', type: 'text', required: false },
                        { key: 'status', label: 'Status', type: 'select', required: true, options: ['Ativo', 'Inativo'] }
                    ]
                };
            }
            return {
                titulo: 'Cliente',
                descricao: 'Clientes reutilizáveis nas RNCs',
                fields: [
                    { key: 'nome', label: 'Nome do Cliente', type: 'text', required: true },
                    { key: 'codigo', label: 'Código', type: 'text', required: false },
                    { key: 'status', label: 'Status', type: 'select', required: true, options: ['Ativo', 'Inativo'] },
                    { key: 'fotoConteudo', label: 'Foto', type: 'file', required: true, isImage: true }
                ]
            };
        }

        function getCadastroLista(tipo) {
            if (tipo === 'pessoas') return pessoasBase;
            if (tipo === 'modos-falha') return modosFalhaBase;
            return clientesBase;
        }

        function getCadastroItemById(tipo, id) {
            return getCadastroLista(tipo).find(item => item.id === Number(id));
        }

        function getNextId(listaBase) {
            return Math.max(0, ...listaBase.map(x => Number(x.id) || 0)) + 1;
        }

        function bloqueioExclusaoCadastro(tipo, item) {
            if (!item) return null;
            if (tipo === 'pessoas') {
                const vinculado = state.rncs.some(rnc => isRNCAtiva(rnc) && (
                    rnc.equipeResponsavel?.responsavelContencaoId === item.id ||
                    rnc.equipeResponsavel?.analistaEngenhariaId === item.id ||
                    rnc.equipeResponsavel?.analistaQualidadeId === item.id ||
                    (rnc.equipeResponsavel?.outrosEnvolvidosIds || []).includes(item.id) ||
                    (rnc.d5?.listaAcoes || []).some(acao => acao.responsavelId === item.id || acao.responsavel === item.nome) ||
                    rnc.responsavel === item.nome ||
                    (rnc.d1?.lider === item.nome) ||
                    (rnc.d1?.equipe || '').split(',').map(nome => nome.trim()).includes(item.nome)
                ));
                if (vinculado) return 'Não é possível excluir: item vinculado a RNC ativa.';
            }
            if (tipo === 'modos-falha') {
                const vinculado = state.rncs.some(rnc => isRNCAtiva(rnc) && rnc.tipoFalha === item.nome);
                if (vinculado) return 'Não é possível excluir: modo de falha vinculado a RNC ativa.';
            }
            if (tipo === 'clientes') {
                const vinculado = state.rncs.some(rnc => isRNCAtiva(rnc) && rnc.cliente === item.nome);
                if (vinculado) return 'Não é possível excluir: cliente vinculado a RNC ativa.';
            }
            return null;
        }

        function propagarRenomeacaoCadastro(tipo, nomeAnterior, nomeNovo) {
            if (!nomeAnterior || nomeAnterior === nomeNovo) return;
            if (tipo === 'pessoas') {
                state.rncs.forEach(rnc => {
                    if (rnc.responsavel === nomeAnterior) rnc.responsavel = nomeNovo;
                    if (rnc.d1?.lider === nomeAnterior) rnc.d1.lider = nomeNovo;
                    if (rnc.d1?.equipe) {
                        rnc.d1.equipe = rnc.d1.equipe
                            .split(',')
                            .map(nome => nome.trim() === nomeAnterior ? nomeNovo : nome.trim())
                            .join(', ');
                    }
                    (rnc.d5?.listaAcoes || []).forEach(acao => {
                        if (acao.responsavel === nomeAnterior) acao.responsavel = nomeNovo;
                    });
                });
            } else if (tipo === 'modos-falha') {
                state.rncs.forEach(rnc => {
                    if (rnc.tipoFalha === nomeAnterior) rnc.tipoFalha = nomeNovo;
                });
            } else if (tipo === 'clientes') {
                state.rncs.forEach(rnc => {
                    if (rnc.cliente === nomeAnterior) rnc.cliente = nomeNovo;
                });
            }
        }

        function abrirModalListagemCadastro(tipo) {
            if (!isCurrentUserAdmin()) {
                alert('Acesso restrito ao perfil ADMIN.');
                return;
            }
            const config = getCadastroConfig(tipo);
            const lista = getCadastroLista(tipo);
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1002';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 1200px; width: 95vw;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">Gerenciar ${config.titulo}</h2>
                            <p style="color:#64748b; margin-top:0.5rem;">${config.descricao}</p>
                        </div>
                        <button class="modal-close" data-close-cadastro-lista>×</button>
                    </div>
                    <div class="modal-body">
                        <div style="overflow:auto;">
                        <table>
                            <thead>
                                <tr>
                                    ${config.fields.map(field => `<th>${field.label}</th>`).join('')}
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lista.length === 0 ? `
                                    <tr><td colspan="${config.fields.length + 1}" style="text-align:center; color:#64748b;">Nenhum item cadastrado.</td></tr>
                                ` : lista.map(item => `
                                    <tr>
                                        ${config.fields.map(field => {
                                            if (field.isImage) {
                                                return `<td>${item.fotoConteudo ? `<img src="${item.fotoConteudo}" alt="${escapeHtml(item.nome)}" style="width:48px; height:48px; object-fit:cover; border-radius:8px; border:1px solid #e2e8f0;">` : '<span style="color:#94a3b8;">Sem foto</span>'}</td>`;
                                            }
                                            return `<td>${escapeHtml(item[field.key] || '')}</td>`;
                                        }).join('')}
                                        <td style="display:flex; gap:0.5rem;">
                                            <button type="button" class="btn btn-secondary btn-editar-cadastro-item" data-cadastro-tipo="${tipo}" data-item-id="${item.id}" style="padding:0.4rem 0.75rem; font-size:0.8rem;">Editar</button>
                                            <button type="button" class="btn btn-warning btn-excluir-cadastro-item" data-cadastro-tipo="${tipo}" data-item-id="${item.id}" style="padding:0.4rem 0.75rem; font-size:0.8rem;">Excluir</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        </div>
                        <div style="margin-top:1rem; display:flex; justify-content:flex-end;">
                            <button type="button" class="btn btn-primary btn-novo-cadastro-item" data-cadastro-tipo="${tipo}">Novo Cadastro</button>
                        </div>
                    </div>
                </div>
            `;
            overlay.onclick = (e) => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);

            overlay.querySelector('[data-close-cadastro-lista]').onclick = () => overlay.remove();
            overlay.querySelector('.btn-novo-cadastro-item').onclick = () => abrirModalFormularioCadastro(tipo, null, overlay);
            overlay.querySelectorAll('.btn-editar-cadastro-item').forEach(btn => {
                btn.onclick = () => abrirModalFormularioCadastro(btn.dataset.cadastroTipo, btn.dataset.itemId, overlay);
            });
            overlay.querySelectorAll('.btn-excluir-cadastro-item').forEach(btn => {
                btn.onclick = async () => {
                    const item = getCadastroItemById(btn.dataset.cadastroTipo, btn.dataset.itemId);
                    if (!item) return;
                    const bloqueio = bloqueioExclusaoCadastro(btn.dataset.cadastroTipo, item);
                    if (bloqueio) {
                        alert(bloqueio);
                        return;
                    }
                    if (!confirm(`Deseja excluir "${item.nome}"?`)) return;
                    const listaBase = getCadastroLista(btn.dataset.cadastroTipo);
                    const idx = listaBase.findIndex(x => x.id === item.id);
                    if (idx !== -1) {
                        listaBase.splice(idx, 1);
                        registrarAuditoriaAdmin('EXCLUSAO', `${getCadastroConfig(btn.dataset.cadastroTipo).titulo}: ${item.nome}`, { modulo: 'Cadastro Base', referencia: item.nome, tipoAcao: 'EXCLUSAO' });
                        const salvoNoFirebase = await salvarCadastrosBaseNoFirebase();
                        if (!salvoNoFirebase) {
                            alert('Cadastro atualizado localmente, mas não foi possível salvar no Firebase agora.');
                        }
                    }
                    overlay.remove();
                    abrirModalListagemCadastro(btn.dataset.cadastroTipo);
                    render();
                };
            });
        }

        function abrirModalFormularioCadastro(tipo, itemId, parentOverlay) {
            if (!isCurrentUserAdmin()) {
                alert('Acesso restrito ao perfil ADMIN.');
                return;
            }
            const config = getCadastroConfig(tipo);
            const item = itemId ? getCadastroItemById(tipo, itemId) : null;
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1003';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 720px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">${item ? 'Editar' : 'Novo'} ${config.titulo}</h2>
                        </div>
                        <button class="modal-close" data-close-cadastro-form>×</button>
                    </div>
                    <div class="modal-body">
                        <form id="cadastroItemForm">
                            ${config.fields.map(field => `
                                <div class="form-group">
                                    <label>${field.label} ${field.required ? '*' : ''}</label>
                                    ${field.type === 'file'
                                        ? `<input type="file" name="${field.key}" accept="image/*" ${field.required && !item?.fotoConteudo ? 'required' : ''}>`
                                        : field.type === 'select'
                                            ? `<select name="${field.key}" ${field.required ? 'required' : ''}>${(field.options || []).map(option => `<option value="${escapeHtml(option)}" ${String(item?.[field.key] || '') === String(option) ? 'selected' : ''}>${escapeHtml(option)}</option>`).join('')}</select>`
                                        : `<input type="${field.type}" name="${field.key}" value="${escapeHtml(item?.[field.key] || '')}" ${field.required ? 'required' : ''}>`
                                    }
                                    ${field.isImage && item?.fotoConteudo ? `<div style="margin-top:0.5rem;"><img src="${item.fotoConteudo}" alt="${escapeHtml(item.nome)}" style="width:64px; height:64px; object-fit:cover; border-radius:8px; border:1px solid #e2e8f0;"></div>` : ''}
                                </div>
                            `).join('')}
                            <div style="display:flex; gap:0.75rem;">
                                <button type="button" class="btn btn-secondary" data-close-cadastro-form>Cancelar</button>
                                <button type="submit" class="btn btn-success">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            overlay.onclick = (e) => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);
            overlay.querySelectorAll('[data-close-cadastro-form]').forEach(btn => btn.onclick = () => overlay.remove());
            overlay.querySelector('#cadastroItemForm').onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const payload = {};
                config.fields.forEach(field => {
                    if (field.type !== 'file') payload[field.key] = String(formData.get(field.key) || '').trim();
                });
                const invalid = config.fields.some(field => field.required && field.type !== 'file' && !payload[field.key]);
                if (invalid) {
                    alert('Preencha todos os campos obrigatórios.');
                    return;
                }
                const listaBase = getCadastroLista(tipo);
                const fotoField = config.fields.find(field => field.type === 'file');
                if (fotoField) {
                    const fotoFile = formData.get(fotoField.key);
                    if (fotoFile && fotoFile.name) {
                        const base64 = await lerArquivoBase64(fotoFile, 'foto cliente');
                        if (!base64) {
                            alert('Não foi possível processar a foto. Tente novamente.');
                            return;
                        }
                        payload.fotoNome = fotoFile.name;
                        payload.fotoConteudo = base64;
                    } else if (fotoField.required && !item?.fotoConteudo) {
                        alert('A foto do cliente é obrigatória.');
                        return;
                    }
                }
                if (payload.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.email)) {
                    alert('Informe um e-mail válido.');
                    return;
                }
                if (payload.emailGerencia && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.emailGerencia)) {
                    alert('Informe um e-mail válido no campo E-mail da Gerência.');
                    return;
                }
                if (payload.nome) {
                    const normalize = (nome) => String(nome || '').trim().replace(/\s+/g, ' ').toLowerCase();
                    const nomeJaExiste = listaBase.some(registro => registro.id !== item?.id && normalize(registro.nome) === normalize(payload.nome));
                    if (nomeJaExiste) {
                        alert('Já existe um cadastro com este nome.');
                        return;
                    }
                }
                if (item) {
                    const idx = listaBase.findIndex(x => x.id === item.id);
                    if (idx !== -1) {
                        const nomeAnterior = listaBase[idx].nome;
                        listaBase[idx] = { ...listaBase[idx], ...payload };
                        propagarRenomeacaoCadastro(tipo, nomeAnterior, listaBase[idx].nome);
                        registrarAuditoriaAdmin('EDICAO', `${config.titulo}: ${listaBase[idx].nome}`, { modulo: 'Cadastro Base', referencia: listaBase[idx].nome, tipoAcao: 'EDICAO' });
                    }
                } else {
                    const nextId = getNextId(listaBase);
                    listaBase.push({ id: nextId, ...payload });
                    registrarAuditoriaAdmin('INCLUSAO', `${config.titulo}: ${payload.nome || nextId}`, { modulo: 'Cadastro Base', referencia: payload.nome || String(nextId), tipoAcao: 'INCLUSAO' });
                }
                await salvarCadastrosBaseNoFirebase();
                overlay.remove();
                if (parentOverlay) parentOverlay.remove();
                abrirModalListagemCadastro(tipo);
                render();
            };
        }

        function salvarCadastrosBaseNoFirebase() {
            if (!db) return Promise.resolve(false);
            const payload = {
                pessoasBase,
                clientesBase,
                modosFalhaBase,
                emailTemplatesBase,
                auditoriaAdmin
            };
            return db.collection('configuracoes')
                .doc('cadastros-base')
                .set(payload, { merge: true })
                .then(() => true)
                .catch(error => {
                    console.warn('Falha ao salvar cadastros base no Firebase:', error);
                    return false;
                });
        }

        async function carregarCadastrosBaseDoFirebase() {
            if (!db) return;
            try {
                const cadastrosBaseDoc = await db.collection('configuracoes').doc('cadastros-base').get();
                if (!cadastrosBaseDoc.exists) return;
                const data = cadastrosBaseDoc.data() || {};
                if (Array.isArray(data.pessoasBase)) pessoasBase = data.pessoasBase;
                if (Array.isArray(data.clientesBase)) clientesBase = data.clientesBase;
                if (Array.isArray(data.modosFalhaBase)) modosFalhaBase = data.modosFalhaBase;
                if (data.emailTemplatesBase && typeof data.emailTemplatesBase === 'object') {
                    emailTemplatesBase = { ...defaultEmailTemplates, ...data.emailTemplatesBase };
                }
                if (Array.isArray(data.auditoriaAdmin)) auditoriaAdmin = data.auditoriaAdmin;
            } catch (error) {
                console.warn('Falha ao carregar cadastros base do Firebase:', error);
            }
        }

        async function carregarRNCsDoFirebase() {
            if (!db) return;

            try {
                const snapshot = await db.collection('rncs').get();
                if (snapshot.empty) return;

                state.rncs = snapshot.docs
                    .map(doc => {
                        const numericId = Number(doc.id);
                        const data = doc.data();
                        const id = Number.isFinite(numericId) ? numericId : data.id;
                        if (!Number.isFinite(id)) {
                            console.warn('RNC ignorada por ID inválido no Firebase:', doc.id, data.id);
                            return null;
                        }
                        return { ...data, id };
                    })
                    .filter(rnc => rnc && Number.isFinite(rnc.id))
                    .sort((a, b) => a.id - b.id);
            } catch (error) {
                console.warn('Falha ao carregar RNCs do Firebase:', error);
            }
        }

        function salvarRNCNoFirebase(rnc) {
            if (!db) {
                console.warn('Salvamento não executado. Firebase indisponível.');
                return Promise.resolve(false);
            }
            if (!rnc || !Number.isFinite(rnc.id)) {
                console.warn('Salvamento não executado. RNC inválida.');
                return Promise.resolve(false);
            }
            if (isRncExcluida(rnc) && !isCurrentUserAdmin()) {
                console.warn('Salvamento de exclusão bloqueado para perfil sem permissão ADMIN.');
                return Promise.resolve(false);
            }

            return db.collection('rncs')
                .doc(String(rnc.id))
                .set(rnc, { merge: true })
                .then(() => true)
                .catch(error => {
                    console.warn('Falha ao salvar RNC no Firebase:', error);
                    return false;
                });
        }

        function render() {
            const app = document.getElementById('app');
            state.rncs.forEach(rnc => sincronizarFluxo8D(rnc));
            if (!isCurrentUserAdmin() && ['admin', 'cadastro-pessoas', 'movimentacoes'].includes(state.currentPage)) {
                state.currentPage = 'dashboard';
            }
            
            if (state.currentPage === 'login') {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = `
                    ${renderSidebar()}
                    ${isMobileView() && state.mobileMenuOpen ? '<div class="sidebar-backdrop" id="sidebarBackdrop"></div>' : ''}
                    <div class="main-content ${state.sidebarCollapsed ? 'sidebar-collapsed' : ''}">
                        ${renderTopBar()}
                        <div class="content-area">
                            ${state.currentPage === 'dashboard' ? renderDashboard() : ''}
                            ${state.currentPage === 'cadastro-rnc' ? renderCadastroRNC() : ''}
                            ${(state.currentPage === 'cadastro-pessoas' || state.currentPage === 'admin') ? renderAdmin() : ''}
                            ${state.currentPage === 'movimentacoes' ? renderMovimentacoes() : ''}
                            ${state.currentPage === 'controle' ? renderControle() : ''}
                            ${state.currentPage === 'relatorios' ? renderRelatorios() : ''}
                        </div>
                    </div>
                    ${renderModal()}
                    ${renderPerfilModal()}
                    ${renderExportAnaliticoModal()}
                    ${renderAlertasModal()}
                `;
            }
            
            attachEventListeners();
        }

        function renderLogin() {
            return `
                <div class="login-container">
                    <div class="login-box">
                        <div class="login-logo">8D</div>
                        <h1 style="font-size: 2rem; font-weight: 800; text-align: center; margin-bottom: 2rem;">Sistema RNC 8D</h1>
                        <form id="loginForm">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" value="debora@empresa.com" required>
                            </div>
                            <div class="form-group">
                                <label>Senha</label>
                                <input type="password" autocomplete="current-password" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Acessar</button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderSidebar() {
            const collapsed = state.sidebarCollapsed && !isMobileView();
            const sidebarClasses = [
                'sidebar',
                collapsed ? 'collapsed' : '',
                isMobileView() ? 'mobile' : '',
                isMobileView() && state.mobileMenuOpen ? 'open' : ''
            ].filter(Boolean).join(' ');
            const toggleTitle = isMobileView()
                ? (state.mobileMenuOpen ? 'Fechar menu' : 'Expandir menu')
                : (collapsed ? 'Expandir menu' : 'Recolher menu');
            return `
                <div class="${sidebarClasses}">
                    <div class="sidebar-header">
                        <h2>MAGIUS • 8D</h2>
                        <button type="button" class="menu-toggle-btn" id="toggleSidebarBtn" title="${toggleTitle}" aria-label="${toggleTitle}" aria-expanded="${collapsed ? 'false' : 'true'}">
                            ${renderIcon('menu')}
                        </button>
                    </div>
                    <div class="nav-menu">
                        <div class="nav-item ${state.currentPage === 'dashboard' ? 'active' : ''}" data-page="dashboard" title="Dashboard" aria-label="Dashboard" tabindex="0">
                            <span class="nav-icon">${renderIcon('dashboard')}</span>
                            <span class="nav-label">Dashboard</span>
                        </div>
                        <div class="nav-item ${state.currentPage === 'controle' ? 'active' : ''}" data-page="controle" title="Controle 8D" aria-label="Controle 8D" tabindex="0">
                            <span class="nav-icon">${renderIcon('control')}</span>
                            <span class="nav-label">Controle 8D</span>
                            <span class="nav-badge">${state.rncs.filter(r => isRncAtiva(r) && getStatusRncValue(r) === 'AT_RISK').length}</span>
                        </div>
                        <div class="nav-item ${state.currentPage === 'cadastro-rnc' ? 'active' : ''}" data-page="cadastro-rnc" title="Cadastro de RNC" aria-label="Cadastro de RNC" tabindex="0">
                            <span class="nav-icon">${renderIcon('register')}</span>
                            <span class="nav-label">Cadastro de RNC</span>
                        </div>
                        ${isCurrentUserAdmin() ? `
                            <div class="nav-item ${state.currentPage === 'admin' || state.currentPage === 'cadastro-pessoas' ? 'active' : ''}" data-page="admin" title="Cadastro Base" aria-label="Cadastro Base" tabindex="0">
                                <span class="nav-icon">${renderIcon('base')}</span>
                                <span class="nav-label">Cadastro Base</span>
                            </div>
                            <div class="nav-item ${state.currentPage === 'movimentacoes' ? 'active' : ''}" data-page="movimentacoes" title="Movimentações" aria-label="Movimentações" tabindex="0">
                                <span class="nav-icon">${renderIcon('logs')}</span>
                                <span class="nav-label">Movimentações</span>
                            </div>
                        ` : ''}
                        <div class="nav-item ${state.currentPage === 'relatorios' ? 'active' : ''}" data-page="relatorios" title="Relatórios" aria-label="Relatórios" tabindex="0">
                            <span class="nav-icon">${renderIcon('report')}</span>
                            <span class="nav-label">Relatórios</span>
                        </div>
                        <div class="nav-item" data-page="logout" title="Sair" aria-label="Sair" tabindex="0" style="margin-top: 2rem; color: #ef4444;">
                            <span class="nav-icon">${renderIcon('logout')}</span>
                            <span class="nav-label">Sair</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTopBar() {
            const alertasResumo = getAlertasSistema();
            return `
                <div class="top-bar">
                    <div class="top-brand">
                        <button class="top-menu-btn" id="mobileSidebarBtn" type="button" title="Expandir menu" aria-label="Expandir menu">
                            ${renderIcon('menu')}
                        </button>
                        <div class="top-logo">MAGIUS</div>
                        <div class="top-institutional">AJUDANDO A CONSTRUIR, CULTIVAR, TRANSPORTAR E SEGUIR EM FRENTE</div>
                    </div>
                    <div class="top-bar-actions">
                        <button class="notification-btn" id="abrirAlertasBtn" type="button" title="Avisos e pendências">
                            ${renderIcon('bell')}
                            ${alertasResumo.total > 0 ? `<span class="notification-badge">${alertasResumo.total}</span>` : ''}
                        </button>
                        <div class="top-user" id="abrirPerfilModal" role="button" tabindex="0" title="Perfil e segurança">
                            <div class="top-user-meta">
                                <div class="top-user-name">${escapeHtml(state.currentUser.name)}</div>
                                <div class="top-user-role">${escapeHtml(state.currentUser.role)} • ${escapeHtml(state.currentUser.planta || 'Matriz')}</div>
                            </div>
                            <div class="user-avatar" style="width: 38px; height: 38px; margin: 0; font-size: 0.9rem;">${state.currentUser.initials}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAlertasModal() {
            if (!state.alertsModalAberto) return '';
            const alertas = getAlertasSistema();
            const renderSecaoAcoesAtrasadas = alertas.acoesAtrasadas.length
                ? `
                    <div>
                        <div class="alerts-section-title">Ações atrasadas</div>
                        ${alertas.acoesAtrasadas.map(alerta => `
                            <button
                                type="button"
                                class="alerts-item-card red alerts-open-acao"
                                data-alerta-tipo="${escapeHtml(alerta.tipo)}"
                                data-rnc-id="${Number(alerta.rncId)}"
                                data-acao-id="${escapeHtml(String(alerta.acaoId || ''))}">
                                <div class="alerts-item-label">Ação atrasada</div>
                                <div class="alerts-item-line">RNC: ${escapeHtml(alerta.rncNumero)}</div>
                                <div class="alerts-item-line">Ação: ${escapeHtml(alerta.descricao)}</div>
                                <div class="alerts-item-line">Responsável: ${escapeHtml(alerta.responsavel)}</div>
                                <div class="alerts-item-line">Prazo: ${formatDateSafe(alerta.prazo)} (Atraso: ${alerta.atrasoDias} dia${alerta.atrasoDias === 1 ? '' : 's'})</div>
                                ${alerta.historico ? `<div class="alerts-item-line">Histórico de re-prazos: ${escapeHtml(alerta.historico)}</div>` : ''}
                            </button>
                        `).join('')}
                    </div>
                `
                : '';

            const renderSecaoRncProximas = alertas.rncsProximasVencimento.length
                ? `
                    <div>
                        <div class="alerts-section-title">RNCs próximas do vencimento</div>
                        ${alertas.rncsProximasVencimento.map(alerta => `
                            <button type="button" class="alerts-item-card orange alerts-open-rnc" data-rnc-id="${Number(alerta.rncId)}">
                                <div class="alerts-item-label">RNC próxima do vencimento</div>
                                <div class="alerts-item-line">RNC: ${escapeHtml(alerta.rncNumero)}</div>
                                <div class="alerts-item-line">Fase atual: ${escapeHtml(alerta.faseAtual)}</div>
                                <div class="alerts-item-line">Vencimento: ${formatDateSafe(alerta.vencimento)}</div>
                                <div class="alerts-item-line">Histórico de prazos: ${escapeHtml(alerta.historico || '-')}</div>
                            </button>
                        `).join('')}
                    </div>
                `
                : '';

            const renderSecaoRncRisco = alertas.rncsEmRisco.length
                ? `
                    <div>
                        <div class="alerts-section-title">RNCs em risco</div>
                        ${alertas.rncsEmRisco.map(alerta => `
                            <button type="button" class="alerts-item-card red alerts-open-rnc" data-rnc-id="${Number(alerta.rncId)}">
                                <div class="alerts-item-label">RNC em risco</div>
                                <div class="alerts-item-line">RNC: ${escapeHtml(alerta.rncNumero)}</div>
                                <div class="alerts-item-line">Etapa crítica: ${escapeHtml(alerta.etapaCritica)}</div>
                                <div class="alerts-item-line">Dias em atraso: ${Number(alerta.diasAtraso || 0)}</div>
                                <div class="alerts-item-line">Histórico de prazos: ${escapeHtml(alerta.historico || '-')}</div>
                                <div class="alerts-item-line">${escapeHtml(alerta.reprazoInfo || '')}</div>
                            </button>
                        `).join('')}
                    </div>
                `
                : '';

            const semAlertas = !renderSecaoAcoesAtrasadas && !renderSecaoRncProximas && !renderSecaoRncRisco;

            return `
                <div class="alerts-popover-overlay active" id="alertsPopoverOverlay">
                    <div class="alerts-popover">
                        <div class="alerts-popover-header">
                            <div class="alerts-popover-title">Avisos e Pendências</div>
                            <div class="alerts-popover-subtitle">Ações e RNCs que exigem atenção</div>
                        </div>
                        <div class="alerts-popover-content">
                            ${semAlertas ? `<div class="alerts-empty">Nenhum alerta ativo no período selecionado.</div>` : `${renderSecaoAcoesAtrasadas}${renderSecaoRncProximas}${renderSecaoRncRisco}`}
                        </div>
                        <div class="alerts-popover-footer">
                            <button type="button" class="btn btn-secondary" id="fecharAlertasBtn">Fechar</button>
                            <button type="button" class="btn btn-primary" id="irControleViaAlertasBtn">Ver Controle 8D</button>
                            <button type="button" class="btn btn-primary" id="irControleOrdenadoBtn">Ver todas ordenadas por criticidade</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPerfilModal() {
            if (!state.perfilModalAberto || !state.currentUser) return '';
            const podeGerenciarSenha = isCurrentUserAdmin();
            const usuariosSenha = pessoasBase
                .filter(pessoa => normalizeEmail(pessoa.email))
                .map(pessoa => ({ email: normalizeEmail(pessoa.email), nome: pessoa.nome }))
                .filter((pessoa, idx, arr) => arr.findIndex(item => item.email === pessoa.email) === idx);
            const emailAtual = normalizeEmail(state.currentUser.email);
            if (emailAtual && !usuariosSenha.some(usuario => usuario.email === emailAtual)) {
                usuariosSenha.unshift({ email: emailAtual, nome: state.currentUser.name });
            }
            return `
                <div class="modal-overlay active" id="perfilModal">
                    <div class="modal-content" style="max-width: 620px;">
                        <div class="modal-header">
                            <div>
                                <h2 class="modal-title">Perfil do Usuário</h2>
                                <p style="color:#64748b; margin-top:0.4rem;">Gerencie seus dados e segurança sem sair da tela atual.</p>
                            </div>
                            <button class="modal-close" id="fecharPerfilModal">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="modal-tabs">
                                <button type="button" class="modal-tab profile-modal-tab ${state.perfilAbaAtiva === 'perfil' ? 'active' : ''}" data-perfil-tab="perfil">Perfil</button>
                                ${podeGerenciarSenha ? `<button type="button" class="modal-tab profile-modal-tab ${state.perfilAbaAtiva === 'seguranca' ? 'active' : ''}" data-perfil-tab="seguranca">Segurança / Senha</button>` : ''}
                            </div>
                            <div class="tab-content ${state.perfilAbaAtiva === 'perfil' ? 'active' : ''}">
                                <div class="card" style="margin-bottom:0;">
                                    <p><strong>Nome:</strong> ${escapeHtml(state.currentUser.name)}</p>
                                    <p style="margin-top:0.5rem;"><strong>Cargo:</strong> ${escapeHtml(state.currentUser.role)}</p>
                                    <p style="margin-top:0.5rem;"><strong>Planta:</strong> ${escapeHtml(state.currentUser.planta || 'Matriz')}</p>
                                    <p style="margin-top:0.5rem;"><strong>E-mail:</strong> ${escapeHtml(state.currentUser.email || '-')}</p>
                                </div>
                            </div>
                            <div class="tab-content ${state.perfilAbaAtiva === 'seguranca' ? 'active' : ''}">
                                ${podeGerenciarSenha ? `
                                    <form id="segurancaSenhaForm">
                                        <div class="form-group">
                                            <label>Usuário</label>
                                            <select name="usuarioEmail" required>
                                                ${usuariosSenha.map(usuario => `
                                                    <option value="${escapeHtml(usuario.email)}" ${usuario.email === emailAtual ? 'selected' : ''}>${escapeHtml(usuario.nome)} (${escapeHtml(usuario.email)})</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Nova senha</label>
                                            <input type="password" name="novaSenha" minlength="8" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Confirmar nova senha</label>
                                            <input type="password" name="confirmarNovaSenha" minlength="8" required>
                                        </div>
                                        <p id="segurancaSenhaMsg" style="font-size:0.875rem; margin-bottom:0.75rem; color:#64748b;"></p>
                                        <button type="submit" class="btn btn-primary">Atualizar senha do usuário</button>
                                    </form>
                                ` : `
                                    <div class="card" style="margin-bottom:0;">
                                        <p style="color:#64748b;">A gestão de senha é restrita ao perfil ADMIN.</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderExportAnaliticoModal() {
            if (!state.exportModalAberto) return '';
            const selected = state.exportAnalisesSelecionadas || {};
            const hasAnyAnalysisSelected = Object.values(selected).some(Boolean);
            const mk = (key, label) => `
                <label class="export-checkbox-item">
                    <input type="checkbox" data-export-key="${key}" ${selected[key] ? 'checked' : ''}>
                    <span>${label}</span>
                </label>
            `;
            return `
                <div class="modal-overlay active" id="exportAnaliticoModal">
                    <div class="modal-content" style="max-width:900px;">
                        <div class="modal-header">
                            <div>
                                <h2 class="modal-title">Exportações Analíticas – Relatórios 8D (Excel)</h2>
                                <p style="color:#64748b; margin-top:0.4rem;">Selecione quais análises gerar para a competência ${getCompetenciaLabelAtual()}.</p>
                            </div>
                            <button class="modal-close" id="fecharExportAnaliticoModal">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="export-modal-grid">
                                <div class="export-box">
                                    <h4>Análises Gerais da RNC</h4>
                                    <hr>
                                    ${mk('resumoGeral', 'Resumo Geral das RNCs')}
                                    ${mk('volumePecasImpactadas', 'Volume de Peças Impactadas')}
                                    ${mk('statusPrioridade', 'Status e Prioridade')}
                                </div>
                                <div class="export-box">
                                    <h4>Análise de Tempo</h4>
                                    <hr>
                                    ${mk('tempoPorFase', 'Tempo por Fase (D1 a D8)')}
                                    ${mk('leadTimeTotal', 'Lead Time Total (D1 → D8)')}
                                    ${mk('tempoMedioPorFase', 'Tempo médio por fase')}
                                    ${mk('tempoAtrasoPorFase', 'Tempo em atraso por fase')}
                                </div>
                                <div class="export-box">
                                    <h4>Prazo e Re-prazo</h4>
                                    <hr>
                                    ${mk('numeroReprazosPorRnc', 'Número de Re-prazos por RNC')}
                                    ${mk('primeiroPrazoUltimoPrazo', 'Data do primeiro prazo x último prazo')}
                                    ${mk('diasAdicionadosReprazo', 'Dias adicionados por re-prazo')}
                                    ${mk('rncsComReprazo', 'RNCs com re-prazo (Sim/Não)')}
                                </div>
                                <div class="export-box">
                                    <h4>Análise de Ações</h4>
                                    <hr>
                                    ${mk('qtdAcoesCorretivas', 'Quantidade de ações corretivas por RNC')}
                                    ${mk('qtdAcoesPreventivas', 'Quantidade de ações preventivas por RNC')}
                                    ${mk('tempoMedioImplementacaoAcoes', 'Tempo médio de implementação das ações')}
                                    ${mk('acoesNoPrazoForaPrazo', 'Ações concluídas no prazo x fora do prazo')}
                                </div>
                                <div class="export-box">
                                    <h4>Contenção e Volume</h4>
                                    <hr>
                                    ${mk('quantidadeTotalPecas', 'Quantidade total de peças impactadas')}
                                    ${mk('quantidadeInspecionada', 'Quantidade inspecionada')}
                                    ${mk('quantidadeNaoConforme', 'Quantidade não conforme')}
                                    ${mk('percentualNaoConforme', '% de peças não conformes')}
                                </div>
                                <div class="export-box">
                                    <h4>Performance do Sistema</h4>
                                    <hr>
                                    ${mk('taxaRncsNoPrazo', 'Taxa de RNCs no prazo')}
                                    ${mk('taxaRncsEmRisco', 'Taxa de RNCs em risco')}
                                    ${mk('taxaReprazos', 'Taxa de re-prazos')}
                                    ${mk('rncsEncerradasPeriodo', 'RNCs encerradas no período')}
                                </div>
                            </div>
                            <hr class="export-section-divider">
                            <div class="export-box compact">
                                <h4>Exportação Direta (Excel)</h4>
                                <p style="color:#64748b; margin-bottom:0.6rem;">Para uso rápido e operacional.</p>
                                <label class="export-radio-item">
                                    <input type="radio" name="exportDiretoTipo" value="RNC_GERAL" ${state.exportDiretoTipo === 'RNC_GERAL' ? 'checked' : ''}>
                                    <span>RNCs – Visão Geral</span>
                                </label>
                                <label class="export-radio-item">
                                    <input type="radio" name="exportDiretoTipo" value="ACOES" ${state.exportDiretoTipo === 'ACOES' ? 'checked' : ''}>
                                    <span>Ações</span>
                                </label>
                                <label class="export-radio-item" style="margin-bottom:0;">
                                    <input type="radio" name="exportDiretoTipo" value="INDICADORES" ${state.exportDiretoTipo === 'INDICADORES' ? 'checked' : ''}>
                                    <span>Indicadores Mensais</span>
                                </label>
                            </div>
                            <div style="display:flex; justify-content:flex-end; gap:0.75rem; margin-top:1rem;">
                                <button type="button" class="btn btn-secondary" id="cancelarExportAnalitico">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="confirmarExportAnalitico" ${hasAnyAnalysisSelected ? '' : 'disabled'}>Gerar Excel Analítico</button>
                                <button type="button" class="btn btn-primary" id="confirmarExportDireto">Exportar Excel Simples</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const anosDisponiveis = [...new Set(state.rncs
                .map(r => new Date(r.dataAbertura).getFullYear())
                .filter(y => !Number.isNaN(y))
                .concat([new Date().getFullYear()]))].sort((a, b) => a - b);
            const rncsCompetencia = getDashboardCompetenciaRncs();
            const trendData = buildCompetenciaTrendData();

            // Cálculos de métricas básicas
            const total = rncsCompetencia.length;
            const noPrazo = rncsCompetencia.filter(r => getStatusRncValue(r) === "ON_TIME").length;
            const emRisco = rncsCompetencia.filter(r => getStatusRncValue(r) === "AT_RISK").length;
            
            // Cálculos Lean
            const taxaNoPrazo = total > 0 ? ((noPrazo / total) * 100).toFixed(1) : 0;
            const rncsComReprazo = rncsCompetencia.filter(r => {
                return Object.values(r.prazos).some(p => p.reprazo1 !== null || p.reprazo2 !== null);
            }).length;
            const taxaReprazo = total > 0 ? ((rncsComReprazo / total) * 100).toFixed(1) : 0;
            
            // Lead Time médio (simulado - dias desde abertura)
            const hoje = new Date('2026-02-14');
            const leadTimes = rncsCompetencia.map(r => {
                const abertura = new Date(r.dataAbertura);
                return Math.floor((hoje - abertura) / (1000 * 60 * 60 * 24));
            });
            const avgLeadTime = leadTimes.length > 0 ? 
                (leadTimes.reduce((a, b) => a + b, 0) / leadTimes.length).toFixed(1) : 0;
            
            // Comparação com mês anterior
            const prevTotal = historicalData.previousMonth.total;
            const totalTrend = total - prevTotal;
            const totalTrendPercent = prevTotal > 0 ? ((totalTrend / prevTotal) * 100).toFixed(0) : 0;
            const leadTimeTrend = avgLeadTime - historicalData.previousMonth.avgLeadTime;
            
            // Distribuição por setor
            const porSetor = {};
            rncsCompetencia.forEach(r => {
                porSetor[r.setor] = (porSetor[r.setor] || 0) + 1;
            });
            const setorData = Object.entries(porSetor).map(([setor, count]) => ({ setor, count }))
                .sort((a, b) => b.count - a.count);
            
            // Distribuição por tipo de falha
            const porTipo = {};
            rncsCompetencia.forEach(r => {
                porTipo[r.tipoFalha] = (porTipo[r.tipoFalha] || 0) + 1;
            });
            const tipoData = Object.entries(porTipo).map(([tipo, count]) => ({ tipo, count }))
                .sort((a, b) => b.count - a.count);
            
            // Tempo médio por fase (simulado)
            const tempoMedioPorFase = {
                'D1-D2': 0.5,
                'D2-D3': 1.2,
                'D3-D4': 3.5,
                'D4-D5': 2.8,
                'D5-D6': 4.2,
                'D6-D7': 5.5,
                'D7-D8': 1.5
            };

            const searchTerm = String(state.dashboardSearch || '').trim().toLowerCase();
            const listaFiltrada = rncsCompetencia.filter(rnc =>
                !searchTerm ||
                String(rnc.numero || '').toLowerCase().includes(searchTerm) ||
                String(rnc.cliente || '').toLowerCase().includes(searchTerm)
            );
            const pageSize = 5;
            const totalPages = Math.max(1, Math.ceil(listaFiltrada.length / pageSize));
            const currentPage = Math.min(state.dashboardPage, totalPages);
            state.dashboardPage = currentPage;
            const start = (currentPage - 1) * pageSize;
            const listaPaginada = listaFiltrada.slice(start, start + pageSize);
             
            return `
                <div class="dashboard-filter-bar">
                    <div class="form-group" style="margin-bottom:0;">
                        <label>Mês</label>
                        <select id="dashboardMonthFilter">
                            ${meses.map((mes, idx) => `<option value="${idx}" ${Number(state.dashboardFilterMonth) === idx ? 'selected' : ''}>${mes}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label>Ano</label>
                        <select id="dashboardYearFilter">
                            ${anosDisponiveis.map(ano => `<option value="${ano}" ${Number(state.dashboardFilterYear) === ano ? 'selected' : ''}>${ano}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <!-- Métricas Principais -->
                <div class="stats-grid">
                    <div class="stat-card fade-in-up stagger-1" data-filter="all">
                        <div class="stat-header">
                            <div class="stat-icon">${renderIcon('chart')}</div>
                        </div>
                        <div class="stat-label">Total de RNCs</div>
                        <div class="stat-value">${total}</div>
                        <div class="stat-trend ${totalTrend > 0 ? 'negative' : totalTrend < 0 ? 'positive' : 'neutral'}">
                            <span>${totalTrend > 0 ? '↗' : totalTrend < 0 ? '↘' : '→'} ${Math.abs(totalTrendPercent)}%</span>
                        </div>
                        <div class="stat-comparison">vs mês anterior (${prevTotal})</div>
                    </div>
                    
                    <div class="stat-card success fade-in-up stagger-2" data-filter="ON_TIME">
                        <div class="stat-header">
                            <div class="stat-icon">${renderIcon('check')}</div>
                        </div>
                        <div class="stat-label">No Prazo</div>
                        <div class="stat-value" style="color: #059669;">${noPrazo}</div>
                        <div class="stat-trend positive">
                            <span>${taxaNoPrazo}% do total</span>
                        </div>
                        <div class="stat-comparison">Meta: ≥ 80%</div>
                    </div>
                    
                    <div class="stat-card danger fade-in-up stagger-3" data-filter="AT_RISK">
                        <div class="stat-header">
                            <div class="stat-icon">${renderIcon('alert')}</div>
                        </div>
                        <div class="stat-label">Em Risco</div>
                        <div class="stat-value" style="color: #dc2626;">${emRisco}</div>
                        <div class="stat-trend ${emRisco > 2 ? 'negative' : 'positive'}">
                            <span>${total > 0 ? ((emRisco / total) * 100).toFixed(1) : '0.0'}% do total</span>
                        </div>
                        <div class="stat-comparison">Meta: ≤ 20%</div>
                    </div>
                    
                    <div class="stat-card fade-in-up stagger-4">
                        <div class="stat-header">
                            <div class="stat-icon">${renderIcon('time')}</div>
                        </div>
                        <div class="stat-label">Lead Time Médio</div>
                        <div class="stat-value" style="font-size: 2.25rem;">${avgLeadTime}<span style="font-size: 1rem; color: #64748b; font-weight: 600;"> dias</span></div>
                        <div class="stat-trend ${leadTimeTrend > 0 ? 'negative' : 'positive'}">
                            <span>${leadTimeTrend > 0 ? '↗' : '↘'} ${Math.abs(leadTimeTrend).toFixed(1)} dias</span>
                        </div>
                        <div class="stat-comparison">vs mês anterior</div>
                    </div>
                </div>
                
                <!-- Métricas Lean -->
                <div class="section-title" style="margin-top: 2rem;"><span class="section-title-icon">${renderIcon('metrics')}</span> Métricas Lean</div>
                <div class="lean-metrics-grid">
                    <div class="stat-card ${taxaNoPrazo >= 80 ? 'success' : taxaNoPrazo >= 60 ? 'warning' : 'danger'} fade-in-up">
                        <div class="stat-label">Taxa Resolução no Prazo</div>
                        <div class="stat-value" style="font-size: 2.5rem; color: ${taxaNoPrazo >= 80 ? '#059669' : taxaNoPrazo >= 60 ? '#f59e0b' : '#dc2626'};">${taxaNoPrazo}%</div>
                        <div class="stat-comparison">RNCs concluídas dentro do prazo</div>
                    </div>
                    
                    <div class="stat-card warning fade-in-up">
                        <div class="stat-label">Taxa de Re-prazos</div>
                        <div class="stat-value" style="font-size: 2.5rem; color: #f59e0b;">${taxaReprazo}%</div>
                        <div class="stat-comparison">${rncsComReprazo} de ${total} RNCs com reprazo</div>
                    </div>
                    
                    <div class="stat-card fade-in-up">
                        <div class="stat-label">Tempo Médio D1 → D8</div>
                        <div class="stat-value" style="font-size: 2.5rem;">15.2<span style="font-size: 1rem; color: #64748b; font-weight: 600;"> dias</span></div>
                        <div class="stat-comparison">Ciclo completo 8D</div>
                    </div>
                </div>
                
                <!-- Gráficos -->
                <div class="section-title" style="margin-top: 2rem;"><span class="section-title-icon">${renderIcon('analytics')}</span> Análises Visuais</div>
                <div class="charts-grid">
                    <!-- Gráfico RNCs por Setor -->
                    <div class="chart-card fade-in-up">
                        <div class="chart-title">RNCs por Setor</div>
                        <div class="bar-chart">
                            ${setorData.map(item => {
                                const percentage = (item.count / total) * 100;
                                return `
                                    <div class="bar-item">
                                        <div class="bar-label">${item.setor}</div>
                                        <div class="bar-container">
                                            <div class="bar-fill" style="width: ${percentage}%">
                                                ${item.count > 1 ? item.count : ''}
                                            </div>
                                        </div>
                                        <div class="bar-value">${item.count}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Gráfico Distribuição de Status -->
                    <div class="chart-card fade-in-up">
                        <div class="chart-title">Distribuição de Status</div>
                        <div class="donut-chart">
                            <div class="donut-container">
                                <svg class="donut-svg" width="200" height="200" viewBox="0 0 200 200">
                                    ${renderDonutChart(noPrazo, emRisco)}
                                </svg>
                                <div class="donut-center">
                                    <div class="donut-total">${total}</div>
                                    <div class="donut-label-text">RNCs</div>
                                </div>
                            </div>
                            <div class="donut-legend">
                                <div class="donut-legend-item">
                                    <div class="donut-color" style="background: #10b981;"></div>
                                    <div class="donut-legend-label">No Prazo</div>
                                    <div class="donut-legend-value">${noPrazo}</div>
                                </div>
                                <div class="donut-legend-item">
                                    <div class="donut-color" style="background: #ef4444;"></div>
                                    <div class="donut-legend-label">Em Risco</div>
                                    <div class="donut-legend-value">${emRisco}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gráfico RNCs por Tipo de Falha -->
                    <div class="chart-card fade-in-up">
                        <div class="chart-title">RNCs por Tipo de Falha</div>
                        <div class="bar-chart">
                            ${tipoData.map(item => {
                                const percentage = (item.count / total) * 100;
                                return `
                                    <div class="bar-item">
                                        <div class="bar-label">${item.tipo}</div>
                                        <div class="bar-container">
                                            <div class="bar-fill" style="width: ${percentage}%; background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);">
                                                ${item.count > 1 ? item.count : ''}
                                            </div>
                                        </div>
                                        <div class="bar-value">${item.count}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Gráfico Tendência Mensal -->
                    <div class="chart-card fade-in-up">
                        <div class="chart-title">Tendência de RNCs (Últimos 6 Meses)</div>
                        <div class="line-chart">
                            <svg class="line-chart-svg" viewBox="0 0 100 50">
                                ${renderLineChart(trendData)}
                            </svg>
                        </div>
                        <div class="line-chart-labels">
                            ${trendData.map(m => `
                                <span class="line-chart-label">${m.month}</span>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Tabela de RNCs -->
                <div class="section-title" style="margin-top: 2rem;"><span class="section-title-icon">${renderIcon('list')}</span> Lista de RNCs</div>
                <div class="card fade-in-up">
                    <div class="dashboard-list-toolbar">
                        <input id="dashboardSearchInput" type="text" placeholder="Buscar por número ou cliente" value="${escapeHtml(state.dashboardSearch || '')}" style="max-width: 320px;">
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <button class="btn btn-secondary" id="dashboardPrevPage" ${currentPage <= 1 ? 'disabled' : ''}>Anterior</button>
                            <button class="btn btn-secondary" id="dashboardNextPage" ${currentPage >= totalPages ? 'disabled' : ''}>Próxima</button>
                            <span class="pagination-info">Página ${currentPage} de ${totalPages}</span>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Cliente</th>
                                <th>Tipo</th>
                                <th>Setor</th>
                                <th>Prioridade</th>
                                <th>Fase</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${listaPaginada.map(rnc => {
                                const statusRnc = getStatusRncValue(rnc);
                                return `
                                <tr class="rnc-row" data-rnc-id="${rnc.id}">
                                    <td style="font-weight: 700; color: #1e40af;">${rnc.numero}</td>
                                    <td>${rnc.cliente}</td>
                                    <td>${rnc.tipoFalha}</td>
                                    <td>${rnc.setor}</td>
                                    <td><span class="badge ${rnc.prioridade === 'Alta' ? 'red' : 'orange'}">${rnc.prioridade}</span></td>
                                    <td><span class="badge blue">${phases.find(p => p.id === rnc.faseAtual).name}</span></td>
                                    <td><span class="badge ${statusRnc === 'ON_TIME' ? 'green' : 'red'}">${statusRnc === 'ON_TIME' ? 'No Prazo' : 'Em Risco'}</span></td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Função auxiliar para renderizar gráfico donut
        function renderDonutChart(onTime, atRisk) {
            const total = onTime + atRisk;
            if (total === 0) return '';
            
            const radius = 80;
            const circumference = 2 * Math.PI * radius;
            const onTimePercent = onTime / total;
            const atRiskPercent = atRisk / total;
            
            const onTimeStroke = circumference * onTimePercent;
            const atRiskStroke = circumference * atRiskPercent;
            
            return `
                <circle cx="100" cy="100" r="${radius}" fill="none" stroke="#f1f5f9" stroke-width="30"/>
                <circle cx="100" cy="100" r="${radius}" fill="none" stroke="#10b981" stroke-width="30"
                    stroke-dasharray="${onTimeStroke} ${circumference}"
                    stroke-dashoffset="0"
                    style="transition: stroke-dasharray 1s ease;"/>
                <circle cx="100" cy="100" r="${radius}" fill="none" stroke="#ef4444" stroke-width="30"
                    stroke-dasharray="${atRiskStroke} ${circumference}"
                    stroke-dashoffset="${-onTimeStroke}"
                    style="transition: stroke-dasharray 1s ease;"/>
            `;
        }
        
        // Função auxiliar para renderizar gráfico de linha
        function renderLineChart(data) {
            if (!data.length) return '';
            const maxCount = Math.max(1, ...data.map(d => d.count || 0));
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * 100;
                const y = 45 - ((d.count / maxCount) * 35);
                return `${x},${y}`;
            }).join(' ');
            
            const area = `0,45 ${points} 100,45`;
            
            return `
                <defs>
                    <linearGradient id="lineGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3" />
                        <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0.05" />
                    </linearGradient>
                </defs>
                <polygon points="${area}" fill="url(#lineGradient)" />
                <polyline points="${points}" fill="none" stroke="#3b82f6" stroke-width="2" />
                ${data.map((d, i) => {
                    const x = (i / (data.length - 1)) * 100;
                    const y = 45 - ((d.count / maxCount) * 35);
                    return `<circle cx="${x}" cy="${y}" r="2" fill="#1e40af" />`;
                }).join('')}
            `;
        }

        function renderCadastroRNC() {
            return `
                <h1 class="page-title">Cadastro de RNC</h1>
                <div class="card">
                    <h3 style="font-size: 1.125rem; font-weight: 800; margin-bottom: 1.25rem;">Cadastro de RNC</h3>
                    <form id="cadastroRncForm">
                        <div class="form-group" style="padding:0.8rem; border:1px solid #bfdbfe; border-radius:8px; background:#eff6ff; margin-bottom:1rem;">
                            <label>Número da RNC *</label>
                            <input type="text" name="numeroRnc" id="numeroRncInput" placeholder="Ex.: RNC-2026-001" required>
                            <p id="numeroRncValidacao" aria-live="polite" style="font-size: 0.8125rem; color: #dc2626; margin-top: 0.45rem; display:none;"></p>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Cliente</label>
                                <select name="cliente" required>
                                    <option value="">Selecione</option>
                                    ${getClientesAtivos().map(cliente => `<option value="${escapeHtml(cliente.nome)}">${escapeHtml(cliente.nome)}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Código da Peça</label>
                                <input type="text" name="codigoPeca" required>
                            </div>
                            <div class="form-group">
                                <label>Tipo de Falha</label>
                                <select name="tipoFalha" required>
                                    <option value="">Selecione</option>
                                    ${getModosFalhaAtivos().map(modo => `<option value="${escapeHtml(modo.nome)}">${escapeHtml(modo.nome)}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Setor</label>
                                <select name="setor" required>
                                    <option value="">Selecione</option>
                                    <option value="Usinagem">Usinagem</option>
                                    <option value="Pintura">Pintura</option>
                                    <option value="Montagem">Montagem</option>
                                    <option value="Acabamento">Acabamento</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Prioridade</label>
                                <select name="prioridade" required>
                                    <option value="">Selecione</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Média">Média</option>
                                    <option value="Baixa">Baixa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Quantidade</label>
                                <input type="number" name="quantidade" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Analista de Engenharia</label>
                                <select name="analistaEngenhariaId" required>
                                    <option value="">Selecione</option>
                                    ${getPessoasOptions()}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Analista da Qualidade</label>
                                <select name="analistaQualidadeId" required>
                                    <option value="">Selecione</option>
                                    ${getPessoasOptions()}
                                </select>
                                <p style="font-size: 0.75rem; color: #1d4ed8; margin-top: 0.5rem;">Regra automática: o Analista da Qualidade será o Líder da Equipe 8D.</p>
                            </div>
                            <div class="form-group">
                                <label>Responsável da Contenção</label>
                                <select name="responsavelContencaoId" required>
                                    <option value="">Selecione</option>
                                    ${getPessoasOptions()}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Outros Envolvidos</label>
                                <div style="display:flex; gap:0.5rem; align-items:center;">
                                    <select id="outrosEnvolvidosSelect" aria-label="Selecione outros envolvidos da RNC">
                                        <option value="">Selecione</option>
                                        ${getPessoasOptions()}
                                    </select>
                                    <button type="button" class="btn btn-secondary" id="adicionarOutroEnvolvidoBtn">Adicionar</button>
                                </div>
                                <input type="hidden" name="outrosEnvolvidosIds" id="outrosEnvolvidosIds" value="">
                                <div id="outrosEnvolvidosSelecionados" style="margin-top:0.6rem; display:flex; flex-wrap:wrap; gap:0.4rem;"></div>
                                <p id="outrosEnvolvidosHint" style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">Selecione um nome e clique em adicionar. Você pode remover depois.</p>
                            </div>
                            <div class="form-group">
                                <label>Foto da Peça Conforme</label>
                                <input type="file" name="fotoConforme" accept="image/*" required>
                            </div>
                            <div class="form-group">
                                <label>Foto da Peça Não Conforme</label>
                                <input type="file" name="fotoNaoConforme" accept="image/*" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Descrição da Não Conformidade</label>
                            <textarea rows="3" name="descricao" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" id="cadastroRncSubmitBtn">Cadastrar RNC</button>
                    </form>
                </div>
            `;
        }

        function renderAdmin() {
            if (!isCurrentUserAdmin()) {
                return `
                    <h1 class="page-title">Cadastro Base</h1>
                    <div class="card">
                        <p style="color:#475569;">Acesso restrito. Apenas usuários com perfil ADMIN podem visualizar esta área.</p>
                    </div>
                `;
            }
            const abas = [
                { id: 'pessoas', label: 'Pessoas', tipo: 'pessoas' },
                { id: 'clientes', label: 'Clientes', tipo: 'clientes' },
                { id: 'modos', label: 'Modos de Falha', tipo: 'modos-falha' },
                { id: 'templates', label: 'Templates de E-mail', tipo: '' }
            ];
            const totalPorTipo = {
                pessoas: pessoasBase.length,
                clientes: clientesBase.length,
                modos: modosFalhaBase.length
            };
            const templateAtual = getTemplateEscalonamento(state.adminTemplateTipo || 'FASE');
            return `
                <h1 class="page-title">Cadastro Base</h1>
                <div class="card">
                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                        ${abas.map(aba => `
                            <button type="button" class="modal-tab admin-tab-btn ${state.adminTabAtiva === aba.id ? 'active' : ''}" data-admin-tab="${aba.id}">${aba.label}</button>
                        `).join('')}
                    </div>
                </div>
                <div class="card" style="${state.adminTabAtiva === 'templates' ? 'display:none;' : ''}">
                    ${['pessoas', 'clientes', 'modos'].includes(state.adminTabAtiva) ? `
                        <h3 style="font-size: 1.1rem; font-weight: 800; margin-bottom: 0.5rem;">${abas.find(a => a.id === state.adminTabAtiva)?.label || ''}</h3>
                        <p style="color:#64748b; margin-bottom: 1rem;">${state.adminTabAtiva === 'pessoas' ? 'Base de usuários, perfis e gerência vinculada para escalonamento.' : state.adminTabAtiva === 'clientes' ? 'Clientes ativos/inativos para seleção no cadastro da RNC.' : 'Modos de falha disponíveis para seleção no cadastro da RNC.'}</p>
                        <p style="font-size:0.875rem; color:#475569; margin-bottom: 1rem;">Itens cadastrados: <strong>${totalPorTipo[state.adminTabAtiva] || 0}</strong></p>
                        <button type="button" class="btn btn-primary btn-gerenciar-cadastro" data-cadastro-tipo="${abas.find(a => a.id === state.adminTabAtiva)?.tipo || ''}">Gerenciar</button>
                    ` : ''}
                </div>
                <div class="card" style="${state.adminTabAtiva === 'templates' ? '' : 'display:none;'}">
                    <h3 style="font-size:1.1rem; font-weight:800; margin-bottom:0.75rem;">Templates de E-mail (Escalonamento)</h3>
                    <div class="form-group">
                        <label>Tipo de Template</label>
                        <select id="adminTemplateTipoSelect">
                            <option value="FASE" ${(state.adminTemplateTipo || 'FASE') === 'FASE' ? 'selected' : ''}>Escalonamento por atraso de FASE</option>
                            <option value="ACAO" ${state.adminTemplateTipo === 'ACAO' ? 'selected' : ''}>Escalonamento por atraso de AÇÃO</option>
                            <option value="PRAZO_TOTAL_RNC" ${state.adminTemplateTipo === 'PRAZO_TOTAL_RNC' ? 'selected' : ''}>Escalonamento por estouro do prazo total da RNC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Assunto do e-mail</label>
                        <input type="text" id="adminTemplateAssunto" value="${escapeHtml(templateAtual.assunto || '')}">
                    </div>
                    <div class="form-group">
                        <label>Corpo do e-mail</label>
                        <textarea rows="7" id="adminTemplateCorpo">${escapeHtml(templateAtual.corpo || '')}</textarea>
                    </div>
                    <p style="font-size:0.8125rem; color:#64748b; margin-bottom:0.75rem;">Variáveis: {{numero_rnc}}, {{cliente}}, {{fase}}, {{acao}}, {{responsavel}}, {{dias_atraso}}, {{quantidade_reprazo}}, {{data_referencia}}</p>
                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                        <button type="button" class="btn btn-success" id="salvarTemplateEmailBtn">Salvar Template</button>
                        <button type="button" class="btn btn-secondary" id="testarTemplateEmailBtn">Testar Template</button>
                    </div>
                    <p id="adminTemplateFeedback" style="display:none; margin-top:0.75rem; font-size:0.85rem;"></p>
                </div>
                <div class="card">
                    <h3 style="font-size:1rem; font-weight:700; margin-bottom:0.75rem;">Auditoria de Alterações</h3>
                    <div style="max-height:220px; overflow:auto;">
                        <table>
                            <thead><tr><th>Data</th><th>Ação</th><th>Detalhe</th><th>Usuário</th></tr></thead>
                            <tbody>
                                ${auditoriaAdmin.length ? auditoriaAdmin.slice(0, MAX_ADMIN_AUDIT_DISPLAY).map(item => `
                                    <tr>
                                        <td>${extractAndFormatDate(item.data)}</td>
                                        <td>${escapeHtml(item.acao)}</td>
                                        <td>${escapeHtml(item.detalhe)}</td>
                                        <td>${escapeHtml(item.por)}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="4" style="text-align:center; color:#64748b;">Sem registros de auditoria.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderMovimentacoes() {
            if (!isCurrentUserAdmin()) {
                return `
                    <h1 class="page-title">Movimentações</h1>
                    <div class="card">
                        <p style="color:#475569;">Acesso restrito. Apenas usuários com perfil ADMIN podem visualizar esta área.</p>
                    </div>
                `;
            }
            const filtros = state.movimentacoesFilters || {};
            const normalize = (v) => String(v || '').trim().toLowerCase();
            const inicio = filtros.dataInicio ? parseISODate(filtros.dataInicio) : null;
            const fimRaw = filtros.dataFim ? parseISODate(filtros.dataFim) : null;
            const fim = fimRaw ? new Date(fimRaw) : null;
            if (fim) fim.setHours(23, 59, 59, 999);
            const logsFiltrados = auditoriaAdmin.filter(item => {
                const data = new Date(item.data || '');
                if (inicio && data < inicio) return false;
                if (fim && data > fim) return false;
                if (filtros.usuario && normalize(item.usuario || item.por) !== normalize(filtros.usuario)) return false;
                if (filtros.tipoAcao && String(item.tipoAcao || item.acao || '').toUpperCase() !== String(filtros.tipoAcao).toUpperCase()) return false;
                if (filtros.modulo && normalize(item.modulo) !== normalize(filtros.modulo)) return false;
                if (filtros.numeroRnc && !normalize(item.referencia || '').includes(normalize(filtros.numeroRnc))) return false;
                return true;
            });
            const usuarios = [...new Set(auditoriaAdmin.map(item => item.usuario || item.por).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'pt-BR'));
            const tipos = [...new Set(auditoriaAdmin.map(item => (item.tipoAcao || item.acao || '').toUpperCase()).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'pt-BR'));
            const modulos = [...new Set(auditoriaAdmin.map(item => item.modulo).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'pt-BR'));
            return `
                <h1 class="page-title">Movimentações / Auditoria</h1>
                <div class="card">
                    <div class="grid-2">
                        <div class="form-group"><label>Data inicial</label><input type="date" id="movDataInicio" value="${escapeHtml(filtros.dataInicio || '')}"></div>
                        <div class="form-group"><label>Data final</label><input type="date" id="movDataFim" value="${escapeHtml(filtros.dataFim || '')}"></div>
                        <div class="form-group"><label>Usuário</label><select id="movUsuario"><option value="">Todos</option>${usuarios.map(usuario => `<option value="${escapeHtml(usuario)}" ${filtros.usuario === usuario ? 'selected' : ''}>${escapeHtml(usuario)}</option>`).join('')}</select></div>
                        <div class="form-group"><label>Tipo de ação</label><select id="movTipoAcao"><option value="">Todos</option>${tipos.map(tipo => `<option value="${escapeHtml(tipo)}" ${filtros.tipoAcao === tipo ? 'selected' : ''}>${escapeHtml(tipo)}</option>`).join('')}</select></div>
                        <div class="form-group"><label>Módulo</label><select id="movModulo"><option value="">Todos</option>${modulos.map(modulo => `<option value="${escapeHtml(modulo)}" ${filtros.modulo === modulo ? 'selected' : ''}>${escapeHtml(modulo)}</option>`).join('')}</select></div>
                        <div class="form-group"><label>Número da RNC</label><input type="text" id="movNumeroRnc" placeholder="RNC-2026-001" value="${escapeHtml(filtros.numeroRnc || '')}"></div>
                    </div>
                </div>
                <div class="card">
                    <div style="overflow:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usuário</th>
                                    <th>Perfil</th>
                                    <th>Ação</th>
                                    <th>Módulo</th>
                                    <th>Referência</th>
                                    <th>Descrição</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${logsFiltrados.length ? logsFiltrados.map(item => `
                                    <tr>
                                        <td>${new Date(item.data || '').toLocaleString('pt-BR')}</td>
                                        <td>${escapeHtml(item.usuario || item.por || '-')}</td>
                                        <td>${escapeHtml(item.perfil || '-')}</td>
                                        <td>${escapeHtml(item.tipoAcao || item.acao || '-')}</td>
                                        <td>${escapeHtml(item.modulo || '-')}</td>
                                        <td>${escapeHtml(item.referencia || '-')}</td>
                                        <td>${escapeHtml(item.descricao || item.detalhe || '-')}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="7" style="text-align:center; color:#64748b;">Sem registros para os filtros selecionados.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function getControleRows() {
            const hojeIso = new Date().toISOString().slice(0, 10);
            return state.rncs.map(rnc => {
                const statusConclusao = getStatusConclusao8D(rnc);
                const statusEtapas = getStatusEtapas8D(rnc);
                const responsavel = getResponsavelRNC(rnc);
                const statusRnc = getStatusRncValue(rnc);
                const faseAtual = getFaseAtualDefinida(rnc);
                const fase = phases.find(p => p.id === faseAtual) || phases[0];
                const dataReferencia = getDataReferenciaControle(rnc);
                const governancaReprazo = getGovernancaReprazoFase(rnc, faseAtual);
                const dataAbertura = rnc.dataAbertura || '';
                const atrasos = getEtapasEmAtraso(rnc);
                const maiorAtraso = Math.max(0, ...atrasos.map(item => Number(diffDays(item.vencimento, hojeIso) || 0)));
                const criticidade = (statusEtapas.value === 'COM_ATRASO' ? PESO_CRITICIDADE_ATRASO : 0)
                    + maiorAtraso
                    + (isPrazoTotalRncExcedido(rnc) ? PESO_CRITICIDADE_PRAZO_TOTAL : 0);
                return { rnc, statusConclusao, statusEtapas, responsavel, statusRnc, faseAtual, fase, dataReferencia, dataAbertura, governancaReprazo, criticidade };
            });
        }

        function filtrarControleRows(rows) {
            const filtros = state.controleFilters || {};
            const busca = String(filtros.busca || '').trim().toLowerCase();
            return rows.filter(item => {
                const podeVerExcluidas = isCurrentUserAdmin() && !!filtros.showExcluidas;
                if (isRncExcluida(item.rnc) && !podeVerExcluidas) return false;
                const matchStatus = !filtros.status || item.statusRnc === filtros.status;
                const matchSetor = !filtros.setor || item.rnc.setor === filtros.setor;
                const matchConclusao = !filtros.conclusao || item.statusConclusao.value === filtros.conclusao;
                const matchEtapas = !filtros.etapas || item.statusEtapas.value === filtros.etapas;
                const textoBusca = `${item.rnc.numero} ${item.rnc.cliente} ${item.responsavel}`.toLowerCase();
                const matchBusca = !busca || textoBusca.includes(busca);
                return matchStatus && matchSetor && matchConclusao && matchEtapas && matchBusca;
            });
        }

        function ordenarControleRows(rows) {
            const sort = state.controleSort || { key: '', dir: 'asc' };
            const phaseOrder = { d1: 1, d2: 2, d3: 3, d4: 4, d5: 5, d6: 6, d7: 7, d8: 8 };
            const statusOrder = { COM_ATRASO: 1, SEM_ATRASO: 2 };
            const dir = sort.dir === 'desc' ? -1 : 1;
            const list = [...rows];
            if (!sort.key) return list;
            list.sort((a, b) => {
                let av = '';
                let bv = '';
                if (sort.key === 'numero') {
                    av = String(a.rnc.numero || '');
                    bv = String(b.rnc.numero || '');
                } else if (sort.key === 'responsavel') {
                    av = String(a.responsavel || '');
                    bv = String(b.responsavel || '');
                } else if (sort.key === 'faseAtual') {
                    av = phaseOrder[a.faseAtual] || 99;
                    bv = phaseOrder[b.faseAtual] || 99;
                } else if (sort.key === 'statusEtapas') {
                    av = statusOrder[a.statusEtapas.value] || 99;
                    bv = statusOrder[b.statusEtapas.value] || 99;
                } else if (sort.key === 'dataReferencia') {
                    av = parseISODate(a.dataReferencia)?.getTime() || Number.MAX_SAFE_INTEGER;
                    bv = parseISODate(b.dataReferencia)?.getTime() || Number.MAX_SAFE_INTEGER;
                } else if (sort.key === 'dataAbertura') {
                    av = parseISODate(a.dataAbertura)?.getTime() || Number.MAX_SAFE_INTEGER;
                    bv = parseISODate(b.dataAbertura)?.getTime() || Number.MAX_SAFE_INTEGER;
                } else if (sort.key === 'criticidade') {
                    av = a.criticidade;
                    bv = b.criticidade;
                }
                if (typeof av === 'string' || typeof bv === 'string') return String(av).localeCompare(String(bv), 'pt-BR') * dir;
                return (av - bv) * dir;
            });
            return list;
        }

        function renderControleSortHeader(label, key) {
            const sort = state.controleSort || { key: '', dir: 'asc' };
            const isActive = sort.key === key;
            const upActive = isActive && sort.dir === 'asc';
            const downActive = isActive && sort.dir === 'desc';
            return `
                <button type="button" class="th-sort-btn controle-sort-btn" data-sort-key="${key}">
                    <span>${label}</span>
                    <span class="th-sort-icon ${upActive ? 'active' : ''}">▲</span><span class="th-sort-icon ${downActive ? 'active' : ''}">▼</span>
                </button>
            `;
        }

        function renderControle() {
            const rows = ordenarControleRows(filtrarControleRows(getControleRows()));
            return `
                <h1 class="page-title">Controle 8D</h1>
                <div class="card">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Filtrar por Status</label>
                            <select id="controleFiltroStatus">
                                <option value="">Todos</option>
                                <option value="ON_TIME" ${state.controleFilters.status === 'ON_TIME' ? 'selected' : ''}>No Prazo</option>
                                <option value="AT_RISK" ${state.controleFilters.status === 'AT_RISK' ? 'selected' : ''}>Em Risco</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filtrar por Setor</label>
                            <select id="controleFiltroSetor">
                                <option value="">Todos</option>
                                ${[...new Set(state.rncs.map(r => r.setor))].map(setor => `<option value="${escapeHtml(setor)}" ${state.controleFilters.setor === setor ? 'selected' : ''}>${escapeHtml(setor)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status de Conclusão</label>
                            <select id="controleFiltroConclusao">
                                <option value="">Todos</option>
                                <option value="CONCLUIDO" ${state.controleFilters.conclusao === 'CONCLUIDO' ? 'selected' : ''}>Concluído</option>
                                <option value="EM_ANDAMENTO" ${state.controleFilters.conclusao === 'EM_ANDAMENTO' ? 'selected' : ''}>Em andamento</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Situação de Etapas</label>
                            <select id="controleFiltroEtapas">
                                <option value="">Todos</option>
                                <option value="SEM_ATRASO" ${state.controleFilters.etapas === 'SEM_ATRASO' ? 'selected' : ''}>Sem atraso</option>
                                <option value="COM_ATRASO" ${state.controleFilters.etapas === 'COM_ATRASO' ? 'selected' : ''}>Com atraso</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Buscar por número ou cliente</label>
                        <input type="text" id="controleFiltroBusca" placeholder="Ex.: RNC-2026-001 ou nome do cliente" value="${escapeHtml(state.controleFilters.busca || '')}">
                    </div>
                    ${isCurrentUserAdmin() ? `
                        <div class="form-group" style="margin-top:0.75rem;">
                            <label style="display:flex; align-items:center; gap:0.5rem;">
                                <input type="checkbox" id="controleFiltroExcluidas" ${state.controleFilters.showExcluidas ? 'checked' : ''}>
                                Mostrar RNCs excluídas
                            </label>
                        </div>
                    ` : ''}
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>${renderControleSortHeader('Número da RNC', 'numero')}</th>
                                <th>${renderControleSortHeader('Data de Abertura', 'dataAbertura')}</th>
                                <th>Cliente</th>
                                <th>${renderControleSortHeader('Responsável', 'responsavel')}</th>
                                <th>${renderControleSortHeader('Fase Atual', 'faseAtual')}</th>
                                <th>${renderControleSortHeader('Prazo da Fase Atual', 'dataReferencia')}</th>
                                <th>Status Conclusão</th>
                                <th>${renderControleSortHeader('Status da Fase', 'statusEtapas')}</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.map(item => {
                                const { rnc, statusConclusao, statusEtapas, responsavel, statusRnc, fase, governancaReprazo, dataReferencia, dataAbertura } = item;
                                return `
                                <tr class="controle-row" data-status="${statusRnc}" data-conclusao="${statusConclusao.value}" data-etapas="${statusEtapas.value}" data-setor="${encodeURIComponent(rnc.setor)}">
                                    <td style="font-weight: 700; color: #1e40af;">${rnc.numero}${isRncExcluida(rnc) ? ' <span class="badge red" style="margin-left:0.4rem;">🗑️ RNC EXCLUÍDA</span>' : ''}</td>
                                    <td>${formatDateSafe(dataAbertura)}</td>
                                    <td>${rnc.cliente}</td>
                                    <td>${escapeHtml(responsavel)}</td>
                                    <td><span class="badge blue">${fase.name}</span></td>
                                    <td>${formatDateSafe(dataReferencia)}</td>
                                    <td><span class="badge ${statusConclusao.className}">${statusConclusao.label}</span></td>
                                    <td>
                                        <span class="badge ${statusEtapas.className}" title="${escapeHtml(statusEtapas.detalhe || '')}">${statusEtapas.label}</span>
                                        <span class="controle-status-detail ${governancaReprazo.className}">${governancaReprazo.texto}</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-view" data-rnc-id="${rnc.id}" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                            Ver Detalhes
                                        </button>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderRelatorios() {
            const total = state.rncs.length;
            const noPrazo = state.rncs.filter(r => getStatusRncValue(r) === 'ON_TIME').length;
            const emRisco = state.rncs.filter(r => getStatusRncValue(r) === 'AT_RISK').length;
            const taxaNoPrazo = total > 0 ? ((noPrazo / total) * 100).toFixed(1) : '0.0';

            return `
                <h1 class="page-title">Relatórios Qualificados</h1>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header"><div class="stat-icon">${renderIcon('report')}</div></div>
                        <div class="stat-label">Total Auditado</div>
                        <div class="stat-value">${total}</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-header"><div class="stat-icon">${renderIcon('check')}</div></div>
                        <div class="stat-label">Taxa no Prazo</div>
                        <div class="stat-value" style="color:#059669;">${taxaNoPrazo}%</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-header"><div class="stat-icon">${renderIcon('alert')}</div></div>
                        <div class="stat-label">Pendências Críticas</div>
                        <div class="stat-value" style="color:#dc2626;">${emRisco}</div>
                    </div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:flex-end; margin-bottom:0.75rem;">
                        <button type="button" class="btn btn-primary" id="abrirExportAnaliticoModal">Exportar Análises (Excel)</button>
                    </div>
                    <h3 class="section-title"><span class="section-title-icon">${renderIcon('analytics')}</span> Consolidado por Setor</h3>
                    <table>
                        <thead>
                            <tr><th>Setor</th><th>Quantidade</th><th>Em Risco</th><th>Taxa no Prazo</th></tr>
                        </thead>
                        <tbody>
                            ${Object.entries(state.rncs.reduce((acc, r) => {
                                acc[r.setor] = acc[r.setor] || { total: 0, risk: 0 };
                                acc[r.setor].total += 1;
                                if (getStatusRncValue(r) === 'AT_RISK') acc[r.setor].risk += 1;
                                return acc;
                            }, {})).map(([setor, dados]) => `
                                <tr>
                                    <td>${setor}</td>
                                    <td>${dados.total}</td>
                                    <td>${dados.risk}</td>
                                    <td>${dados.total > 0 ? ((((dados.total - dados.risk) / dados.total) * 100).toFixed(1)) : '0.0'}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderModal() {
            if (!state.selectedRNC) return '';
            
            const rnc = state.selectedRNC;
            sincronizarFluxo8D(rnc);
            if (!canAcessarEtapa(rnc, state.activeTab)) state.activeTab = rnc.faseAtual;
            const currentPhaseIndex = phases.findIndex(p => p.id === rnc.faseAtual);
            
            return `
                <div class="modal-overlay active" id="rncModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div>
                                <h2 class="modal-title">${rnc.numero} - ${rnc.cliente}</h2>
                                <p style="color: #64748b; margin-top: 0.5rem;">Metodologia 8D de Resolução de Problemas</p>
                            </div>
                            <button class="modal-close" id="closeModal">×</button>
                        </div>
                        
                        <div class="modal-body">
                            <div class="phase-tracker">
                                ${phases.map((phase, index) => `
                                    <div class="phase-step">
                                        <div class="phase-circle ${isEtapaConcluida(rnc, phase.id) ? 'completed' : index === currentPhaseIndex ? 'active' : ''}">
                                            ${isEtapaConcluida(rnc, phase.id) ? renderIcon('check') : phase.short}
                                        </div>
                                        <p style="font-size: 0.75rem; font-weight: 600; margin-top: 0.5rem;">${phase.name.replace(/D\d - /, '')}</p>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="modal-tabs">
                                ${phases.map(phase => `
                                    <button class="modal-tab rnc-phase-tab ${state.activeTab === phase.id ? 'active' : ''}" data-tab="${phase.id}" ${canAcessarEtapa(rnc, phase.id) ? '' : 'disabled'}>
                                        ${phase.name}
                                    </button>
                                `).join('')}
                            </div>
                            
                            ${phases.map(phase => `
                                <div class="tab-content ${state.activeTab === phase.id ? 'active' : ''}">
                                    ${renderPhaseContent(rnc, phase)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPhaseContent(rnc, phase) {
            const prazo = rnc.prazos[phase.id];
            const canReprazo = ['d3', 'd4'].includes(phase.id);
            const canManageDeadlines = isCurrentUserAdmin();
            
            let content = `
                <div class="d8-section ${rnc.faseAtual === phase.id ? 'active' : ''}">
                    <div class="d8-header">
                        <h3 class="d8-title">${phase.name}</h3>
                        <div class="prazo-info">
                            <div class="prazo-box original">
                                <div class="prazo-label">Prazo Original (${prazo.sla})</div>
                                <div class="prazo-date">${new Date(prazo.original).toLocaleDateString('pt-BR')}</div>
                            </div>
                            ${prazo.reprazo1 ? `
                                <div class="prazo-box reprazo1">
                                    <div class="prazo-label">Re-prazo 1</div>
                                    <div class="prazo-date">${new Date(prazo.reprazo1).toLocaleDateString('pt-BR')}</div>
                                </div>
                            ` : ''}
                            ${prazo.reprazo2 ? `
                                <div class="prazo-box reprazo2">
                                    <div class="prazo-label">Re-prazo 2</div>
                                    <div class="prazo-date">${new Date(prazo.reprazo2).toLocaleDateString('pt-BR')}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
            `;
            
            // Conteúdo específico de cada fase
            if (phase.id === 'd1') {
                const equipeD1 = montarEquipeD1(rnc);
                content += `
                    ${isCurrentUserAdmin() && !isRncExcluida(rnc) ? `
                        <div style="display:flex; justify-content:flex-end; margin-bottom:0.75rem;">
                            <button type="button" class="btn btn-danger" onclick="abrirModalExcluirRNC()">${renderIcon('trash')} Excluir RNC</button>
                        </div>
                    ` : ''}
                    <div class="card" style="padding: 1rem; margin-top: 0.5rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Equipe da RNC</h4>
                        <table>
                            <thead>
                                <tr><th>Nome</th><th>Função na RNC</th><th>Setor</th><th>Planta</th></tr>
                            </thead>
                            <tbody>
                                ${equipeD1.length === 0 ? `
                                    <tr><td colspan="4" style="text-align:center; color:#64748b;">Equipe não definida no cadastro da RNC.</td></tr>
                                ` : equipeD1.map(item => `
                                    <tr>
                                        <td>${escapeHtml(item.pessoa.nome)}${item.funcaoRnc === 'Analista da Qualidade' ? ' <span class="badge blue" style="margin-left:0.35rem;">Líder da Equipe</span>' : ''}</td>
                                        <td>${escapeHtml(item.funcaoRnc)}</td>
                                        <td>${escapeHtml(item.pessoa.setor || '-')}</td>
                                        <td>${escapeHtml(item.pessoa.planta || '-')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.75rem;">A atualização dos dados da equipe deve ser feita na página "Cadastro de Pessoas".</p>
                    </div>
                `;
            } else if (phase.id === 'd2') {
                const fotoConformeSrc = getSafeImageSrc(rnc.fotosPeca?.conforme?.conteudo);
                const fotoNaoConformeSrc = getSafeImageSrc(rnc.fotosPeca?.naoConforme?.conteudo);
                content += `
                    <div class="card" style="padding:1rem; margin-top:0.5rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Dados do Cadastro da RNC</h4>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Cliente</label>
                                <input type="text" value="${escapeHtml(rnc.cliente || '')}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Modo de Falha</label>
                                <input type="text" value="${escapeHtml(rnc.tipoFalha || '')}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Quantidade de Peças</label>
                                <input type="text" value="${escapeHtml(rnc.quantidade ?? '')}" readonly>
                            </div>
                        </div>
                        <div class="d2-image-layout">
                            <div class="d2-image-card green">
                                ${fotoConformeSrc
                                    ? `<img src="${escapeHtml(fotoConformeSrc)}" alt="Peça conforme" class="d2-image-preview" data-image-src="${escapeHtml(fotoConformeSrc)}" data-image-title="Peça Conforme" role="button" tabindex="0">`
                                    : `<div class="d2-image-empty">Sem foto</div>`
                                }
                                <div class="d2-image-label">Peça Conforme</div>
                            </div>
                            <div class="d2-image-card red">
                                ${fotoNaoConformeSrc
                                    ? `<img src="${escapeHtml(fotoNaoConformeSrc)}" alt="Peça não conforme" class="d2-image-preview" data-image-src="${escapeHtml(fotoNaoConformeSrc)}" data-image-title="Peça Não Conforme" role="button" tabindex="0">`
                                    : `<div class="d2-image-empty">Sem foto</div>`
                                }
                                <div class="d2-image-label">Peça Não Conforme</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Definição do Problema</label>
                        <textarea rows="4" readonly>${escapeHtml(rnc.descricao || rnc.d2.problema || '')}</textarea>
                    </div>
                `;
            } else if (phase.id === 'd3') {
                content += `
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Quantidade de Peças em Estoque</label>
                            <input type="number" min="0" id="d3-estoque" value="${rnc.d3.quantidadeEstoque ?? ''}">
                        </div>
                        <div class="form-group">
                            <label>Quantidade de Peças Inspecionadas</label>
                            <input type="number" min="0" id="d3-inspecionada" value="${rnc.d3.quantidadeInspecionada ?? ''}">
                        </div>
                        <div class="form-group">
                            <label>Quantidade de Peças Não Conformes</label>
                            <input type="number" min="0" id="d3-nao-conforme" value="${rnc.d3.quantidadeNaoConforme ?? ''}">
                        </div>
                        <div class="form-group">
                            <label>Anexo – Alerta Assinado</label>
                            <input type="file" id="d3-alerta-arquivo" accept=".pdf,image/*">
                            ${rnc.d3.anexoAlertaAssinadoNome ? `
                                <div style="margin-top:0.5rem; display:flex; align-items:center; gap:0.5rem;">
                                    <span style="font-size:0.8125rem; color:#475569;">Anexo atual: ${escapeHtml(rnc.d3.anexoAlertaAssinadoNome)}</span>
                                    <button type="button" class="btn btn-secondary" style="padding:0.3rem 0.6rem; font-size:0.75rem;" onclick="removerAnexoD3()">Remover</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Evidências</label>
                        <input type="text" id="d3-evidencia" value="${rnc.d3.evidencia}">
                    </div>
                    <div id="d3-validacao-msg" class="prazo-justificativa" style="margin-bottom:1rem; display:none;"></div>
                    <button type="button" class="btn btn-primary" id="d3-etapa-concluida-btn" onclick="concluirEtapaD3()" disabled>Etapa Concluída</button>
                    ${prazo.reprazo1 ? `
                        <div class="prazo-justificativa">
                            <strong>Justificativa Re-prazo 1:</strong> ${prazo.just1}
                        </div>
                    ` : ''}
                    ${prazo.reprazo2 ? `
                        <div class="prazo-justificativa">
                            <strong>Justificativa Re-prazo 2:</strong> ${prazo.just2}
                        </div>
                    ` : ''}
                `;
            } else if (phase.id === 'd4') {
                ensureD4Structure(rnc);
                const d4 = rnc.d4;
                content += `
                    <div style="display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap;">
                        <button type="button" class="modal-tab d4-subtab ${state.activeD4SubTab === 'principal' ? 'active' : ''}" data-d4-subtab="principal">Principal</button>
                        <button type="button" class="modal-tab d4-subtab ${state.activeD4SubTab === 'ocorrencia' ? 'active' : ''}" data-d4-subtab="ocorrencia">Ocorrência</button>
                        <button type="button" class="modal-tab d4-subtab ${state.activeD4SubTab === 'deteccao' ? 'active' : ''}" data-d4-subtab="deteccao">Detecção</button>
                    </div>
                    ${state.activeD4SubTab === 'principal' ? `
                        <div class="form-group">
                            <label for="d4-causa-raiz-ocorrencia">Causa Raiz – Ocorrência</label>
                            <input type="text" id="d4-causa-raiz-ocorrencia" value="${escapeHtml(getUltimoPorquePreenchido(d4.ocorrencia))}" readonly>
                        </div>
                        <div class="form-group">
                            <label for="d4-causa-raiz-deteccao">Causa Raiz – Detecção</label>
                            <input type="text" id="d4-causa-raiz-deteccao" value="${escapeHtml(getUltimoPorquePreenchido(d4.deteccao))}" readonly>
                        </div>
                    ` : ''}
                    ${state.activeD4SubTab === 'ocorrencia' ? `
                        <h4 style="font-weight: 700; margin-bottom: 1rem;">Análise 5 Porquês - Ocorrência</h4>
                        ${[1,2,3,4,5].map(i => `
                            <div class="form-group">
                                <label>${i}º Por quê?</label>
                                <textarea rows="2" id="d4-oc-why${i}">${escapeHtml(d4.ocorrencia[`why${i}`] || '')}</textarea>
                            </div>
                        `).join('')}
                    ` : ''}
                    ${state.activeD4SubTab === 'deteccao' ? `
                        <h4 style="font-weight: 700; margin-bottom: 1rem;">Análise 5 Porquês - Detecção</h4>
                        ${[1,2,3,4,5].map(i => `
                            <div class="form-group">
                                <label>${i}º Por quê?</label>
                                <textarea rows="2" id="d4-det-why${i}">${escapeHtml(d4.deteccao[`why${i}`] || '')}</textarea>
                            </div>
                        `).join('')}
                    ` : ''}
                `;
            } else if (phase.id === 'd5') {
                const acoesD5 = rnc.d5.listaAcoes || [];
                content += `
                    <div style="display:flex; justify-content:flex-end; margin-bottom:1rem;">
                        <button type="button" class="btn btn-primary" onclick="abrirCadastroAcaoD5()">Cadastrar Ação</button>
                    </div>
                    <div class="card" style="padding: 1rem; margin-top: 1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Ações Cadastradas</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Descrição da Ação</th>
                                    <th>Responsável</th>
                                    <th>Prazo Original</th>
                                    <th>Último Re-prazo</th>
                                    <th>Status de Prazo</th>
                                    <th>Status da Ação</th>
                                    <th>Re-prazo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${acoesD5.length === 0 ? `
                                    <tr>
                                        <td colspan="8" style="text-align:center; color:#64748b;">Nenhuma ação cadastrada.</td>
                                    </tr>
                                ` : acoesD5.map(acao => {
                                    const acaoNormalizada = normalizeAcaoD5(acao);
                                    const indicador = obterIndicadorPrazoAcao(acaoNormalizada);
                                    const responsavelAcao = getPessoaById(acaoNormalizada.responsavelId)?.nome || acaoNormalizada.responsavel || '-';
                                    const ultimoReprazoData = acaoNormalizada.reprazos?.length ? acaoNormalizada.reprazos[acaoNormalizada.reprazos.length - 1]?.data : '';
                                    return `
                                        <tr>
                                            <td>${escapeHtml(acaoNormalizada.descricao || '')}</td>
                                            <td>${escapeHtml(responsavelAcao)}</td>
                                            <td>${formatDateSafe(acaoNormalizada.prazoPrincipal)}</td>
                                            <td>${ultimoReprazoData ? formatDateSafe(ultimoReprazoData) : '—'}</td>
                                            <td><span class="badge ${indicador.className === 'red' ? 'red' : (indicador.className === 'orange' ? 'orange' : 'green')}">${indicador.className === 'red' ? 'Em atraso' : (indicador.className === 'orange' ? 'Próximo ao vencimento' : 'Dentro do prazo')}</span></td>
                                            <td><span class="badge ${acaoNormalizada.status === 'CONCLUIDA' ? 'green' : 'orange'}">${acaoNormalizada.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto'}</span></td>
                                            <td>${acaoNormalizada.reprazos?.length ? `Sim / Nº ${acaoNormalizada.reprazos.length}` : 'Não'}</td>
                                            <td><button type="button" class="btn btn-secondary" style="padding:0.45rem 0.8rem; font-size:0.8125rem;" onclick="abrirCadastroAcaoD5('${acao.id}')">Editar</button></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (phase.id === 'd6') {
                const acoesD6 = (rnc.d5.listaAcoes || []).map(normalizeAcaoD5);
                content += `
                    <div class="card" style="padding:1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Ações para Implementação</h4>
                        ${acoesD6.length === 0 ? `
                            <div style="color:#64748b;">Nenhuma ação cadastrada no D5.</div>
                        ` : `
                            <div style="display:flex; flex-direction:column; gap:0.75rem;">
                                ${acoesD6.map(acao => {
                                    const prazoVigente = obterPrazoVigenteAcao(acao);
                                    const responsavelAcao = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
                                    return `
                                        <button type="button" class="btn btn-secondary" style="text-align:left; width:100%;" onclick="abrirImplementacaoAcaoD6('${acao.id}')">
                                            <strong>${escapeHtml(acao.descricao || 'Ação sem descrição')}</strong><br>
                                            <span style="font-size:0.8125rem; color:#475569;">Responsável: ${escapeHtml(responsavelAcao)} • Prazo vigente: ${formatDateSafe(prazoVigente)} • Status: ${acao.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto'}</span>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            } else if (phase.id === 'd7') {
                const acoesD7 = (rnc.d7.listaAcoes || []).map(normalizeAcaoD7);
                content += `
                    <div class="card" style="padding:1rem; margin-bottom:1rem;">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:0.75rem; margin-bottom:0.75rem;">
                            <h4 style="font-weight:700;">Ações Preventivas Cadastradas (Controle)</h4>
                            <button type="button" class="btn btn-primary" onclick="abrirCadastroAcaoD7()">Cadastrar Ação Preventiva</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Descrição da Ação Preventiva</th>
                                    <th>Responsável</th>
                                    <th>Origem da Prevenção</th>
                                    <th>Prazo Original</th>
                                    <th>Último Re-prazo</th>
                                    <th>Status de Prazo</th>
                                    <th>Status da Ação</th>
                                    <th>Re-prazo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${acoesD7.length === 0 ? `
                                    <tr><td colspan="9" style="text-align:center; color:#64748b;">Nenhuma ação preventiva cadastrada.</td></tr>
                                ` : acoesD7.map(acao => {
                                    const responsavelAcao = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
                                    const indicador = obterIndicadorPrazoAcao(acao);
                                    const ultimoReprazoData = acao.reprazos?.length ? acao.reprazos[acao.reprazos.length - 1]?.data : '';
                                    return `
                                        <tr>
                                            <td>${escapeHtml(acao.descricao || '')}</td>
                                            <td>${escapeHtml(responsavelAcao)}</td>
                                            <td>${escapeHtml(acao.origemPrevencao || '-')}</td>
                                            <td>${formatDateSafe(acao.prazoPrincipal)}</td>
                                            <td>${ultimoReprazoData ? formatDateSafe(ultimoReprazoData) : '—'}</td>
                                            <td><span class="badge ${indicador.className === 'red' ? 'red' : (indicador.className === 'orange' ? 'orange' : 'green')}">${indicador.className === 'red' ? 'Em atraso' : (indicador.className === 'orange' ? 'Próximo ao vencimento' : 'Dentro do prazo')}</span></td>
                                            <td><span class="badge ${acao.status === 'CONCLUIDA' ? 'green' : 'orange'}">${acao.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto'}</span></td>
                                            <td>${acao.reprazos?.length ? `Sim / Nº ${acao.reprazos.length}` : 'Não'}</td>
                                            <td><button type="button" class="btn btn-secondary" style="padding:0.45rem 0.8rem; font-size:0.8125rem;" onclick="abrirCadastroAcaoD7('${acao.id}')">Editar</button></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="card" style="padding:1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Implementação das Ações Preventivas</h4>
                        ${acoesD7.length === 0 ? `
                            <div style="color:#64748b;">Nenhuma ação preventiva para implementação.</div>
                        ` : `
                            <div style="display:flex; flex-direction:column; gap:0.75rem;">
                                ${acoesD7.map(acao => {
                                    const responsavelAcao = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
                                    const prazoVigente = obterPrazoVigenteAcao(acao);
                                    return `
                                        <button type="button" class="btn btn-secondary" style="text-align:left; width:100%;" onclick="abrirImplementacaoAcaoD7('${acao.id}')">
                                            <strong>${escapeHtml(acao.descricao || 'Ação preventiva sem descrição')}</strong><br>
                                            <span style="font-size:0.8125rem; color:#475569;">Responsável: ${escapeHtml(responsavelAcao)} • Prazo vigente: ${formatDateSafe(prazoVigente)} • Status: ${acao.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto'}</span>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            } else if (phase.id === 'd8') {
                ensureD8Structure(rnc);
                const equipeD1 = montarEquipeD1(rnc);
                const pendenciasD8 = getPendenciasConclusaoD8(rnc);
                const d8Readonly = rnc.d8.concluida ? 'readonly disabled' : '';
                const dataConclusaoD8 = /^\d{4}-\d{2}-\d{2}/.test(rnc.d8.dataConclusao || '') ? rnc.d8.dataConclusao.slice(0, 10) : '';
                content += `
                    <div class="card" style="padding:1rem; margin-bottom:1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Lições Aprendidas</h4>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Lições Aprendidas <span style="color:#dc2626;">*</span></label>
                            <textarea rows="4" id="d8-licao" ${d8Readonly}>${escapeHtml(rnc.d8.licaoAprendida || '')}</textarea>
                        </div>
                    </div>
                    <div class="card" style="padding:1rem; margin-bottom:1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Equipe Envolvida</h4>
                        <table>
                            <thead>
                                <tr><th>Nome</th><th>Função na RNC</th><th>Setor</th><th>Planta</th></tr>
                            </thead>
                            <tbody>
                                ${equipeD1.length === 0 ? `
                                    <tr><td colspan="4" style="text-align:center; color:#64748b;">Equipe não disponível.</td></tr>
                                ` : equipeD1.map(item => `
                                    <tr>
                                        <td>${escapeHtml(item.pessoa.nome)}</td>
                                        <td>${escapeHtml(item.funcaoRnc)}</td>
                                        <td>${escapeHtml(item.pessoa.setor || '-')}</td>
                                        <td>${escapeHtml(item.pessoa.planta || '-')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="card" style="padding:1rem; margin-bottom:1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Reconhecimento Individual</h4>
                        ${equipeD1.length === 0 ? `<div style="color:#64748b;">Sem membros para reconhecer.</div>` : equipeD1.map(item => {
                            const key = getEquipeMembroKey(item);
                            return `
                                <div class="form-group">
                                    <label>${escapeHtml(item.pessoa.nome)} (${escapeHtml(item.funcaoRnc)})</label>
                                    <textarea rows="2" id="d8-rec-${key}" ${d8Readonly}>${escapeHtml(rnc.d8.reconhecimentoIndividual?.[key] || '')}</textarea>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="card" style="padding:1rem;">
                        <h4 style="font-weight:700; margin-bottom:0.75rem;">Agradecimento Final da Liderança</h4>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Mensagem Final de Agradecimento</label>
                            <textarea rows="3" id="d8-mensagem" ${d8Readonly}>${escapeHtml(rnc.d8.mensagemFinal || '')}</textarea>
                        </div>
                    </div>
                    <div style="margin-top:1rem;">
                        ${rnc.d8.concluida ? `
                            <div class="badge green" style="display:inline-flex;">8D encerrado em ${formatDateSafe(dataConclusaoD8)}</div>
                            <p style="margin-top:0.5rem; color:#64748b;">Registro disponível somente para consulta.</p>
                            <button type="button" class="btn btn-primary" style="margin-top:0.75rem;" onclick="gerarRelatorio8DPDF()">Gerar Relatório 8D (PDF)</button>
                        ` : `
                            ${pendenciasD8.length ? `<div class="prazo-justificativa" style="margin-bottom:0.75rem;"><strong>Pendências para concluir D8:</strong><ul style="padding-left:1.25rem; margin-top:0.5rem;">${pendenciasD8.map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ul></div>` : ''}
                            <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                                <button type="button" class="btn btn-secondary" onclick="salvarD8(false)">Salvar D8</button>
                                <button type="button" class="btn btn-success" onclick="salvarD8(true)" ${pendenciasD8.length ? 'disabled' : ''}>Concluir D8 e Encerrar 8D</button>
                            </div>
                        `}
                    </div>
                `;
            }
            
            content += `
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    ${!['d1', 'd2', 'd3', 'd5', 'd6', 'd7', 'd8'].includes(phase.id) ? `<button class="btn btn-success" onclick="salvarFase('${phase.id}')">Salvar ${phase.name}</button>` : ''}
                    ${canReprazo && canManageDeadlines && !prazo.reprazo2 ? `
                        <button class="btn btn-warning" onclick="solicitarReprazo('${phase.id}', ${prazo.reprazo1 ? 2 : 1})">
                            Solicitar ${prazo.reprazo1 ? 'Re-prazo 2' : 'Re-prazo 1'}
                        </button>
                    ` : ''}
                </div>
            </div>
            `;
            
            return content;
        }

        function normalizeAcaoD5(acao) {
            if (!acao) return { id: '', descricao: '', prazoPrincipal: '', responsavelId: null, status: 'ABERTA', reprazos: [], evidencias: [], before_image_url: '', after_image_url: '', implementation_completed_at: '', implementation_completed_by: '', dataConclusao: '' };
            if (!Array.isArray(acao.reprazos)) {
                const reprazos = [];
                if (acao.reprazo1) reprazos.push({ numero: 1, data: acao.reprazo1, justificativa: acao.justificativaReprazo1 || '' });
                if (acao.reprazo2) reprazos.push({ numero: 2, data: acao.reprazo2, justificativa: acao.justificativaReprazo2 || '' });
                acao.reprazos = reprazos;
            }
            acao.evidencias = Array.isArray(acao.evidencias) ? acao.evidencias : [];
            if (typeof acao.before_image_url !== 'string') acao.before_image_url = '';
            if (typeof acao.after_image_url !== 'string') acao.after_image_url = '';
            if (typeof acao.implementation_completed_at !== 'string') acao.implementation_completed_at = acao.dataConclusao || '';
            if (typeof acao.implementation_completed_by !== 'string') acao.implementation_completed_by = '';
            return acao;
        }

        function normalizeAcaoD7(acao) {
            if (!acao) return { id: '', descricao: '', origemPrevencao: '', prazoPrincipal: '', responsavelId: null, status: 'ABERTA', reprazos: [], evidencias: [], dataConclusao: '' };
            if (!Array.isArray(acao.reprazos)) acao.reprazos = [];
            acao.evidencias = Array.isArray(acao.evidencias) ? acao.evidencias : [];
            return acao;
        }

        function obterPrazoVigenteAcao(acao) {
            const acaoNormalizada = normalizeAcaoD5(acao);
            const ultimoReprazo = acaoNormalizada.reprazos?.length ? acaoNormalizada.reprazos[acaoNormalizada.reprazos.length - 1]?.data : '';
            return ultimoReprazo || acaoNormalizada.prazoPrincipal || '';
        }

        function obterIndicadorPrazoAcao(acao) {
            const prazoVigente = obterPrazoVigenteAcao(acao);
            if (!prazoVigente) return { label: '-', className: 'blue' };
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const prazo = new Date(`${prazoVigente}T00:00:00`);
            if (hoje.getTime() < prazo.getTime()) return { label: 'No prazo', className: 'green' };
            if (hoje.getTime() === prazo.getTime()) return { label: 'A vencer', className: 'orange' };
            return { label: 'Em atraso', className: 'red' };
        }

        function validarCamposD3({ quantidadeEstoque, quantidadeInspecionada, quantidadeNaoConforme, anexoPresente }) {
            if (quantidadeEstoque === '' || quantidadeInspecionada === '' || quantidadeNaoConforme === '' || !anexoPresente) {
                return { valido: false, mensagem: 'Preencha todos os campos obrigatórios da contenção para concluir a etapa.' };
            }
            const estoque = Number(quantidadeEstoque);
            const inspecionada = Number(quantidadeInspecionada);
            const naoConforme = Number(quantidadeNaoConforme);
            if (inspecionada > estoque) {
                return { valido: false, mensagem: 'Quantidade inspecionada deve ser menor ou igual à quantidade em estoque.' };
            }
            if (naoConforme > inspecionada) {
                return { valido: false, mensagem: 'Quantidade não conforme deve ser menor ou igual à quantidade inspecionada.' };
            }
            return { valido: true, mensagem: 'Campos válidos. A etapa pode ser concluída.' };
        }

        function atualizarEstadoConclusaoD3() {
            const estoqueInput = document.getElementById('d3-estoque');
            const inspecionadaInput = document.getElementById('d3-inspecionada');
            const naoConformeInput = document.getElementById('d3-nao-conforme');
            const anexoInput = document.getElementById('d3-alerta-arquivo');
            const concluirBtn = document.getElementById('d3-etapa-concluida-btn');
            const msg = document.getElementById('d3-validacao-msg');
            if (!estoqueInput || !inspecionadaInput || !naoConformeInput || !anexoInput || !concluirBtn || !msg) {
                console.warn('Campos obrigatórios da D3 não encontrados para validação dinâmica.');
                return;
            }

            const anexoPresente = (anexoInput.files && anexoInput.files.length > 0) || !!state.selectedRNC?.d3?.anexoAlertaAssinadoNome;
            const validacao = validarCamposD3({
                quantidadeEstoque: estoqueInput.value,
                quantidadeInspecionada: inspecionadaInput.value,
                quantidadeNaoConforme: naoConformeInput.value,
                anexoPresente
            });

            const etapaConcluida = !!state.selectedRNC?.d3?.etapaConcluida;
            concluirBtn.disabled = etapaConcluida || !validacao.valido;
            if (!etapaConcluida && !validacao.valido) {
                msg.textContent = validacao.mensagem;
                msg.style.display = 'block';
            } else {
                msg.textContent = '';
                msg.style.display = 'none';
            }
        }

        function lerArquivoBase64(file, contexto = 'arquivo') {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result || '');
                reader.onerror = () => {
                    console.warn(`Falha ao converter ${contexto} para base64.`);
                    resolve(null);
                };
                reader.readAsDataURL(file);
            });
        }

        async function removerAnexoD3() {
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            state.rncs[rncIndex].d3.anexoAlertaAssinadoNome = '';
            state.rncs[rncIndex].d3.anexoAlertaAssinadoConteudo = '';
            state.rncs[rncIndex].d3.etapaConcluida = false;
            state.selectedRNC = state.rncs[rncIndex];
            await salvarRNCNoFirebase(state.selectedRNC);
            render();
        }

        async function concluirEtapaD3() {
            const estoqueInput = document.getElementById('d3-estoque');
            const inspecionadaInput = document.getElementById('d3-inspecionada');
            const naoConformeInput = document.getElementById('d3-nao-conforme');
            const anexoInput = document.getElementById('d3-alerta-arquivo');
            const anexoPresente = (anexoInput.files && anexoInput.files.length > 0) || !!state.selectedRNC?.d3?.anexoAlertaAssinadoNome;
            const validacao = validarCamposD3({
                quantidadeEstoque: estoqueInput.value,
                quantidadeInspecionada: inspecionadaInput.value,
                quantidadeNaoConforme: naoConformeInput.value,
                anexoPresente
            });
            if (!validacao.valido) {
                alert(validacao.mensagem);
                return;
            }
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            state.rncs[rncIndex].d3.quantidadeEstoque = estoqueInput.value;
            state.rncs[rncIndex].d3.quantidadeInspecionada = inspecionadaInput.value;
            state.rncs[rncIndex].d3.quantidadeNaoConforme = naoConformeInput.value;
            const evidenciaInput = document.getElementById('d3-evidencia');
            state.rncs[rncIndex].d3.evidencia = evidenciaInput ? evidenciaInput.value : state.rncs[rncIndex].d3.evidencia;
            if (anexoInput && anexoInput.files && anexoInput.files.length > 0) {
                const arquivo = anexoInput.files[0];
                const base64 = await lerArquivoBase64(arquivo, 'anexo D3');
                if (base64 === null) {
                    alert('Falha ao processar o anexo da D3. Tente novamente.');
                    return;
                }
                state.rncs[rncIndex].d3.anexoAlertaAssinadoNome = arquivo.name;
                state.rncs[rncIndex].d3.anexoAlertaAssinadoConteudo = base64;
            }
            state.rncs[rncIndex].d3.etapaConcluida = true;
            state.rncs[rncIndex].d3.dataConclusao = new Date().toISOString();
            registrarAuditoriaAdmin('EDICAO', 'Etapa D3 concluída com dados de contenção e evidência.', {
                modulo: 'Fase D3',
                referencia: state.rncs[rncIndex].numero,
                tipoAcao: 'EDICAO'
            });
            const indiceFaseAtual = phases.findIndex(p => p.id === 'd3');
            const proximaFase = (indiceFaseAtual >= 0 && indiceFaseAtual < phases.length - 1) ? phases[indiceFaseAtual + 1] : null;
            if (proximaFase) {
                state.rncs[rncIndex].faseAtual = proximaFase.id;
                state.activeTab = proximaFase.id;
            }
            state.selectedRNC = state.rncs[rncIndex];
            const salvoNoFirebase = await salvarRNCNoFirebase(state.selectedRNC);
            alert(salvoNoFirebase ? 'Etapa D3 concluída com sucesso! Avançando para a próxima etapa.' : 'Etapa D3 concluída localmente. Firebase indisponível. Avançando para a próxima etapa.');
            render();
        }

        function abrirCadastroAcaoD5(acaoId = '') {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1002';
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            const acoes = state.rncs[rncIndex].d5.listaAcoes || [];
            const acaoExistente = acoes.find(acao => acao.id === acaoId);
            const dadosAcao = normalizeAcaoD5(acaoExistente || {});
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 760px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">${acaoExistente ? 'Editar Ação Corretiva' : 'Cadastrar Ação Corretiva'}</h2>
                            <p style="color:#64748b; margin-top:0.5rem;">Etapa D5 - Ações Corretivas</p>
                        </div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="d5AcaoForm">
                            <div class="form-group">
                                <label>Descrição da Ação</label>
                                <textarea id="d5-acao-descricao" rows="3" required>${escapeHtml(dadosAcao.descricao || '')}</textarea>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Prazo Principal</label>
                                    <input type="date" id="d5-acao-prazo-principal" value="${dadosAcao.prazoPrincipal || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Responsável</label>
                                    <select id="d5-acao-responsavel" required>
                                        <option value="">Selecione</option>
                                        ${getPessoasAtivas().map(pessoa => `<option value="${pessoa.id}" ${Number(dadosAcao.responsavelId) === pessoa.id ? 'selected' : ''}>${escapeHtml(pessoa.nome)}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div style="display:flex; gap:1rem;">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
                                <button type="submit" class="btn btn-success">${acaoExistente ? 'Salvar Alterações' : 'Salvar Ação'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            overlay.onclick = (e) => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);

            document.getElementById('d5AcaoForm').onsubmit = async (e) => {
                e.preventDefault();
                state.rncs[rncIndex].d5.listaAcoes = state.rncs[rncIndex].d5.listaAcoes || [];
                const payload = {
                    id: acaoExistente?.id || `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                    descricao: document.getElementById('d5-acao-descricao').value,
                    prazoPrincipal: document.getElementById('d5-acao-prazo-principal').value,
                    responsavelId: Number(document.getElementById('d5-acao-responsavel').value),
                    status: acaoExistente?.status || 'ABERTA',
                    reprazos: acaoExistente?.reprazos || [],
                    evidencias: acaoExistente?.evidencias || [],
                    before_image_url: acaoExistente?.before_image_url || '',
                    after_image_url: acaoExistente?.after_image_url || '',
                    implementation_completed_at: acaoExistente?.implementation_completed_at || '',
                    implementation_completed_by: acaoExistente?.implementation_completed_by || '',
                    dataConclusao: acaoExistente?.dataConclusao || ''
                };
                const idxAcao = state.rncs[rncIndex].d5.listaAcoes.findIndex(acao => acao.id === payload.id);
                if (idxAcao >= 0) state.rncs[rncIndex].d5.listaAcoes[idxAcao] = payload;
                else state.rncs[rncIndex].d5.listaAcoes.push(payload);
                const responsavelAnterior = acaoExistente ? (getPessoaById(acaoExistente.responsavelId)?.nome || '-') : '-';
                const responsavelAtual = getPessoaById(payload.responsavelId)?.nome || '-';
                const acaoTipoLog = acaoExistente ? 'EDICAO' : 'INCLUSAO';
                const detalhesAcao = [
                    `Ação corretiva "${payload.descricao}"`,
                    `Responsável: ${responsavelAtual}`,
                    `Prazo: ${formatDateSafe(payload.prazoPrincipal)}`
                ];
                if (acaoExistente && responsavelAnterior !== responsavelAtual) detalhesAcao.push(`Responsável anterior: ${responsavelAnterior}`);
                registrarAuditoriaAdmin(acaoTipoLog, detalhesAcao.join(' • '), {
                    modulo: 'Ação Corretiva',
                    referencia: state.rncs[rncIndex].numero,
                    tipoAcao: acaoTipoLog
                });
                state.selectedRNC = state.rncs[rncIndex];
                sincronizarFluxo8D(state.selectedRNC);
                state.activeTab = state.selectedRNC.faseAtual;
                const salvoNoFirebase = await salvarRNCNoFirebase(state.selectedRNC);
                overlay.remove();
                render();
                alert(salvoNoFirebase ? 'Ação corretiva salva com sucesso!' : 'Ação salva localmente. Firebase indisponível.');
            };
        }

        function obterHistoricoReprazoHtml(acao) {
            const reprazos = normalizeAcaoD5(acao).reprazos || [];
            if (!reprazos.length) return '<div style="color:#64748b;">Sem re-prazo aplicado.</div>';
            return `<ul style="padding-left:1.25rem; color:#334155;">${reprazos.map(item => `<li>Nº ${item.numero}: ${formatDateSafe(item.data)} - ${escapeHtml(item.justificativa || '-')}</li>`).join('')}</ul>`;
        }

        function abrirImplementacaoAcaoD6(acaoId) {
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            const acoes = state.rncs[rncIndex].d5.listaAcoes || [];
            const acaoIndex = acoes.findIndex(acao => acao.id === acaoId);
            if (acaoIndex === -1) return;
            const acao = normalizeAcaoD5(acoes[acaoIndex]);
            const responsavelAcao = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
            const canManageDeadlines = isCurrentUserAdmin();
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1003';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 780px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h2 class="modal-title">Implementação da Ação</h2>
                        <button class="modal-close" id="d6-implementacao-close-btn">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="card" style="padding:1rem; margin-bottom:1rem;">
                            <h4 style="font-weight:700; margin-bottom:0.75rem;">Informações de Cadastro</h4>
                            <div><strong>Descrição:</strong> ${escapeHtml(acao.descricao || '-')}</div>
                            <div><strong>Responsável:</strong> ${escapeHtml(responsavelAcao)}</div>
                            <div><strong>Prazo Original:</strong> ${formatDateSafe(acao.prazoPrincipal)}</div>
                            <div style="margin-top:0.5rem;"><strong>Histórico de Re-prazo:</strong> ${obterHistoricoReprazoHtml(acao)}</div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Novo Re-prazo</label>
                                <input type="date" id="d6-acao-reprazo-data" ${canManageDeadlines ? '' : 'disabled'}>
                            </div>
                            <div class="form-group">
                                <label>Justificativa do Re-prazo</label>
                                <input type="text" id="d6-acao-reprazo-just" placeholder="${canManageDeadlines ? 'Obrigatória ao aplicar re-prazo' : 'Somente ADMIN pode alterar re-prazo'}" ${canManageDeadlines ? '' : 'disabled'}>
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:0.75rem; margin-bottom:1rem;">
                            <div class="card" style="padding:0.875rem; border:2px solid #dc2626;">
                                <h4 style="font-weight:700; margin-bottom:0.5rem; color:#b91c1c;">Situação ANTES da Implementação</h4>
                                <p style="font-size:0.8125rem; color:#475569; margin-bottom:0.5rem;">Evidência visual da condição antes da implementação da ação.</p>
                                <input type="file" id="d6-acao-before-file" accept=".jpg,.jpeg,.png,image/jpeg,image/png">
                                <div id="d6-before-file-name" style="margin-top:0.5rem; font-size:0.8125rem; color:#64748b;">${acao.before_image_url ? 'Imagem ANTES anexada.' : 'Sem imagem ANTES anexada.'}</div>
                                <img id="d6-before-preview" src="${acao.before_image_url || ''}" alt="Pré-visualização ANTES" style="margin-top:0.5rem; width:100%; max-height:180px; object-fit:contain; border:1px solid #fecaca; border-radius:4px; background:#fff; ${acao.before_image_url ? '' : 'display:none;'}">
                            </div>
                            <div class="card" style="padding:0.875rem; border:2px solid #16a34a;">
                                <h4 style="font-weight:700; margin-bottom:0.5rem; color:#166534;">Situação APÓS a Implementação</h4>
                                <p style="font-size:0.8125rem; color:#475569; margin-bottom:0.5rem;">Evidência visual após a implementação da ação corretiva.</p>
                                <input type="file" id="d6-acao-after-file" accept=".jpg,.jpeg,.png,image/jpeg,image/png">
                                <div id="d6-after-file-name" style="margin-top:0.5rem; font-size:0.8125rem; color:#64748b;">${acao.after_image_url ? 'Imagem APÓS anexada.' : 'Sem imagem APÓS anexada.'}</div>
                                <img id="d6-after-preview" src="${acao.after_image_url || ''}" alt="Pré-visualização APÓS" style="margin-top:0.5rem; width:100%; max-height:180px; object-fit:contain; border:1px solid #bbf7d0; border-radius:4px; background:#fff; ${acao.after_image_url ? '' : 'display:none;'}">
                            </div>
                        </div>
                        <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                            <button type="button" class="btn btn-secondary" id="d6-salvar-acao-btn">Salvar Alterações</button>
                            <button type="button" class="btn btn-success" id="d6-concluir-acao-btn" title="Anexe as evidências de antes e depois para concluir a ação." ${(acao.before_image_url && acao.after_image_url) ? '' : 'disabled'}>Concluir Ação</button>
                        </div>
                    </div>
                </div>
            `;
            const closeOverlay = () => {
                if (beforeObjectUrl) URL.revokeObjectURL(beforeObjectUrl);
                if (afterObjectUrl) URL.revokeObjectURL(afterObjectUrl);
                overlay.remove();
            };
            overlay.onclick = (e) => e.target === overlay && closeOverlay();
            document.body.appendChild(overlay);
            overlay.querySelector('#d6-implementacao-close-btn').onclick = closeOverlay;

            const beforeInput = overlay.querySelector('#d6-acao-before-file');
            const afterInput = overlay.querySelector('#d6-acao-after-file');
            const beforeName = overlay.querySelector('#d6-before-file-name');
            const afterName = overlay.querySelector('#d6-after-file-name');
            const beforePreview = overlay.querySelector('#d6-before-preview');
            const afterPreview = overlay.querySelector('#d6-after-preview');
            const concluirBtn = overlay.querySelector('#d6-concluir-acao-btn');
            const extensoesPermitidas = ['jpg', 'jpeg', 'png'];
            const mimesPermitidos = ['image/jpeg', 'image/png'];
            let beforeObjectUrl = '';
            let afterObjectUrl = '';
            const arquivoImagemValido = (arquivo) => {
                if (!arquivo) return false;
                const ext = String(arquivo.name || '').split('.').pop().toLowerCase();
                const mimeValido = !!arquivo.type && mimesPermitidos.includes(String(arquivo.type).toLowerCase());
                return extensoesPermitidas.includes(ext) && mimeValido;
            };
            const atualizarEstadoConcluir = () => {
                const temAntes = !!acao.before_image_url || !!beforeInput.files?.length;
                const temDepois = !!acao.after_image_url || !!afterInput.files?.length;
                concluirBtn.disabled = !(temAntes && temDepois);
            };
            beforeInput.onchange = () => {
                if (beforeInput.files?.length && !arquivoImagemValido(beforeInput.files[0])) {
                    alert('A imagem ANTES deve ser do tipo .jpg, .jpeg ou .png.');
                    beforeInput.value = '';
                    return;
                }
                if (beforeInput.files?.length) {
                    if (beforeObjectUrl) URL.revokeObjectURL(beforeObjectUrl);
                    beforeObjectUrl = URL.createObjectURL(beforeInput.files[0]);
                    beforePreview.src = beforeObjectUrl;
                    beforePreview.style.display = 'block';
                    beforeName.textContent = `Arquivo selecionado: ${beforeInput.files[0].name}`;
                } else {
                    beforeName.textContent = acao.before_image_url ? 'Imagem ANTES anexada.' : 'Sem imagem ANTES anexada.';
                }
                atualizarEstadoConcluir();
            };
            afterInput.onchange = () => {
                if (afterInput.files?.length && !arquivoImagemValido(afterInput.files[0])) {
                    alert('A imagem APÓS deve ser do tipo .jpg, .jpeg ou .png.');
                    afterInput.value = '';
                    return;
                }
                if (afterInput.files?.length) {
                    if (afterObjectUrl) URL.revokeObjectURL(afterObjectUrl);
                    afterObjectUrl = URL.createObjectURL(afterInput.files[0]);
                    afterPreview.src = afterObjectUrl;
                    afterPreview.style.display = 'block';
                    afterName.textContent = `Arquivo selecionado: ${afterInput.files[0].name}`;
                } else {
                    afterName.textContent = acao.after_image_url ? 'Imagem APÓS anexada.' : 'Sem imagem APÓS anexada.';
                }
                atualizarEstadoConcluir();
            };
            atualizarEstadoConcluir();

            const aplicarAtualizacoes = async () => {
                const reprazoData = overlay.querySelector('#d6-acao-reprazo-data').value;
                const reprazoJust = overlay.querySelector('#d6-acao-reprazo-just').value.trim();
                if (reprazoData && !canManageDeadlines) {
                    alert('Apenas usuários ADMIN podem alterar prazos e re-prazos.');
                    return false;
                }
                if (reprazoData && !reprazoJust) {
                    alert('Justificativa é obrigatória para aplicar re-prazo.');
                    return false;
                }
                if (reprazoData) {
                    const totalReprazosAcao = acao.reprazos?.length || 0;
                    if (totalReprazosAcao >= LIMITE_NEGOCIACAO_REPRAZO && !usuarioPodeNegociarReprazo()) {
                        const responsavelAcaoEscalonamento = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
                        const emailGerenciaAcao = getPessoaEmailGerenciaById(acao.responsavelId);
                        registrarEscalonamentoReprazo(state.rncs[rncIndex], {
                            tipo: 'LIMITE_REPRAZO_ACAO',
                            origem: 'ACAO_D6',
                            chave: `ACAO_D6:${acao.id}`,
                            faseId: 'd6',
                            faseLabel: getLabelCurtoFase('d6'),
                            acaoId: acao.id,
                            acaoDescricao: acao.descricao || 'Ação sem descrição',
                            responsavel: responsavelAcaoEscalonamento,
                            emailGerencia: emailGerenciaAcao,
                            totalReprazosAcao,
                            mensagem: `⛔ Ação "${acao.descricao || 'Sem descrição'}" ultrapassou o limite de ${LIMITE_NEGOCIACAO_REPRAZO} re-prazos. Escalonamento automático para a Gerência do responsável pela ação.`
                        });
                        await salvarRNCNoFirebase(state.rncs[rncIndex]);
                        alert(`⛔ Ação "${acao.descricao || 'Sem descrição'}" ultrapassou o limite de ${LIMITE_NEGOCIACAO_REPRAZO} re-prazos. Escalonamento automático para a Gerência do responsável pela ação${emailGerenciaAcao ? ` (${emailGerenciaAcao})` : ''}.`);
                        return false;
                    }
                    const numero = (acao.reprazos?.length || 0) + 1;
                    acao.reprazos.push({ numero, data: reprazoData, justificativa: reprazoJust, dataRegistro: new Date().toISOString() });
                    registrarAuditoriaAdmin('EDICAO', `Re-prazo ${numero} aplicado na ação corretiva "${acao.descricao || '-'}"`, { modulo: 'Ação Corretiva', referencia: state.rncs[rncIndex].numero, tipoAcao: 'EDICAO' });
                }
                if (beforeInput.files?.length) {
                    const arquivoAntes = beforeInput.files[0];
                    const base64Antes = await lerArquivoBase64(arquivoAntes, 'evidência ANTES da ação D6');
                    if (base64Antes === null) {
                        alert('Falha ao processar imagem ANTES. Tente novamente.');
                        return false;
                    }
                    acao.before_image_url = base64Antes;
                }
                if (afterInput.files?.length) {
                    const arquivoDepois = afterInput.files[0];
                    const base64Depois = await lerArquivoBase64(arquivoDepois, 'evidência APÓS da ação D6');
                    if (base64Depois === null) {
                        alert('Falha ao processar imagem APÓS. Tente novamente.');
                        return false;
                    }
                    acao.after_image_url = base64Depois;
                }
                return true;
            };

            overlay.querySelector('#d6-salvar-acao-btn').onclick = async () => {
                const ok = await aplicarAtualizacoes();
                if (!ok) return;
                acoes[acaoIndex] = acao;
                state.selectedRNC = state.rncs[rncIndex];
                sincronizarFluxo8D(state.selectedRNC);
                await salvarRNCNoFirebase(state.selectedRNC);
                registrarAuditoriaAdmin('EDICAO', `Ação corretiva "${acao.descricao || '-'}" atualizada na implementação D6.`, {
                    modulo: 'Ação Corretiva',
                    referencia: state.rncs[rncIndex].numero,
                    tipoAcao: 'EDICAO'
                });
                closeOverlay();
                render();
            };

            concluirBtn.onclick = async () => {
                const possuiAntes = !!acao.before_image_url || !!beforeInput.files?.length;
                const possuiDepois = !!acao.after_image_url || !!afterInput.files?.length;
                if (!possuiAntes || !possuiDepois) {
                    alert('Anexe as evidências ANTES e APÓS para concluir a ação.');
                    return;
                }
                const ok = await aplicarAtualizacoes();
                if (!ok) return;
                acao.status = 'CONCLUIDA';
                acao.dataConclusao = new Date().toISOString();
                acao.implementation_completed_at = acao.dataConclusao;
                acao.implementation_completed_by = String(state.currentUser?.id || state.currentUser?.email || state.currentUser?.name || '');
                acoes[acaoIndex] = acao;
                state.selectedRNC = state.rncs[rncIndex];
                sincronizarFluxo8D(state.selectedRNC);
                state.activeTab = state.selectedRNC.faseAtual;
                await salvarRNCNoFirebase(state.selectedRNC);
                registrarAuditoriaAdmin('EDICAO', `Conclusão da Implementação D6 da ação corretiva "${acao.descricao || '-'}" com evidências ANTES e APÓS anexadas.`, {
                    modulo: 'Ação Corretiva',
                    referencia: state.rncs[rncIndex].numero,
                    tipoAcao: 'EDICAO'
                });
                closeOverlay();
                render();
            };
        }

        function abrirCadastroAcaoD7(acaoId = '') {
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            state.rncs[rncIndex].d7.listaAcoes = state.rncs[rncIndex].d7.listaAcoes || [];
            const acoes = state.rncs[rncIndex].d7.listaAcoes;
            const acaoExistente = acoes.find(acao => acao.id === acaoId);
            const dadosAcao = normalizeAcaoD7(acaoExistente || {});
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1002';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 760px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">${acaoExistente ? 'Editar Ação Preventiva' : 'Cadastrar Ação Preventiva'}</h2>
                            <p style="color:#64748b; margin-top:0.5rem;">Etapa D7 - Ações Preventivas</p>
                        </div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <form id="d7AcaoForm">
                            <div class="form-group">
                                <label>Descrição da Ação Preventiva</label>
                                <textarea id="d7-acao-descricao" rows="3" required>${escapeHtml(dadosAcao.descricao || '')}</textarea>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Origem da Prevenção</label>
                                    <select id="d7-acao-origem" required>
                                        <option value="">Selecione</option>
                                        ${['Mesmo produto', 'Outro produto', 'Outro processo', 'Outra planta'].map(origem => `<option value="${origem}" ${dadosAcao.origemPrevencao === origem ? 'selected' : ''}>${origem}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Prazo Original</label>
                                    <input type="date" id="d7-acao-prazo-principal" value="${dadosAcao.prazoPrincipal || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Responsável</label>
                                    <select id="d7-acao-responsavel" required>
                                        <option value="">Selecione</option>
                                        ${getPessoasAtivas().map(pessoa => `<option value="${pessoa.id}" ${Number(dadosAcao.responsavelId) === pessoa.id ? 'selected' : ''}>${escapeHtml(pessoa.nome)}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div style="display:flex; gap:1rem;">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
                                <button type="submit" class="btn btn-success">${acaoExistente ? 'Salvar Alterações' : 'Salvar Ação Preventiva'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            overlay.onclick = (e) => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);

            document.getElementById('d7AcaoForm').onsubmit = async (e) => {
                e.preventDefault();
                const payload = {
                    id: acaoExistente?.id || `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                    descricao: document.getElementById('d7-acao-descricao').value,
                    origemPrevencao: document.getElementById('d7-acao-origem').value,
                    prazoPrincipal: document.getElementById('d7-acao-prazo-principal').value,
                    responsavelId: Number(document.getElementById('d7-acao-responsavel').value),
                    status: acaoExistente?.status || 'ABERTA',
                    reprazos: acaoExistente?.reprazos || [],
                    evidencias: acaoExistente?.evidencias || [],
                    dataConclusao: acaoExistente?.dataConclusao || ''
                };
                const idxAcao = acoes.findIndex(acao => acao.id === payload.id);
                if (idxAcao >= 0) acoes[idxAcao] = payload;
                else acoes.push(payload);
                const responsavelAnterior = acaoExistente ? (getPessoaById(acaoExistente.responsavelId)?.nome || '-') : '-';
                const responsavelAtual = getPessoaById(payload.responsavelId)?.nome || '-';
                const acaoTipoLog = acaoExistente ? 'EDICAO' : 'INCLUSAO';
                const detalhesAcao = [
                    `Ação preventiva "${payload.descricao}"`,
                    `Responsável: ${responsavelAtual}`,
                    `Prazo: ${formatDateSafe(payload.prazoPrincipal)}`
                ];
                if (acaoExistente && responsavelAnterior !== responsavelAtual) detalhesAcao.push(`Responsável anterior: ${responsavelAnterior}`);
                registrarAuditoriaAdmin(acaoTipoLog, detalhesAcao.join(' • '), {
                    modulo: 'Ação Preventiva',
                    referencia: state.rncs[rncIndex].numero,
                    tipoAcao: acaoTipoLog
                });
                state.selectedRNC = state.rncs[rncIndex];
                sincronizarFluxo8D(state.selectedRNC);
                state.activeTab = state.selectedRNC.faseAtual;
                await salvarRNCNoFirebase(state.selectedRNC);
                overlay.remove();
                render();
            };
        }

        function obterHistoricoReprazoHtmlD7(acao) {
            const reprazos = normalizeAcaoD7(acao).reprazos || [];
            if (!reprazos.length) return '<div style="color:#64748b;">Sem re-prazo aplicado.</div>';
            return `<ul style="padding-left:1.25rem; color:#334155;">${reprazos.map(item => `<li>Nº ${item.numero}: ${formatDateSafe(item.data)} - ${escapeHtml(item.justificativa || '-')}</li>`).join('')}</ul>`;
        }

        function abrirImplementacaoAcaoD7(acaoId) {
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            state.rncs[rncIndex].d7.listaAcoes = state.rncs[rncIndex].d7.listaAcoes || [];
            const acoes = state.rncs[rncIndex].d7.listaAcoes;
            const acaoIndex = acoes.findIndex(acao => acao.id === acaoId);
            if (acaoIndex === -1) return;
            const acao = normalizeAcaoD7(acoes[acaoIndex]);
            const responsavelAcao = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
            const canManageDeadlines = isCurrentUserAdmin();
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1003';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 780px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h2 class="modal-title">Implementação da Ação Preventiva</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="card" style="padding:1rem; margin-bottom:1rem;">
                            <h4 style="font-weight:700; margin-bottom:0.75rem;">Informações de Cadastro</h4>
                            <div><strong>Descrição:</strong> ${escapeHtml(acao.descricao || '-')}</div>
                            <div><strong>Responsável:</strong> ${escapeHtml(responsavelAcao)}</div>
                            <div><strong>Origem da prevenção:</strong> ${escapeHtml(acao.origemPrevencao || '-')}</div>
                            <div><strong>Prazo Original:</strong> ${formatDateSafe(acao.prazoPrincipal)}</div>
                            <div style="margin-top:0.5rem;"><strong>Histórico de Re-prazo:</strong> ${obterHistoricoReprazoHtmlD7(acao)}</div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Novo Re-prazo</label>
                                <input type="date" id="d7-acao-reprazo-data" ${canManageDeadlines ? '' : 'disabled'}>
                            </div>
                            <div class="form-group">
                                <label>Justificativa do Re-prazo</label>
                                <input type="text" id="d7-acao-reprazo-just" placeholder="${canManageDeadlines ? 'Obrigatória ao aplicar re-prazo' : 'Somente ADMIN pode alterar re-prazo'}" ${canManageDeadlines ? '' : 'disabled'}>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Anexo de Evidências da Implementação</label>
                            <input type="file" id="d7-acao-evidencia-file" accept=".pdf,image/*">
                            ${acao.evidencias?.length ? `<div style="margin-top:0.5rem; color:#475569; font-size:0.8125rem;">Evidências anexadas: ${acao.evidencias.length}</div>` : ''}
                        </div>
                        <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                            <button type="button" class="btn btn-secondary" id="d7-salvar-acao-btn">Salvar Alterações</button>
                            <button type="button" class="btn btn-success" id="d7-concluir-acao-btn" ${acao.evidencias?.length ? '' : 'disabled'} aria-disabled="${acao.evidencias?.length ? 'false' : 'true'}">Concluir Ação Preventiva</button>
                        </div>
                    </div>
                </div>
            `;
            overlay.onclick = (e) => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);

            const evidenciaInput = overlay.querySelector('#d7-acao-evidencia-file');
            const concluirBtn = overlay.querySelector('#d7-concluir-acao-btn');
            const atualizarEstadoConcluir = () => {
                const habilitado = !!(acao.evidencias?.length || evidenciaInput.files?.length);
                concluirBtn.disabled = !habilitado;
                concluirBtn.setAttribute('aria-disabled', habilitado ? 'false' : 'true');
            };
            evidenciaInput.onchange = atualizarEstadoConcluir;
            atualizarEstadoConcluir();

            const aplicarAtualizacoes = async () => {
                const reprazoData = overlay.querySelector('#d7-acao-reprazo-data').value;
                const reprazoJust = overlay.querySelector('#d7-acao-reprazo-just').value.trim();
                if (reprazoData && !canManageDeadlines) {
                    alert('Apenas usuários ADMIN podem alterar prazos e re-prazos.');
                    return false;
                }
                if (reprazoData && !reprazoJust) {
                    alert('Justificativa é obrigatória para aplicar re-prazo.');
                    return false;
                }
                if (reprazoData) {
                    const totalReprazosAcao = acao.reprazos?.length || 0;
                    if (totalReprazosAcao >= LIMITE_NEGOCIACAO_REPRAZO && !usuarioPodeNegociarReprazo()) {
                        const responsavelAcaoEscalonamento = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
                        const emailGerenciaAcao = getPessoaEmailGerenciaById(acao.responsavelId);
                        registrarEscalonamentoReprazo(state.rncs[rncIndex], {
                            tipo: 'LIMITE_REPRAZO_ACAO',
                            origem: 'ACAO_D7',
                            chave: `ACAO_D7:${acao.id}`,
                            faseId: 'd7',
                            faseLabel: getLabelCurtoFase('d7'),
                            acaoId: acao.id,
                            acaoDescricao: acao.descricao || 'Ação preventiva sem descrição',
                            responsavel: responsavelAcaoEscalonamento,
                            emailGerencia: emailGerenciaAcao,
                            totalReprazosAcao,
                            mensagem: `⛔ Ação "${acao.descricao || 'Sem descrição'}" ultrapassou o limite de ${LIMITE_NEGOCIACAO_REPRAZO} re-prazos. Escalonamento automático para a Gerência do responsável pela ação.`
                        });
                        await salvarRNCNoFirebase(state.rncs[rncIndex]);
                        alert(`⛔ Ação "${acao.descricao || 'Sem descrição'}" ultrapassou o limite de ${LIMITE_NEGOCIACAO_REPRAZO} re-prazos. Escalonamento automático para a Gerência do responsável pela ação${emailGerenciaAcao ? ` (${emailGerenciaAcao})` : ''}.`);
                        return false;
                    }
                    const numero = (acao.reprazos?.length || 0) + 1;
                    acao.reprazos.push({ numero, data: reprazoData, justificativa: reprazoJust, dataRegistro: new Date().toISOString() });
                    registrarAuditoriaAdmin('EDICAO', `Re-prazo ${numero} aplicado na ação preventiva "${acao.descricao || '-'}"`, { modulo: 'Ação Preventiva', referencia: state.rncs[rncIndex].numero, tipoAcao: 'EDICAO' });
                }
                if (evidenciaInput.files?.length) {
                    const arquivo = evidenciaInput.files[0];
                    const base64 = await lerArquivoBase64(arquivo, 'evidência da ação D7');
                    if (base64 === null) {
                        alert('Falha ao processar evidência. Tente novamente.');
                        return false;
                    }
                    acao.evidencias = acao.evidencias || [];
                    acao.evidencias.push({ nome: arquivo.name, conteudo: base64, data: new Date().toISOString() });
                }
                return true;
            };

            overlay.querySelector('#d7-salvar-acao-btn').onclick = async () => {
                const ok = await aplicarAtualizacoes();
                if (!ok) return;
                acoes[acaoIndex] = acao;
                state.selectedRNC = state.rncs[rncIndex];
                sincronizarFluxo8D(state.selectedRNC);
                await salvarRNCNoFirebase(state.selectedRNC);
                overlay.remove();
                render();
            };

            concluirBtn.onclick = async () => {
                if (!acao.evidencias?.length && !evidenciaInput.files?.length) {
                    alert('Anexe pelo menos uma evidência para concluir a ação preventiva.');
                    return;
                }
                const ok = await aplicarAtualizacoes();
                if (!ok) return;
                acao.status = 'CONCLUIDA';
                acao.dataConclusao = new Date().toISOString();
                acoes[acaoIndex] = acao;
                state.selectedRNC = state.rncs[rncIndex];
                sincronizarFluxo8D(state.selectedRNC);
                state.activeTab = state.selectedRNC.faseAtual;
                await salvarRNCNoFirebase(state.selectedRNC);
                registrarAuditoriaAdmin('EDICAO', `Ação preventiva "${acao.descricao || '-'}" concluída na D7.`, {
                    modulo: 'Ação Preventiva',
                    referencia: state.rncs[rncIndex].numero,
                    tipoAcao: 'EDICAO'
                });
                overlay.remove();
                render();
            };
        }

        async function salvarD8(concluir = false) {
            const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
            if (rncIndex === -1) return;
            ensureD8Structure(state.rncs[rncIndex]);
            const rnc = state.rncs[rncIndex];
            if (rnc.d8.concluida) {
                alert('O D8 já foi concluído e está disponível somente para consulta.');
                return;
            }

            const licaoInput = document.getElementById('d8-licao');
            const msgInput = document.getElementById('d8-mensagem');
            rnc.d8.licaoAprendida = licaoInput ? licaoInput.value : rnc.d8.licaoAprendida;
            rnc.d8.mensagemFinal = msgInput ? msgInput.value : rnc.d8.mensagemFinal;

            const equipeD1 = montarEquipeD1(rnc);
            const reconhecimentoIndividual = {};
            equipeD1.forEach(item => {
                const key = getEquipeMembroKey(item);
                const campo = document.getElementById(`d8-rec-${key}`);
                if (campo) reconhecimentoIndividual[key] = campo.value;
            });
            rnc.d8.reconhecimentoIndividual = reconhecimentoIndividual;

            if (concluir) {
                const pendencias = getPendenciasConclusaoD8(rnc);
                if (pendencias.length) {
                    alert(`Não foi possível concluir o D8:\n- ${pendencias.join('\n- ')}`);
                    return;
                }
                rnc.d8.concluida = true;
                rnc.d8.dataConclusao = new Date().toISOString();
            }

            state.selectedRNC = rnc;
            sincronizarFluxo8D(state.selectedRNC);
            if (concluir) state.activeTab = state.selectedRNC.faseAtual;
            const salvoNoFirebase = await salvarRNCNoFirebase(state.selectedRNC);
            registrarAuditoriaAdmin('EDICAO', concluir ? 'D8 concluído e RNC encerrada.' : 'D8 atualizado.', {
                modulo: 'Fase D8',
                referencia: rnc.numero,
                tipoAcao: 'EDICAO'
            });
            alert(salvoNoFirebase
                ? (concluir ? 'D8 concluído e 8D encerrado com sucesso!' : 'D8 salvo com sucesso!')
                : (concluir ? 'D8 concluído localmente. Firebase indisponível.' : 'D8 salvo localmente. Firebase indisponível.'));
            render();
        }

        function canConfirmDeleteRNC(reason, accepted) {
            return String(reason || '').trim().length >= MIN_DELETE_REASON_LENGTH && !!accepted;
        }

        function abrirModalExcluirRNC() {
            if (!isCurrentUserAdmin()) {
                alert('Apenas ADMIN pode excluir RNC.');
                return;
            }
            const rnc = state.selectedRNC;
            if (!rnc) return;
            if (isRncExcluida(rnc)) {
                alert('Esta RNC já está marcada como excluída.');
                return;
            }
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1003';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width:700px;">
                    <div class="modal-header">
                        <h2 class="modal-title" style="color:#b91c1c;">Excluir RNC – ação de bloqueio operacional</h2>
                        <button class="modal-close" type="button" data-close-delete-rnc>×</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom:0.75rem;">
                            Esta ação marcará a RNC <strong>${escapeHtml(rnc.numero)}</strong> – <strong>${escapeHtml(rnc.cliente)}</strong> como excluída para operação.
                        </p>
                        <p style="margin-bottom:1rem; color:#7f1d1d;">
                            A RNC ficará oculta das visões padrão, mantendo histórico e anexos para auditoria. Deseja continuar?
                        </p>
                        <div class="form-group">
                            <label for="deleteRncReason">Motivo da exclusão <span style="color:#dc2626;">*</span></label>
                            <textarea id="deleteRncReason" rows="4" placeholder="Informe o motivo da exclusão (mínimo de ${MIN_DELETE_REASON_LENGTH} caracteres)"></textarea>
                        </div>
                        <label style="display:flex; align-items:center; gap:0.5rem; margin:0.75rem 0;">
                            <input type="checkbox" id="deleteRncConfirmCheck">
                            Estou ciente de que esta ação não poderá ser desfeita
                        </label>
                        <p id="deleteRncFeedback" style="display:none; margin-top:0.5rem; color:#dc2626; font-size:0.875rem;"></p>
                    </div>
                    <div style="display:flex; gap:0.75rem; justify-content:flex-end; padding:1rem 1.5rem; border-top:1px solid #e2e8f0;">
                        <button type="button" class="btn btn-secondary" data-close-delete-rnc>Cancelar</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteRncBtn" disabled>Confirmar exclusão</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            const reasonInput = overlay.querySelector('#deleteRncReason');
            const checkInput = overlay.querySelector('#deleteRncConfirmCheck');
            const confirmBtn = overlay.querySelector('#confirmDeleteRncBtn');
            const feedback = overlay.querySelector('#deleteRncFeedback');
            const close = () => overlay.remove();
            const updateState = () => {
                const motivo = String(reasonInput?.value || '').trim();
                const aceitou = !!checkInput?.checked;
                confirmBtn.disabled = !canConfirmDeleteRNC(motivo, aceitou);
            };
            overlay.querySelectorAll('[data-close-delete-rnc]').forEach(btn => btn.onclick = close);
            overlay.onclick = (event) => {
                if (event.target === overlay) close();
            };
            reasonInput.oninput = updateState;
            checkInput.onchange = updateState;
            confirmBtn.onclick = async () => {
                const motivo = String(reasonInput.value || '').trim();
                if (!canConfirmDeleteRNC(motivo, checkInput.checked)) {
                    if (feedback) {
                        feedback.style.display = 'block';
                        feedback.textContent = `Preencha o motivo (mínimo ${MIN_DELETE_REASON_LENGTH} caracteres) e confirme ciência para continuar.`;
                    }
                    return;
                }
                await excluirRNCSelecionada(motivo);
                close();
            };
        }

        async function excluirRNCSelecionada(motivoExclusao) {
            if (!isCurrentUserAdmin()) {
                alert('Apenas ADMIN pode excluir RNC.');
                return;
            }
            const rnc = state.selectedRNC;
            if (!rnc) return;
            const rncIndex = state.rncs.findIndex(item => item.id === rnc.id);
            if (rncIndex === -1) return;
            const motivo = String(motivoExclusao || '').trim();
            if (!canConfirmDeleteRNC(motivo, true)) {
                alert(`Informe um motivo de exclusão com no mínimo ${MIN_DELETE_REASON_LENGTH} caracteres.`);
                return;
            }

            const timestamp = new Date().toISOString();
            state.rncs[rncIndex].status = 'EXCLUIDA';
            state.rncs[rncIndex].deleted_at = timestamp;
            state.rncs[rncIndex].deleted_by = state.currentUser?.id || null;
            state.rncs[rncIndex].deleted_reason = motivo;

            const salvoNoFirebase = await salvarRNCNoFirebase(state.rncs[rncIndex]);
            registrarMovimentacao({
                tipoAcao: 'EXCLUSAO',
                modulo: 'RNC',
                referencia: state.rncs[rncIndex].numero,
                descricao: `Exclusão lógica da RNC. Motivo: ${motivo}`,
                usuario: state.currentUser?.name || '',
                perfil: state.currentUser?.profile || ''
            });

            state.currentPage = 'controle';
            state.selectedRNC = null;
            render();
            alert(salvoNoFirebase ? 'RNC excluída com sucesso.' : 'RNC excluída localmente. Falha ao salvar no Firebase agora.');
        }

        function isDataUrlImagem(data) {
            return /^data:image\//.test(String(data || ''));
        }

        function renderImagemOuAnexoRelatorio(titulo, dataUrl, options = {}) {
            if (!dataUrl) return `<div class="pdf-muted">${titulo}: não informado.</div>`;
            if (isDataUrlImagem(dataUrl)) {
                return `
                    <div class="pdf-image-card ${options.variant || ''}">
                        <div class="pdf-image-title">${escapeHtml(titulo)}</div>
                        <img src="${dataUrl}" alt="${escapeHtml(titulo)}">
                    </div>
                `;
            }
            return `<div class="pdf-muted">${escapeHtml(titulo)} anexado (conteúdo não-imagem).</div>`;
        }

        function renderTabelaAcoesRelatorio(acoes = [], incluirOrigem = false) {
            if (!acoes.length) return '<div class="pdf-muted">Nenhuma ação cadastrada.</div>';
            return `
                <table class="pdf-table">
                    <thead>
                        <tr>
                            <th>Descrição</th>
                            <th>Responsável</th>
                            ${incluirOrigem ? '<th>Origem</th>' : ''}
                            <th>Prazo Original</th>
                            <th>Último Re-prazo</th>
                            <th>Status de Prazo</th>
                            <th>Status da Ação</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${acoes.map(acao => {
                            const responsavel = getPessoaById(acao.responsavelId)?.nome || acao.responsavel || '-';
                            const indicador = obterIndicadorPrazoAcao(acao);
                            const ultimoReprazoData = acao.reprazos?.length ? acao.reprazos[acao.reprazos.length - 1]?.data : '';
                            return `
                                <tr>
                                    <td>${escapeHtml(acao.descricao || '-')}</td>
                                    <td>${escapeHtml(responsavel)}</td>
                                    ${incluirOrigem ? `<td>${escapeHtml(acao.origemPrevencao || '-')}</td>` : ''}
                                    <td>${formatDateSafe(acao.prazoPrincipal)}</td>
                                    <td>${ultimoReprazoData ? formatDateSafe(ultimoReprazoData) : '—'}</td>
                                    <td>${indicador.className === 'red' ? 'Em atraso' : (indicador.className === 'orange' ? 'Próximo ao vencimento' : 'Dentro do prazo')}</td>
                                    <td>${acao.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderEvidenciasAcoesRelatorio(acoes = [], tituloPadrao = 'Ação') {
            if (!acoes.length) return '<div class="pdf-muted">Nenhuma ação cadastrada.</div>';
            return acoes.map((acao, idx) => {
                const evidencias = acao.evidencias || [];
                const dataConclusao = extractAndFormatDate(acao.dataConclusao);
                const possuiAntesDepois = !!acao.before_image_url || !!acao.after_image_url;
                return `
                    <div class="pdf-action-block">
                        <h4>${escapeHtml(acao.descricao || `${tituloPadrao} ${idx + 1}`)}</h4>
                        <div><strong>Status:</strong> ${acao.status === 'CONCLUIDA' ? 'Concluída' : 'Em aberto'}</div>
                        <div><strong>Data de conclusão:</strong> ${acao.status === 'CONCLUIDA' ? dataConclusao : 'Não concluída'}</div>
                        ${possuiAntesDepois ? `
                            <div class="pdf-image-grid" style="margin-top:6px;">
                                ${renderImagemOuAnexoRelatorio('Situação ANTES da Implementação', acao.before_image_url, { variant: 'red' })}
                                ${renderImagemOuAnexoRelatorio('Situação APÓS a Implementação', acao.after_image_url, { variant: 'green' })}
                            </div>
                            <div class="pdf-muted">Situação antes da implementação da ação corretiva • Situação após a implementação da ação corretiva.</div>
                        ` : evidencias.length ? `
                            <div class="pdf-evidence-grid">
                                ${evidencias.map((ev, eidx) => renderImagemOuAnexoRelatorio(ev.nome || `Evidência ${eidx + 1}`, ev.conteudo)).join('')}
                            </div>
                        ` : '<div class="pdf-muted">Sem evidências anexadas.</div>'}
                    </div>
                `;
            }).join('');
        }

        function gerarRelatorio8DPDF() {
            const rnc = state.selectedRNC;
            if (!rnc) return;
            if (!isEtapaConcluida(rnc, 'd8')) {
                alert('O botão de geração do relatório está disponível somente após a conclusão do D8.');
                return;
            }

            ensureD4Structure(rnc);
            ensureD8Structure(rnc);
            const equipeD1 = montarEquipeD1(rnc);
            const acoesD5 = (rnc.d5?.listaAcoes || []).map(normalizeAcaoD5);
            const acoesD7 = (rnc.d7?.listaAcoes || []).map(normalizeAcaoD7);
            const dataGeracao = new Date().toLocaleString('pt-BR');
            const plantaRnc = equipeD1[0]?.pessoa?.planta || '-';
            const responsavelRnc = getPessoaById(rnc.equipeResponsavel?.analistaQualidadeId)?.nome || rnc.d1?.lider || '-';
            const nomeArquivoPdf = `Relatorio_8D_${rnc.numero || 'RNC'}`.replace(/[^\w\-]+/g, '_');
            const RELATORIO_PDF_VERSAO = '1.0';
            const RELATORIO_PDF_CLASSIFICACAO = 'Interno e Cliente';
            // Capa + 8 disciplinas (D1 a D8)
            const totalPaginas = 9;
            const NUM_PORQUES = 5;
            const renderPdfHeader = () => `
                <div class="pdf-header-bar">
                    <div class="pdf-logo">MAGIUS</div>
                    <div class="pdf-frase">AJUDANDO A CONSTRUIR, CULTIVAR, TRANSPORTAR E SEGUIR EM FRENTE</div>
                </div>
                <div class="pdf-report-title">
                    <div>RELATÓRIO 8D</div>
                    <div>${escapeHtml(rnc.numero)}</div>
                </div>
            `;
            const renderPdfSectionTitle = (tituloEtapa) => `<h3 class="pdf-section-title">${tituloEtapa}</h3>`;
            const renderPdfFooter = (pageNumber) => `
                <div class="pdf-footer">
                    <span>RNC: ${escapeHtml(rnc.numero)}</span>
                    <span>Relatório 8D – Página ${pageNumber} de ${totalPaginas}</span>
                </div>
            `;
            const renderPorquesRelatorio = (tipo) => `
                <div class="pdf-why-list">
                    ${Array.from({ length: NUM_PORQUES }, (_, idx) => idx + 1).map(i => `
                        <div class="pdf-why-item">
                            <div class="pdf-why-label">Por quê ${i}</div>
                            <div>${escapeHtml(rnc.d4?.[tipo]?.[`why${i}`] || '-')}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            const html = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8" />
                    <title>${escapeHtml(nomeArquivoPdf)}</title>
                    <style>
                        @page {
                            size: A4 portrait;
                            margin-top: 2cm;
                            margin-right: 2cm;
                            margin-bottom: 2cm;
                            margin-left: 2cm;
                        }
                        body { font-family: Inter, Segoe UI, Arial, sans-serif; color:#1e293b; font-size:12px; margin:0; }
                        .pdf-toolbar { position: sticky; top: 0; z-index: 999; display:flex; justify-content:flex-end; gap:8px; margin-bottom:10px; background:#f1f5f9; padding:8px; border:1px solid #bfdbfe; border-radius:6px; }
                        .pdf-toolbar button { border:none; border-radius:5px; padding:6px 12px; font-size:12px; cursor:pointer; }
                        .pdf-toolbar .btn-export { background:#0b3a75; color:white; }
                        .pdf-toolbar .btn-close { background:#e2e8f0; color:#1e293b; }
                        .pdf-page { page-break-after: always; padding-bottom: 12mm; }
                        .pdf-page:last-child { page-break-after: auto; }
                        .pdf-header-bar { background:#0b3a75; color:#fff; min-height:2.5cm; display:flex; justify-content:space-between; align-items:center; padding:0.45cm 0.6cm; border-radius:6px; }
                        .pdf-logo { font-weight:700; letter-spacing:0.08em; font-size:16px; }
                        .pdf-frase { font-size:9px; text-transform:uppercase; letter-spacing:0.04em; opacity:0.92; max-width:62%; text-align:right; }
                        .pdf-report-title { margin-top:8px; background:#dbeafe; border-bottom:2px solid #1e3a8a; border-radius:4px; padding:8px 10px; display:flex; justify-content:space-between; align-items:center; color:#0b3a75; font-weight:700; }
                        .pdf-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px 14px; margin-top:10px; }
                        .pdf-grid div { padding:7px; border:1px solid #bfdbfe; border-radius:6px; background:#fff; }
                        .pdf-section-title { font-size:15px; color:#1e3a8a; background:#dbeafe; margin:14px 0 8px; border-radius:4px; padding:8px 10px; border:1px solid #bfdbfe; page-break-after: avoid; }
                        .pdf-subtitle { margin:10px 0 6px; font-size:13px; color:#1e40af; border-bottom:1px solid #bfdbfe; padding-bottom:3px; page-break-after: avoid; }
                        .pdf-why-list { border:1px solid #bfdbfe; border-radius:6px; background:#fff; }
                        .pdf-why-item { display:grid; grid-template-columns: 96px 1fr; gap:10px; align-items:start; padding:8px 10px; border-bottom:1px solid #dbeafe; }
                        .pdf-why-item:last-child { border-bottom:none; }
                        .pdf-why-label { font-weight:700; color:#1e3a8a; }
                        .pdf-table { width:100%; border-collapse: collapse; margin-top:6px; }
                        .pdf-table th, .pdf-table td { border:1px solid #bfdbfe; padding:6px; vertical-align: top; text-align:left; }
                        .pdf-table th { background:#e0ecff; color:#1e3a8a; font-weight:700; page-break-after: avoid; }
                        .pdf-table tbody tr:nth-child(even) { background:#f8fbff; }
                        /* Repete o cabeçalho da tabela em novas páginas impressas */
                        thead { display: table-header-group; }
                        .pdf-muted { color:#64748b; font-style:italic; margin-top:4px; }
                        .pdf-image-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
                        .pdf-image-card { border:1px solid #bfdbfe; border-radius:6px; padding:6px; break-inside: avoid; background:#fff; }
                        .pdf-image-card.green { border:2px solid #16a34a; background:#f0fdf4; }
                        .pdf-image-card.red { border:2px solid #dc2626; background:#fef2f2; }
                        .pdf-image-title { font-weight:700; margin-bottom:6px; color:#1e40af; padding:4px 6px; border-radius:4px; }
                        .pdf-image-card.green .pdf-image-title { background:#16a34a; color:#fff; }
                        .pdf-image-card.red .pdf-image-title { background:#dc2626; color:#fff; }
                        .pdf-image-card img { width:100%; max-height:240px; object-fit:contain; border:1px solid #bfdbfe; background:white; display:block; margin:0 auto; }
                        .pdf-image-card.green img { border-color:#16a34a; }
                        .pdf-image-card.red img { border-color:#dc2626; }
                        .pdf-action-block { border:1px solid #bfdbfe; border-radius:6px; padding:8px; margin-bottom:8px; break-inside: avoid; }
                        .pdf-action-block h4 { margin:0 0 6px; font-size:13px; }
                        .pdf-evidence-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:6px; }
                        .pdf-footer { margin-top:10px; padding-top:6px; border-top:1px solid #bfdbfe; font-size:10px; color:#64748b; display:flex; justify-content:space-between; }
                        .pdf-doc-controls { margin-top:8px; padding:8px 10px; border:1px solid #bfdbfe; border-radius:6px; background:#f8fbff; color:#334155; }
                        @media print { .pdf-toolbar { display:none; } }
                    </style>
                </head>
                <body>
                    <div class="pdf-toolbar">
                        <button class="btn-export" onclick="exportarPdfRelatorio()">Exportar PDF</button>
                        <button class="btn-close" onclick="window.close()">Fechar</button>
                    </div>
                    <section class="pdf-page">
                        ${renderPdfHeader()}
                        <div class="pdf-grid">
                            <div><strong>Cliente:</strong> ${escapeHtml(rnc.cliente || '-')}</div>
                            <div><strong>Produto / Processo:</strong> ${escapeHtml(rnc.setor || '-')}</div>
                            <div><strong>Planta:</strong> ${escapeHtml(plantaRnc)}</div>
                            <div><strong>Data de abertura:</strong> ${formatDateSafe(rnc.dataAbertura)}</div>
                            <div><strong>Data de encerramento:</strong> ${extractAndFormatDate(rnc.d8?.dataConclusao)}</div>
                            <div><strong>Responsável pela RNC:</strong> ${escapeHtml(responsavelRnc)}</div>
                        </div>
                        <div class="pdf-muted">Data de geração: ${dataGeracao}</div>
                        <div class="pdf-doc-controls">
                            <strong>Controle do Documento:</strong> Relatório oficial 8D para auditoria • Versão ${RELATORIO_PDF_VERSAO} • Classificação: ${RELATORIO_PDF_CLASSIFICACAO}.
                        </div>
                        ${renderPdfFooter(1)}
                    </section>

                    <section class="pdf-page">
                        ${renderPdfSectionTitle('D1 – Construção da Equipe')}
                        <table class="pdf-table">
                            <thead><tr><th>Nome</th><th>Função na RNC</th><th>Setor</th><th>Planta</th></tr></thead>
                            <tbody>
                                ${equipeD1.length ? equipeD1.map(item => `<tr><td>${escapeHtml(item.pessoa.nome)}</td><td>${escapeHtml(item.funcaoRnc)}</td><td>${escapeHtml(item.pessoa.setor || '-')}</td><td>${escapeHtml(item.pessoa.planta || '-')}</td></tr>`).join('') : '<tr><td colspan="4">Equipe não informada.</td></tr>'}
                            </tbody>
                        </table>
                        ${renderPdfFooter(2)}
                    </section>

                    <section class="pdf-page">
                        ${renderPdfSectionTitle('D2 – Definição do Problema')}
                        <div><strong>Descrição do problema:</strong> ${escapeHtml(rnc.descricao || rnc.d2?.problema || '-')}</div>
                        <div class="pdf-grid" style="margin-top:8px;">
                            <div><strong>Cliente:</strong> ${escapeHtml(rnc.cliente || '-')}</div>
                            <div><strong>Modo de falha:</strong> ${escapeHtml(rnc.tipoFalha || '-')}</div>
                            <div><strong>Quantidade impactada:</strong> ${escapeHtml(String(rnc.quantidade || '-'))}</div>
                        </div>
                        <h4 class="pdf-subtitle">Imagens de referência</h4>
                        <div class="pdf-image-grid">
                            ${renderImagemOuAnexoRelatorio('Peça Conforme', rnc.fotosPeca?.conforme?.conteudo, { variant: 'green' })}
                            ${renderImagemOuAnexoRelatorio('Peça Não Conforme', rnc.fotosPeca?.naoConforme?.conteudo, { variant: 'red' })}
                        </div>
                        ${renderPdfFooter(3)}
                    </section>

                    <section class="pdf-page">
                        ${renderPdfSectionTitle('D3 – Contenção')}
                        <div class="pdf-grid">
                            <div><strong>Quantidade em estoque:</strong> ${escapeHtml(String(rnc.d3?.quantidadeEstoque || '-'))}</div>
                            <div><strong>Quantidade inspecionada:</strong> ${escapeHtml(String(rnc.d3?.quantidadeInspecionada || '-'))}</div>
                            <div><strong>Quantidade não conforme:</strong> ${escapeHtml(String(rnc.d3?.quantidadeNaoConforme || '-'))}</div>
                            <div><strong>Data de conclusão da contenção:</strong> ${extractAndFormatDate(rnc.d3?.dataConclusao)}</div>
                        </div>
                        <h4 class="pdf-subtitle">Alerta de contenção assinado</h4>
                        ${renderImagemOuAnexoRelatorio(rnc.d3?.anexoAlertaAssinadoNome || 'Alerta assinado', rnc.d3?.anexoAlertaAssinadoConteudo)}
                        ${renderPdfFooter(4)}
                    </section>

                    <section class="pdf-page">
                        ${renderPdfSectionTitle('D4 – Análise da Causa Raiz')}
                        <div class="pdf-grid">
                            <div><strong>Causa raiz – Ocorrência:</strong> ${escapeHtml(rnc.d4?.causaRaizOcorrencia || '-')}</div>
                            <div><strong>Causa raiz – Detecção:</strong> ${escapeHtml(rnc.d4?.causaRaizDeteccao || '-')}</div>
                        </div>
                        <h4 class="pdf-subtitle">5 Porquês – Ocorrência</h4>
                        ${renderPorquesRelatorio('ocorrencia')}
                        <h4 class="pdf-subtitle">5 Porquês – Detecção</h4>
                        ${renderPorquesRelatorio('deteccao')}
                        ${renderPdfFooter(5)}
                    </section>

                    <section class="pdf-page">
                        ${renderPdfSectionTitle('D5 – Ações Corretivas')}
                        ${renderTabelaAcoesRelatorio(acoesD5)}
                        ${renderPdfFooter(6)}
                    </section>

                    <section class="pdf-page">
                        ${renderPdfSectionTitle('D6 – Implementação das Ações Corretivas')}
                        ${renderEvidenciasAcoesRelatorio(acoesD5, 'Ação corretiva')}
                        ${renderPdfFooter(7)}
                    </section>

                    <section class="pdf-page">
                        ${renderPdfSectionTitle('D7 – Ações Preventivas')}
                        ${renderTabelaAcoesRelatorio(acoesD7, true)}
                        <h4 class="pdf-subtitle">Implementação e Evidências</h4>
                        ${renderEvidenciasAcoesRelatorio(acoesD7, 'Ação preventiva')}
                        ${renderPdfFooter(8)}
                    </section>

                    <section class="pdf-page">
                        ${renderPdfSectionTitle('D8 – Lições Aprendidas e Reconhecimento')}
                        <h4 class="pdf-subtitle">Lições Aprendidas</h4>
                        <div>${escapeHtml(rnc.d8?.licaoAprendida || '-')}</div>
                        <h4 class="pdf-subtitle">Reconhecimento Individual</h4>
                        <table class="pdf-table">
                            <thead><tr><th>Nome</th><th>Função</th><th>Reconhecimento</th></tr></thead>
                            <tbody>
                                ${equipeD1.length ? equipeD1.map(item => {
                                    const key = getEquipeMembroKey(item);
                                    return `<tr><td>${escapeHtml(item.pessoa.nome)}</td><td>${escapeHtml(item.funcaoRnc)}</td><td>${escapeHtml(rnc.d8?.reconhecimentoIndividual?.[key] || '-')}</td></tr>`;
                                }).join('') : '<tr><td colspan="3">Sem equipe vinculada.</td></tr>'}
                            </tbody>
                        </table>
                        <h4 class="pdf-subtitle">Agradecimento Final</h4>
                        <div>${escapeHtml(rnc.d8?.mensagemFinal || '-')}</div>
                        ${renderPdfFooter(9)}
                    </section>
                    <script>
                        function exportarPdfRelatorio() {
                            window.focus();
                            window.print();
                        }
                    <\/script>
                </body>
                </html>
            `;

            const blob = new Blob([html], { type: 'text/html' });
            const blobUrl = URL.createObjectURL(blob);
            const win = window.open(blobUrl, '_blank', 'noopener,noreferrer');
            if (!win) {
                URL.revokeObjectURL(blobUrl);
                alert('Não foi possível abrir a janela do relatório. Verifique bloqueio de pop-up.');
                return;
            }
            // 2 minutos para permitir carregamento completo e diálogo de impressão em relatórios extensos.
            const BLOB_URL_CLEANUP_TIMEOUT_MS = 120000;
            const WINDOW_CLOSE_POLL_INTERVAL_MS = 1000;
            const cleanupUrl = () => URL.revokeObjectURL(blobUrl);
            const cleanupTimer = setTimeout(cleanupUrl, BLOB_URL_CLEANUP_TIMEOUT_MS);
            const cleanupPoll = setInterval(() => {
                try {
                    if (!win.closed) return;
                    clearInterval(cleanupPoll);
                    clearTimeout(cleanupTimer);
                    cleanupUrl();
                } catch (error) {
                    console.warn('Erro ao verificar fechamento da janela do relatório 8D.', error);
                    clearInterval(cleanupPoll);
                    clearTimeout(cleanupTimer);
                    cleanupUrl();
                }
            }, WINDOW_CLOSE_POLL_INTERVAL_MS);
        }

        async function salvarFase(phaseId) {
            const rnc = state.selectedRNC;
            const rncIndex = state.rncs.findIndex(r => r.id === rnc.id);
            
            if (phaseId === 'd1') {
                // D1 é controlado pelo cadastro de pessoas e pelo cadastro da RNC.
                return;
            } else if (phaseId === 'd2') {
                return;
            } else if (phaseId === 'd3') {
                state.rncs[rncIndex].d3.evidencia = document.getElementById('d3-evidencia').value;
                state.rncs[rncIndex].d3.quantidadeEstoque = document.getElementById('d3-estoque').value;
                state.rncs[rncIndex].d3.quantidadeInspecionada = document.getElementById('d3-inspecionada').value;
                state.rncs[rncIndex].d3.quantidadeNaoConforme = document.getElementById('d3-nao-conforme').value;
                const anexoInput = document.getElementById('d3-alerta-arquivo');
                if (anexoInput && anexoInput.files && anexoInput.files.length > 0) {
                    const arquivo = anexoInput.files[0];
                    const base64 = await lerArquivoBase64(arquivo, 'anexo D3');
                    if (base64 === null) {
                        alert('Falha ao processar o anexo da D3. Tente novamente.');
                        return;
                    }
                    state.rncs[rncIndex].d3.anexoAlertaAssinadoNome = arquivo.name;
                    state.rncs[rncIndex].d3.anexoAlertaAssinadoConteudo = base64;
                }
            } else if (phaseId === 'd4') {
                ensureD4Structure(state.rncs[rncIndex]);
                const d4 = state.rncs[rncIndex].d4;
                for (let i = 1; i <= 5; i++) {
                    const oc = document.getElementById(`d4-oc-why${i}`);
                    const det = document.getElementById(`d4-det-why${i}`);
                    if (oc) d4.ocorrencia[`why${i}`] = oc.value;
                    if (det) d4.deteccao[`why${i}`] = det.value;
                }
                consolidateD4Data(d4);
            } else if (phaseId === 'd5') {
                return;
            } else if (phaseId === 'd6') {
                return;
            } else if (phaseId === 'd7') {
                return;
            } else if (phaseId === 'd8') {
                return;
            }
            
            state.selectedRNC = state.rncs[rncIndex];
            sincronizarFluxo8D(state.selectedRNC);
            state.activeTab = state.selectedRNC.faseAtual;
            const salvoNoFirebase = await salvarRNCNoFirebase(state.selectedRNC);
            alert(salvoNoFirebase ? 'Dados salvos com sucesso!' : 'Dados salvos localmente. Firebase indisponível.');
            render();
        }

        function solicitarReprazo(phaseId, num) {
            if (!isCurrentUserAdmin()) {
                alert('Apenas usuários ADMIN podem alterar prazos e re-prazos.');
                return;
            }
            const phase = phases.find(p => p.id === phaseId);
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.style.zIndex = '1001';
            overlay.innerHTML = `
                <div class="modal-content" style="max-width: 600px;" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">Solicitar Re-prazo ${num}</h2>
                            <p style="color: #64748b; margin-top: 0.5rem;">${phase.name}</p>
                        </div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <strong>Atenção:</strong> Justifique detalhadamente o motivo da solicitação.
                        </div>
                        <form id="reprazoForm">
                            <div class="form-group">
                                <label>Nova Data Limite</label>
                                <input type="date" id="novaData" required>
                            </div>
                            <div class="form-group">
                                <label>Justificativa</label>
                                <textarea id="justificativa" rows="4" placeholder="Descreva o motivo..." required></textarea>
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
                                <button type="submit" class="btn btn-success">Confirmar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            overlay.onclick = (e) => e.target === overlay && overlay.remove();
            document.body.appendChild(overlay);
            
            document.getElementById('reprazoForm').onsubmit = async (e) => {
                e.preventDefault();
                const novaData = document.getElementById('novaData').value;
                const just = document.getElementById('justificativa').value;
                 
                const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
                const rnc = state.rncs[rncIndex];
                if (getReprazoCountFase(rnc, phaseId) >= LIMITE_NEGOCIACAO_REPRAZO && !usuarioPodeNegociarReprazo()) {
                    const faseLabel = getLabelCurtoFase(phaseId);
                    const responsavelFase = getResponsavelFase(rnc, phaseId);
                    const emailGerenciaFase = getEmailGerenciaResponsavelFase(rnc, phaseId);
                    registrarEscalonamentoReprazo(rnc, {
                        tipo: 'LIMITE_REPRAZO_FASE',
                        origem: `ETAPA_${phaseId.toUpperCase()}`,
                        chave: `ETAPA:${phaseId}`,
                        faseId: phaseId,
                        faseLabel,
                        responsavel: responsavelFase,
                        emailGerencia: emailGerenciaFase,
                        totalReprazosFase: getReprazoCountFase(rnc, phaseId),
                        mensagem: `⛔ Fase ${faseLabel} ultrapassou o limite de ${LIMITE_NEGOCIACAO_REPRAZO} re-prazos. Escalonamento automático para a Gerência do responsável pela fase.`
                    });
                    await salvarRNCNoFirebase(rnc);
                    alert(`⛔ Limite de re-prazos atingido na fase ${faseLabel}. Próximo atraso nesta fase foi escalonado para a Gerência do responsável pela fase${emailGerenciaFase ? ` (${emailGerenciaFase})` : ''}.`);
                    overlay.remove();
                    render();
                    return;
                }
                if (num === 1) {
                    state.rncs[rncIndex].prazos[phaseId].reprazo1 = novaData;
                    state.rncs[rncIndex].prazos[phaseId].just1 = just;
                } else {
                    state.rncs[rncIndex].prazos[phaseId].reprazo2 = novaData;
                    state.rncs[rncIndex].prazos[phaseId].just2 = just;
                }
                registrarAuditoriaAdmin('EDICAO', `Re-prazo ${num} definido para ${getLabelCurtoFase(phaseId)} em ${formatDateSafe(novaData)}`, { modulo: `Fase ${getLabelCurtoFase(phaseId)}`, referencia: state.rncs[rncIndex].numero, tipoAcao: 'EDICAO' });
                
                state.rncs[rncIndex].status = "AT_RISK";
                state.selectedRNC = state.rncs[rncIndex];
                const salvoNoFirebase = await salvarRNCNoFirebase(state.selectedRNC);
                overlay.remove();
                render();
                alert(salvoNoFirebase ? `Re-prazo ${num} solicitado com sucesso!` : `Re-prazo ${num} salvo localmente. Firebase indisponível.`);
            };
        }

        function fecharAlertasModal() {
            state.alertsModalAberto = false;
            render();
        }

        function abrirRNCViaAlerta(rncId, etapaPreferida) {
            const rnc = state.rncs.find(item => item.id === Number(rncId));
            if (!rnc) return;
            state.currentPage = 'controle';
            state.selectedRNC = rnc;
            sincronizarFluxo8D(state.selectedRNC);
            const etapaDestino = etapaPreferida && canAcessarEtapa(state.selectedRNC, etapaPreferida)
                ? etapaPreferida
                : (state.selectedRNC.faseAtual || 'd1');
            state.activeTab = etapaDestino;
            state.activeD4SubTab = 'principal';
            state.alertsModalAberto = false;
            render();
        }

        function abrirAlertaRNC(rncId) {
            abrirRNCViaAlerta(rncId);
        }

        function abrirAlertaAcao(tipo, rncId, acaoId) {
            const etapa = tipo === 'PREVENTIVA' ? 'd7' : 'd6';
            state.pendingActionAlert = { tipo, acaoId };
            abrirRNCViaAlerta(rncId, etapa);
        }
 
        function attachEventListeners() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.onsubmit = (e) => {
                    e.preventDefault();
                    const emailInput = loginForm.querySelector('input[type="email"]');
                    const senhaInput = loginForm.querySelector('input[type="password"]');
                    const emailInformado = String(emailInput?.value || '').trim().toLowerCase();
                    const senhaInformada = String(senhaInput?.value || '');
                    if (!senhaInformada) {
                        alert('Informe a senha para acessar.');
                        return;
                    }
                    const usuarioSistema = users.find(user => String(user.email || '').toLowerCase() === emailInformado);
                    const pessoaCadastro = pessoasBase.find(pessoa => String(pessoa.email || '').toLowerCase() === emailInformado);
                    if (!usuarioSistema && !pessoaCadastro) {
                        alert('Usuário não encontrado.');
                        return;
                    }
                    if (pessoaCadastro && String(pessoaCadastro.status || '').toLowerCase() !== 'ativo') {
                        alert('Usuário inativo. Procure um administrador.');
                        return;
                    }
                    if (senhaInformada !== getUserPassword(emailInformado)) {
                        alert('Senha inválida.');
                        return;
                    }
                    const baseUser = usuarioSistema || {
                        id: pessoaCadastro?.id || GUEST_USER_ID,
                        name: pessoaCadastro?.nome || 'Usuário',
                        email: emailInformado,
                        role: pessoaCadastro?.cargo || 'Usuário',
                        profile: String(pessoaCadastro?.perfilAcesso || 'USUARIO').toUpperCase(),
                        planta: pessoaCadastro?.planta || 'Matriz',
                        initials: (pessoaCadastro?.nome || 'U').split(' ').map(x => x[0]).slice(0, 2).join('').toUpperCase()
                    };
                    state.currentUser = baseUser;
                    registrarMovimentacao({
                        tipoAcao: 'LOGIN',
                        modulo: 'Usuários e Segurança',
                        referencia: baseUser.email,
                        descricao: 'Acesso ao sistema',
                        usuario: baseUser.name,
                        perfil: baseUser.profile
                    });
                    state.currentPage = 'dashboard';
                    render();
                };
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                const handleNavSelection = () => {
                    const page = item.dataset.page;
                    if (page === 'logout') {
                        if (confirm('Sair?')) {
                            registrarMovimentacao({
                                tipoAcao: 'LOGOUT',
                                modulo: 'Usuários e Segurança',
                                referencia: state.currentUser?.email || '',
                                descricao: 'Saída do sistema'
                            });
                            state.currentUser = null;
                            state.currentPage = 'login';
                            state.mobileMenuOpen = false;
                            render();
                        }
                    } else if (page) {
                        if ((page === 'admin' || page === 'movimentacoes') && !isCurrentUserAdmin()) {
                            alert('Acesso restrito ao perfil ADMIN.');
                            return;
                        }
                        state.currentPage = page;
                        state.mobileMenuOpen = false;
                        render();
                    }
                };
                item.onclick = handleNavSelection;
                item.onkeydown = (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        handleNavSelection();
                    }
                };
            });

            const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
            if (toggleSidebarBtn) {
                toggleSidebarBtn.onclick = toggleSidebar;
            }

            const sidebarBackdrop = document.getElementById('sidebarBackdrop');
            if (sidebarBackdrop) {
                sidebarBackdrop.onclick = () => {
                    state.mobileMenuOpen = false;
                    render();
                };
            }

            const mobileSidebarBtn = document.getElementById('mobileSidebarBtn');
            if (mobileSidebarBtn) {
                mobileSidebarBtn.onclick = () => {
                    state.mobileMenuOpen = true;
                    render();
                };
            }

            document.querySelectorAll('.rnc-row').forEach(row => {
                row.onclick = () => {
                    state.selectedRNC = state.rncs.find(r => r.id == row.dataset.rncId);
                    sincronizarFluxo8D(state.selectedRNC);
                    state.activeTab = state.selectedRNC?.faseAtual || 'd1';
                    state.activeD4SubTab = 'principal';
                    render();
                };
            });

            const abrirPerfilModal = document.getElementById('abrirPerfilModal');
            if (abrirPerfilModal) {
                const abrirModalPerfil = () => {
                    state.perfilModalAberto = true;
                    state.perfilAbaAtiva = 'perfil';
                    render();
                };
                abrirPerfilModal.onclick = abrirModalPerfil;
                abrirPerfilModal.onkeydown = (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        abrirModalPerfil();
                    }
                };
            }

            const abrirAlertasBtn = document.getElementById('abrirAlertasBtn');
            if (abrirAlertasBtn) {
                abrirAlertasBtn.onclick = () => {
                    state.alertsModalAberto = !state.alertsModalAberto;
                    render();
                };
            }

            const alertsPopoverOverlay = document.getElementById('alertsPopoverOverlay');
            if (alertsPopoverOverlay) {
                alertsPopoverOverlay.onclick = (event) => {
                    if (event.target === alertsPopoverOverlay) {
                        state.alertsModalAberto = false;
                        render();
                    }
                };
            }

            const fecharAlertasBtn = document.getElementById('fecharAlertasBtn');
            if (fecharAlertasBtn) {
                fecharAlertasBtn.onclick = () => fecharAlertasModal();
            }

            const irControleViaAlertasBtn = document.getElementById('irControleViaAlertasBtn');
            if (irControleViaAlertasBtn) {
                irControleViaAlertasBtn.onclick = () => {
                    state.currentPage = 'controle';
                    state.alertsModalAberto = false;
                    render();
                };
            }

            if (state.pendingActionAlert && state.selectedRNC) {
                const pending = state.pendingActionAlert;
                try {
                    if (pending.tipo === 'PREVENTIVA') {
                        abrirImplementacaoAcaoD7(pending.acaoId);
                    } else {
                        abrirImplementacaoAcaoD6(pending.acaoId);
                    }
                    state.pendingActionAlert = null;
                } catch (error) {
                    console.warn('Falha ao abrir ação de alerta pendente.', error);
                }
            }

            document.querySelectorAll('.alerts-open-rnc').forEach(btn => {
                btn.onclick = () => {
                    const rncId = Number(btn.dataset.rncId);
                    if (!Number.isFinite(rncId)) return;
                    abrirAlertaRNC(rncId);
                };
            });

            document.querySelectorAll('.alerts-open-acao').forEach(btn => {
                btn.onclick = () => {
                    const tipo = String(btn.dataset.alertaTipo || '');
                    const rncId = Number(btn.dataset.rncId);
                    const acaoId = String(btn.dataset.acaoId || '');
                    if (!tipo || !Number.isFinite(rncId) || !acaoId) return;
                    abrirAlertaAcao(tipo, rncId, acaoId);
                };
            });
             
            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.onclick = () => {
                    state.selectedRNC = state.rncs.find(r => r.id == btn.dataset.rncId);
                    sincronizarFluxo8D(state.selectedRNC);
                    state.activeTab = state.selectedRNC?.faseAtual || 'd1';
                    state.activeD4SubTab = 'principal';
                    render();
                };
            });

            const dashboardMonthFilter = document.getElementById('dashboardMonthFilter');
            const dashboardYearFilter = document.getElementById('dashboardYearFilter');
            const dashboardSearchInput = document.getElementById('dashboardSearchInput');
            const dashboardPrevPage = document.getElementById('dashboardPrevPage');
            const dashboardNextPage = document.getElementById('dashboardNextPage');
            if (dashboardMonthFilter && dashboardYearFilter) {
                dashboardMonthFilter.onchange = () => {
                    state.dashboardFilterMonth = Number(dashboardMonthFilter.value);
                    state.dashboardPage = 1;
                    render();
                };
                dashboardYearFilter.onchange = () => {
                    state.dashboardFilterYear = Number(dashboardYearFilter.value);
                    state.dashboardPage = 1;
                    render();
                };
            }
            if (dashboardSearchInput) {
                dashboardSearchInput.oninput = () => {
                    state.dashboardSearch = dashboardSearchInput.value;
                    state.dashboardPage = 1;
                    render();
                };
            }
            if (dashboardPrevPage) {
                dashboardPrevPage.onclick = () => {
                    state.dashboardPage = Math.max(1, state.dashboardPage - 1);
                    render();
                };
            }
            if (dashboardNextPage) {
                dashboardNextPage.onclick = () => {
                    state.dashboardPage = state.dashboardPage + 1;
                    render();
                };
            }

            const cadastroRncForm = document.getElementById('cadastroRncForm');
            if (cadastroRncForm) {
                const numeroRncInput = cadastroRncForm.querySelector('#numeroRncInput');
                const numeroRncMsg = cadastroRncForm.querySelector('#numeroRncValidacao');
                const cadastroRncSubmitBtn = cadastroRncForm.querySelector('#cadastroRncSubmitBtn');
                const validarNumeroRncUnico = () => {
                    if (!numeroRncInput || !numeroRncMsg || !cadastroRncSubmitBtn) return true;
                    const numeroInformado = String(numeroRncInput.value || '').trim();
                    if (!numeroInformado) {
                        numeroRncInput.setCustomValidity('');
                        numeroRncMsg.style.display = 'none';
                        cadastroRncSubmitBtn.disabled = false;
                        return true;
                    }
                    if (existeNumeroRNCDuplicado(numeroInformado)) {
                        numeroRncInput.setCustomValidity(RNC_NUMERO_DUPLICADO_MSG);
                        numeroRncMsg.textContent = RNC_NUMERO_DUPLICADO_MSG;
                        numeroRncMsg.style.display = 'block';
                        cadastroRncSubmitBtn.disabled = true;
                        return false;
                    }
                    numeroRncInput.setCustomValidity('');
                    numeroRncMsg.textContent = '';
                    numeroRncMsg.style.display = 'none';
                    cadastroRncSubmitBtn.disabled = false;
                    return true;
                };
                if (numeroRncInput) {
                    numeroRncInput.onblur = validarNumeroRncUnico;
                    numeroRncInput.oninput = validarNumeroRncUnico;
                }

                const outrosHidden = cadastroRncForm.querySelector('#outrosEnvolvidosIds');
                const outrosSelect = cadastroRncForm.querySelector('#outrosEnvolvidosSelect');
                const adicionarOutroBtn = cadastroRncForm.querySelector('#adicionarOutroEnvolvidoBtn');
                const outrosSelecionadosContainer = cadastroRncForm.querySelector('#outrosEnvolvidosSelecionados');
                if (outrosHidden && outrosSelect && adicionarOutroBtn && outrosSelecionadosContainer) {
                    renderOutrosEnvolvidosSelecionados();
                    adicionarOutroBtn.onclick = () => {
                        const novoId = Number(outrosSelect.value);
                        if (!novoId) return;
                        const ids = getOutrosEnvolvidosSelecionados();
                        if (!ids.includes(novoId)) {
                            ids.push(novoId);
                            outrosHidden.value = ids.join(',');
                            renderOutrosEnvolvidosSelecionados();
                        }
                        outrosSelect.value = '';
                    };
                    outrosSelecionadosContainer.onclick = (event) => {
                        const target = event.target.closest('.btn-remover-outro');
                        if (!target) return;
                        const removerId = Number(target.dataset.outroId);
                        const ids = getOutrosEnvolvidosSelecionados().filter(id => id !== removerId);
                        outrosHidden.value = ids.join(',');
                        renderOutrosEnvolvidosSelecionados();
                    };
                }

                cadastroRncForm.onsubmit = async (e) => {
                    e.preventDefault();
                    if (!validarNumeroRncUnico()) return;
                    const formData = new FormData(cadastroRncForm);
                    const nextId = state.rncs.length ? Math.max(...state.rncs.map(r => r.id)) + 1 : 1;
                    const hoje = new Date();
                    const dataAbertura = hoje.toISOString().split('T')[0];
                    const addDays = (days) => {
                        const data = new Date(hoje);
                        data.setDate(data.getDate() + days);
                        return data.toISOString().split('T')[0];
                    };

                    const analistaEngenhariaId = Number(formData.get('analistaEngenhariaId'));
                    const analistaQualidadeId = Number(formData.get('analistaQualidadeId'));
                    const responsavelContencaoId = Number(formData.get('responsavelContencaoId'));
                    const outrosEnvolvidosIds = String(formData.get('outrosEnvolvidosIds') || '').trim()
                        ? String(formData.get('outrosEnvolvidosIds') || '').split(',').map(id => Number(id)).filter(id => Number.isFinite(id) && id > 0)
                        : [];

                    const analistaEngenharia = getPessoaById(analistaEngenhariaId);
                    const analistaQualidade = getPessoaById(analistaQualidadeId);
                    const responsavelContencao = getPessoaById(responsavelContencaoId);
                    const outrosEnvolvidos = outrosEnvolvidosIds.map(id => getPessoaById(id)).filter(Boolean);
                    const equipeD1 = [...new Set([
                        responsavelContencao?.nome,
                        analistaEngenharia?.nome,
                        analistaQualidade?.nome,
                        ...outrosEnvolvidos.map(p => p.nome)
                    ].filter(Boolean))].join(', ');
                    const fotoConformeFile = formData.get('fotoConforme');
                    const fotoNaoConformeFile = formData.get('fotoNaoConforme');

                    const toBase64 = (file) => new Promise((resolve) => {
                        if (!file || !file.name) {
                            resolve('');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result || '');
                        reader.onerror = () => {
                            console.warn('Falha ao ler arquivo de foto:', file.name);
                            resolve('');
                        };
                        reader.readAsDataURL(file);
                    });

                    const fotoConformeBase64 = await toBase64(fotoConformeFile);
                    const fotoNaoConformeBase64 = await toBase64(fotoNaoConformeFile);
                    if (!fotoConformeBase64 || !fotoNaoConformeBase64) {
                        alert('Não foi possível processar as fotos da peça. Tente novamente.');
                        return;
                    }

                    const numeroRnc = String(formData.get('numeroRnc') || '').trim();
                    if (existeNumeroRNCDuplicado(numeroRnc)) {
                        alert(RNC_NUMERO_DUPLICADO_MSG);
                        return;
                    }

                    const novaRnc = {
                        id: nextId,
                        numero: numeroRnc,
                        cliente: formData.get('cliente'),
                        codigoPeca: formData.get('codigoPeca'),
                        tipoFalha: formData.get('tipoFalha'),
                        responsavel: responsavelContencao?.nome || '',
                        quantidade: Number(formData.get('quantidade')),
                        faseAtual: 'd1',
                        status: 'ON_TIME',
                        prioridade: formData.get('prioridade'),
                        setor: formData.get('setor'),
                        dataAbertura,
                        descricao: formData.get('descricao'),
                        equipeResponsavel: {
                            analistaEngenhariaId,
                            analistaQualidadeId,
                            responsavelContencaoId,
                            outrosEnvolvidosIds
                        },
                        fotosPeca: {
                            conforme: {
                                nome: fotoConformeFile?.name || '',
                                conteudo: fotoConformeBase64
                            },
                            naoConforme: {
                                nome: fotoNaoConformeFile?.name || '',
                                conteudo: fotoNaoConformeBase64
                            }
                        },
                        d1: { equipe: equipeD1, lider: analistaQualidade?.nome || '' },
                        d2: { problema: formData.get('descricao'), etapaConcluida: true },
                        d3: {
                            acaoContemcao: "",
                            evidencia: "",
                            quantidadeEstoque: "",
                            quantidadeInspecionada: "",
                            quantidadeNaoConforme: "",
                            anexoAlertaAssinadoNome: "",
                            anexoAlertaAssinadoConteudo: "",
                            etapaConcluida: false
                        },
                        d4: { causaRaiz: "", why1: "", why2: "", why3: "", why4: "", why5: "" },
                        d5: { acoesCorretivas: "" },
                        d6: { planoImplementacao: "", responsavel: "", prazoImplementacao: "" },
                        d7: { acoesPreventivas: "", listaAcoes: [] },
                        d8: { reconhecimento: "", licaoAprendida: "", mensagemFinal: "", reconhecimentoIndividual: {}, concluida: false, dataConclusao: "" },
                        prazos: {
                            d1: { original: dataAbertura, sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d2: { original: dataAbertura, sla: "Imediato", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d3: { original: addDays(1), sla: "24 horas", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d4: { original: addDays(3), sla: "3 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d5: { original: addDays(5), sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d6: { original: addDays(12), sla: "7 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d7: { original: addDays(14), sla: "2 dias", reprazo1: null, reprazo2: null, just1: "", just2: "" },
                            d8: { original: addDays(15), sla: "1 dia", reprazo1: null, reprazo2: null, just1: "", just2: "" }
                        }
                    };

                    state.rncs.push(novaRnc);
                    registrarAuditoriaAdmin('INCLUSAO', `Nova RNC criada (${novaRnc.numero}) para o cliente ${novaRnc.cliente}.`, {
                        modulo: 'RNC',
                        referencia: novaRnc.numero,
                        tipoAcao: 'INCLUSAO'
                    });
                    const salvoNoFirebase = await salvarRNCNoFirebase(novaRnc);
                    cadastroRncForm.reset();
                    render();
                    alert(salvoNoFirebase ? 'RNC cadastrada com sucesso!' : 'RNC cadastrada localmente. Firebase indisponível.');
                };
            }

            document.querySelectorAll('.btn-gerenciar-cadastro').forEach(btn => {
                btn.onclick = () => abrirModalListagemCadastro(btn.dataset.cadastroTipo);
            });

            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.onclick = () => {
                    if (!isCurrentUserAdmin()) return;
                    state.adminTabAtiva = btn.dataset.adminTab;
                    render();
                };
            });

            const movDataInicio = document.getElementById('movDataInicio');
            const movDataFim = document.getElementById('movDataFim');
            const movUsuario = document.getElementById('movUsuario');
            const movTipoAcao = document.getElementById('movTipoAcao');
            const movModulo = document.getElementById('movModulo');
            const movNumeroRnc = document.getElementById('movNumeroRnc');
            if (movDataInicio && movDataFim && movUsuario && movTipoAcao && movModulo && movNumeroRnc) {
                const aplicarFiltrosMovimentacoes = () => {
                    state.movimentacoesFilters.dataInicio = movDataInicio.value;
                    state.movimentacoesFilters.dataFim = movDataFim.value;
                    state.movimentacoesFilters.usuario = movUsuario.value;
                    state.movimentacoesFilters.tipoAcao = movTipoAcao.value;
                    state.movimentacoesFilters.modulo = movModulo.value;
                    state.movimentacoesFilters.numeroRnc = movNumeroRnc.value;
                    render();
                };
                [movDataInicio, movDataFim, movUsuario, movTipoAcao, movModulo].forEach(el => el.onchange = aplicarFiltrosMovimentacoes);
                movNumeroRnc.oninput = aplicarFiltrosMovimentacoes;
            }

            const adminTemplateTipoSelect = document.getElementById('adminTemplateTipoSelect');
            if (adminTemplateTipoSelect) {
                adminTemplateTipoSelect.onchange = () => {
                    state.adminTemplateTipo = adminTemplateTipoSelect.value;
                    render();
                };
            }
            const salvarTemplateEmailBtn = document.getElementById('salvarTemplateEmailBtn');
            const testarTemplateEmailBtn = document.getElementById('testarTemplateEmailBtn');
            const adminTemplateFeedback = document.getElementById('adminTemplateFeedback');
            if (salvarTemplateEmailBtn && testarTemplateEmailBtn) {
                salvarTemplateEmailBtn.onclick = () => {
                    if (!isCurrentUserAdmin()) return;
                    const tipo = state.adminTemplateTipo || 'FASE';
                    const key = tipo === 'ACAO' ? 'acao' : (tipo === 'PRAZO_TOTAL_RNC' ? 'prazoTotal' : 'fase');
                    const assunto = String(document.getElementById('adminTemplateAssunto')?.value || '').trim();
                    const corpo = String(document.getElementById('adminTemplateCorpo')?.value || '').trim();
                    if (!assunto || !corpo) {
                        if (adminTemplateFeedback) {
                            adminTemplateFeedback.style.display = 'block';
                            adminTemplateFeedback.style.color = '#dc2626';
                            adminTemplateFeedback.textContent = 'Preencha assunto e corpo do template.';
                        }
                        return;
                    }
                    emailTemplatesBase[key] = { assunto, corpo };
                    registrarAuditoriaAdmin('EDICAO', `Template ${tipo} atualizado`, { modulo: 'Template de E-mail', referencia: tipo, tipoAcao: 'EDICAO' });
                    if (adminTemplateFeedback) {
                        adminTemplateFeedback.style.display = 'block';
                        adminTemplateFeedback.style.color = '#059669';
                        adminTemplateFeedback.textContent = 'Template salvo com sucesso.';
                    }
                };
                testarTemplateEmailBtn.onclick = () => {
                    if (!isCurrentUserAdmin()) {
                        alert('Acesso restrito ao perfil ADMIN.');
                        return;
                    }
                    const tipo = state.adminTemplateTipo || 'FASE';
                    const assunto = String(document.getElementById('adminTemplateAssunto')?.value || '').trim();
                    const corpo = String(document.getElementById('adminTemplateCorpo')?.value || '').trim();
                    const exemplo = {
                        numero_rnc: 'RNC-2026-001',
                        cliente: 'Cliente Exemplo',
                        fase: 'D3 - Contenção',
                        acao: 'Ajuste de setup',
                        responsavel: 'João Silva',
                        dias_atraso: '3',
                        quantidade_reprazo: '2',
                        data_referencia: formatDateSafe(new Date().toISOString().slice(0, 10))
                    };
                    const preview = `Assunto: ${aplicarTemplateEmail(assunto, exemplo)}\n\n${aplicarTemplateEmail(corpo, exemplo)}`;
                    alert(preview);
                    registrarAuditoriaAdmin('ENVIO', `Teste de template ${tipo} executado com dados de exemplo.`, {
                        modulo: 'Template de E-mail',
                        referencia: tipo,
                        tipoAcao: 'ENVIO'
                    });
                    if (adminTemplateFeedback) {
                        adminTemplateFeedback.style.display = 'block';
                        adminTemplateFeedback.style.color = '#1d4ed8';
                        adminTemplateFeedback.textContent = `Template ${tipo} testado com dados de exemplo.`;
                    }
                };
            }

            const d3Estoque = document.getElementById('d3-estoque');
            const d3Inspecionada = document.getElementById('d3-inspecionada');
            const d3NaoConforme = document.getElementById('d3-nao-conforme');
            const d3Anexo = document.getElementById('d3-alerta-arquivo');
            if (d3Estoque && d3Inspecionada && d3NaoConforme && d3Anexo) {
                [d3Estoque, d3Inspecionada, d3NaoConforme].forEach(el => el.oninput = () => {
                    if (state.selectedRNC?.d3) {
                        state.selectedRNC.d3.etapaConcluida = false;
                        const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
                        if (rncIndex !== -1) state.rncs[rncIndex].d3.etapaConcluida = false;
                    }
                    atualizarEstadoConclusaoD3();
                });
                d3Anexo.onchange = () => {
                    if (state.selectedRNC?.d3) {
                        state.selectedRNC.d3.etapaConcluida = false;
                        const rncIndex = state.rncs.findIndex(r => r.id === state.selectedRNC.id);
                        if (rncIndex !== -1) state.rncs[rncIndex].d3.etapaConcluida = false;
                    }
                    atualizarEstadoConclusaoD3();
                };
                atualizarEstadoConclusaoD3();
            }

            const filtroStatus = document.getElementById('controleFiltroStatus');
            const filtroSetor = document.getElementById('controleFiltroSetor');
            const filtroConclusao = document.getElementById('controleFiltroConclusao');
            const filtroEtapas = document.getElementById('controleFiltroEtapas');
            const filtroBusca = document.getElementById('controleFiltroBusca');
            const filtroExcluidas = document.getElementById('controleFiltroExcluidas');
            if (filtroStatus && filtroSetor && filtroConclusao && filtroEtapas && filtroBusca) {
                const aplicarFiltrosControle = () => {
                    state.controleFilters.status = filtroStatus.value;
                    state.controleFilters.setor = filtroSetor.value;
                    state.controleFilters.conclusao = filtroConclusao.value;
                    state.controleFilters.etapas = filtroEtapas.value;
                    state.controleFilters.busca = filtroBusca.value;
                    state.controleFilters.showExcluidas = !!filtroExcluidas?.checked;
                    render();
                };
                filtroStatus.onchange = aplicarFiltrosControle;
                filtroSetor.onchange = aplicarFiltrosControle;
                filtroConclusao.onchange = aplicarFiltrosControle;
                filtroEtapas.onchange = aplicarFiltrosControle;
                filtroBusca.oninput = aplicarFiltrosControle;
                if (filtroExcluidas) filtroExcluidas.onchange = aplicarFiltrosControle;
            }

            document.querySelectorAll('.controle-sort-btn').forEach(btn => {
                btn.onclick = () => {
                    const key = String(btn.dataset.sortKey || '');
                    if (!key) return;
                    if (state.controleSort.key === key) {
                        state.controleSort.dir = state.controleSort.dir === 'asc' ? 'desc' : 'asc';
                    } else {
                        state.controleSort.key = key;
                        state.controleSort.dir = 'asc';
                    }
                    render();
                };
            });

            const irControleOrdenadoBtn = document.getElementById('irControleOrdenadoBtn');
            if (irControleOrdenadoBtn) {
                irControleOrdenadoBtn.onclick = () => {
                    state.currentPage = 'controle';
                    state.controleSort.key = 'criticidade';
                    state.controleSort.dir = 'desc';
                    state.alertsModalAberto = false;
                    render();
                };
            }
            
            const closeModal = document.getElementById('closeModal');
            if (closeModal) {
                closeModal.onclick = () => {
                    state.selectedRNC = null;
                    render();
                };
            }

            const perfilModal = document.getElementById('perfilModal');
            const fecharPerfilModal = document.getElementById('fecharPerfilModal');
            if (fecharPerfilModal) {
                fecharPerfilModal.onclick = () => {
                    state.perfilModalAberto = false;
                    render();
                };
            }
            if (perfilModal) {
                perfilModal.onclick = (e) => {
                    if (e.target === perfilModal) {
                        state.perfilModalAberto = false;
                        render();
                    }
                };
            }
            document.querySelectorAll('.profile-modal-tab[data-perfil-tab]').forEach(tab => {
                tab.onclick = () => {
                    state.perfilAbaAtiva = tab.dataset.perfilTab;
                    render();
                };
            });
            const segurancaSenhaForm = document.getElementById('segurancaSenhaForm');
            if (segurancaSenhaForm) {
                segurancaSenhaForm.onsubmit = async (event) => {
                    event.preventDefault();
                    if (!isCurrentUserAdmin()) {
                        const msg = document.getElementById('segurancaSenhaMsg');
                        if (msg) {
                            msg.textContent = 'Apenas usuários ADMIN podem alterar senhas.';
                            msg.style.color = '#dc2626';
                        }
                        return;
                    }
                    const formData = new FormData(segurancaSenhaForm);
                    const usuarioEmail = normalizeEmail(formData.get('usuarioEmail'));
                    const novaSenha = String(formData.get('novaSenha') || '');
                    const confirmarNovaSenha = String(formData.get('confirmarNovaSenha') || '');
                    const msg = document.getElementById('segurancaSenhaMsg');
                    if (!msg) return;
                    if (!usuarioEmail) {
                        msg.textContent = 'Selecione um usuário para alterar senha.';
                        msg.style.color = '#dc2626';
                        return;
                    }
                    if (novaSenha.length < 8) {
                        msg.textContent = 'A nova senha deve ter no mínimo 8 caracteres.';
                        msg.style.color = '#dc2626';
                        return;
                    }
                    if (!validatePasswordComplexity(novaSenha)) {
                        msg.textContent = 'A nova senha deve conter letra maiúscula, minúscula, número e caractere especial.';
                        msg.style.color = '#dc2626';
                        return;
                    }
                    if (novaSenha !== confirmarNovaSenha) {
                        msg.textContent = 'Confirmação de senha não confere.';
                        msg.style.color = '#dc2626';
                        return;
                    }
                    if (getUserPassword(usuarioEmail) === novaSenha) {
                        msg.textContent = 'A nova senha deve ser diferente da senha atual.';
                        msg.style.color = '#dc2626';
                        return;
                    }
                    setUserPassword(usuarioEmail, novaSenha);
                    const pessoaAlvo = pessoasBase.find(pessoa => normalizeEmail(pessoa.email) === usuarioEmail);
                    registrarAuditoriaAdmin('EDICAO', `Senha redefinida para ${pessoaAlvo?.nome || 'Usuário'} (id: ${pessoaAlvo?.id || '-'})`, { modulo: 'Usuários e Segurança', referencia: pessoaAlvo?.email || usuarioEmail, tipoAcao: 'EDICAO' });
                    msg.textContent = `Senha atualizada com sucesso para ${usuarioEmail}.`;
                    msg.style.color = '#059669';
                    segurancaSenhaForm.reset();
                };
            }

            const abrirExportAnaliticoModal = document.getElementById('abrirExportAnaliticoModal');
            if (abrirExportAnaliticoModal) {
                abrirExportAnaliticoModal.onclick = () => {
                    state.exportModalAberto = true;
                    render();
                };
            }
            const exportAnaliticoModal = document.getElementById('exportAnaliticoModal');
            const fecharExportAnaliticoModal = document.getElementById('fecharExportAnaliticoModal');
            const cancelarExportAnalitico = document.getElementById('cancelarExportAnalitico');
            const confirmarExportAnalitico = document.getElementById('confirmarExportAnalitico');
            const confirmarExportDireto = document.getElementById('confirmarExportDireto');
            if (fecharExportAnaliticoModal) {
                fecharExportAnaliticoModal.onclick = () => {
                    state.exportModalAberto = false;
                    render();
                };
            }
            if (cancelarExportAnalitico) {
                cancelarExportAnalitico.onclick = () => {
                    state.exportModalAberto = false;
                    render();
                };
            }
            if (exportAnaliticoModal) {
                exportAnaliticoModal.onclick = (event) => {
                    if (event.target === exportAnaliticoModal) {
                        state.exportModalAberto = false;
                        render();
                    }
                };
            }
            document.querySelectorAll('[data-export-key]').forEach(input => {
                input.onchange = () => {
                    const key = input.getAttribute('data-export-key');
                    if (!key) return;
                    state.exportAnalisesSelecionadas[key] = input.checked;
                    render();
                };
            });
            document.querySelectorAll('input[name="exportDiretoTipo"]').forEach(input => {
                input.onchange = () => {
                    state.exportDiretoTipo = input.value || 'RNC_GERAL';
                };
            });
            if (confirmarExportAnalitico) {
                confirmarExportAnalitico.onclick = () => {
                    exportarRelatorioAnaliticoExcel();
                    state.exportModalAberto = false;
                    render();
                };
            }
            if (confirmarExportDireto) {
                confirmarExportDireto.onclick = () => {
                    exportarRelatorioDiretoExcel();
                    state.exportModalAberto = false;
                    render();
                };
            }
             
            const modal = document.getElementById('rncModal');
            if (modal) {
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        state.selectedRNC = null;
                        render();
                    }
                };
            }
            
            document.querySelectorAll('.rnc-phase-tab[data-tab]:not(.d4-subtab)').forEach(tab => {
                tab.onclick = () => {
                    if (!tab.dataset.tab) return;
                    if (!state.selectedRNC || !canAcessarEtapa(state.selectedRNC, tab.dataset.tab)) {
                        const targetIndex = phases.findIndex(p => p.id === tab.dataset.tab);
                        const etapaBloqueante = targetIndex > 0 ? phases[targetIndex - 1]?.name : 'etapa anterior';
                        alert(`Esta etapa está bloqueada. Conclua ${etapaBloqueante} para continuar.`);
                        return;
                    }
                    if (state.activeTab === 'd4') sincronizarD4EmEdicao();
                    state.activeTab = tab.dataset.tab;
                    if (state.activeTab === 'd4') state.activeD4SubTab = 'principal';
                    render();
                };
            });

            document.querySelectorAll('.d4-subtab').forEach(tab => {
                tab.onclick = () => {
                    sincronizarD4EmEdicao();
                    state.activeD4SubTab = tab.dataset.d4Subtab;
                    render();
                };
            });

            document.querySelectorAll('.d2-image-preview').forEach(img => {
                img.onclick = () => abrirImagemModal(img.dataset.imageSrc, img.dataset.imageTitle || 'Imagem');
                img.onkeydown = (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        abrirImagemModal(img.dataset.imageSrc, img.dataset.imageTitle || 'Imagem');
                    }
                };
            });
            
            // Event listeners para filtros dos cards de métricas
            document.querySelectorAll('.stat-card[data-filter]').forEach(card => {
                card.onclick = () => {
                    const filter = card.dataset.filter;
                    const rows = document.querySelectorAll('.rnc-row');
                    
                    rows.forEach(row => {
                        const rncId = parseInt(row.dataset.rncId);
                        const rnc = state.rncs.find(r => r.id === rncId);
                        const statusRnc = rnc ? getStatusRncValue(rnc) : 'ON_TIME';
                        
                        if (filter === 'all' || statusRnc === filter) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                    
                    // Scroll suave para a tabela
                    const table = document.querySelector('.card table');
                    if (table) {
                        table.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };
            });
        }

        async function initApp() {
            await carregarCadastrosBaseDoFirebase();
            await carregarRNCsDoFirebase();
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && state.mobileMenuOpen) {
                    state.mobileMenuOpen = false;
                    render();
                }
            });
            window.addEventListener('resize', () => {
                if (!isMobileView() && state.mobileMenuOpen) {
                    state.mobileMenuOpen = false;
                    render();
                }
            });
            render();
        }

        initApp();
    </script>
</body>

</html>
